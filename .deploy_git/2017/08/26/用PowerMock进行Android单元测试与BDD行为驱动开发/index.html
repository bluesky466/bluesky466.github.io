<!DOCTYPE html>


  <html class="light page-post">


<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>用PowerMock进行Android单元测试与BDD行为驱动开发 | LinJW</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="技术相关,Android,单元测试,">
  

  <meta name="description" content="很久之前就有听说过mockito和PowerMock的大名了,无奈我司写单元测试的风气不浓,加上一直以来业务繁忙,惰性使我一直没有写单元测试的习惯。 正好现在手头上的是一个全新的项目,可以在初期有时间也有冲动将各种需要的东西都用上。于是这几天就好好学习了一番,感觉PowerMock的确是无比强大。 什么是mock维基百科上是这么写的:  在面向对象程序设计中，模拟对象（英语：mock object">
<meta name="keywords" content="技术相关,Android,单元测试">
<meta property="og:type" content="article">
<meta property="og:title" content="用PowerMock进行Android单元测试与BDD行为驱动开发">
<meta property="og:url" content="http://139.199.4.241/2017/08/26/用PowerMock进行Android单元测试与BDD行为驱动开发/index.html">
<meta property="og:site_name" content="LinJW">
<meta property="og:description" content="很久之前就有听说过mockito和PowerMock的大名了,无奈我司写单元测试的风气不浓,加上一直以来业务繁忙,惰性使我一直没有写单元测试的习惯。 正好现在手头上的是一个全新的项目,可以在初期有时间也有冲动将各种需要的东西都用上。于是这几天就好好学习了一番,感觉PowerMock的确是无比强大。 什么是mock维基百科上是这么写的:  在面向对象程序设计中，模拟对象（英语：mock object">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-10-14T14:06:52.286Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="用PowerMock进行Android单元测试与BDD行为驱动开发">
<meta name="twitter:description" content="很久之前就有听说过mockito和PowerMock的大名了,无奈我司写单元测试的风气不浓,加上一直以来业务繁忙,惰性使我一直没有写单元测试的习惯。 正好现在手头上的是一个全新的项目,可以在初期有时间也有冲动将各种需要的东西都用上。于是这几天就好好学习了一番,感觉PowerMock的确是无比强大。 什么是mock维基百科上是这么写的:  在面向对象程序设计中，模拟对象（英语：mock object">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=c114cbe6" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?57e94d016e201fba3603a8a2b0263af0";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  
  <script type="text/javascript">
	(function(){
	    var bp = document.createElement('script');
	    var curProtocol = window.location.protocol.split(':')[0];
	    if (curProtocol === 'https') {
	        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
	    }
	    else {
	        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
	    }
	    var s = document.getElementsByTagName("script")[0];
	    s.parentNode.insertBefore(bp, s);
	})();
  </script>



  
    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  
</head>
</html>
<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            rel="noopener noreferrer"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            rel="noopener noreferrer"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            rel="noopener noreferrer"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            rel="noopener noreferrer"
            target="_self"
            >
            关于
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#什么是mock"><span class="toc-text">什么是mock</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PowerMock"><span class="toc-text">PowerMock</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mock的简单用法"><span class="toc-text">mock的简单用法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mock-方法内部创建的对象"><span class="toc-text">mock 方法内部创建的对象</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#使用BDD的方式编写单元测试"><span class="toc-text">使用BDD的方式编写单元测试</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mock-静态方法"><span class="toc-text">mock 静态方法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#完整Demo"><span class="toc-text">完整Demo</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-用PowerMock进行Android单元测试与BDD行为驱动开发" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">用PowerMock进行Android单元测试与BDD行为驱动开发</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2017.08.26</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>林嘉伟</span>
        </span>
      

      


      
        <span>
          <i class="icon-comment"></i>
          <a href="http://blog.islinjw.cn/2017/08/26/用PowerMock进行Android单元测试与BDD行为驱动开发/#disqus_thread"></a>
        </span>
      

      
      <i class="fa fa-eye"></i> 
        <span id="busuanzi_container_page_pv">
           &nbsp热度 <span id="busuanzi_value_page_pv">
           <i class="fa fa-spinner fa-spin"></i></span>℃
        </span>
      

      
      
    </div>
  </header>

  <div class="article-content">
    
      <p>很久之前就有听说过mockito和PowerMock的大名了,无奈我司写单元测试的风气不浓,加上一直以来业务繁忙,惰性使我一直没有写单元测试的习惯。</p>
<p>正好现在手头上的是一个全新的项目,可以在初期有时间也有冲动将各种需要的东西都用上。于是这几天就好好学习了一番,感觉PowerMock的确是无比强大。</p>
<h1 id="什么是mock"><a href="#什么是mock" class="headerlink" title="什么是mock"></a>什么是mock</h1><p>维基百科上是这么写的:</p>
<blockquote>
<p>在面向对象程序设计中，模拟对象（英语：mock object，也译作模仿对象）是以可控的方式模拟真实对象行为的假的对象。程序员通常创造模拟对象来测试其他对象的行为，很类似汽车设计者使用碰撞测试假人来模拟车辆碰撞中人的动态行为。<br>在单元测试中，模拟对象可以模拟复杂的、真实的（非模拟）对象的行为， 如果真实的对象无法放入单元测试中，使用模拟对象就很有帮助。</p>
</blockquote>
<p>如果我们使用依赖注入的方式编写代码,例如Context通常都是外部传入的:</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassA</span>&#123;</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">staticFunc</span><span class="params">(Context context, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法如果不使用mock object的方法,我们很难脱离安卓环境去编写单元测试,因为Context是系统生成的。</p>
<p>而使用mock技术去模拟一个Context出来,就可以在android studio中编写并且脱离安卓环境运行单元测试了。</p>
<h1 id="PowerMock"><a href="#PowerMock" class="headerlink" title="PowerMock"></a>PowerMock</h1><p><a href="https://github.com/powermock/powermock" target="_blank" rel="noopener">powermock</a>是一个流行的java mock框架,通过它我们可以很方便的实现模拟对象。它实际上是继承并且拓展了EasyMock、Mockito等其他的流行框架。</p>
<p>在android studio上导入powermock框架很简单,只需要在build.gradle中添加dependencies就好了:</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">	...</span><br><span class="line">    testCompile <span class="string">'junit:junit:4.12'</span></span><br><span class="line"></span><br><span class="line">    testCompile <span class="string">'org.powermock:powermock-core:1.6.1'</span></span><br><span class="line">    testCompile <span class="string">'org.powermock:powermock-module-junit4:1.6.1'</span></span><br><span class="line">    testCompile <span class="string">'org.powermock:powermock-module-junit4-rule:1.6.1'</span></span><br><span class="line">    testCompile <span class="string">'org.powermock:powermock-api-mockito:1.6.1'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有个坑点，之前我用的是1.5.6版本的powermock,但是我的junit是4.12版本的,于是在使用@RunWith(PowerMockRunner.class)的时候会报错:</p>
<blockquote>
<p>org.powermock.reflect.exceptions.FieldNotFoundException: Field ‘fTestClass’ was not found in class org.junit.internal.runners.MethodValidator.</p>
</blockquote>
<p>到stackoverflow上搜索到国外大神的<a href="https://stackoverflow.com/questions/26192929/unable-to-run-junit-test-with-powermockrunner" target="_blank" rel="noopener">回答</a>是powermock小于1.6.1的版本在使用junit 4.12的一个bug,在1.6.1被修复。所以要么用junit 4.12 + powermock 1.6.1,要么使用junit 4.11 + powermock 1.5.6.</p>
<h1 id="mock的简单用法"><a href="#mock的简单用法" class="headerlink" title="mock的简单用法"></a>mock的简单用法</h1><p>先说一下最近我拿到的一个需求。我们的应用的按钮点击启动其他应用的响应需要在服务器上配置。服务器上可能配的是包名启动应用,也可能是action启动应用,还有可能是Uri启动应用。</p>
<p>所以我这样写了一个工具类:</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppUtils</span> &#123;</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">startApp</span><span class="params">(Context context, StartAppParam param)</span> </span>&#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	 <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">StartAppParam</span> &#123;</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">String</span> packageName;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">String</span> activity;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">String</span> action;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">String</span> uri;</span><br><span class="line">        <span class="keyword">private</span> List&lt;<span class="keyword">String</span>&gt; categorys = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在服务器上配置一个json,传到客户端解析成StartAppParam,然后调用AppUtils. startApp方法。这样就可以实现这个需求了。</p>
<p>我们使用TDD的方式开发这个功能。首先考虑只配置Action的方式启动:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testOpenAppByAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Context context = Mockito.mock(Context<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		</span><br><span class="line">		AppUtils.StartAppParam param = Mockito.mock(AppUtils.StartAppParam<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		PowerMockito.when(param.getAction()).thenReturn(<span class="string">"package"</span>);</span><br><span class="line">		</span><br><span class="line">		assertTrue(AppUtils.startApp(context, param));</span><br><span class="line">		    </span><br><span class="line">		Mockito.verify(context, Mockito.times(<span class="number">1</span>)).startActivity(Matchers.any(Intent<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>首先,使用Mockito.mock方法可以创建一个模拟对象出来。我们这里使用模拟的Context就可以直接在android studio中运行单元测试了。</p>
<p>同时param也用mock的方式创建了出来,而且还模拟了它的getAction方法,让该方法返回”package”,表示配置了使用Action去启动应用:</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AppUtils.StartAppParam param = Mockito.mock(AppUtils.StartAppParam <span class="class">.<span class="keyword">class</span>);</span></span><br><span class="line">PowerMockito.<span class="keyword">when</span>(param.getAction()).thenReturn(<span class="string">"package"</span>);</span><br></pre></td></tr></table></figure>

<p>然后Mockito.verify方法可以用来验证调用了方法的调用次数,比如这里我们就验证了startActivity被调用了一次。</p>
<h1 id="mock-方法内部创建的对象"><a href="#mock-方法内部创建的对象" class="headerlink" title="mock 方法内部创建的对象"></a>mock 方法内部创建的对象</h1><p>当然这个测试不充分,因为我们没有验证到底是不是通过Action启动的。也就是说我们还需要判断是不是通过new Intent(param.getAction())的方式创建了一个Intent出来。</p>
<p>这就用到了PowerMock的一个很屌的功能了,它不仅可以在外部mock一个对象通过参数传给需要测试的方法,更可以直接mock方法内部创建的对象(比如这里的Intent)!</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@RunWith(PowerMockRunner.<span class="keyword">class</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> AppUtilsTest &#123;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    @PrepareForTest(&#123;AppUtils.<span class="keyword">class</span>&#125;)</span><br><span class="line">    <span class="keyword">public</span> void testOpenAppByAction() throws Exception &#123;</span><br><span class="line">        <span class="keyword">Intent</span> <span class="keyword">intent</span> = Mockito.mock(<span class="keyword">Intent</span>.<span class="keyword">class</span>);</span><br><span class="line">        PowerMockito.whenNew(<span class="keyword">Intent</span>.<span class="keyword">class</span>).withArguments(<span class="string">"package"</span>).thenReturn(<span class="keyword">intent</span>);</span><br><span class="line"></span><br><span class="line">        Context context = Mockito.mock(Context.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">        AppUtils.StartAppParam param = Mockito.mock(AppUtils.StartAppParam.<span class="keyword">class</span>);</span><br><span class="line">        PowerMockito.when(param.getAction()).thenReturn(<span class="string">"package"</span>);</span><br><span class="line"></span><br><span class="line">        assertTrue(AppUtils.startApp(context, param));</span><br><span class="line">        </span><br><span class="line">        Mockito.<span class="built_in">verify</span>(context, Mockito.times(<span class="number">1</span>)).startActivity(<span class="keyword">intent</span>);</span><br><span class="line">        Mockito.<span class="built_in">verify</span>(<span class="keyword">intent</span>, Mockito.times(<span class="number">0</span>)).setData(Matchers.<span class="built_in">any</span>(Uri.<span class="keyword">class</span>));</span><br><span class="line">        Mockito.<span class="built_in">verify</span>(<span class="keyword">intent</span>, Mockito.times(<span class="number">0</span>)).addCategory(Matchers.anyString());</span><br><span class="line">        Mockito.<span class="built_in">verify</span>(<span class="keyword">intent</span>, Mockito.times(<span class="number">0</span>)).setClassName(Matchers.anyString(), Matchers.anyString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先需要用@RunWith(PowerMockRunner.class)注解AppUtilsTest类,用@PrepareForTest({AppUtils.class})注解testOpenAppByAction方法,传入的AppUtils.class表示需要在AppUtils类内部实现mock操作。</p>
<p>然后mock一个Intent出来,接着使用下面的方法使得使用new Intent(“package”)得到的Intent是我们mock出来的intent,注意这里连传入的”package”参数也需要匹配才能得到我们mock出来的intent。否则只能得到null:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">PowerMockito</span><span class="selector-class">.whenNew</span>(<span class="selector-tag">Intent</span><span class="selector-class">.class</span>)<span class="selector-class">.withArguments</span>("<span class="selector-tag">package</span>")<span class="selector-class">.thenReturn</span>(<span class="selector-tag">intent</span>);</span><br></pre></td></tr></table></figure>

<p>所以我们在后面只需要验证startActivity调用的intent是不是我们mock出来的对象,就可以验证是不是通过Action启动的应用了:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Mockito</span><span class="selector-class">.verify</span>(<span class="selector-tag">context</span>, <span class="selector-tag">Mockito</span><span class="selector-class">.times</span>(1))<span class="selector-class">.startActivity</span>(<span class="selector-tag">intent</span>);</span><br></pre></td></tr></table></figure>

<p>当然,为了保险我们可以顺便确认一下Intent的其他方法是不是没有被调用到:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Mockito</span><span class="selector-class">.verify</span>(<span class="selector-tag">intent</span>, <span class="selector-tag">Mockito</span><span class="selector-class">.times</span>(0))<span class="selector-class">.setData</span>(<span class="selector-tag">Matchers</span><span class="selector-class">.any</span>(<span class="selector-tag">Uri</span><span class="selector-class">.class</span>));</span><br><span class="line"><span class="selector-tag">Mockito</span><span class="selector-class">.verify</span>(<span class="selector-tag">intent</span>, <span class="selector-tag">Mockito</span><span class="selector-class">.times</span>(0))<span class="selector-class">.addCategory</span>(<span class="selector-tag">Matchers</span><span class="selector-class">.anyString</span>());</span><br><span class="line"><span class="selector-tag">Mockito</span><span class="selector-class">.verify</span>(<span class="selector-tag">intent</span>, <span class="selector-tag">Mockito</span><span class="selector-class">.times</span>(0))<span class="selector-class">.setClassName</span>(<span class="selector-tag">Matchers</span><span class="selector-class">.anyString</span>(), <span class="selector-tag">Matchers</span><span class="selector-class">.anyString</span>());</span><br></pre></td></tr></table></figure>

<h1 id="使用BDD的方式编写单元测试"><a href="#使用BDD的方式编写单元测试" class="headerlink" title="使用BDD的方式编写单元测试"></a>使用BDD的方式编写单元测试</h1><p>BDD (Behavior-driven development,行为驱动开发)通过用自然语言书写非程序员可读的测试用例扩展了测试驱动开发方法。也就是说用bdd方式写的代码就连不是程序员的人也能看得懂,这种可读性的重要性就不用我多费口舌了吧。</p>
<p>其实Mockito的BDD方式的写法我觉得并不是特别的像自然语言。所以我想用C++的单元测试框架Catch框架来举例:</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">GIVEN</span>(<span class="string">"a enable stub publish server entry"</span>) &#123;</span><br><span class="line">    <span class="selector-tag">StubPublishServerEntry</span> <span class="selector-tag">entry</span>(true);</span><br><span class="line">	<span class="selector-tag">entry</span><span class="selector-class">.Start</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">WHEN</span>(<span class="string">"publish service"</span>) &#123;</span><br><span class="line">        <span class="selector-tag">entry</span><span class="selector-class">.PublishService</span>(service, on_result, on_success, on_error);</span><br><span class="line"></span><br><span class="line">        <span class="selector-tag">THEN</span>(<span class="string">"publish successfully"</span>) &#123;</span><br><span class="line">            <span class="selector-tag">REQUIRE</span>(service_entry != nullptr);</span><br><span class="line">            <span class="selector-tag">REQUIRE</span>(service_entry-&gt;IsPublished());</span><br><span class="line">            <span class="selector-tag">REQUIRE</span>(is_on_success);</span><br><span class="line">            <span class="selector-tag">REQUIRE_FALSE</span>(is_on_error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是我之前的半成品项目中的一个代码片段。如果将代码部分去掉,只留下GIVEN、WHEN、THEN三个宏里面的东西,基本只有是懂英语的人都能看得懂这段代码想做什么:</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">GIVEN</span>(<span class="string">"a enable stub publish server entry"</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">WHEN</span>(<span class="string">"publish service"</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="selector-tag">THEN</span>(<span class="string">"publish successfully"</span>) &#123;</span><br><span class="line">            ...  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PowerMock也是支持BDD的(应该说Mockito是支持BDD的),我们可以将上面写的测试用例改成BDD的写法:</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> void testOpenAppByAction() throws Exception &#123;</span><br><span class="line">    <span class="keyword">Intent</span> <span class="keyword">intent</span> = Mockito.mock(<span class="keyword">Intent</span>.<span class="keyword">class</span>);</span><br><span class="line">    PowerMockito.whenNew(<span class="keyword">Intent</span>.<span class="keyword">class</span>).withArguments(<span class="string">"package"</span>).thenReturn(<span class="keyword">intent</span>);</span><br><span class="line"></span><br><span class="line">    Context context = Mockito.mock(Context.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">    AppUtils.StartAppParam param = Mockito.mock(AppUtils.StartAppParam .<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">    //given</span><br><span class="line">    BDDMockito.given(param.getAction()).willReturn(<span class="string">"package"</span>);</span><br><span class="line"></span><br><span class="line">    //when</span><br><span class="line">    assertTrue(AppUtils.startApp(context, param));</span><br><span class="line"></span><br><span class="line">    //<span class="keyword">then</span></span><br><span class="line">    BDDMockito.<span class="keyword">then</span>(context).should().startActivity(<span class="keyword">intent</span>);</span><br><span class="line">    BDDMockito.<span class="keyword">then</span>(<span class="keyword">intent</span>).should(Mockito.never()).setData(Matchers.<span class="built_in">any</span>(Uri.<span class="keyword">class</span>));</span><br><span class="line">    BDDMockito.<span class="keyword">then</span>(<span class="keyword">intent</span>).should(Mockito.never()).addCategory(Matchers.anyString());</span><br><span class="line">    BDDMockito.<span class="keyword">then</span>(<span class="keyword">intent</span>).should(Mockito.never()).setClassName(Matchers.anyString(), Matchers.anyString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>感觉是不是和自然语言还是差别蛮大的,我们改造改造,将一些方法改成通过import static的方式import:</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> void testOpenAppByAction() throws Exception &#123;</span><br><span class="line">    <span class="keyword">Intent</span> <span class="keyword">intent</span> = mock(<span class="keyword">Intent</span>.<span class="keyword">class</span>);</span><br><span class="line">    whenNew(<span class="keyword">Intent</span>.<span class="keyword">class</span>).withArguments(<span class="string">"package"</span>).thenReturn(<span class="keyword">intent</span>);</span><br><span class="line"></span><br><span class="line">    Context context = mock(Context.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">    AppUtils.StartAppParam param = mock(AppUtils.StartAppParam .<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">    //given</span><br><span class="line">    given(param.getAction()).willReturn(<span class="string">"package"</span>);</span><br><span class="line"></span><br><span class="line">    //when</span><br><span class="line">    assertTrue(AppUtils.startApp(context, param));</span><br><span class="line"></span><br><span class="line">    //<span class="keyword">then</span></span><br><span class="line">    <span class="keyword">then</span>(context).should().startActivity(<span class="keyword">intent</span>);</span><br><span class="line">    <span class="keyword">then</span>(<span class="keyword">intent</span>).should(never()).setData(<span class="built_in">any</span>(Uri.<span class="keyword">class</span>));</span><br><span class="line">    <span class="keyword">then</span>(<span class="keyword">intent</span>).should(never()).addCategory(anyString());</span><br><span class="line">    <span class="keyword">then</span>(<span class="keyword">intent</span>).should(never()).setClassName(anyString(), anyString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样是不是好多了？让我们继续改造:</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">class</span> <span class="selector-tag">AppUtilsTest</span> &#123;</span><br><span class="line">    <span class="variable">@Mock</span></span><br><span class="line">    private Intent mIntent;</span><br><span class="line"></span><br><span class="line">    <span class="variable">@Mock</span></span><br><span class="line">    private Context mContext;</span><br><span class="line"></span><br><span class="line">    <span class="variable">@Mock</span></span><br><span class="line">    private AppUtils.StartAppParam mParam;</span><br><span class="line"></span><br><span class="line">    <span class="variable">@Before</span></span><br><span class="line">    public void setUp() throws Exception &#123;</span><br><span class="line">        <span class="selector-tag">whenNew</span>(Intent.class)<span class="selector-class">.withArguments</span>(<span class="string">"package"</span>)<span class="selector-class">.thenReturn</span>(mIntent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="selector-tag">Test</span></span><br><span class="line">    @<span class="selector-tag">PrepareForTest</span>(&#123;<span class="selector-tag">AppUtils</span><span class="selector-class">.class</span>&#125;)</span><br><span class="line">    <span class="selector-tag">public</span> <span class="selector-tag">void</span> <span class="selector-tag">testOpenAppByAction</span>() &#123;</span><br><span class="line">        <span class="selector-tag">given</span>(mParam.getAction())<span class="selector-class">.willReturn</span>(<span class="string">"package"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//when</span></span><br><span class="line">        <span class="selector-tag">assertTrue</span>(AppUtils.startApp(mContext, mParam));</span><br><span class="line"></span><br><span class="line">        <span class="selector-tag">then</span>(mContext)<span class="selector-class">.should</span>()<span class="selector-class">.startActivity</span>(mIntent);</span><br><span class="line">        <span class="selector-tag">then</span>(mIntent)<span class="selector-class">.should</span>(never())<span class="selector-class">.setData</span>(any(Uri.class));</span><br><span class="line">        <span class="selector-tag">then</span>(mIntent)<span class="selector-class">.should</span>(never())<span class="selector-class">.addCategory</span>(anyString());</span><br><span class="line">        <span class="selector-tag">then</span>(mIntent)<span class="selector-class">.should</span>(never())<span class="selector-class">.setClassName</span>(anyString(), anyString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为Intent、Context、AppUtils.StartAppParam都是需要在不同测试用例中经常被用到的,我们将它写成成员变量并且用@Mock实现自动mock,省去Mockito.mock()方法的调用。</p>
<p>然后将whenNew方法放到由@Before注解的setUp()方法中。</p>
<p>现在看testOpenAppByAction是不是简洁多了？只要有一点代码功底的人都能很容易看明白这个用例到底是用来验证什么的。</p>
<p>当然,这里的BDD写法和上面Catch的写法比起来在像自然语言方面还是有点差距的。</p>
<p>现在我们已经将测试用例写出来了，就可以开始写代码让这个测试用例通过了。像这样先写行为测试用例再写代码的开发方式就叫做BDD。</p>
<h1 id="mock-静态方法"><a href="#mock-静态方法" class="headerlink" title="mock 静态方法"></a>mock 静态方法</h1><p>我们下一个需要实现的功能是什么呢？就实现通过包名启动应用吧。将设只配置了包名,但没有配置Activity名。我们就需要先找到这个应用的Launch Activity,然后再去启动应用。</p>
<p>所以我们在AppUtils中新增了一个方法,用于从包名获取Activity名:</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppUtils</span> &#123;</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">startApp</span><span class="params">(Context context, StartAppParam param)</span> </span>&#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> <span class="title">getLaunchActivityByPackage</span><span class="params">(Context context, <span class="keyword">String</span> packageName)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> null;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果是正常的开发流程我们需要写一个getLaunchActivityByPackage测试用例，再实现这个方法。这里我就省略了这步,让getLaunchActivityByPackage这个方法先不实现,直接返回null,测试的时候直接mock就好了。</p>
<p>之后我们再去写startAppByPackage的测试用例:</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Test</span></span><br><span class="line">public void startAppByPackage() &#123;</span><br><span class="line">    <span class="selector-tag">mockStatic</span>(AppUtils.class);</span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">given</span>(AppUtils.startApp(any(Context.class), any(AppUtils.StartAppParam.class)))</span><br><span class="line">            <span class="selector-class">.willCallRealMethod</span>();</span><br><span class="line">    <span class="selector-tag">given</span>(AppUtils.getLaunchActivityByPackage(any(Context.class), anyString()))</span><br><span class="line">            <span class="selector-class">.willReturn</span>(<span class="string">"LauncActivity"</span>);</span><br><span class="line">    <span class="selector-tag">given</span>(mParam.getPackageName())<span class="selector-class">.willReturn</span>(<span class="string">"packageName"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//when</span></span><br><span class="line">    <span class="selector-tag">assertTrue</span>(AppUtils.startApp(mContext, mParam));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//then</span></span><br><span class="line">    <span class="selector-tag">verifyStatic</span>(); <span class="comment">//开启static方法的验证,需要开启才能验证AppUtils.getLaunchActivityByPackage是否被调用</span></span><br><span class="line">    <span class="selector-tag">AppUtils</span><span class="selector-class">.getLaunchActivityByPackage</span>(any(Context.class), eq(<span class="string">"packageName"</span>));</span><br><span class="line">    <span class="selector-tag">then</span>(mIntent)<span class="selector-class">.should</span>()<span class="selector-class">.setClassName</span>(mParam.getPackageName(), <span class="string">"LauncActivity"</span>);</span><br><span class="line">    <span class="selector-tag">then</span>(mContext)<span class="selector-class">.should</span>()<span class="selector-class">.startActivity</span>(mIntent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先我们使用mockStatic去模拟AppUtils,然后配置AppUtils.startApp调用实际的方法,而getLaunchActivityByPackage直接返回”LauncActivity”。</p>
<p>在验证getLaunchActivityByPackage是否被调用的时候要先调用verifyStatic()。</p>
<p>之后再用下面的方式验证是不是调用了AppUtils.getLaunchActivityByPackage并且传入了”packageName”</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AppUtils.getLaunchActivityByPackage(any(Context.class), e<span class="string">q("packageName")</span>);</span><br></pre></td></tr></table></figure>

<p>这里多说一点,假设getLaunchActivityByPackage是一个private的方法,我们可以用下面的方式去mock它:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">when</span>(AppUtils<span class="class">.<span class="keyword">class</span>, <span class="type">"getLaunchActivityByPackage"</span>, <span class="type">any</span></span>(Context<span class="class">.<span class="keyword">class</span>), <span class="type">anyString</span></span>())</span><br><span class="line">        .thenReturn(<span class="string">"LauncActivity"</span>);</span><br></pre></td></tr></table></figure>

<h1 id="完整Demo"><a href="#完整Demo" class="headerlink" title="完整Demo"></a>完整Demo</h1><p>其他剩下的测试用例我就不一个一个去讲了,基本上通过之前对PowerMock用法的介绍大家也应该能自己实现了。</p>
<p>完整的demo代码可以从<a href="https://github.com/bluesky466/UnitTestDemo" target="_blank" rel="noopener">这里</a>获取</p>

    
  </div>
</article>


   

   
  <div class="box-prev-next clearfix">
    <a class="show pull-left" href="/2017/08/24/Java多线程-如何正确的终止线程/">
        <i class="icon icon-angle-left"></i>
    </a>
    <a class="show pull-right" href="/2017/08/31/Java多线程-各种线程锁/">
        <i class="icon icon-angle-right"></i>
    </a>
  </div>




</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              rel="noopener noreferrer"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              rel="noopener noreferrer"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              rel="noopener noreferrer"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              rel="noopener noreferrer"
              target="_self"
              >
              关于
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    
  <section class="disqus-comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  </section>

  <script>
    var disqus_shortname = 'forsigner';
    
    var disqus_url = 'http://139.199.4.241/2017/08/26/用PowerMock进行Android单元测试与BDD行为驱动开发/';
    
    (function(){
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>

  <script id="dsq-count-scr" src="//forsigner.disqus.com/count.js" async></script>



    




    

  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"left","width":300,"height":300},"mobile":{"show":true},"log":false});</script></body>
</html>
