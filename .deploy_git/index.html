<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>修我矛戟</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="林嘉伟的个人博客">
<meta property="og:type" content="website">
<meta property="og:title" content="修我矛戟">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="修我矛戟">
<meta property="og:description" content="林嘉伟的个人博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="修我矛戟">
<meta name="twitter:description" content="林嘉伟的个人博客">
  
    <link rel="alternative" href="/atom.xml" title="修我矛戟" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://blog.islinjw.cn/head.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">林嘉伟</a></h1>
		</hgroup>

		
		<p class="header-subtitle">什么都想学</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>標籤</li>
						
						<li>友情链接</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/tags/读书笔记">读书笔记</a></li>
				        
							<li><a href="/tags/技术相关">技术相关</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="http://github.com/bluesky466" title="github">github</a>
					        
								<a class="mail" target="_blank" href="mailto:466474482@qq.com" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Android/" style="font-size: 18px;">Android</a> <a href="/tags/Http协议/" style="font-size: 12px;">Http协议</a> <a href="/tags/c/" style="font-size: 12px;">c++</a> <a href="/tags/grpc/" style="font-size: 10px;">grpc</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/lua/" style="font-size: 14px;">lua</a> <a href="/tags/单元测试/" style="font-size: 12px;">单元测试</a> <a href="/tags/技术相关/" style="font-size: 20px;">技术相关</a> <a href="/tags/设计模式/" style="font-size: 12px;">设计模式</a> <a href="/tags/读书笔记/" style="font-size: 16px;">读书笔记</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.guorongfei.com/">荣飞大大的博客</a>
			        
			        </div>
				</section>
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">林嘉伟</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="http://blog.islinjw.cn/head.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">林嘉伟</h1>
			</hgroup>
			
			<p class="header-subtitle">什么都想学</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags/读书笔记">读书笔记</a></li>
		        
					<li><a href="/tags/技术相关">技术相关</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="http://github.com/bluesky466" title="github">github</a>
			        
						<a class="mail" target="_blank" href="mailto:466474482@qq.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-在android上使用grpc" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2017/03/03/在android上使用grpc/" class="article-date">
  	<time datetime="2017-03-03T01:49:37.000Z" itemprop="datePublished">2017-03-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/03/在android上使用grpc/">在android上使用grpc</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近的一个项目使用到了grpc实现跨平台的远程调用，在安卓端使用的时候遇到了一些坑，这里记录一下。</p>
<p>首先根据grpc android的<a href="https://github.com/grpc/grpc-java/tree/v1.0.0/examples/android" target="_blank" rel="external">官方Demo</a>配置grpc依赖，测试它的hello world工程。</p>
<h1 id="u7F16_u8BD1_u8C37_u6B4C_u5B98_u65B9_u7684helloworld_u5DE5_u7A0B"><a href="#u7F16_u8BD1_u8C37_u6B4C_u5B98_u65B9_u7684helloworld_u5DE5_u7A0B" class="headerlink" title="编译谷歌官方的helloworld工程"></a>编译谷歌官方的helloworld工程</h1><h3 id="u6DFB_u52A0rotobuf-gradle-plugin_u63D2_u4EF6"><a href="#u6DFB_u52A0rotobuf-gradle-plugin_u63D2_u4EF6" class="headerlink" title="添加rotobuf-gradle-plugin插件"></a>添加rotobuf-gradle-plugin插件</h3><p>首先添加rotobuf-gradle-plugin插件，他是用来从proto文件自动生成java代码的:</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Project的build.gradle中添加rotobuf-gradle-plugin插件</span></span><br><span class="line">buildscript &#123;</span><br><span class="line">    <span class="attribute">...</span></span><br><span class="line">    dependencies &#123;</span><br><span class="line">        <span class="attribute">...</span></span><br><span class="line">        classpath <span class="string">"com.google.protobuf:protobuf-gradle-plugin:0.8.0"</span></span><br><span class="line">        <span class="attribute">...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">//App的build.gradle中添加下面配置</span><br><span class="line">apply plugin: <span class="string">'com.google.protobuf'</span></span><br><span class="line"></span><br><span class="line">protobuf &#123;</span><br><span class="line">    protoc &#123;</span><br><span class="line">        artifact = <span class="string">'com.google.protobuf:protoc:3.0.0'</span></span><br><span class="line">    &#125;</span><br><span class="line">    plugins &#123;</span><br><span class="line">        javalite &#123;</span><br><span class="line">            artifact = <span class="string">"com.google.protobuf:protoc-gen-javalite:3.0.0"</span></span><br><span class="line">        &#125;</span><br><span class="line">        grpc &#123;</span><br><span class="line">            artifact = <span class="string">'io.grpc:protoc-gen-grpc-java:1.0.0'</span> // CURRENT_GRPC_VERSION</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    generateProtoTasks &#123;</span><br><span class="line">        all().each &#123; task -&gt;</span><br><span class="line">            task.plugins &#123;</span><br><span class="line">                javalite &#123;&#125;</span><br><span class="line">                grpc &#123;</span><br><span class="line">                    // Options added to --grpc_out</span><br><span class="line">                    option <span class="string">'lite'</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="u6DFB_u52A0proto_u6587_u4EF6_u5E76_u81EA_u52A8_u751F_u6210java_u4EE3_u7801"><a href="#u6DFB_u52A0proto_u6587_u4EF6_u5E76_u81EA_u52A8_u751F_u6210java_u4EE3_u7801" class="headerlink" title="添加proto文件并自动生成java代码"></a>添加proto文件并自动生成java代码</h3><p>在src/main/目录下创建一个proto目录，并将官方的<a href="https://github.com/grpc/grpc-java/blob/v1.0.0/examples/android/helloworld/app/src/main/proto/helloworld.proto" target="_blank" rel="external">helloworld.proto</a>放到proto目录下</p>
<p>之后只需要rebuild一下就能看到build/generated/source/proto/目录下根据helloworld.proto生成了几个Java类</p>
<img src="/在android上使用grpc/proto_gen.jpeg">
<h3 id="u6DFB_u52A0_u5B89_u5353_u7AEFgrpc_u7684_u4F9D_u8D56"><a href="#u6DFB_u52A0_u5B89_u5353_u7AEFgrpc_u7684_u4F9D_u8D56" class="headerlink" title="添加安卓端grpc的依赖"></a>添加安卓端grpc的依赖</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//App的build.gradle中添加下面配置</span></span><br><span class="line"> <span class="keyword">dependencies</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'io.grpc:grpc-okhttp:1.1.2'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'io.grpc:grpc-protobuf-lite:1.1.2'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'io.grpc:grpc-stub:1.1.2'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'javax.annotation:javax.annotation-api:1.2'</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">configurations.<span class="name">all</span> &#123;</span><br><span class="line">        resolutionStrategy.<span class="literal">force</span> <span class="string">'com.google.code.findbugs:jsr305:3.0.1'</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>我这个时候报了这个错误</p>
<blockquote>
<p>Warning:Conflict with dependency ‘com.google.code.findbugs:jsr305’. Resolved versions for app (3.0.0) and test app (2.0.1) differ. See <a href="http://g.co/androidstudio/app-test-app-conflict" target="_blank" rel="external">http://g.co/androidstudio/app-test-app-conflict</a> for details.</p>
</blockquote>
<p>这是因为com.google.code.findbugs:jsr305的版本不一致导致的</p>
<p>可以在App的build.gradle的android标签中配置一下解决</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    <span class="attribute">...</span></span><br><span class="line">    configurations<span class="built_in">.</span><span class="literal">all</span> &#123;</span><br><span class="line">        resolutionStrategy<span class="built_in">.</span>force <span class="string">'com.google.code.findbugs:jsr305:3.0.1'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="u7F16_u5199demo_u4EE3_u7801"><a href="#u7F16_u5199demo_u4EE3_u7801" class="headerlink" title="编写demo代码"></a>编写demo代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"GrpcDemo"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROT = <span class="number">55055</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME = <span class="string">"linjw"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HOST = <span class="string">"localhost"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        startServer(PROT);</span><br><span class="line">        startClient(HOST, PROT, NAME);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startServer</span><span class="params">(<span class="keyword">int</span> port)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Server server = ServerBuilder.forPort(port)</span><br><span class="line">                    .addService(<span class="keyword">new</span> GreeterImpl())</span><br><span class="line">                    .build()</span><br><span class="line">                    .start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            Log.d(TAG, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startClient</span><span class="params">(String host, <span class="keyword">int</span> port, String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">new</span> GrpcTask(host, port, name).execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">GreeterImpl</span> <span class="keyword">extends</span> <span class="title">GreeterGrpc</span>.<span class="title">GreeterImplBase</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">(HelloRequest request, StreamObserver&lt;HelloReply&gt; responseObserver)</span> </span>&#123;</span><br><span class="line">            responseObserver.onNext(sayHello(request));</span><br><span class="line">            responseObserver.onCompleted();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> HelloReply <span class="title">sayHello</span><span class="params">(HelloRequest request)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> HelloReply.newBuilder()</span><br><span class="line">                    .setMessage(<span class="string">"hello "</span>+ request.getName())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">GrpcTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">Void</span>, <span class="title">Void</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String mHost;</span><br><span class="line">        <span class="keyword">private</span> String mName;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> mPort;</span><br><span class="line">        <span class="keyword">private</span> ManagedChannel mChannel;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">GrpcTask</span><span class="params">(String host, <span class="keyword">int</span> port, String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.mHost = host;</span><br><span class="line">            <span class="keyword">this</span>.mName = name;</span><br><span class="line">            <span class="keyword">this</span>.mPort = port;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPreExecute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> String <span class="title">doInBackground</span><span class="params">(Void... nothing)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mChannel = ManagedChannelBuilder.forAddress(mHost, mPort)</span><br><span class="line">                        .usePlaintext(<span class="keyword">true</span>)</span><br><span class="line">                        .build();</span><br><span class="line">                GreeterGrpc.GreeterBlockingStub stub = GreeterGrpc.newBlockingStub(mChannel);</span><br><span class="line">                HelloRequest message = HelloRequest.newBuilder().setName(mName).build();</span><br><span class="line">                HelloReply reply = stub.sayHello(message);</span><br><span class="line">                <span class="keyword">return</span> reply.getMessage();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                StringWriter sw = <span class="keyword">new</span> StringWriter();</span><br><span class="line">                PrintWriter pw = <span class="keyword">new</span> PrintWriter(sw);</span><br><span class="line">                e.printStackTrace(pw);</span><br><span class="line">                pw.flush();</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"Failed... : "</span> + System.lineSeparator() + sw;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(String result)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mChannel.shutdown().awaitTermination(<span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125;</span><br><span class="line">            Log.d(TAG, result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码运行会崩溃:</p>
<blockquote>
<p>Caused by: io.grpc.ManagedChannelProvider$ProviderNotFoundException: No functional server found. Try adding a dependency on the grpc-netty artifact</p>
</blockquote>
<p>猜测google使用netty替代了okhttp，尝试换成grpc-netty的依赖:</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'io.grpc:grpc-netty:1.1.2'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'io.grpc:grpc-protobuf-lite:1.1.2'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'io.grpc:grpc-stub:1.1.2'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'javax.annotation:javax.annotation-api:1.2'</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这么编译会报错</p>
<blockquote>
<p>com.android.build.api.transform.TransformException: com.android.builder.packaging.DuplicateFileException: Duplicate files copied in APK META-INF/INDEX.LIST</p>
</blockquote>
<p>需要加上下面的配置解决</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    <span class="attribute">...</span></span><br><span class="line">    packagingOptions &#123;</span><br><span class="line">        pickFirst <span class="string">'META-INF/INDEX.LIST'</span></span><br><span class="line">        pickFirst <span class="string">'META-INF/LICENSE'</span></span><br><span class="line">        pickFirst <span class="string">'META-INF/io.netty.versions.properties'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然，还需要加上INTERNET权限，要不然运行的时候还是会崩溃。</p>
<p>最终就能看的下面的打印，这样安卓grpc的helloworld就成功了。</p>
<blockquote>
<p>03-03 00:04:20.000 6137-6137/linjw.com.grpcdemo D/GrpcDemo: hello linjw</p>
</blockquote>
<h1 id="u4F7F_u7528com-google-protobuf-Any"><a href="#u4F7F_u7528com-google-protobuf-Any" class="headerlink" title="使用com.google.protobuf.Any"></a>使用com.google.protobuf.Any</h1><p>Any可以携带任意类型的数据，用法相当于c语言的void指针。在项目中是很常用的，但是谷歌在javalite的版本不支持Any。</p>
<p>如果在proto文件中使用了Any的话生成java代码就会有报错，例如将helloworld的proto文件改成下面的样子:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright 2015, Google Inc.</span></span><br><span class="line"><span class="comment">// All rights reserved.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Redistribution and use in source and binary forms, with or without</span></span><br><span class="line"><span class="comment">// modification, are permitted provided that the following conditions are</span></span><br><span class="line"><span class="comment">// met:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//     * Redistributions of source code must retain the above copyright</span></span><br><span class="line"><span class="comment">// notice, this list of conditions and the following disclaimer.</span></span><br><span class="line"><span class="comment">//     * Redistributions in binary form must reproduce the above</span></span><br><span class="line"><span class="comment">// copyright notice, this list of conditions and the following disclaimer</span></span><br><span class="line"><span class="comment">// in the documentation and/or other materials provided with the</span></span><br><span class="line"><span class="comment">// distribution.</span></span><br><span class="line"><span class="comment">//     * Neither the name of Google Inc. nor the names of its</span></span><br><span class="line"><span class="comment">// contributors may be used to endorse or promote products derived from</span></span><br><span class="line"><span class="comment">// this software without specific prior written permission.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span></span><br><span class="line"><span class="comment">// "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span></span><br><span class="line"><span class="comment">// LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span></span><br><span class="line"><span class="comment">// A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span></span><br><span class="line"><span class="comment">// OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span></span><br><span class="line"><span class="comment">// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span></span><br><span class="line"><span class="comment">// LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span></span><br><span class="line"><span class="comment">// DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span></span><br><span class="line"><span class="comment">// THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span></span><br><span class="line"><span class="comment">// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span></span><br><span class="line"><span class="comment">// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span></span><br><span class="line"></span><br><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"></span><br><span class="line">option java_multiple_files = <span class="literal">true</span>;</span><br><span class="line">option java_package = <span class="string">"io.grpc.examples.helloworld"</span>;</span><br><span class="line">option java_outer_classname = <span class="string">"HelloWorldProto"</span>;</span><br><span class="line">option objc_class_prefix = <span class="string">"HLW"</span>;</span><br><span class="line"></span><br><span class="line">package helloworld;</span><br><span class="line"></span><br><span class="line">import <span class="string">"google/protobuf/any.proto"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The greeting service definition.</span></span><br><span class="line">service Greeter &#123;</span><br><span class="line">  <span class="comment">// Sends a greeting</span></span><br><span class="line">  <span class="function">rpc <span class="title">SayHello</span> <span class="params">(google.protobuf.Any)</span> <span class="title">returns</span> <span class="params">(HelloReply)</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The request message containing the user's name.</span></span><br><span class="line">message HelloRequest &#123;</span><br><span class="line">  <span class="built_in">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The response message containing the greetings</span></span><br><span class="line">message HelloReply &#123;</span><br><span class="line">  <span class="built_in">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>报错如下</p>
<blockquote>
<p>google/protobuf/any.proto: File not found.<br>  helloworld.proto: Import “google/protobuf/any.proto” was not found or had errors.<br>  helloworld.proto:44:17: “google.protobuf.Any” is not defined.</p>
</blockquote>
<h3 id="u4F7F_u7528grpc-jave_u4EE3_u66FFgrpc-javalite"><a href="#u4F7F_u7528grpc-jave_u4EE3_u66FFgrpc-javalite" class="headerlink" title="使用grpc-jave代替grpc-javalite"></a>使用grpc-jave代替grpc-javalite</h3><p>但是现在做的这个项目的linux端实现已经用了Any，要改的话需要耗费比较大的精力。幸好尝试了下，发现安卓上也能跑支持Any的grpc-java。</p>
<p>首先我们要使用grpc-protobuf依赖替换grpc-protobuf-lite依赖</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'io.grpc:grpc-netty:1.1.2'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'io.grpc:grpc-protobuf:1.1.2'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'io.grpc:grpc-stub:1.1.2'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'javax.annotation:javax.annotation-api:1.2'</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着修改protobuf-gradle-plugin配置使得自动生成java的代码而不是javalite的代码</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">protobuf &#123;</span><br><span class="line">    protoc &#123;</span><br><span class="line">        artifact = <span class="string">'com.google.protobuf:protoc:3.0.0'</span></span><br><span class="line">    &#125;</span><br><span class="line">    plugins &#123;</span><br><span class="line">        grpc &#123;</span><br><span class="line">            artifact = <span class="string">'io.grpc:protoc-gen-grpc-java:1.0.0'</span> // CURRENT_GRPC_VERSION</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    generateProtoTasks &#123;</span><br><span class="line">        all().each &#123; task -&gt;</span><br><span class="line">            task.builtins &#123;</span><br><span class="line">                java &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">            task.plugins &#123;</span><br><span class="line">                grpc &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应的修改helloworld的代码就能运行了</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">AppCompatActivity</span> &#123;</span></span><br><span class="line">    <span class="keyword">private</span> static <span class="keyword">final</span> <span class="type">String</span> <span class="type">TAG</span> = <span class="string">"GrpcDemo"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> static <span class="keyword">final</span> int <span class="type">PROT</span> = <span class="number">55055</span>;</span><br><span class="line">    <span class="keyword">private</span> static <span class="keyword">final</span> <span class="type">String</span> <span class="type">NAME</span> = <span class="string">"linjw"</span>;</span><br><span class="line">    <span class="keyword">private</span> static <span class="keyword">final</span> <span class="type">String</span> <span class="type">HOST</span> = <span class="string">"localhost"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void onCreate(<span class="type">Bundle</span> savedInstanceState) &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(<span class="type">R</span>.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        startServer(<span class="type">PROT</span>);</span><br><span class="line">        startClient(<span class="type">HOST</span>, <span class="type">PROT</span>, <span class="type">NAME</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> void startServer(int port)&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Server</span> server = <span class="type">ServerBuilder</span>.forPort(port)</span><br><span class="line">                    .addService(<span class="keyword">new</span> <span class="type">GreeterImpl</span>())</span><br><span class="line">                    .build()</span><br><span class="line">                    .start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="type">IOException</span> e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="type">Log</span>.d(<span class="type">TAG</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> void startClient(<span class="type">String</span> host, int port, <span class="type">String</span> name)&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="type">GrpcTask</span>(host, port, name).execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">GreeterImpl</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">GreeterGrpc</span>.<span class="title">GreeterImplBase</span> &#123;</span></span><br><span class="line">        public void sayHello(<span class="type">Any</span> request, <span class="type">StreamObserver</span>&lt;<span class="type">HelloReply</span>&gt; responseObserver) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                responseObserver.onNext(sayHello(request.unpack(<span class="type">HelloRequest</span>.<span class="keyword">class</span>)));</span><br><span class="line">                responseObserver.onCompleted();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="type">InvalidProtocolBufferException</span> e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">HelloReply</span> sayHello(<span class="type">HelloRequest</span> request) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="type">HelloReply</span>.newBuilder()</span><br><span class="line">                    .setMessage(<span class="string">"hello "</span>+ request.getName())</span><br><span class="line">                    .build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">GrpcTask</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">AsyncTask&lt;Void</span>, <span class="title">Void</span>, <span class="title">String&gt;</span> &#123;</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">String</span> mHost;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">String</span> mName;</span><br><span class="line">        <span class="keyword">private</span> int mPort;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">ManagedChannel</span> mChannel;</span><br><span class="line"></span><br><span class="line">        public <span class="type">GrpcTask</span>(<span class="type">String</span> host, int port, <span class="type">String</span> name) &#123;</span><br><span class="line">            <span class="keyword">this</span>.mHost = host;</span><br><span class="line">            <span class="keyword">this</span>.mName = name;</span><br><span class="line">            <span class="keyword">this</span>.mPort = port;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> void onPreExecute() &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="type">String</span> doInBackground(<span class="type">Void</span>... nothing) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mChannel = <span class="type">ManagedChannelBuilder</span>.forAddress(mHost, mPort)</span><br><span class="line">                        .usePlaintext(<span class="literal">true</span>)</span><br><span class="line">                        .build();</span><br><span class="line">                <span class="type">GreeterGrpc</span>.<span class="type">GreeterBlockingStub</span> stub = <span class="type">GreeterGrpc</span>.newBlockingStub(mChannel);</span><br><span class="line">                <span class="type">HelloRequest</span> message = <span class="type">HelloRequest</span>.newBuilder().setName(mName).build();</span><br><span class="line">                <span class="type">HelloReply</span> reply = stub.sayHello(<span class="type">Any</span>.pack(message));</span><br><span class="line">                <span class="keyword">return</span> reply.getMessage();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="type">Exception</span> e) &#123;</span><br><span class="line">                <span class="type">StringWriter</span> sw = <span class="keyword">new</span> <span class="type">StringWriter</span>();</span><br><span class="line">                <span class="type">PrintWriter</span> pw = <span class="keyword">new</span> <span class="type">PrintWriter</span>(sw);</span><br><span class="line">                e.printStackTrace(pw);</span><br><span class="line">                pw.flush();</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"Failed... : "</span> + <span class="type">System</span>.lineSeparator() + sw;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> void onPostExecute(<span class="type">String</span> result) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mChannel.shutdown().awaitTermination(<span class="number">1</span>, <span class="type">TimeUnit</span>.<span class="type">SECONDS</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="type">InterruptedException</span> e) &#123;</span><br><span class="line">                <span class="type">Thread</span>.currentThread().interrupt();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Log</span>.d(<span class="type">TAG</span>, result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完整的demo代码可以点<a href="https://github.com/bluesky466/grpc-android-demo" target="_blank" rel="external">这里</a>在我的github中查看</p>
<h1 id="Android_u65B9_u6CD5_u6570_u4E0D_u80FD_u8D85_u8FC765535_u7684_u95EE_u9898"><a href="#Android_u65B9_u6CD5_u6570_u4E0D_u80FD_u8D85_u8FC765535_u7684_u95EE_u9898" class="headerlink" title="Android方法数不能超过65535的问题"></a>Android方法数不能超过65535的问题</h1><p>最后使用grpc，方法数会超过65535，可以使用com.android.support:multidex去解决</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/grpc/">grpc</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/技术相关/">技术相关</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-责任链模式" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/11/18/责任链模式/" class="article-date">
  	<time datetime="2016-11-17T18:01:31.000Z" itemprop="datePublished">2016-11-18</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/18/责任链模式/">责任链模式</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="u4EC0_u4E48_u662F_u8D23_u4EFB_u94FE_u6A21_u5F0F"><a href="#u4EC0_u4E48_u662F_u8D23_u4EFB_u94FE_u6A21_u5F0F" class="headerlink" title="什么是责任链模式"></a>什么是责任链模式</h1><p>责任链模式是一种对象的行为模式，它包含了一些命令对象和一系列的处理对象。是一种链型的结构，每个处理对象可以处理特定的命令对象，当遇到不能处理的命令对象的时候，就会把它传递给下一个处理对象，直到没有最后一个处理对象。</p>
<img src="/责任链模式/链式结构.png">
<h1 id="u8D23_u4EFB_u94FE_u6A21_u5F0F_u7684_u5B9E_u73B0"><a href="#u8D23_u4EFB_u94FE_u6A21_u5F0F_u7684_u5B9E_u73B0" class="headerlink" title="责任链模式的实现"></a>责任链模式的实现</h1><p>从责任链模式的定义来看，使用单链表去实现它是一种最容易想到和最形象的做法。假设我们有一个解压程序，它可以解压多种不同的压缩格式。</p>
<p>数据定义成下面的样子:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> Data&#123;</span><br><span class="line">    Data(<span class="keyword">unsigned</span> <span class="keyword">char</span>* data, <span class="keyword">int</span> size) :data(data), size(size) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>* data;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>每个解压器类根据自己是否能够解压接收到的数据，判断应该直接解压数据还是传递给下一个解压器程序去解压。所以将这一逻辑抽象出来，我们可以得到下面的抽象基类:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Decompressor&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Decompressor() : mSuccessor(<span class="number">0</span>)&#123;&#125;</span><br><span class="line">    Decompressor(<span class="keyword">const</span> Decompressor* successor) : mSuccessor(successor)&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSuccessor</span><span class="params">(<span class="keyword">const</span> Decompressor* successor)</span></span>&#123;</span><br><span class="line">        mSuccessor = successor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Data <span class="title">decompress</span><span class="params">(<span class="keyword">const</span> Data&amp; data)</span> <span class="keyword">const</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(canDecompress(data))&#123;</span><br><span class="line">            <span class="keyword">return</span> doDecompress(data);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(mSuccessor!=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> mSuccessor-&gt;decompress(data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Data(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">const</span> Decompressor* mSuccessor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">canDecompress</span><span class="params">(<span class="keyword">const</span> Data&amp; data)</span><span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Data <span class="title">doDecompress</span><span class="params">(<span class="keyword">const</span> Data&amp; data)</span><span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们模拟三种数据的解压器:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> GZipDecompressor : <span class="keyword">public</span> Decompressor&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    GZipDecompressor() &#123; &#125;</span><br><span class="line">    GZipDecompressor(Decompressor* successor):Decompressor(successor) &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">canDecompress</span><span class="params">(<span class="keyword">const</span> Data&amp; data)</span><span class="keyword">const</span></span>&#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"GZipDecompressor:canDecompress"</span>&lt;&lt;endl;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* d = (<span class="keyword">const</span> <span class="keyword">char</span>*)data.data;</span><br><span class="line">        <span class="keyword">return</span> d &amp;&amp; <span class="number">0</span>==<span class="built_in">strncmp</span>(d, <span class="string">"gzip"</span>, <span class="built_in">strlen</span>(<span class="string">"gzip"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Data <span class="title">doDecompress</span><span class="params">(<span class="keyword">const</span> Data&amp; data)</span><span class="keyword">const</span></span>&#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"GZipDecompressor:doDecompress"</span>&lt;&lt;endl;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* d = <span class="string">"doDecompress by GZipDecompressor"</span>;</span><br><span class="line">        <span class="keyword">return</span> Data((<span class="keyword">unsigned</span> <span class="keyword">char</span>*)d, <span class="built_in">strlen</span>(d));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> RarDecompressor : <span class="keyword">public</span> Decompressor&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    RarDecompressor() &#123; &#125;</span><br><span class="line">    RarDecompressor(Decompressor* successor):Decompressor(successor) &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">canDecompress</span><span class="params">(<span class="keyword">const</span> Data&amp; data)</span><span class="keyword">const</span></span>&#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"RarDecompressor:canDecompress"</span>&lt;&lt;endl;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* d = (<span class="keyword">const</span> <span class="keyword">char</span>*)data.data;</span><br><span class="line">        <span class="keyword">return</span> d &amp;&amp; <span class="number">0</span>==<span class="built_in">strncmp</span>(d, <span class="string">"rar"</span>, <span class="built_in">strlen</span>(<span class="string">"rar"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Data <span class="title">doDecompress</span><span class="params">(<span class="keyword">const</span> Data&amp; data)</span><span class="keyword">const</span></span>&#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"RarDecompressor:doDecompress"</span>&lt;&lt;endl;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* d = <span class="string">"doDecompress by RarDecompressor"</span>;</span><br><span class="line">        <span class="keyword">return</span> Data((<span class="keyword">unsigned</span> <span class="keyword">char</span>*)d, <span class="built_in">strlen</span>(d));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> ZipDecompressor : <span class="keyword">public</span> Decompressor&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ZipDecompressor() &#123; &#125;</span><br><span class="line">    ZipDecompressor(Decompressor* successor):Decompressor(successor) &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">canDecompress</span><span class="params">(<span class="keyword">const</span> Data&amp; data)</span><span class="keyword">const</span></span>&#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"ZipDecompressor:canDecompress"</span>&lt;&lt;endl;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* d = (<span class="keyword">const</span> <span class="keyword">char</span>*)data.data;</span><br><span class="line">        <span class="keyword">return</span> d &amp;&amp; <span class="number">0</span>==<span class="built_in">strncmp</span>(d, <span class="string">"zip"</span>, <span class="built_in">strlen</span>(<span class="string">"zip"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Data <span class="title">doDecompress</span><span class="params">(<span class="keyword">const</span> Data&amp; data)</span><span class="keyword">const</span></span>&#123;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;<span class="string">"ZipDecompressor:doDecompress"</span>&lt;&lt;endl;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* d = <span class="string">"doDecompress by ZipDecompressor"</span>;</span><br><span class="line">        <span class="keyword">return</span> Data((<span class="keyword">unsigned</span> <span class="keyword">char</span>*)d, <span class="built_in">strlen</span>(d));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>嗯哼，是否直观的实现方式。最后是main函数和输出结果:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">int main()&#123;</span><br><span class="line">    RarDecompressor rarDecompressor;</span><br><span class="line">    GZipDecompressor gzipDecompressor(&amp;rarDecompressor);</span><br><span class="line">    ZipDecompressor zipDecompressor(&amp;gzipDecompressor);</span><br><span class="line"></span><br><span class="line">    Data input((unsigned char*)"gzip",strlen("gzip"));</span><br><span class="line">    Data output = zipDecompressor.decompress(input);</span><br><span class="line"></span><br><span class="line">    if(output.data)&#123;</span><br><span class="line">        const char* out = (const char*)output.data;</span><br><span class="line">        cout&lt;&lt;"result : "&lt;&lt;out&lt;&lt;endl;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        cout&lt;&lt;"result : null"&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ZipDecompressor:canDecompress<br>GZipDecompressor:canDecompress<br>GZipDecompressor:doDecompress<br>result : doDecompress by GZipDecompressor</p>
</blockquote>
<p>可以看到，数据经过了ZipDecompressor和GZipDecompressor，最后由GZipDecompressor解压处理，整个过程没有经过RarDecompressor</p>
<p>当然为了使代码可维护性更高，我们可以再编写一个SuperDecompressor类来包装解压操作:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> SuperDecompressor&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">Data <span class="title">decompressCompressedFile</span><span class="params">(<span class="keyword">const</span> Data&amp; data)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ZipDecompressor mZipDecompressor;</span><br><span class="line">    RarDecompressor mRarDecompressor;</span><br><span class="line">    GZipDecompressor mGZipDecompressor;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Data SuperDecompressor::decompressCompressedFile(<span class="keyword">const</span> Data&amp; data)&#123;</span><br><span class="line">    mZipDecompressor.setSuccessor(&amp;mGZipDecompressor);</span><br><span class="line">    mGZipDecompressor.setSuccessor(&amp;mRarDecompressor);</span><br><span class="line">    mRarDecompressor.setSuccessor(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mZipDecompressor.decompress(data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个时候main函数会显得比较简单:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">int main()&#123;</span><br><span class="line">    SuperDecompressor decompressor;</span><br><span class="line"></span><br><span class="line">    Data input((unsigned char*)"gzip",strlen("gzip"));</span><br><span class="line">    Data output = decompressor.decompressCompressedFile(input);</span><br><span class="line"></span><br><span class="line">    if(output.data)&#123;</span><br><span class="line">        const char* out = (const char*)output.data;</span><br><span class="line">        cout&lt;&lt;"result : "&lt;&lt;out&lt;&lt;endl;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        cout&lt;&lt;"result : null"&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出的结果是一样的:</p>
<blockquote>
<p>ZipDecompressor:canDecompress<br>GZipDecompressor:canDecompress<br>GZipDecompressor:doDecompress<br>result : doDecompress by GZipDecompressor</p>
</blockquote>
<h1 id="u4F18_u5316"><a href="#u4F18_u5316" class="headerlink" title="优化"></a>优化</h1><p>依靠我们程序员的直觉，下面两段代码都是很容易出错的，尤其是当Decompressor的数目很多的时候。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">int main()&#123;</span><br><span class="line">	 //下面的三行代码容易出错</span><br><span class="line">    RarDecompressor rarDecompressor;</span><br><span class="line">    GZipDecompressor gzipDecompressor(&amp;rarDecompressor);</span><br><span class="line">    ZipDecompressor zipDecompressor(&amp;gzipDecompressor);</span><br><span class="line"></span><br><span class="line">    Data input((unsigned char*)"gzip",strlen("gzip"));</span><br><span class="line">    Data output = zipDecompressor.decompress(input);</span><br><span class="line"></span><br><span class="line">    if(output.data)&#123;</span><br><span class="line">        const char* out = (const char*)output.data;</span><br><span class="line">        cout&lt;&lt;"result : "&lt;&lt;out&lt;&lt;endl;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        cout&lt;&lt;"result : null"&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Data SuperDecompressor::decompressCompressedFile(<span class="keyword">const</span> Data&amp; data)&#123;</span><br><span class="line">    mZipDecompressor.setSuccessor(&amp;mGZipDecompressor);</span><br><span class="line">    mGZipDecompressor.setSuccessor(&amp;mRarDecompressor);</span><br><span class="line">    mRarDecompressor.setSuccessor(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mZipDecompressor.decompress(data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实使用构造函数和setter方法设置下一个处理类有一个很大的问题，就是在编码的时候很容易就写错了，会出现一些意想不到的bug，而且比较难发现。同时，每次需要修改处理类的顺序或者删除其中的一个或几个处理类，都需要使用setter方法对处理链进行修改，不仅繁琐，而且也比较容易出错。</p>
<p>基于以上的原因，我们会去想，有没有一种更加灵活的实现方式，使得构建处理链不容易出错，而且也能很简单而且很安全的修改处理链呢？</p>
<p>其实我们可以用下面的链式结构去优化:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Decompressor&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Decompressor() : mSuccessor(<span class="number">0</span>)&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Decompressor&amp; <span class="title">next</span><span class="params">(Decompressor&amp; successor)</span></span>&#123;</span><br><span class="line">        mSuccessor = &amp;successor;</span><br><span class="line">        successor.setSuccessor(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> successor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Data <span class="title">decompress</span><span class="params">(<span class="keyword">const</span> Data&amp; data)</span> <span class="keyword">const</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(canDecompress(data))&#123;</span><br><span class="line">            <span class="keyword">return</span> doDecompress(data);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(mSuccessor!=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> mSuccessor-&gt;decompress(data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Data(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">const</span> Decompressor* mSuccessor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">canDecompress</span><span class="params">(<span class="keyword">const</span> Data&amp; data)</span><span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Data <span class="title">doDecompress</span><span class="params">(<span class="keyword">const</span> Data&amp; data)</span><span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSuccessor</span><span class="params">(<span class="keyword">const</span> Decompressor* successor)</span></span>&#123;</span><br><span class="line">        mSuccessor = successor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在这里，我们添加了一个next方法，同时把setSuccessor设为private,于是使用的方法就会变得简洁了许多。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Data SuperDecompressor::decompressCompressedFile(<span class="keyword">const</span> Data&amp; data)&#123;</span><br><span class="line">    mZipDecompressor.next(mGZipDecompressor).next(mRarDecompressor);</span><br><span class="line">    <span class="keyword">return</span> mZipDecompressor.decompress(data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="u53E6_u4E00_u79CD_u7075_u6D3B_u7684_u5B9E_u73B0_u65B9_u5F0F"><a href="#u53E6_u4E00_u79CD_u7075_u6D3B_u7684_u5B9E_u73B0_u65B9_u5F0F" class="headerlink" title="另一种灵活的实现方式"></a>另一种灵活的实现方式</h1><p>联想一下linux的管道机制：<strong>前一个命令的结果会传递给后一个命令</strong>。</p>
<p>是不是可以从中得到启发呢？是不是可以有一种架构可以使得通过下面的形式就能得到最终处理后的结果？</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Data decompressedData = compressedData | mZipDecompressor | mGZipDecompressor | mRarDecompressor;</span><br></pre></td></tr></table></figure>
<p>首先，很容易想到我们需要通过重载操作符去实现这种机制。我们可以重载 “|” 操作符，将Data和Decompressor作为参数传入，再将处理后或者没有处理的Data作为返回值返回，传到下一个Decompressor那里去。</p>
<p>基本的思想是这样的，但是这里有个很重要的问题要处理：我们如何知道上一个Decompressor有没有解压过数据？</p>
<p>当然可以直接调用Decompressor::canDecompress看看是否是可解压的就能知道上一个Decompressor有没有处理过数据。但是这样的处理模式有一些风险，而且也比较浪费资源，明明前一个Decompressor已经解压完成了，但是后面的Decompressor还回去判断是否可以解压，这个判断可能比较复杂。</p>
<p>第二种解决方案就是拓展Data结构体，添加一个是否已经解压字段。这样能够完美的解决问题，但是Data的职责就变重了，他不仅要保存数据，还要知道保存的数据究竟是解压过的还是没有解压过的。而且这个标志字段只有在解压的过程中才有用，因为一般数据在存储的时候我们已经知道它是否被压缩过了，我们总不会会将未解压和解压过的数据混在一起存放的。</p>
<p>其实还有第三种解决方法:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> DataWrapper&#123;</span><br><span class="line">    DataWrapper(<span class="keyword">const</span> Data&amp; data) : data(data),isDecompressed(<span class="literal">false</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    Data data;</span><br><span class="line">    <span class="keyword">bool</span> isDecompressed;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在DataWrapper添加了一个属性isDecompressed来标志数据是否已经解压。这个Wrapper可以只在解压过程中临时使用，不影响数据的存储。</p>
<p>然后实现的重点就是重载操作符了，其实它的实现很简单:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DataWrapper&amp; <span class="keyword">operator</span> | (DataWrapper&amp; data, <span class="keyword">const</span> Decompressor&amp; decompressor)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!data.isDecompressed &amp;&amp; decompressor.canDecompress(data.data))&#123;</span><br><span class="line">        data.data = decompressor.doDecompress(data.data);</span><br><span class="line">        data.isDecompressed = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在Decompressor就只需要提供判断是否可以解压和进行解压的功能。所以我们可以将Decompressor基类简化下面这样。其实这样的Decompressor就相当于java里面的接口了，面向接口编程可以使得业务逻辑更加清晰，而且也更易于维护。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Decompressor&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">canDecompress</span><span class="params">(<span class="keyword">const</span> Data&amp; data)</span><span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Data <span class="title">doDecompress</span><span class="params">(<span class="keyword">const</span> Data&amp; data)</span><span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>所以我们的SuperDecompressor类就可以写成下面的样子:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> SuperDecompressor&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">Data <span class="title">decompressCompressedFile</span><span class="params">(<span class="keyword">const</span> Data&amp; data)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ZipDecompressor mZipDecompressor;</span><br><span class="line">    RarDecompressor mRarDecompressor;</span><br><span class="line">    GZipDecompressor mGZipDecompressor;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Data SuperDecompressor::decompressCompressedFile(<span class="keyword">const</span> Data&amp; data)&#123;</span><br><span class="line">    <span class="function">DataWrapper <span class="title">wrapper</span><span class="params">(data)</span></span>;</span><br><span class="line">    wrapper | mZipDecompressor | mGZipDecompressor | mRarDecompressor;</span><br><span class="line">    <span class="keyword">return</span> wrapper.isDecompressed ? wrapper.data : Data(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而main函数是一样的:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">int main()&#123;</span><br><span class="line">    SuperDecompressor decompressor;</span><br><span class="line"></span><br><span class="line">    Data input((unsigned char*)"gzip",strlen("gzip"));</span><br><span class="line"></span><br><span class="line">    Data output = decompressor.decompressCompressedFile(input);</span><br><span class="line"></span><br><span class="line">    if(output.data)&#123;</span><br><span class="line">        const char* out = (const char*)output.data;</span><br><span class="line">        cout&lt;&lt;"result : "&lt;&lt;out&lt;&lt;endl;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        cout&lt;&lt;"result : null"&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果如下:</p>
<blockquote>
<p>ZipDecompressor:canDecompress<br>GZipDecompressor:canDecompress<br>GZipDecompressor:doDecompress<br>result : doDecompress by GZipDecompressor  </p>
</blockquote>
<p>所以如果我们现在需要将SuperDecompressor拓展成一个真正万能的解压类，不仅能解压压缩文件，也能解压图片，还能解压Base64编码的超级解压类也很简单了:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> SuperDecompressor&#123;</span><br><span class="line">    <span class="function">Data <span class="title">decompressUnknowType</span><span class="params">(<span class="keyword">const</span> Data&amp; data)</span></span>;</span><br><span class="line">    <span class="function">Data <span class="title">decompressImage</span><span class="params">(<span class="keyword">const</span> Data&amp; data)</span></span>;</span><br><span class="line">    <span class="function">Data <span class="title">decompressCompressedFile</span><span class="params">(<span class="keyword">const</span> Data&amp; data)</span></span>;</span><br><span class="line">    <span class="function">Data <span class="title">decompressBase64</span><span class="params">(<span class="keyword">const</span> Data&amp; data)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ZipDecompressor mZipDecompressor;</span><br><span class="line">    RarDecompressor mRarDecompressor;</span><br><span class="line">    GZipDecompressor mGZipDecompressor;</span><br><span class="line"></span><br><span class="line">    JpgDecompressor mJpgDecompressor;</span><br><span class="line">    PngDecompressor mPngDecompressor;</span><br><span class="line"></span><br><span class="line">    Base64Decompressor mBase64Decompressor;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Data SuperDecompressor::decompressUnknowType(<span class="keyword">const</span> Data&amp; data)&#123;</span><br><span class="line">    <span class="function">DataWrapper <span class="title">wrapper</span><span class="params">(data)</span></span>;</span><br><span class="line">    wrapper | mZipDecompressor | mRarDecompressor | mGZipDecompressor</span><br><span class="line">            | mJpgDecompressor | mPngDecompressor</span><br><span class="line">            | mBase64Decompressor;</span><br><span class="line">    <span class="keyword">return</span> wrapper.isDecompressed ? wrapper.data : Data(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Data SuperDecompressor::decompressImage(<span class="keyword">const</span> Data&amp; data)&#123;</span><br><span class="line">    <span class="function">DataWrapper <span class="title">wrapper</span><span class="params">(data)</span></span>;</span><br><span class="line">    wrapper | mJpgDecompressor | mPngDecompressor;</span><br><span class="line">    <span class="keyword">return</span> wrapper.isDecompressed ? wrapper.data : Data(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Data SuperDecompressor::decompressCompressedFile(<span class="keyword">const</span> Data&amp; data)&#123;</span><br><span class="line">    <span class="function">DataWrapper <span class="title">wrapper</span><span class="params">(data)</span></span>;</span><br><span class="line">    wrapper | mZipDecompressor | mRarDecompressor | mGZipDecompressor;</span><br><span class="line">    <span class="keyword">return</span> wrapper.isDecompressed ? wrapper.data : Data(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Data SuperDecompressor::decompressBase64(<span class="keyword">const</span> Data&amp; data)&#123;</span><br><span class="line">    <span class="function">DataWrapper <span class="title">wrapper</span><span class="params">(data)</span></span>;</span><br><span class="line">    wrapper | mBase64Decompressor;</span><br><span class="line">    <span class="keyword">return</span> wrapper.isDecompressed ? wrapper.data : Data(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然，这种处理方式在数据已经被解压的情况下依然会传给下一个解压器，直到经过了整条处理链。所以会造成一定的资源浪费。</p>
<h1 id="u8D23_u4EFB_u94FE_u6A21_u5F0F_u7684_u5B9E_u9645_u5E94_u7528_u573A_u666F"><a href="#u8D23_u4EFB_u94FE_u6A21_u5F0F_u7684_u5B9E_u9645_u5E94_u7528_u573A_u666F" class="headerlink" title="责任链模式的实际应用场景"></a>责任链模式的实际应用场景</h1><p>责任链模式的实际应用，最广为人知的就是安卓View的Touch事件的传递机制了。其实这是一种双向的责任链模式。在接收到Touch事件的时候，父View会通知子View，如果子View不处理，父View才去处理。光说可能有点难懂，我们直接看源码吧:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;             <span class="comment">// 默认状态为没有消费过</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!onInterceptTouchEvent(ev)) &#123;   <span class="comment">// 如果没有拦截交给子View</span></span><br><span class="line">        result = child.dispatchTouchEvent(ev);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!result) &#123;                      <span class="comment">// 如果事件没有被消费,询问自身onTouchEvent</span></span><br><span class="line">        result = onTouchEvent(ev);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码看起来也不好懂？没关系，我用个实际的例子解释一下就明白了。首先我们有下面的一个Activity:</p>
<img src="/责任链模式/Touch事件传递机制例子.png">
<p>当我们点击最中间的那个View的时候Touch事件的传递过程如下图:</p>
<img src="/责任链模式/Touch事件传递过程.png">
<p>Touch事件通过Activity、ViewGroup1、ViewGroup2的dispatchTouchEvent方法最后到达View的dispatchTouchEvent方法，在View被处理，所以返回true。于是Activity、ViewGroup1、ViewGroup2的dispatchTouchEvent方法都会直接返回，而不会调用处理方法onTouchEvent</p>
<h1 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h1><p>这一部分本来应该讲一讲责任链模式的优缺点的，但是我自己其实不太喜欢这样的总结性的东西。所以还是留给读者自己体会吧。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/技术相关/">技术相关</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/设计模式/">设计模式</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-lua面向对象编程" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/11/16/lua面向对象编程/" class="article-date">
  	<time datetime="2016-11-15T16:43:45.000Z" itemprop="datePublished">2016-11-16</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/16/lua面向对象编程/">lua面向对象编程</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>lua也支持面向对象编程的,嗯对,就是用table和元表。lua可以在某种程度上实现面向对象的封装、继承和多态三大基本特性。</p>
<h2 id="u5C01_u88C5"><a href="#u5C01_u88C5" class="headerlink" title="封装"></a>封装</h2><p>lua实现封装的最简单方法就是将属性和方法放到table之中。首先我们声明一个类table,用来定义一些该类的类方法，其中的new方法就类似其他面向对象语言的new关键字,用来创建一个新的实例出来。同时为了模块化，将它放在一个单独的Position.lua文件中:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> Position = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Position.new</span><span class="params">(x,y)</span></span></span><br><span class="line">	<span class="keyword">local</span> instance = &#123;x=x, y=y&#125;</span><br><span class="line">	<span class="keyword">return</span> instance</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Position.getLength</span><span class="params">(instance)</span></span></span><br><span class="line">	<span class="keyword">return</span> (instance.x^<span class="number">2</span>+instance.y^<span class="number">2</span>)^<span class="number">0.5</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> Position</span><br></pre></td></tr></table></figure>
<p>这样就可以这样使用它:<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> Position = <span class="built_in">require</span>(<span class="string">"Position"</span>)</span><br><span class="line"><span class="keyword">local</span> pos1 = Position.new(<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(Position.getLength(pos1))</span><br></pre></td></tr></table></figure></p>
<p>输出如下:</p>
<blockquote>
<p>1.4142135623731</p>
</blockquote>
<p>看看这个方法的定义:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Position.getLength</span><span class="params">(instance)</span></span></span><br><span class="line">	<span class="keyword">return</span> (instance.x^<span class="number">2</span>+instance.y^<span class="number">2</span>)^<span class="number">0.5</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>它其实是一种语法糖,上面的写法和下面的写法是一样的</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Position.getLength = <span class="function"><span class="keyword">function</span><span class="params">(instance)</span></span></span><br><span class="line">	<span class="keyword">return</span> (instance.x^<span class="number">2</span>+instance.y^<span class="number">2</span>)^<span class="number">0.5</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>但是这样的写法是不是感觉很奇怪,和一般的面向对象的写法和用法都不一样？我们可以把Position.lua改成下面的这个样子:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> Position = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Position.new</span><span class="params">(x,y)</span></span></span><br><span class="line">	<span class="keyword">local</span> instance = &#123;x=x, y=y&#125;</span><br><span class="line">	<span class="built_in">setmetatable</span>(instance, &#123;__index=Position&#125;)</span><br><span class="line">	<span class="keyword">return</span> instance</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Position.getLength</span><span class="params">(instance)</span></span></span><br><span class="line">	<span class="keyword">return</span> (instance.x^<span class="number">2</span>+instance.y^<span class="number">2</span>)^<span class="number">0.5</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> Position</span><br></pre></td></tr></table></figure>
<p>于是用法就有点接近我们熟悉的面向对象语法了</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> Position = <span class="built_in">require</span>(<span class="string">"Position"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> pos1 = Position.new(<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(pos1.getLength(pos1))</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> pos2 = Position.new(<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(pos2.getLength(pos2))</span><br></pre></td></tr></table></figure>
<p>输出如下:</p>
<blockquote>
<p>1.4142135623731<br>5</p>
</blockquote>
<p>但是每次调用类方法都需要把实例显示的当作参数传入,这样既麻烦又容易出错。有没有办法让lua解释器自动传入类实例呢？答案当然是有的,这就要看另一种语法糖了:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> Position = <span class="built_in">require</span>(<span class="string">"Position"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> pos1 = Position.new(<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(pos1:getLength())</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> pos2 = Position.new(<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(pos2:getLength())</span><br></pre></td></tr></table></figure>
<p>对的，下面的两种写法是等价的:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pos1.getLength(pos1)</span><br><span class="line">pos1:getLength()</span><br></pre></td></tr></table></figure>
<p>类似的,在Position.lua中也能这么写：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> Position = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Position.new</span><span class="params">(x,y)</span></span></span><br><span class="line">	<span class="keyword">local</span> instance = &#123;x=x, y=y&#125;</span><br><span class="line">	<span class="built_in">setmetatable</span>(instance, &#123;__index=Position&#125;)</span><br><span class="line">	<span class="keyword">return</span> instance</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Position:getLength</span><span class="params">()</span></span></span><br><span class="line">	<span class="keyword">return</span> (self.x^<span class="number">2</span>+self.y^<span class="number">2</span>)^<span class="number">0.5</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> Position</span><br></pre></td></tr></table></figure>
<p>下面两种写法也是等价的:<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Position.getLength</span><span class="params">(self)</span></span></span><br><span class="line">	<span class="keyword">return</span> (self.x^<span class="number">2</span>+self.y^<span class="number">2</span>)^<span class="number">0.5</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Position:getLength</span><span class="params">()</span></span></span><br><span class="line">	<span class="keyword">return</span> (self.x^<span class="number">2</span>+self.y^<span class="number">2</span>)^<span class="number">0.5</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>这里的self就相当于c++的this</p>
<p>我们还可以把new方法抽象出来,作为公共方法,而不用为每个类都写一个new方法:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- function.lua</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">class</span><span class="params">(className)</span></span></span><br><span class="line">	<span class="keyword">local</span> cls = &#123;&#125;</span><br><span class="line">	cls.__cname = className</span><br><span class="line">	cls.new = <span class="function"><span class="keyword">function</span><span class="params">(...)</span></span></span><br><span class="line">		<span class="keyword">local</span> instance = &#123;&#125;</span><br><span class="line">		<span class="built_in">setmetatable</span>(instance, &#123;__index=cls&#125;)</span><br><span class="line">		<span class="keyword">if</span> cls.ctor <span class="keyword">then</span> cls:ctor(...) <span class="keyword">end</span></span><br><span class="line">		<span class="keyword">return</span> instance</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">return</span> cls</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这个new方法将类名保存了下来,方便运行时获取类的类型,同时如果这个类有定义构造函数(ctor)的话,它还会自动的调用类的构造函数。</p>
<p>这个时候类的定义就可以变成下面这个样子了:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Position.lua</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> Position = class(<span class="string">"Position"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Position:ctor</span><span class="params">(x,y)</span></span></span><br><span class="line">	self.x = x</span><br><span class="line">	self.y = y</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Position:getLength</span><span class="params">()</span></span></span><br><span class="line">	<span class="keyword">return</span> (self.x^<span class="number">2</span>+self.y^<span class="number">2</span>)^<span class="number">0.5</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> Position</span><br></pre></td></tr></table></figure>
<p>已经和一般的面向对象语言很接近了。当然,这个class方法我们必须在程序的一开始就加载进来作为全局方法使用。我们来看看main.lua是怎么使用它们的吧:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">"function"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> Position = <span class="built_in">require</span>(<span class="string">"Position"</span>)</span><br><span class="line"><span class="built_in">print</span>(Position.__cname)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> pos1 = Position.new(<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(pos1:getLength())</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> pos2 = Position.new(<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(pos2:getLength())</span><br></pre></td></tr></table></figure>
<p>输出如下:</p>
<blockquote>
<p>Position<br>1.4142135623731<br>5</p>
</blockquote>
<h2 id="u7EE7_u627F_u4E0E_u591A_u6001"><a href="#u7EE7_u627F_u4E0E_u591A_u6001" class="headerlink" title="继承与多态"></a>继承与多态</h2><p>lua的继承机制在上一篇博客《lua元表》中已经有提到了一些,原理就是使用元表机制,将子类元表的__index字段设置为父类。所以我们可以这样拓展我们的new方法:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- function.lua</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">class</span><span class="params">(className, super)</span></span></span><br><span class="line">	<span class="keyword">local</span> cls = &#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> super <span class="keyword">then</span> </span><br><span class="line">		cls.super = super</span><br><span class="line">		<span class="built_in">setmetatable</span>(cls, &#123;__index=super&#125;)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	</span><br><span class="line">	cls.__cname = className</span><br><span class="line"></span><br><span class="line">	cls.new = <span class="function"><span class="keyword">function</span><span class="params">(...)</span></span></span><br><span class="line">		<span class="keyword">local</span> instance = &#123;&#125;</span><br><span class="line">		<span class="built_in">setmetatable</span>(instance, &#123;__index=cls&#125;)</span><br><span class="line">		<span class="keyword">if</span> cls.ctor <span class="keyword">then</span> cls:ctor(...) <span class="keyword">end</span></span><br><span class="line">		<span class="keyword">return</span> instance</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> cls</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>这里我们将父类保存到子类的元表的__index字段中,同时为类添加了super字段用于保存父类</p>
<p>于是基于new方法,我们可以定义Position的子类Position3D:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Position3D.lua</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> Position3D = class(<span class="string">"Position3D"</span>, <span class="built_in">require</span>(<span class="string">"Position"</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Position3D:ctor</span><span class="params">(x,y,z)</span></span></span><br><span class="line">	self.super:ctor(x, y)</span><br><span class="line">	self.z = z</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Position3D:getLength</span><span class="params">()</span></span></span><br><span class="line">	<span class="keyword">return</span> (self.x^<span class="number">2</span>+self.y^<span class="number">2</span>+self.z^<span class="number">2</span>)^<span class="number">0.5</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> Position3D</span><br></pre></td></tr></table></figure>
<p>子类Position3D重写了Position的ctor方法和getLength方法。如果需要用父类的被重写的方法,就要用super字段显示调用,就如ctor方法中做的一样。</p>
<p>来看看main.lua吧：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">"function"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> Position3D = <span class="built_in">require</span>(<span class="string">"Position3D"</span>)</span><br><span class="line"><span class="built_in">print</span>(Position3D.__cname)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> pos1 = Position3D.new(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(pos1:getLength())</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> pos2 = Position3D.new(<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line"><span class="built_in">print</span>(pos2:getLength())</span><br></pre></td></tr></table></figure>
<p>输出如下:</p>
<blockquote>
<p>Position3D<br>1.7320508075689<br>7.0710678118655</p>
</blockquote>
<h2 id="u591A_u7EE7_u627F"><a href="#u591A_u7EE7_u627F" class="headerlink" title="多继承"></a>多继承</h2><p>lua同样可以实现多继承。由于一个多继承的子类有多个父类,所以我们不能简单的把父类设为元表的__index属性。但是我们可以将该类的父类保存在一个table里面,然后用一个函数去搜索父类的方法。这时,只有将这个函数赋值个于元表的__index就好了。</p>
<p>于是我们可以将class函数拓展成下面的样子</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">class</span><span class="params">(className, ...)</span></span></span><br><span class="line">	<span class="keyword">local</span> cls = &#123;__cname = className&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> supers = &#123;...&#125;</span><br><span class="line">	<span class="keyword">for</span> i,super <span class="keyword">in</span> <span class="built_in">ipairs</span>(supers) <span class="keyword">do</span></span><br><span class="line">        cls.__supers = cls.__supers <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">        <span class="built_in">table</span>.insert(cls.__supers, super)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> cls.super==<span class="keyword">nil</span> <span class="keyword">then</span></span><br><span class="line">            cls.super=super</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> cls.__supers==<span class="keyword">nil</span> <span class="keyword">or</span>  #cls.__supers==<span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">setmetatable</span>(cls, &#123;__index=cls.super&#125;)</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">local</span> index = <span class="function"><span class="keyword">function</span><span class="params">(t,k)</span></span></span><br><span class="line">			<span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(cls.__supers) <span class="keyword">do</span></span><br><span class="line">				<span class="keyword">if</span> v[k] <span class="keyword">then</span> <span class="keyword">return</span> v[k] <span class="keyword">end</span></span><br><span class="line">			<span class="keyword">end</span></span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">        <span class="built_in">setmetatable</span>(cls, &#123;__index=index&#125;)</span><br><span class="line">	<span class="keyword">end</span>	</span><br><span class="line"></span><br><span class="line">	cls.new = <span class="function"><span class="keyword">function</span><span class="params">(...)</span></span></span><br><span class="line">	    <span class="keyword">local</span> instance = &#123;&#125;</span><br><span class="line">		<span class="built_in">setmetatable</span>(instance, &#123;__index=cls&#125;)</span><br><span class="line">		<span class="keyword">if</span> cls.ctor <span class="keyword">then</span> cls:ctor(...) <span class="keyword">end</span></span><br><span class="line">		<span class="keyword">return</span> instance</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cls</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>之后我们就能这样去使用多继承机制了:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--ClassA.lua</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> ClassA = class(<span class="string">"ClassA"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ClassA:ctor</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ClassA:methodA</span><span class="params">()</span></span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">"ClassA:methodA"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ClassA</span><br></pre></td></tr></table></figure>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--ClassB.lua</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> ClassB = class(<span class="string">"ClassB"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ClassB:ctor</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ClassB:methodB</span><span class="params">()</span></span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">"ClassB:methodB"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ClassB</span><br></pre></td></tr></table></figure>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--ClassC.lua</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> ClassC = class(<span class="string">"ClassC"</span>, <span class="built_in">require</span>(<span class="string">"ClassA"</span>), <span class="built_in">require</span>(<span class="string">"ClassB"</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ClassC:ctor</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ClassC</span><br></pre></td></tr></table></figure>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--main.lua</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">"function"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> c = <span class="built_in">require</span>(<span class="string">"ClassC"</span>).new()</span><br><span class="line">c:methodA()</span><br><span class="line">c:methodB()</span><br></pre></td></tr></table></figure>
<p>执行结果如下:</p>
<blockquote>
<p>ClassA:methodA<br>ClassB:methodB</p>
</blockquote>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lua/">lua</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/技术相关/">技术相关</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-lua元表" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/10/28/lua元表/" class="article-date">
  	<time datetime="2016-10-28T14:45:37.000Z" itemprop="datePublished">2016-10-28</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/28/lua元表/">lua元表</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="u5143_u8868_u662F_u4EC0_u4E48_uFF1F"><a href="#u5143_u8868_u662F_u4EC0_u4E48_uFF1F" class="headerlink" title="元表是什么？"></a>元表是什么？</h2><p>在lua中,每个值都有一套预定义的操作集合。例如数字可以相加、比较、字符串可以连接,lua将这些操作的定义放在了元表中去描述。lua中的每个值都有一个元表。table和userdata可以有各自独立的元表,而其他类型则共享其类型所属的统一元表。(书上是这么说的，但是我用getmetatable方法只能获取到字符串的元表)lua在创建table的时候不会为它创建元表,所以,table没有加的操作,我们就可以通过给table设置我们自己写的元表,为table定义一套自定义的加的操作。</p>
<h2 id="u5982_u4F55_u83B7_u53D6_u5143_u8868_3F"><a href="#u5982_u4F55_u83B7_u53D6_u5143_u8868_3F" class="headerlink" title="如何获取元表?"></a>如何获取元表?</h2><p>lua中通过getmetatable获取值得元表:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">"str 1 : "</span>..<span class="built_in">tostring</span>( <span class="built_in">getmetatable</span>(<span class="string">"str1"</span>)) )</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"str 2 : "</span>..<span class="built_in">tostring</span>( <span class="built_in">getmetatable</span>(<span class="string">"str1"</span>)) )</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"nil : "</span>..<span class="built_in">tostring</span>( <span class="built_in">getmetatable</span>(<span class="keyword">nil</span>)) )</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"number : "</span>..<span class="built_in">tostring</span>( <span class="built_in">getmetatable</span>(<span class="number">1</span>)) )</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"function : "</span>..<span class="built_in">tostring</span>( <span class="built_in">getmetatable</span>(<span class="function"><span class="keyword">function</span><span class="params">()</span></span><span class="keyword">end</span>)) )</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"table : "</span>..<span class="built_in">tostring</span>( <span class="built_in">getmetatable</span>(&#123;&#125;)) )</span><br></pre></td></tr></table></figure>
<blockquote>
<p>str 1 : table: 009D9798<br>str 2 : table: 009D9798<br>nil : nilw<br>number : nil<br>function : nil<br>table : nil</p>
</blockquote>
<p>可以看到不同的字符串用的是同一个元表,而除了字符串之外其他的值的元表都是nil。这里就是我看到和书上不一样的地方，书上说每个值都有一个元表。不过这只是一个小疑点，并不影响我们对元表的理解。</p>
<p>我们看看string的原表到底是个什么东西:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dump</span><span class="params">(t)</span></span></span><br><span class="line">	<span class="keyword">if</span> t==<span class="keyword">nil</span> <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">print</span>(t)</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">print</span>(<span class="string">"&#123;"</span>)</span><br><span class="line">		<span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span></span><br><span class="line">			<span class="built_in">print</span>(<span class="string">"\t"</span>..<span class="built_in">tostring</span>(k)..<span class="string">" = "</span>..<span class="built_in">tostring</span>(v))</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">		<span class="built_in">print</span>(<span class="string">"&#125;"</span>)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">dump(<span class="built_in">getmetatable</span>(<span class="string">"str1"</span>))</span><br></pre></td></tr></table></figure>
<p>输出如下:</p>
<blockquote>
<p>{<br>       __index = table: 00AF9270<br>}</p>
</blockquote>
<p>字符串的元表里面只有一个元素:__index,它也是一个table,我们继续跟踪下看看它到底是什么:<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dump</span><span class="params">(t)</span></span></span><br><span class="line">	<span class="keyword">if</span> t==<span class="keyword">nil</span> <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">print</span>(t)</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">print</span>(<span class="string">"&#123;"</span>)</span><br><span class="line">		<span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span></span><br><span class="line">			<span class="built_in">print</span>(<span class="string">"\t"</span>..<span class="built_in">tostring</span>(k)..<span class="string">" = "</span>..<span class="built_in">tostring</span>(v))</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">		<span class="built_in">print</span>(<span class="string">"&#125;"</span>)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">dump(<span class="built_in">getmetatable</span>(<span class="string">"str1"</span>).__index)</span><br></pre></td></tr></table></figure></p>
<p>输出如下:</p>
<blockquote>
<p>{<br>       sub = function: 00ABABF8<br>       upper = function: 00ABACB8<br>       len = function: 00AB9D00<br>       gfind = function: 00AB9CA0<br>       rep = function: 00ABAD58<br>       find = function: 00AB9E20<br>       match = function: 00ABA9F8<br>       char = function: 00AB9C40<br>       dump = function: 00AB9F20<br>       gmatch = function: 00AB9CA0<br>       reverse = function: 00ABAC38<br>       byte = function: 00AB9CC0<br>       format = function: 00AB9C80<br>       gsub = function: 00AB9CE0<br>       lower = function: 00AB9D40<br>}</p>
</blockquote>
<p>__index这个table定义了字符串的一些基本操作,如获取长度,查找子串等。它们的其实就定义在string这个table里,也就是说所有的字符串的元表的__index都是string:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dump</span><span class="params">(t)</span></span></span><br><span class="line">	<span class="keyword">if</span> t==<span class="keyword">nil</span> <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">print</span>(t)</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">print</span>(<span class="string">"&#123;"</span>)</span><br><span class="line">		<span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span></span><br><span class="line">			<span class="built_in">print</span>(<span class="string">"\t"</span>..<span class="built_in">tostring</span>(k)..<span class="string">" = "</span>..<span class="built_in">tostring</span>(v))</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">		<span class="built_in">print</span>(<span class="string">"&#125;"</span>)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">getmetatable</span>(<span class="string">"str"</span>).__index)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>table: 00C89270<br>table: 00C89270</p>
</blockquote>
<h2 id="u5982_u4F55_u8BBE_u7F6E_u5143_u8868_3F"><a href="#u5982_u4F55_u8BBE_u7F6E_u5143_u8868_3F" class="headerlink" title="如何设置元表?"></a>如何设置元表?</h2><p>在lua中,我们可以用setmetatable(table, metatable)这个方法去设置table的元表:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> t = &#123;&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">getmetatable</span>(t))</span><br><span class="line"><span class="built_in">setmetatable</span>(t,&#123;&#125;)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">getmetatable</span>(t))</span><br></pre></td></tr></table></figure>
<p>输出如下:</p>
<blockquote>
<p>nil<br>table: 0x7feaf1407190</p>
</blockquote>
<p>这样就成功为t设置了一个元表,这个元表是一个空的table。</p>
<h2 id="u5143_u8868_u7684_u4F5C_u7528"><a href="#u5143_u8868_u7684_u4F5C_u7528" class="headerlink" title="元表的作用"></a>元表的作用</h2><p>那设置元表又有什么用呢？还记得元表的作用是什么吗？对定义对值得操作,例如下面的代码,我们为table设置了一个tostring的操作:<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> t = &#123;x=<span class="number">1</span>,y=<span class="number">2</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">tostring</span>(t))</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> mt = &#123;&#125;</span><br><span class="line">mt.__tostring = <span class="function"><span class="keyword">function</span><span class="params">(t)</span></span><span class="keyword">return</span> <span class="string">"("</span>..t.x..<span class="string">","</span>..t.y..<span class="string">")"</span> <span class="keyword">end</span></span><br><span class="line"><span class="built_in">setmetatable</span>(t,mt)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">tostring</span>(t))</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>table: 00B49678<br>(1,2)</p>
</blockquote>
<p>类似的在元表中我们可以定义下面的这些方法:</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>__add</td>
<td>加法</td>
</tr>
<tr>
<td>__sub</td>
<td>减法</td>
</tr>
<tr>
<td>__mul</td>
<td>乘法</td>
</tr>
<tr>
<td>__div</td>
<td>除法</td>
</tr>
<tr>
<td>__unm</td>
<td>相反数</td>
</tr>
<tr>
<td>__mod</td>
<td>取模</td>
</tr>
<tr>
<td>__pow</td>
<td>乘幂</td>
</tr>
<tr>
<td>__concat</td>
<td>连接操作</td>
</tr>
<tr>
<td>__eq</td>
<td>等于</td>
</tr>
<tr>
<td>__lt</td>
<td>小于</td>
</tr>
<tr>
<td>__le</td>
<td>小于等于</td>
</tr>
<tr>
<td>__tostring</td>
<td>转化为字符串</td>
</tr>
<tr>
<td>__index</td>
<td>读取不存在的字段</td>
</tr>
<tr>
<td>__newindex</td>
<td>设置不存在的字段</td>
</tr>
</tbody>
</table>
<p>注意lua会把a~=b转化为not(a==b),将a&gt;b转化为b<a,将a>=b转化为b&lt;=a,所以元表中并没有表示这几种操作的字段</a,将a></p>
<h2 id="u5143_u8868_u4E0E_u7C7B_u673A_u5236"><a href="#u5143_u8868_u4E0E_u7C7B_u673A_u5236" class="headerlink" title="元表与类机制"></a>元表与类机制</h2><p>如果我们每创建一个table都要这样手动的为它创建一个元表,其实是很麻烦的一件事情,所以我们可以用下面的方法去简化操作:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> MyTable = &#123;__tostring=<span class="function"><span class="keyword">function</span><span class="params">(t)</span></span><span class="keyword">return</span> t.x..<span class="string">","</span>..t.y <span class="keyword">end</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyTable.new</span><span class="params">(t)</span></span></span><br><span class="line">	<span class="keyword">if</span> t==<span class="keyword">nil</span> <span class="keyword">then</span></span><br><span class="line">		t = &#123;&#125;</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="built_in">setmetatable</span>(t, MyTable)</span><br><span class="line">	<span class="keyword">return</span> t</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(MyTable.new&#123;x=<span class="number">1</span>,y=<span class="number">2</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>输出如下:</p>
<blockquote>
<p>1,2</p>
</blockquote>
<p>看，这是不是有点像类？还记得__index吗？它用来定义访问table中没有的字段的时候的操作:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> mt = &#123;&#125;</span><br><span class="line">mt.__index = <span class="function"><span class="keyword">function</span><span class="params">(t,k)</span></span><span class="keyword">return</span> <span class="string">"no key ["</span>..k..<span class="string">"] in table"</span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> t = &#123;x=<span class="number">1</span>,y=<span class="number">2</span>&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(t,mt)</span><br><span class="line"><span class="built_in">print</span>(t.x)</span><br><span class="line"><span class="built_in">print</span>(t.y)</span><br><span class="line"><span class="built_in">print</span>(t.z)</span><br></pre></td></tr></table></figure>
<p>输出如下:</p>
<blockquote>
<p>1<br>2<br>no key [z] in table</p>
</blockquote>
<p>特殊的,如果__index是一个table的时候,在访问没有的字段的时候lua解释器就会到元表的__index中去找:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> t = &#123;&#125;</span><br><span class="line"><span class="built_in">print</span>(t.x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> index = &#123;x=<span class="number">123</span>&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(t,&#123;__index=index&#125;)</span><br><span class="line"><span class="built_in">print</span>(t.x)</span><br><span class="line"></span><br><span class="line">t.x = <span class="number">321</span></span><br><span class="line"><span class="built_in">print</span>(t.x)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">getmetatable</span>(t).__index.x)</span><br></pre></td></tr></table></figure>
<p>它的输出是这样的:</p>
<blockquote>
<p>nil<br>123<br>321<br>123</p>
</blockquote>
<p>当在table中找不到字段时,解释器会去元表的__index字段中去找,如果__index中可以找到的话就用__index中的字段。如果table中有该字段的话,解释器就不会再去查询元表。嗯，听起来是不是有点像继承和重写?事实上lua的继承机制也是利用元表的这种特性实现的。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lua/">lua</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/技术相关/">技术相关</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-lua泛型for的原理" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/10/23/lua泛型for的原理/" class="article-date">
  	<time datetime="2016-10-23T15:10:47.000Z" itemprop="datePublished">2016-10-23</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/23/lua泛型for的原理/">lua泛型for的原理</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>学习lua的时候,一直觉得泛型for是个很有用的东西,也觉得它很神奇,但因为它是语法层面就支持的东西,所以就没有去深入思考其中的原理。直到最近看《Lua程序设计》才知道它底层的工作原理原来那么巧妙。</p>
<h2 id="u6CDB_u578Bfor_u539F_u7406"><a href="#u6CDB_u578Bfor_u539F_u7406" class="headerlink" title="泛型for原理"></a>泛型for原理</h2><p>泛型for的用法如下:<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> person = &#123;name=<span class="string">"Jim"</span>, age=<span class="number">18</span>&#125;</span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">pairs</span>(person) <span class="keyword">do</span></span><br><span class="line">	<span class="built_in">print</span>(k,v)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></p>
<p>输出结果如下:</p>
<blockquote>
<p>name    Jim<br>age     18</p>
</blockquote>
<p>它究竟是怎么做到通过循环,把table中的key和value通通打印出来的呢？</p>
<p>其实泛型for语句:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> var_1, ..., var_n <span class="keyword">in</span> &lt;explist&gt; <span class="keyword">do</span> &lt;block&gt; <span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>等价以下的代码:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> </span><br><span class="line">    <span class="keyword">local</span> _f,_s,_var = &lt;explist&gt;</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> var_1, ..., var_n = _f(_s, _var)</span><br><span class="line">        _var = var_1</span><br><span class="line">        <span class="keyword">if</span> _var==<span class="keyword">nil</span> <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        &lt;block&gt;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="pairs_u51FD_u6570_u539F_u7406"><a href="#pairs_u51FD_u6570_u539F_u7406" class="headerlink" title="pairs函数原理"></a>pairs函数原理</h2><p>这里要先介绍一个基本函数next。如果k是table t的一个key,在调用next(t,k)的时候,会返回t的下一个key和对应的值,如果key为nil,则返回t的第一组key和value,如果没有下一组key和value则返回nil。</p>
<p>其实pairs的定义很简单:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pairs</span><span class="params">(t)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">next</span>, t, <span class="keyword">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>它只是简单的返回了next函数和原来的table,所以泛型for又能这么写:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> person = &#123;name=<span class="string">"Jim"</span>, age=<span class="number">18</span>&#125;</span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">next</span>, person <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(k,v)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>等价于:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> person = &#123;name=<span class="string">"Jim"</span>, age=<span class="number">18</span>&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	<span class="keyword">local</span> _f,_s,_var = <span class="built_in">next</span>, person</span><br><span class="line">	<span class="keyword">while</span> <span class="keyword">true</span> <span class="keyword">do</span></span><br><span class="line">		k,v = _f(_s, _var)</span><br><span class="line">		_var = k</span><br><span class="line">		<span class="keyword">if</span> _var==<span class="keyword">nil</span> <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">		<span class="built_in">print</span>(k,v)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="ipairs_u51FD_u6570_u539F_u7406"><a href="#ipairs_u51FD_u6570_u539F_u7406" class="headerlink" title="ipairs函数原理"></a>ipairs函数原理</h2><p>ipairs函数比pairs函数要复杂一点。如果按照pair的做法,会出现以下情况:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> test1 = &#123;<span class="string">"one"</span>, <span class="string">"two"</span>, three=<span class="number">3</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">next</span>, test1 <span class="keyword">do</span></span><br><span class="line">	<span class="built_in">print</span>(k,v)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"================"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(test1) <span class="keyword">do</span></span><br><span class="line">	<span class="built_in">print</span>(i,v)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>输出如下:</p>
<blockquote>
<p>1       one<br>2       two<br>three   3<br>\================<br>1       one<br>2       two</p>
</blockquote>
<p>还会出现下面的这种情况:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> test1 = &#123;<span class="string">"one"</span>, <span class="keyword">nil</span>, <span class="string">"three"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">next</span>, test1 <span class="keyword">do</span></span><br><span class="line">	<span class="built_in">print</span>(k,v)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"================"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(test1) <span class="keyword">do</span></span><br><span class="line">	<span class="built_in">print</span>(i,v)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>输出:</p>
<blockquote>
<p>1       one<br>3       three<br>\================<br>1       one</p>
</blockquote>
<p>我们在使用ipairs的时候是想以数组的方式遍历table,但pairs会把table中的所有键值对都遍历一遍。使用ipairs的时候会从下标为1开始逐一遍历table,直到遇到value等于nil的时候停止,它的工作原理如下:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">iter</span><span class="params">(t, index)</span></span></span><br><span class="line">	index = index + <span class="number">1</span></span><br><span class="line">	<span class="keyword">local</span> var = t[index]</span><br><span class="line">	<span class="keyword">if</span> var <span class="keyword">then</span></span><br><span class="line">		<span class="keyword">return</span> index, var</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ipairs</span><span class="params">(t)</span></span></span><br><span class="line">	<span class="keyword">return</span> iter,t,<span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>或者简化成下面的形式:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> test1 = &#123;<span class="string">"one"</span>, <span class="string">"two"</span>, <span class="string">"three"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">iter</span><span class="params">(t, index)</span></span></span><br><span class="line">	index = index + <span class="number">1</span></span><br><span class="line">	<span class="keyword">local</span> var = t[index]</span><br><span class="line">	<span class="keyword">if</span> var <span class="keyword">then</span></span><br><span class="line">		<span class="keyword">return</span> index, var</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i,v <span class="keyword">in</span> iter,test1,<span class="number">0</span> <span class="keyword">do</span></span><br><span class="line">	<span class="built_in">print</span>(i,v)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lua/">lua</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/技术相关/">技术相关</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Java自定义注解和动态代理" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/27/Java自定义注解和动态代理/" class="article-date">
  	<time datetime="2016-05-27T11:49:05.000Z" itemprop="datePublished">2016-05-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/27/Java自定义注解和动态代理/">Java自定义注解和动态代理</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在学习Retrofit的时候就对它奇特的使用方式感到十分的好奇，为什么定义一个接口，使用”@GET”,”@Query”这些奇怪的注解就能创建出能实际访问服务器的实例出来:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GitHubService</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@GET</span>(<span class="string">"/users/&#123;user&#125;/repos"</span>)</span><br><span class="line">    <span class="function">List&lt;Repo&gt; <span class="title">listRepos</span><span class="params">(@Path(<span class="string">"user"</span>)</span> String user)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">RestAdapter restAdapter = <span class="keyword">new</span> RestAdapter.Builder()</span><br><span class="line">    .setEndpoint(<span class="string">"https://api.github.com"</span>)</span><br><span class="line">    .build();</span><br><span class="line">GitHubService service = restAdapter.create(GitHubService.class);</span><br><span class="line">List&lt;Repo&gt; repos = service.listRepos(<span class="string">"octocat"</span>);</span><br></pre></td></tr></table></figure>
<p>尤其是对如何创建一个接口的实例感到万分的好奇，这几天回学校写毕设论文刚好有点空，于是就抽了点时间研究了一下。</p>
<h1 id="u81EA_u5B9A_u4E49Java_u6CE8_u89E3"><a href="#u81EA_u5B9A_u4E49Java_u6CE8_u89E3" class="headerlink" title="自定义Java注解"></a>自定义Java注解</h1><p>说起Java的注解，大家都能很自然的想起”@Override”,”@Deprecated”,”@Documented”这些很常用的内置注解。但很多新手应该都不知道其实Java也是支持自定义注解的吧？(反正我以前是不知道的)</p>
<h2 id="u5143_u6CE8_u89E3"><a href="#u5143_u6CE8_u89E3" class="headerlink" title="元注解"></a>元注解</h2><p>元注解的作用就是负责注解其他注解，Java5.0定义了4个标准的meta-annotation类型，它们被用来提供对其它 annotation类型作说明。Java5.0定义的元注解：</p>
<ul>
<li>@Target</li>
<li>@Retention</li>
<li>@Documented</li>
<li>@Inherited</li>
</ul>
<h3 id="@Target"><a href="#@Target" class="headerlink" title="@Target"></a>@Target</h3><p>@Target说明了自定义注解的修饰类型，也就是说可以用它来声明自定义注解可以用在什么地方，它的取值范围有：</p>
<ol>
<li>ElementType.CONSTRUCTOR : 用于描述构造器</li>
<li>ElementType.FIELD : 用于描述域</li>
<li>ElementType.LOCAL_VARIABLE : 用于描述局部变量</li>
<li>ElementType.METHOD : 用于描述方法</li>
<li>ElementType.PACKAGE : 用于描述包</li>
<li>ElementType.PARAMETER : 用于描述参数</li>
<li>ElementType.TYPE : 用于描述类、接口(包括注解类型) 或enum声明</li>
</ol>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="keyword">public</span> <span class="annotation">@interface</span> TypeAnnotation &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="keyword">public</span> <span class="annotation">@interface</span> MethodAnnotation &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Target</span>(ElementType.PARAMETER)</span><br><span class="line"><span class="keyword">public</span> <span class="annotation">@interface</span> ParamAnnotation &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>TypeAnnotation可以用来修饰描述类、接口(包括注解类型) 或enum声明，MethodAnnotation可以用来修饰方法，ParamAnnotation可以用来修饰参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@TypeAnnotation</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyInterface</span> </span>&#123;</span><br><span class="line">	<span class="annotation">@MethodAnnotation</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">func</span><span class="params">(@ParamAnnotation String param)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="@Retention"><a href="#@Retention" class="headerlink" title="@Retention"></a>@Retention</h2><p>@Retention 定义了自定义注解的生命长短：某些Annotation仅出现在源代码中，而被编译器丢弃；而另一些却被编译在class文件中；编译在class文件中的Annotation可能会被虚拟机忽略，而另一些在class被装载时将被读取（请注意并不影响class的执行，因为Annotation与class在使用上是被分离的）。使用这个meta-Annotation可以对 Annotation的“生命周期”限制。</p>
<p>它的取值有下面这些：</p>
<ol>
<li>RetentionPolicy.SOURCE : 在源文件中有效（即源文件保留）</li>
<li>RetentionPolicy.CLASS : 在class文件中有效（即class保留）</li>
<li>RetentionPolicy.RUNTIME : 时有效（即运行时保留）</li>
</ol>
<p>注解也是可以保存数据的，如value属性就是默认的数据保存属性:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="annotation">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="annotation">@interface</span> MethodAnnotation &#123;</span><br><span class="line">	<span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> "<span class="keyword">default</span> value"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassA</span></span>&#123;</span><br><span class="line">	<span class="annotation">@MethodAnnotation</span>()</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">func1</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="annotation">@MethodAnnotation</span>(<span class="string">"data"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">func2</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>比如可以在程序运行的时候（因为声明了@Retention(RetentionPolicy.RUNTIME)）通过反射获取上面的ClassA.func1的注解MethodAnnotation保存的数据（默认值”default value”）和ClassA.func2的注解MethodAnnotation保存的数据（”data”）</p>
<p>当然如果只能保持一个数据限制就太大了，你可以定义多个数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="annotation">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="annotation">@interface</span> MethodAnnotation &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">enum</span> EnumData&#123; DATA1, DATA2, DATA3&#125;;</span><br><span class="line">	</span><br><span class="line">	<span class="function">String <span class="title">data1</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">data2</span><span class="params">()</span> <span class="keyword">default</span> 0xffff</span>;</span><br><span class="line">	<span class="function">EnumData <span class="title">data3</span><span class="params">()</span> <span class="keyword">default</span> EnumData.DATA1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassA</span></span>&#123;</span><br><span class="line">	<span class="annotation">@MethodAnnotation</span>(data1=<span class="string">"data1"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">func1</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="annotation">@MethodAnnotation</span>(data1=<span class="string">"data1"</span>, data2=<span class="number">0</span>, data3=MethodAnnotation.EnumData.DATA1)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">func2</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当属性没有用default指定默认值得时候在使用的时候必须由用户设置属性值（如这里的data1）</p>
<p>注解参数的可支持数据类型：</p>
<p>1.所有基本数据类型（int,float,boolean,byte,double,char,long,short)<br>2.String类型<br>3.Class类型<br>4.enum类型<br>5.Annotation类型<br>6.以上所有类型的数组</p>
<h2 id="@Inherited"><a href="#@Inherited" class="headerlink" title="@Inherited"></a>@Inherited</h2><p>@Inherited 元注解是一个标记注解，@Inherited阐述了某个被标注的类型是被继承的。如果一个使用了@Inherited修饰的annotation类型被用于一个class，则这个annotation将被用于该class的子类。</p>
<h1 id="Java_u52A8_u6001_u4EE3_u7406"><a href="#Java_u52A8_u6001_u4EE3_u7406" class="headerlink" title="Java动态代理"></a>Java动态代理</h1><p>我知道可以用反射调用方法甚至创建对象，但我还真的没有想到怎样创建出一个接口的实例。用了各种形容方式之后终于找到了这种技术的专业名称:”动态代理”，下面是一个简单的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyInterface</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span><br><span class="line">			<span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		System.out.print(<span class="string">"call : "</span> + method.getName());</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">		MyInterface myInterface = (MyInterface)Proxy.newProxyInstance(</span><br><span class="line">        		 MyInterface.class.getClassLoader(), </span><br><span class="line">			     <span class="keyword">new</span> Class[]&#123;MyInterface.class&#125;, </span><br><span class="line">			     <span class="keyword">new</span> MyHandler());</span><br><span class="line">		myInterface.func();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个例子的输出为：</p>
<blockquote>
<p>call : func</p>
</blockquote>
<p>通过实现InvocationHandler接口，定义自己的handler类，再使用Proxy.newProxyInstance就可以实例化出一个接口的实例。当调用接口的方法的时候，InvocationHandler接口的invoke方法就会被调用，可以在这里编写实际的功能代码。</p>
<p>当然也能将创建实例的代码抽象出来，实现复用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt;<span class="function">T <span class="title">newProxyInstance</span><span class="params">(Class&lt;T&gt; c)</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> (T)Proxy.newProxyInstance(</span><br><span class="line">				c.getClassLoader(),</span><br><span class="line">				<span class="keyword">new</span> Class&lt;?&gt;[]&#123;c&#125;,</span><br><span class="line">				<span class="keyword">new</span> DataBaseHalder(c));</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">    <span class="comment">//使用方式</span></span><br><span class="line">    MyInterface myInterface = (MyInterface)newProxyInstance(MyInterface.class, <span class="keyword">new</span> MyHandler());</span><br><span class="line">	myInterface.func();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="u901A_u8FC7_u53CD_u5C04_u83B7_u53D6_u6CE8_u89E3_u4FDD_u5B58_u7684_u6570_u636E"><a href="#u901A_u8FC7_u53CD_u5C04_u83B7_u53D6_u6CE8_u89E3_u4FDD_u5B58_u7684_u6570_u636E" class="headerlink" title="通过反射获取注解保存的数据"></a>通过反射获取注解保存的数据</h1><ul>
<li>通过Class.getAnnotation(XXXAnnotation.class)可以获取到方法的ElementType.METHOD或者类ElementType.TYPE类型的注解</li>
<li>通过 Method.getParameterAnnotations()可以获取到方法各个参数的注解（ElementType.PARAMETER类型）</li>
</ul>
<p>这部分用代码来解释最直接了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="annotation">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="annotation">@interface</span> TypeAnnotation &#123;</span><br><span class="line">	<span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="annotation">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="annotation">@interface</span> MethodAnnotation &#123;</span><br><span class="line">	<span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Target</span>(ElementType.PARAMETER)</span><br><span class="line"><span class="annotation">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="annotation">@interface</span> ParamAnnotation &#123;</span><br><span class="line">	<span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@TypeAnnotation</span>(<span class="string">"interface MyInterface"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyInterface</span></span>&#123;</span><br><span class="line">	<span class="annotation">@MethodAnnotation</span>(<span class="string">"MyInterface.func"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(@ParamAnnotation(<span class="string">"param1"</span>)</span> String a, @<span class="title">ParamAnnotation</span><span class="params">(<span class="string">"param2"</span>)</span> <span class="keyword">int</span> b)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> Class mClass;</span><br><span class="line">	</span><br><span class="line">	MyHandler(Class c)&#123;</span><br><span class="line">		mClass = c;</span><br><span class="line">		TypeAnnotation typeAnnotation = (TypeAnnotation) mClass.getAnnotation(TypeAnnotation.class);</span><br><span class="line">		System.out.print(<span class="string">"TypeAnnotation : "</span> + typeAnnotation.value() + <span class="string">"\n"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span><br><span class="line">			<span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		</span><br><span class="line">		MethodAnnotation methodAnnotation = (MethodAnnotation)method.getAnnotation(MethodAnnotation.class);</span><br><span class="line">		System.out.print(<span class="string">"MethodAnnotation : "</span> + methodAnnotation.value() + <span class="string">"\n"</span>);</span><br><span class="line"></span><br><span class="line">		Class[] parameterTypes = method.getParameterTypes();</span><br><span class="line">		Annotation[][] parameterAnnotations = method.getParameterAnnotations();</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i&lt; parameterAnnotations.length ; i++)&#123;</span><br><span class="line">			Class type = parameterTypes[i];</span><br><span class="line">			<span class="keyword">for</span>(Annotation annotation : parameterAnnotations[i])&#123;</span><br><span class="line">				<span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> ParamAnnotation)&#123;</span><br><span class="line">					ParamAnnotation paramAnnotation = (ParamAnnotation) annotation;</span><br><span class="line">					System.out.print(paramAnnotation.value() + <span class="string">" - "</span> + args[i]  + <span class="string">"["</span> + type.getName() + <span class="string">"]"</span>+ <span class="string">"\n"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">		MyInterface myInterface = (MyInterface)Proxy.newProxyInstance(</span><br><span class="line">				MyInterface.class.getClassLoader(), </span><br><span class="line">				<span class="keyword">new</span> Class&lt;?&gt;[]&#123;MyInterface.class&#125;,</span><br><span class="line">				<span class="keyword">new</span> MyHandler(MyInterface.class));</span><br><span class="line">		myInterface.func(<span class="string">"data1"</span>,<span class="number">123</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<blockquote>
<p>TypeAnnotation : interface MyInterface<br>MethodAnnotation : MyInterface.func<br>param1 - data1[java.lang.String]<br>param2 - 123[int]</p>
</blockquote>
<p>这里最难理解的就是这两行代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class[] parameterTypes = method.getParameterTypes();</span><br><span class="line">Annotation[][] parameterAnnotations = method.getParameterAnnotations();</span><br></pre></td></tr></table></figure>
<p>method.getParameterTypes() 可以获取到参数的类型，而method.getParameterAnnotations()则获取到一个二维数组，它保存了所有变量的全部注解。</p>
<h1 id="u4E00_u4E2A_u7B80_u5355_u7684_u5E94_u7528_u5B9E_u4F8B"><a href="#u4E00_u4E2A_u7B80_u5355_u7684_u5E94_u7528_u5B9E_u4F8B" class="headerlink" title="一个简单的应用实例"></a>一个简单的应用实例</h1><p>用过Retrofit的人都知道，这种动态代理技术在框架搭建完成之后，使用起来便十分的便利了，有兴趣的同学可以去看看Retrofit的相关资料。我这里再写一个模拟操作数据库的小例子，展示一下这种框架的便捷性。</p>
<p>首先是接口的定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@DataBase</span>(database=<span class="string">"SchoolSystem"</span>, username=<span class="string">"root"</span>, password=<span class="string">"123456"</span>, ip=<span class="string">"localhost"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IDataBaseOperation</span> </span>&#123;</span><br><span class="line">	<span class="annotation">@Table</span>(<span class="string">"Student"</span>)</span><br><span class="line">	<span class="annotation">@Column</span>(&#123;<span class="string">"name"</span>,<span class="string">"age"</span>,<span class="string">"sex"</span>&#125;)</span><br><span class="line">	List&lt;Map&lt;String,String&gt;&gt; getStudentByName(<span class="annotation">@Condition</span>(<span class="string">"name"</span>)String name);</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Table</span>(<span class="string">"Student"</span>)</span><br><span class="line">	<span class="annotation">@Column</span>(&#123;<span class="string">"name"</span>,<span class="string">"age"</span>,<span class="string">"sex"</span>&#125;)</span><br><span class="line">	List&lt;Map&lt;String,String&gt;&gt; getStudentOlder(<span class="annotation">@Condition</span>(value=<span class="string">"age"</span>,compare=<span class="string">"&gt;"</span>)<span class="keyword">int</span> age);</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Table</span>(<span class="string">"Student"</span>)</span><br><span class="line">	<span class="annotation">@Column</span>(&#123;<span class="string">"name"</span>,<span class="string">"age"</span>,<span class="string">"sex"</span>&#125;)</span><br><span class="line">	List&lt;Map&lt;String,String&gt;&gt; getStudentBySexAndAge(<span class="annotation">@Condition</span>(<span class="string">"sex"</span>)String sex, <span class="annotation">@Condition</span>(<span class="string">"age"</span>)<span class="keyword">int</span> age);</span><br><span class="line">	</span><br><span class="line">	<span class="annotation">@Table</span>(<span class="string">"Teacher join Course on Teacher.id=Course.teacher"</span>)</span><br><span class="line">	<span class="annotation">@Column</span>(&#123;<span class="string">"Course.name"</span>&#125;)</span><br><span class="line">	List&lt;Map&lt;String,String&gt;&gt; getCourseByTeacher(<span class="annotation">@Condition</span>(<span class="string">"Teacher.name"</span>)String teacher);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>让我们先跳过实现细节，直接看它的用法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">		IDataBaseOperation oprBaseOperation = newProxyInstance(IDataBaseOperation.class, <span class="keyword">new</span> DataBaseHalder(IDataBaseOperation.class));</span><br><span class="line"></span><br><span class="line">		oprBaseOperation.getStudentByName(<span class="string">"小红"</span>);</span><br><span class="line">		oprBaseOperation.getStudentOlder(<span class="number">12</span>);</span><br><span class="line">		oprBaseOperation.getStudentBySexAndAge(<span class="string">"男"</span>, <span class="number">12</span>);</span><br><span class="line">		oprBaseOperation.getCourseByTeacher(<span class="string">"李老师"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt;<span class="function">T <span class="title">newProxyInstance</span><span class="params">(Class&lt;T&gt; c, InvocationHandler handler)</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> (T)Proxy.newProxyInstance(</span><br><span class="line">				c.getClassLoader(), </span><br><span class="line">				<span class="keyword">new</span> Class&lt;?&gt;[]&#123;c&#125;,</span><br><span class="line">				handler);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样我们就能看到这样的输出:</p>
<blockquote>
<p>===================================</p>
<p>connect database :<br>ip : localhost<br>username : root<br>password : 123456<br>database : SchoolSystem</p>
<p>===================================<br>select name,age,sex from Student where name = “小红”;<br>select name,age,sex from Student where age &gt; 12;<br>select name,age,sex from Student where sex = “男” and age = 12;<br>select Course.name from Teacher join Course on Teacher.id=Course.teacher where &gt; &gt; &gt; Teacher.name = “李老师”;</p>
</blockquote>
<p>这里没有真的去做数据库操作，只是用打印的方法模拟了一下，但如果真的要实现的话也是不难的。</p>
<p>但从这几处使用代码来看，这个框架的是十分易用的，如果我们想要增加一个查询操作的话，只需要在IDataBaseOperation接口声明多一个方法，然后直接就能在得到实例后使用了。</p>
<p>最后将一些细节代码也贴上来：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Column.java</span></span><br><span class="line"><span class="annotation">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="annotation">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="annotation">@interface</span> Column &#123;</span><br><span class="line">	String[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//Condition.java</span><br><span class="line">@Target(ElementType.PARAMETER)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">public @interface Condition &#123;</span><br><span class="line">	public String value();</span><br><span class="line">	public String compare() default "=";</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Table.java</span></span><br><span class="line"><span class="annotation">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="annotation">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="annotation">@interface</span> Table &#123;</span><br><span class="line">	<span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DataBase.java</span></span><br><span class="line"><span class="annotation">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="annotation">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="annotation">@interface</span> DataBase &#123;</span><br><span class="line">	<span class="function">String <span class="title">ip</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function">String <span class="title">database</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function">String <span class="title">username</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function">String <span class="title">password</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DataBaseHalder.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataBaseHalder</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> Class mInterface;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DataBaseHalder</span><span class="params">(Class object)</span></span>&#123;</span><br><span class="line">		mInterface = object;</span><br><span class="line">		</span><br><span class="line">		DataBase db = (DataBase) mInterface.getAnnotation(DataBase.class);</span><br><span class="line"></span><br><span class="line">		System.out.print(<span class="string">"===================================\n"</span>);</span><br><span class="line">		System.out.print(<span class="string">"connect database : \n"</span>);</span><br><span class="line">		System.out.print(<span class="string">"ip : "</span> + db.ip() + <span class="string">"\n"</span>);</span><br><span class="line">		System.out.print(<span class="string">"username : "</span> + db.username() + <span class="string">"\n"</span>);</span><br><span class="line">		System.out.print(<span class="string">"password : "</span> + db.password() + <span class="string">"\n"</span>);</span><br><span class="line">		System.out.print(<span class="string">"database : "</span> + db.database() + <span class="string">"\n"</span>);</span><br><span class="line">		System.out.print(<span class="string">"===================================\n"</span>);</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span><br><span class="line">			<span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(method.getName().matches(<span class="string">"^get.*"</span>))&#123;</span><br><span class="line">			String sql =  <span class="string">"select "</span> + getColumns(method) + <span class="string">" from "</span> + getTable(method) </span><br><span class="line">					+ <span class="string">" where "</span> + getCondition(method, args) + <span class="string">";"</span>;</span><br><span class="line">			System.out.print(sql + <span class="string">"\n"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> String <span class="title">getTable</span><span class="params">(Method method)</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> method.getAnnotation(Table.class).value();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> String <span class="title">getColumns</span><span class="params">(Method method)</span></span>&#123;</span><br><span class="line">		String result = <span class="string">""</span>;</span><br><span class="line">		String conn = <span class="string">""</span>;</span><br><span class="line">		<span class="keyword">for</span> (String col : method.getAnnotation(Column.class).value()) &#123;</span><br><span class="line">			result += conn + col;</span><br><span class="line">			conn = <span class="string">","</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> String <span class="title">getCondition</span><span class="params">(Method method, Object[] args)</span> </span>&#123;</span><br><span class="line">		String result = <span class="string">""</span>;</span><br><span class="line">		String andConnect = <span class="string">""</span>;</span><br><span class="line">		Class[] parameterTypes = method.getParameterTypes();</span><br><span class="line"></span><br><span class="line">		Annotation[][] parameterAnnotations = method.getParameterAnnotations();</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i&lt; parameterAnnotations.length ; i++)&#123;</span><br><span class="line">			Class type = parameterTypes[i];</span><br><span class="line">			<span class="keyword">for</span>(Annotation annotation : parameterAnnotations[i])&#123;</span><br><span class="line">				<span class="keyword">if</span>(annotation <span class="keyword">instanceof</span> Condition)&#123;</span><br><span class="line">					result += andConnect + parseCondition(type, args[i], (Condition) annotation);</span><br><span class="line">					andConnect = <span class="string">" and "</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> String <span class="title">parseCondition</span><span class="params">(Class argType, Object arg, Annotation annotation)</span></span>&#123;</span><br><span class="line">		Condition condition = (Condition) annotation;</span><br><span class="line">		String result = condition.value() + <span class="string">" "</span> + condition.compare() + <span class="string">" "</span>;</span><br><span class="line">		<span class="keyword">if</span>(argType == String.class)&#123;</span><br><span class="line">			result += <span class="string">"\""</span> + arg + <span class="string">"\""</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			result += arg;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="u53E6_u5916_u7684_u4E00_u4E2A_u5B9E_u7528_u7684_u5C0F_u4F8B_u5B50"><a href="#u53E6_u5916_u7684_u4E00_u4E2A_u5B9E_u7528_u7684_u5C0F_u4F8B_u5B50" class="headerlink" title="另外的一个实用的小例子"></a>另外的一个实用的小例子</h1><p>相信做安卓的同学都遇到过在Activity.onCreate初始化的时候写一大堆的findViewById吧？这种重复性的无趣工作其实也可以用注解来简化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="annotation">@interface</span> ViewField &#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Processor</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Activity activity)</span> <span class="keyword">throws</span> IllegalAccessException </span>&#123;</span><br><span class="line">            Field[] fields = activity.getClass().getDeclaredFields();</span><br><span class="line">            ViewField ann = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">                ann = field.getAnnotation(ViewField.class);</span><br><span class="line">                <span class="keyword">if</span> (ann!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    field.set(activity, activity.findViewById(ann.value()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们的Activity就可以这样写来让注解自动初始化View变量了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@ViewField</span>(R.id.text)</span><br><span class="line">    <span class="keyword">private</span> TextView mTextView;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@ViewField</span>(R.id.button)</span><br><span class="line">    <span class="keyword">private</span> Button mButton;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@ViewField</span>(R.id.image)</span><br><span class="line">    <span class="keyword">private</span> ImageView mImageView;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ViewField.Processor.process(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mTextView.setText(<span class="string">"text"</span>);</span><br><span class="line">        mButton.setText(<span class="string">"button"</span>);</span><br><span class="line">        mImageView.setImageResource(R.mipmap.ic_launcher);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然有人说用注解，效率会很低。但我觉得这里的额外消耗其实根本不起眼，用这点小损耗换来编码的便利性是很值得的。但如果真的很在意，也能用下面的泛型方法简化findViewById操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> &lt;T extends View&gt; <span class="function">T <span class="title">generateFindViewById</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//return返回view时,加上泛型T</span></span><br><span class="line">	<span class="keyword">return</span> (T) findViewById(id);</span><br><span class="line">&#125;</span><br><span class="line">mButton = generateFindViewById(R.id.button);</span><br></pre></td></tr></table></figure>
<p>这样能减少强制转换的操作，但编写效率还是不如用注解。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/技术相关/">技术相关</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-学习HTTP协议-用socket实现http访问" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/04/学习HTTP协议-用socket实现http访问/" class="article-date">
  	<time datetime="2016-03-04T14:16:30.000Z" itemprop="datePublished">2016-03-04</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/04/学习HTTP协议-用socket实现http访问/">学习HTTP协议-用socket实现http访问</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>相信大家都知道 http 报文这东西吧？http 报文分两种，请求报文和响应报文。</p>
<h2 id="u8BF7_u6C42_u62A5_u6587"><a href="#u8BF7_u6C42_u62A5_u6587" class="headerlink" title="请求报文"></a><strong>请求报文</strong></h2><p>客户端向服务端发送的就是请求报文，它可告诉服务端自己需要什么样的资源，也可以将一些文件或者数据上传给服务端。</p>
<p>请求报文格式如下：</p>
<img src="/学习HTTP协议-用socket实现http访问/1.jpg">
<p>请求报文分为三个部分：</p>
<ul>
<li>请求行，如：</li>
</ul>
<blockquote>
<p>GET / HTTP/1.1</p>
</blockquote>
<p>这个请求行表明了这次请求使用的是 GET 方法，访问的是网站的根目录，使用的 HTTP 协议版本是 1.1。</p>
<ul>
<li>请求头部，如：</li>
</ul>
<blockquote>
<p>Host: www.baidu.com<br>Connection: keep-alive</p>
</blockquote>
<ul>
<li>请求包体</li>
</ul>
<p>用来携带数据</p>
<h3 id="GET__u65B9_u6CD5"><a href="#GET__u65B9_u6CD5" class="headerlink" title="GET 方法"></a><em>GET 方法</em></h3><p>GET 方法是 HTTP 中最基础的方法，我们在浏览器地址栏输入网站浏览网页使用的都是 GET 方法：</p>
<blockquote>
<p><a href="http://www.islinjw.cn/okhttp_cookie_demo/checkverifycode.php" target="_blank" rel="external">http://www.islinjw.cn/okhttp_cookie_demo/checkverifycode.php</a></p>
</blockquote>
<p>当然有时候服务器需要根据用户传递的信息去返回对应的数据，GET 方法用下面的形式传递信息给服务器：</p>
<blockquote>
<p><a href="http://www.islinjw.cn/okhttp_cookie_demo/checkverifycode.php?verifycode=qwjuy&amp;format=json" target="_blank" rel="external">http://www.islinjw.cn/okhttp_cookie_demo/checkverifycode.php?verifycode=qwjuy&amp;format=json</a></p>
</blockquote>
<p>这里告诉给服务器 verifycode=qwjuy 和 format=json ，服务器会根据用户传过来的信息返回不同的数据。</p>
<p>这个时候的请求行长这个样子，URL 上就携带了 GET 传递的数据：</p>
<blockquote>
<p>GET /okhttp_cookie_demo/checkverifycode.php?verifycode=qwjuy&amp;format=json HTTP/1.1</p>
</blockquote>
<p>这里再说一句题外话，并不是说如果在 URL 里面没有见到 “?” 这个符号，客户端就没有传递数据给服务器。有一种叫做网页伪静态化的技术可以实现不带问号的 URL 使用 GET 方法传递数据。</p>
<h3 id="POST__u65B9_u6CD5"><a href="#POST__u65B9_u6CD5" class="headerlink" title="POST 方法"></a><em>POST 方法</em></h3><p>GET 方法的参数都显示在 URl 上，这样对于诸如账户密码的敏感信息来说太不安全，而且也很难传递想图片这样的数据。所以就有了 POST 方法。</p>
<p>使用 POST 方法传递的数据并不会显示在 URL 上，而是保存在请求包体中，当然 HTTP 协议是明文传输的，所以把账户密码直接用 POST 传递也是不安全的，需要程序员自己进行加密处理。</p>
<h3 id="HTTP__u534F_u8BAE_u65B9_u6CD5_u5217_u8868"><a href="#HTTP__u534F_u8BAE_u65B9_u6CD5_u5217_u8868" class="headerlink" title="HTTP 协议方法列表"></a><em>HTTP 协议方法列表</em></h3><table>
<thead>
<tr>
<th>序号</th>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>GET</td>
<td>请求指定的页面信息，并返回实体主体。</td>
</tr>
<tr>
<td>2</td>
<td>HEAD</td>
<td>类似于get请求，只不过返回的响应中没有具体的内容，用于获取报头</td>
</tr>
<tr>
<td>3</td>
<td>POST</td>
<td>向指定资源提交数据进行处理请求（例如提交表单或者上传文件）。数据被包含在请求体中。POST请求可能会导致新的资源的建立和/或已有资源的修改。</td>
</tr>
<tr>
<td>4</td>
<td>PUT</td>
<td>从客户端向服务器传送的数据取代指定的文档的内容。</td>
</tr>
<tr>
<td>5</td>
<td>DELETE</td>
<td>请求服务器删除指定的页面。</td>
</tr>
<tr>
<td>6</td>
<td>CONNECT</td>
<td>HTTP/1.1协议中预留给能够将连接改为管道方式的代理服务器。</td>
</tr>
<tr>
<td>7</td>
<td>OPTIONS</td>
<td>允许客户端查看服务器的性能。</td>
</tr>
<tr>
<td>8</td>
<td>TRACE</td>
<td>回显服务器收到的请求，主要用于测试或诊断。</td>
</tr>
<tr>
<td>9</td>
<td>PATCH</td>
<td>实体中包含一个表，表中说明与该URI所表示的原内容的区别。</td>
</tr>
<tr>
<td>10</td>
<td>MOVE</td>
<td>请求服务器将指定的页面移至另一个网络地址。</td>
</tr>
<tr>
<td>11</td>
<td>COPY</td>
<td>请求服务器将指定的页面拷贝至另一个网络地址。</td>
</tr>
<tr>
<td>12</td>
<td>LINK</td>
<td>请求服务器建立链接关系。</td>
</tr>
<tr>
<td>13</td>
<td>UNLINK</td>
<td>断开链接关系。</td>
</tr>
<tr>
<td>14</td>
<td>WRAPPED</td>
<td>允许客户端发送经过封装的请求。</td>
</tr>
<tr>
<td>15</td>
<td>Extension-mothed</td>
<td>在不改动协议的前提下，可增加另外的方法。</td>
</tr>
</tbody>
</table>
<h2 id="u54CD_u5E94_u62A5_u6587"><a href="#u54CD_u5E94_u62A5_u6587" class="headerlink" title="响应报文"></a><strong>响应报文</strong></h2><p>服务端接收到请求报文之后，了解到客户端需要什么样的服务之后就会返回响应报文给客户端。</p>
<p>响应报文格式如下：</p>
<img src="/学习HTTP协议-用socket实现http访问/2.jpg">
<ul>
<li>状态行，如：</li>
</ul>
<blockquote>
<p>HTTP/1.1 200 OK</p>
</blockquote>
<ul>
<li>响应头部，如：</li>
</ul>
<blockquote>
<p>Date: Fri, 04 Mar 2016 11:04:01 GMT<br>Server: Apache/2.4.7 (Ubuntu)<br>X-Powered-By: PHP/5.5.9-1ubuntu4.14<br>Expires: Thu, 19 Nov 1981 08:52:00 GMT<br>Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0<br>Pragma: no-cache<br>Content-Length: 20<br>Keep-Alive: timeout=5, max=100<br>Connection: Keep-Alive<br>Content-Type: text/html</p>
</blockquote>
<ul>
<li>响应包体，即页面显示的内容，如：</li>
</ul>
<blockquote>
<p>{“result”:”success”}</p>
</blockquote>
<h3 id="u72B6_u6001_u7801"><a href="#u72B6_u6001_u7801" class="headerlink" title="状态码"></a><em>状态码</em></h3><p>状态码由三位数字组成，第一位数字表示响应的类型，常用的状态码有五大类如下所示：</p>
<p>　　1xx：表示服务器已接收了客户端请求，客户端可继续发送请求;</p>
<p>　　2xx：表示服务器已成功接收到请求并进行处理;</p>
<p>　　3xx：表示服务器要求客户端重定向;</p>
<p>　　4xx：表示客户端的请求有非法内容;</p>
<p>　　5xx：表示服务器未能正常处理客户端的请求而出现意外错误;</p>
<h2 id="u4F7F_u7528_Socket__u53D1_u9001_HTTP__u8BF7_u6C42_u62A5_u6587"><a href="#u4F7F_u7528_Socket__u53D1_u9001_HTTP__u8BF7_u6C42_u62A5_u6587" class="headerlink" title="使用 Socket 发送 HTTP 请求报文"></a><strong>使用 Socket 发送 HTTP 请求报文</strong></h2><p>我们知道 HTTP 协议是基于 TCP 的，而我们可以使用 Socket 进行 TCP 连接，所以在充分理解 HTTP 报文之后我们就可以用 socket 实现自己的 HTTP 访问了。</p>
<h3 id="u8BBF_u95EE_u7F51_u9875"><a href="#u8BBF_u95EE_u7F51_u9875" class="headerlink" title="访问网页"></a><em>访问网页</em></h3><p>首先我们看看怎样用 socket 实现 http 访问网页,这里我们尝试使用 GET 方法访问 <a href="http://www.islinjw.cn" target="_blank" rel="external">www.islinjw.cn</a>。</p>
<p>流程如下：</p>
<ol>
<li>使用 socket 连接服务器</li>
<li>发送请求报文</li>
<li>接收响应报文</li>
<li>断开 socket 连接</li>
</ol>
<p>重点在于发送请求报文，其他步骤和一般的 socket 程序是没有什么区别的。</p>
<p>请求报文分为三个部分还记得吗？</p>
<ul>
<li>请求行<br>使用 HTTP/1.1 协议的 GET 方法访问网站的根目录：</li>
</ul>
<blockquote>
<p>GET / HTTP/1.1</p>
</blockquote>
<ul>
<li>请求头部<br>Host 是请求头部唯一必须携带的数据，要不然能接收到数据，但服务器返回302、400这样的错误代码。原因是服务器可能使用了虚拟服务器技术，一台服务器托管了多个网站，即多个网站通过dns解析到同样的ip地址。像这里我们访问 www.islinjw.cn 主机：</li>
</ul>
<blockquote>
<p>Host: www.islinjw.cn</p>
</blockquote>
<ul>
<li>请求实体：<br>但我们这里因为只是单纯的获取页面，并没有传递数据给服务器，所以报文实体为空。</li>
</ul>
<p>每个部分之间使用 “\r\n” 分割。但需要在请求报文的最后加多一个 “\n”。为什么？还记得请求头部和请求实体之间有一个什么东西吗？对，空行！因为这里没有请求实体，所以报文最后就是一个空行。如果没有它，服务器不会返回响应报文，程序就会一直阻塞在那里。</p>
<p>所以最终发送的报文就是:</p>
<blockquote>
<p>GET / HTTP/1.1\r\nHost: www.islinjw.cn\r\n\n</p>
</blockquote>
<p>代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestRequest</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">TestRequest</span><span class="params">()</span></span>&#123;</span><br><span class="line">    SOCKET sock_client = Connect(SERVER_IP.c_str());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> data = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求行</span></span><br><span class="line">    data += <span class="string">"GET / HTTP/1.1\r\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求头部</span></span><br><span class="line">    data += <span class="string">"Host: www.islinjw.cn\r\n\n"</span>;</span><br><span class="line"></span><br><span class="line">    send(sock_client,data.c_str(),data.size(),<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    PrintRecvData(sock_client);</span><br><span class="line">    Disconnect(sock_client);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>服务器返回的响应报文如下（对，这个网站就是一个 hello world 在那里而已）：</p>
<img src="/学习HTTP协议-用socket实现http访问/3.jpg">
<h3 id="u4F7F_u7528_GET__u65B9_u6CD5"><a href="#u4F7F_u7528_GET__u65B9_u6CD5" class="headerlink" title="使用 GET 方法"></a><em>使用 GET 方法</em></h3><p>为了验证是否真的传送了数据给服务器，我写了一个 demo 页面 <a href="http://www.islinjw.cn/http_packet_demo/demo.php" target="_blank" rel="external">www.islinjw.cn/http_packet_demo/demo.php</a>。这个页面的功能很简单，就是把接收到的 GET 数据和 POST 数据通过 json 格式打印出而已：</p>
<img src="/学习HTTP协议-用socket实现http访问/4.jpg">
<p>我们首先写一个函数用来把 map 转化成 GET 方法的参数格式：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">string</span> <span class="title">MsgToString</span><span class="params">(<span class="keyword">const</span> <span class="built_in">map</span>&lt;<span class="built_in">string</span>,<span class="built_in">string</span>&gt;&amp; msg)</span></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> result = <span class="string">""</span>;</span><br><span class="line">    <span class="built_in">map</span>&lt;<span class="built_in">string</span>,<span class="built_in">string</span>&gt;::const_iterator i = msg.begin();</span><br><span class="line">    <span class="keyword">while</span>(i!=msg.end())&#123;</span><br><span class="line">        result += i-&gt;first + <span class="string">"="</span> + i-&gt;second;</span><br><span class="line">        i++;</span><br><span class="line">        <span class="keyword">if</span>(i!=msg.end())&#123;</span><br><span class="line">            result += <span class="string">"&amp;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之前提到，GET 方法的数据是通过 URL 来传递的，所以只需要把得到的 GET 方法参数拼接到请求行的 URL 后面就行了：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> url = <span class="string">"/http_packet_demo/demo.php"</span>;</span><br><span class="line">url += <span class="string">"?"</span> + MsgToString(msg);</span><br><span class="line">   <span class="built_in">cout</span>&lt;&lt;<span class="string">"url : "</span>&lt;&lt;url&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line"><span class="built_in">string</span> packet = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//请求行</span></span><br><span class="line">packet += <span class="string">"GET "</span> + url + <span class="string">" HTTP/1.1\r\n"</span>;</span><br></pre></td></tr></table></figure>
<p>其他的和刚刚讲的访问网页的方式一模一样：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestGet</span><span class="params">(<span class="keyword">const</span> <span class="built_in">map</span>&lt;<span class="built_in">string</span>,<span class="built_in">string</span>&gt;&amp; msg)</span></span>&#123;</span><br><span class="line">       <span class="comment">//连接服务器主机</span></span><br><span class="line">       SOCKET sock_client = Connect(SERVER_IP.c_str());</span><br><span class="line"></span><br><span class="line">       <span class="built_in">string</span> url = <span class="string">"/http_packet_demo/demo.php"</span>;</span><br><span class="line">       url += <span class="string">"?"</span> + MsgToString(msg);</span><br><span class="line"></span><br><span class="line">       <span class="built_in">cout</span>&lt;&lt;<span class="string">"url : "</span>&lt;&lt;url&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">       <span class="built_in">string</span> packet = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//请求行</span></span><br><span class="line">       packet += <span class="string">"GET "</span> + url + <span class="string">" HTTP/1.1\r\n"</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//请求头部</span></span><br><span class="line">       packet += <span class="string">"Host: www.baidu.com\r\n"</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//空行</span></span><br><span class="line">       packet += <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">       send(sock_client, packet.c_str(), packet.size(),<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">       PrintRecvData(sock_client);</span><br><span class="line">       Disconnect(sock_client);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>我们这样调用:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">map</span>&lt;<span class="built_in">string</span>,<span class="built_in">string</span>&gt; msg;</span><br><span class="line">msg[<span class="string">"abc"</span>] = <span class="string">"123"</span>;</span><br><span class="line">msg[<span class="string">"def"</span>] = <span class="string">"456"</span>;</span><br><span class="line"></span><br><span class="line">TestGet(msg);</span><br></pre></td></tr></table></figure>
<p>URL 长这个样子：</p>
<img src="/学习HTTP协议-用socket实现http访问/5.jpg">
<p>服务器返回的响应报文如下：：</p>
<img src="/学习HTTP协议-用socket实现http访问/6.jpg">
<h3 id="u4F7F_u7528_POST__u65B9_u6CD5"><a href="#u4F7F_u7528_POST__u65B9_u6CD5" class="headerlink" title="使用 POST 方法"></a><em>使用 POST 方法</em></h3><p>使用 POST 方法会复杂那么一点点。首先请求行没有什么特别的，就是指定了 POST 方法和我们的页面，而且 URL 没有带数据:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> url = <span class="string">"/http_packet_demo/demo.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">string</span> packet = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//请求行</span></span><br><span class="line">packet += <span class="string">"POST "</span> + url + <span class="string">" HTTP/1.1\r\n"</span>;</span><br></pre></td></tr></table></figure>
<p>但因为 POST 携带的数据不一定是字符串，有可能是图片等二进制图片，所以就需要在请求头部告诉服务器携带的数据的类型和数据的长度:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//请求头部</span></span><br><span class="line">packet += <span class="string">"Host: www.islinjw.cn\r\n"</span>;</span><br><span class="line">packet += <span class="string">"Content-Type:application/x-www-form-urlencoded\r\n"</span>; <span class="comment">//指定post传递的数据类型</span></span><br><span class="line">packet += <span class="string">"Content-Length: "</span> + ss.str() + <span class="string">"\r\n"</span>; <span class="comment">//标记post传递的数据的长度</span></span><br></pre></td></tr></table></figure>
<p>之后就是一个空行和携带了数据的请求实体了：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//空行</span></span><br><span class="line">packet += <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//post数据</span></span><br><span class="line">packet += data;</span><br></pre></td></tr></table></figure>
<p>所以整个方法长这个样子:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestPost</span><span class="params">(<span class="keyword">const</span> <span class="built_in">map</span>&lt;<span class="built_in">string</span>,<span class="built_in">string</span>&gt;&amp; msg)</span></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> data = MsgToString(msg);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">stringstream</span> ss;</span><br><span class="line">    ss&lt;&lt;data.length();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//连接服务器主机</span></span><br><span class="line">    SOCKET sock_client = Connect(SERVER_IP.c_str());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> url = <span class="string">"/http_packet_demo/demo.php"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> packet = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求行</span></span><br><span class="line">    packet += <span class="string">"POST "</span> + url + <span class="string">" HTTP/1.1\r\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求头部</span></span><br><span class="line">    packet += <span class="string">"Host: www.islinjw.cn\r\n"</span>;</span><br><span class="line">    packet += <span class="string">"Content-Type:application/x-www-form-urlencoded\r\n"</span>; <span class="comment">//指定post传递的数据类型</span></span><br><span class="line">    packet += <span class="string">"Content-Length: "</span> + ss.str() + <span class="string">"\r\n"</span>; <span class="comment">//标记post传递的数据的长度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//空行</span></span><br><span class="line">    packet += <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//post数据</span></span><br><span class="line">    packet += data;</span><br><span class="line"></span><br><span class="line">    send(sock_client, packet.c_str(), packet.size(),<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    PrintRecvData(sock_client);</span><br><span class="line">    Disconnect(sock_client);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发送的数据如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">map</span>&lt;<span class="built_in">string</span>,<span class="built_in">string</span>&gt; msg;</span><br><span class="line">msg[<span class="string">"abc"</span>] = <span class="string">"123"</span>;</span><br><span class="line">msg[<span class="string">"def"</span>] = <span class="string">"456"</span>;</span><br><span class="line"></span><br><span class="line">TestPost(msg);</span><br></pre></td></tr></table></figure>
<p>服务器返回的响应实体如下：</p>
<img src="/学习HTTP协议-用socket实现http访问/7.jpg">
<h2 id="demo__u5B8C_u6574_u4EE3_u7801"><a href="#demo__u5B8C_u6574_u4EE3_u7801" class="headerlink" title="demo 完整代码"></a><strong>demo 完整代码</strong></h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">"stdafx.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;Winsock2.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">pragma</span> comment( lib, <span class="string">"ws2_32.lib"</span> )</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">string</span> SERVER_IP = <span class="string">"182.254.231.66"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">SOCKET <span class="title">Connect</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* ip)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//固定格式</span></span><br><span class="line">    WORD wVersionRequested;</span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">    wVersionRequested = MAKEWORD( <span class="number">1</span>, <span class="number">1</span> );</span><br><span class="line"></span><br><span class="line">    err = WSAStartup( wVersionRequested, &amp;wsaData );</span><br><span class="line">    <span class="keyword">if</span> ( err != <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( LOBYTE( wsaData.wVersion ) != <span class="number">1</span> ||</span><br><span class="line">        HIBYTE( wsaData.wVersion ) != <span class="number">1</span> ) &#123;</span><br><span class="line">        WSACleanup( );</span><br><span class="line">        <span class="keyword">return</span> INVALID_SOCKET;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SOCKET sock_client=socket(AF_INET,SOCK_STREAM,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    SOCKADDR_IN addrSrv;</span><br><span class="line">    addrSrv.sin_addr.S_un.S_addr=inet_addr(ip);</span><br><span class="line">    addrSrv.sin_family=AF_INET;</span><br><span class="line">    addrSrv.sin_port=htons(<span class="number">80</span>);<span class="comment">//http端口为80</span></span><br><span class="line">    connect(sock_client,(SOCKADDR*)&amp;addrSrv,<span class="keyword">sizeof</span>(SOCKADDR));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sock_client;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Disconnect</span><span class="params">(SOCKET sock_client)</span></span>&#123;</span><br><span class="line">    closesocket(sock_client);</span><br><span class="line">    WSACleanup();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PrintRecvData</span><span class="params">(SOCKET sock_client)</span></span>&#123;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"Recv data :"</span>&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> recvBuf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">while</span>((len = recv(sock_client,recvBuf,<span class="number">1023</span>,<span class="number">0</span>))&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        recvBuf[len] = <span class="string">'\0'</span>;</span><br><span class="line">        <span class="built_in">cout</span>&lt;&lt;recvBuf;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestRequest</span><span class="params">()</span></span>&#123;</span><br><span class="line">    SOCKET sock_client = Connect(SERVER_IP.c_str());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//最后必须多一个空行（\n），要不然会阻塞住</span></span><br><span class="line">    <span class="comment">//这个空行其实是报文首部和报文主体的分割符号，但这里请求不需要报文主体，所以是请求报文的结束</span></span><br><span class="line">    <span class="comment">//string data = "GET / HTTP/1.1\r\nHost: www.islinjw.cn\r\n";</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//HOST也是必须的，要不然能接收到数据，但服务器返回302、400这样的错误代码</span></span><br><span class="line">    <span class="comment">//原因是服务器可能使用了虚拟服务器技术，一台服务器托管了多个网站，即多个网站通过dns解析到同样的ip地址</span></span><br><span class="line">    <span class="comment">//所以在发送http请求时必须带上HOST</span></span><br><span class="line">    <span class="comment">//string data = "GET / HTTP/1.1\r\n\n";</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> data = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求行</span></span><br><span class="line">    data += <span class="string">"GET / HTTP/1.1\r\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求头部</span></span><br><span class="line">    data += <span class="string">"Host: www.islinjw.cn\r\n\n"</span>;</span><br><span class="line"></span><br><span class="line">    send(sock_client,data.c_str(),data.size(),<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    PrintRecvData(sock_client);</span><br><span class="line">    Disconnect(sock_client);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="built_in">string</span> <span class="title">MsgToString</span><span class="params">(<span class="keyword">const</span> <span class="built_in">map</span>&lt;<span class="built_in">string</span>,<span class="built_in">string</span>&gt;&amp; msg)</span></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> result = <span class="string">""</span>;</span><br><span class="line">    <span class="built_in">map</span>&lt;<span class="built_in">string</span>,<span class="built_in">string</span>&gt;::const_iterator i = msg.begin();</span><br><span class="line">    <span class="keyword">while</span>(i!=msg.end())&#123;</span><br><span class="line">        result += i-&gt;first + <span class="string">"="</span> + i-&gt;second;</span><br><span class="line">        i++;</span><br><span class="line">        <span class="keyword">if</span>(i!=msg.end())&#123;</span><br><span class="line">            result += <span class="string">"&amp;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestGet</span><span class="params">(<span class="keyword">const</span> <span class="built_in">map</span>&lt;<span class="built_in">string</span>,<span class="built_in">string</span>&gt;&amp; msg)</span></span>&#123;</span><br><span class="line">    <span class="comment">//连接服务器主机</span></span><br><span class="line">    SOCKET sock_client = Connect(SERVER_IP.c_str());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> url = <span class="string">"/http_packet_demo/demo.php"</span>;</span><br><span class="line">    url += <span class="string">"?"</span> + MsgToString(msg);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"url : "</span>&lt;&lt;url&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> packet = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求行</span></span><br><span class="line">    packet += <span class="string">"GET "</span> + url + <span class="string">" HTTP/1.1\r\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求头部</span></span><br><span class="line">    packet += <span class="string">"Host: www.baidu.com\r\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//空行</span></span><br><span class="line">    packet += <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">    send(sock_client, packet.c_str(), packet.size(),<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    PrintRecvData(sock_client);</span><br><span class="line">    Disconnect(sock_client);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TestPost</span><span class="params">(<span class="keyword">const</span> <span class="built_in">map</span>&lt;<span class="built_in">string</span>,<span class="built_in">string</span>&gt;&amp; msg)</span></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> data = MsgToString(msg);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">stringstream</span> ss;</span><br><span class="line">    ss&lt;&lt;data.length();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//连接服务器主机</span></span><br><span class="line">    SOCKET sock_client = Connect(SERVER_IP.c_str());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> url = <span class="string">"/http_packet_demo/demo.php"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> packet = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求行</span></span><br><span class="line">    packet += <span class="string">"POST "</span> + url + <span class="string">" HTTP/1.1\r\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//请求头部</span></span><br><span class="line">    packet += <span class="string">"Host: www.islinjw.cn\r\n"</span>;</span><br><span class="line">    packet += <span class="string">"Content-Type:application/x-www-form-urlencoded\r\n"</span>; <span class="comment">//指定post传递的数据类型</span></span><br><span class="line">    packet += <span class="string">"Content-Length: "</span> + ss.str() + <span class="string">"\r\n"</span>; <span class="comment">//标记post传递的数据的长度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//空行</span></span><br><span class="line">    packet += <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//post数据</span></span><br><span class="line">    packet += data;</span><br><span class="line"></span><br><span class="line">    send(sock_client, packet.c_str(), packet.size(),<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    PrintRecvData(sock_client);</span><br><span class="line">    Disconnect(sock_client);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="built_in">map</span>&lt;<span class="built_in">string</span>,<span class="built_in">string</span>&gt; msg;</span><br><span class="line">    msg[<span class="string">"abc"</span>] = <span class="string">"123"</span>;</span><br><span class="line">    msg[<span class="string">"def"</span>] = <span class="string">"456"</span>;</span><br><span class="line"></span><br><span class="line">    TestRequest();</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"\n\n\n"</span>&lt;&lt;endl;</span><br><span class="line">    TestGet(msg);</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"\n\n\n"</span>&lt;&lt;endl;</span><br><span class="line">    TestPost(msg);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Http协议/">Http协议</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/技术相关/">技术相关</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-学习HTTP协议-在安卓上的使用Cookie与Session" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/03/03/学习HTTP协议-在安卓上的使用Cookie与Session/" class="article-date">
  	<time datetime="2016-03-03T12:43:26.000Z" itemprop="datePublished">2016-03-03</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/03/学习HTTP协议-在安卓上的使用Cookie与Session/">学习HTTP协议-在安卓上的使用Cookie与Session</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>大三的时候写过一段时间的 php ，那时候已经对 html、css、js、cookie、session 这些东西了一点认知，但基本都是浮于表面，知其然而不知其所以然。于是这几天翻了翻《图解http》，书上的知识和自己的以前的理解结合起来，感觉对于 http 协议有了一些比较深刻的理解。</p>
<p>在这里把那些知识点整理记录一下，而因为 HTTP 协议的知识点较多，所以会有一个系列的博客去介绍。这篇文章就先讲一下 Cookie 和 Session 吧。</p>
<h2 id="Cookie__26amp_3B_Session"><a href="#Cookie__26amp_3B_Session" class="headerlink" title="Cookie &amp; Session"></a><strong>Cookie &amp; Session</strong></h2><p>毕业设计有个功能是实现用户的注册登录，而注册账号的时候需要有输入验证码的功能。</p>
<p>众所周知，HTTP 协议是无状态协议，即协议对于事务处理没有记忆能力。但就像这里，我们需要实现一个验证码功能，我们从服务器获取验证码的图片，然后再将用户输入的验证码传回服务器进行对比，这就要求服务器记录之前随机生成的验证码了。于是，两种用于保持HTTP连接状态的技术就应运而生了，一个是 Cookie，而另一个则是 Session。</p>
<h3 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a><em>Cookie</em></h3><p>Cookie 是由服务器端生成，发送给 User-Agent（一般是浏览器），浏览器会将 Cookie 的 key/value 保存到某个目录下的文本文件内，下次请求同一网站时就发送该 Cookie 给服务器（前提是浏览器设置为启用 cookie ）。</p>
<p>我们可以在 chrome 浏览器页面按 F12 打开控制台，选择 Network 标签查看与网站进行 HTTP 协议交流的数据。</p>
<p>这里我们看看登录<a href="http://www.bilibili.tv" target="_blank" rel="external">B站</a>的时候究竟发生了什么事情：</p>
<p>首先我们输入账号密码和验证码之后点击登陆，浏览器会发生账号密码等数据给服务器,之后服务器返回数据。我们查看返回报文的 header 可以看到一堆的 Set-Cookie 字段：</p>
<img src="/学习HTTP协议-在安卓上的使用Cookie与Session/1.jpg">
<p>客户端会把这些 cookie 记录下来，在下次访问服务器的时候就会把它们传回给服务器，这样就能实现数据的保持：</p>
<img src="/学习HTTP协议-在安卓上的使用Cookie与Session/2.jpg">
<h3 id="Session"><a href="#Session" class="headerlink" title="Session"></a><em>Session</em></h3><p>但 Cookie 的数据都是保存在客户端的，客户端很容易就能查看和修改 cookie，十分不安全。例如 chrome 有一个 EditThisCookie 插件，就能直接查看修改网页的 cookie：</p>
<img src="/学习HTTP协议-在安卓上的使用Cookie与Session/3.jpg">
<p>所以就有了存放在服务器端的内存中的 sessio，session可以看作一个存放在服务器的键值对集。</p>
<p>当服务器创建一个 session 对象的时候，就会对应的生成一个sessionId，服务器可以在 session 中写入数据，但它不会将session 的内容告诉客户端，它只会将生成的 sessionId 以 cookie 的方式传给客户端，而客户端在下次访问服务器的时候把 sessionId 又传回给服务器，这样服务器就能找到之前保存的数据了。</p>
<p>在 php 中这个 sessionid 的名字默认叫做 PHPSESSID，当然也能在php.ini中修改。</p>
<p>因为 session 保存在服务器中，所以安全性比 cookie 高的多。</p>
<p>关于 Cookie 和 Session，各位有兴趣的话可以自己去网上搜索一下，或者希望对 HTTP 协议有更深入的理解的话可以去读一下《图解http》。最近就在读这本书，等读完我会写一篇博客，介绍一些 HTTP 协议的重点知识，这里就不再多说了。</p>
<h2 id="okHttp3__u4F7F_u7528_Cookie"><a href="#okHttp3__u4F7F_u7528_Cookie" class="headerlink" title="okHttp3 使用 Cookie"></a><strong>okHttp3 使用 Cookie</strong></h2><p>okHttp3 的 cookie 管理方式对比 okHttp2 有了很大的变化，这里有一篇博客专门介绍<a href="http://www.codeceo.com/article/okhttp3-cookies-manage.html" target="_blank" rel="external">OkHttp3实现Cookies管理及持久化</a>。希望各位在读我这篇博客之前先浏览一下。</p>
<p>okHttp3 使用 CookieJar 接口来管理 Cookie：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CookieJar</span> </span>&#123;</span><br><span class="line"> 	<span class="comment">/** A cookie jar that never accepts any cookies. */</span></span><br><span class="line"> 	CookieJar NO_COOKIES = <span class="keyword">new</span> CookieJar() &#123;</span><br><span class="line">   <span class="annotation">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveFromResponse</span><span class="params">(HttpUrl url, List&lt;Cookie&gt; cookies)</span> </span>&#123;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="annotation">@Override</span> <span class="function"><span class="keyword">public</span> List&lt;Cookie&gt; <span class="title">loadForRequest</span><span class="params">(HttpUrl url)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">   &#125;</span><br><span class="line"> 	&#125;;</span><br></pre></td></tr></table></figure>
<p>我们只要在创建 OkHttpClient 的时候指定我们自己的 CookieJar 就能让 OkHttpClient 实现 Cookie 的自动管理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">   	<span class="keyword">private</span> Map&lt;String, List&lt;Cookie&gt;&gt; mCookieStore;</span><br><span class="line">       ...</span><br><span class="line">       <span class="function"><span class="keyword">private</span> OkHttpClient <span class="title">createHttpClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           CookieJar cookieJar = <span class="keyword">new</span> CookieJar() &#123;</span><br><span class="line">               <span class="annotation">@Override</span></span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveFromResponse</span><span class="params">(HttpUrl url, List&lt;Cookie&gt; cookies)</span> </span>&#123;</span><br><span class="line">                   mCookieStore.put(url.host(), cookies);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="annotation">@Override</span></span><br><span class="line">               <span class="function"><span class="keyword">public</span> List&lt;Cookie&gt; <span class="title">loadForRequest</span><span class="params">(HttpUrl url)</span> </span>&#123;</span><br><span class="line">                   List list = mCookieStore.get(url.host());</span><br><span class="line">                   <span class="keyword">return</span> list != <span class="keyword">null</span> ? list : <span class="keyword">new</span> ArrayList&lt;Cookie&gt;();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> OkHttpClient.Builder()</span><br><span class="line">                   .cookieJar(cookieJar)</span><br><span class="line">                   .build();</span><br><span class="line">       &#125;</span><br><span class="line">       ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有点要注意，我们是拿 host 作 map 的 key 值，<a href="http://www.codeceo.com/article/okhttp3-cookies-manage.html" target="_blank" rel="external">《OkHttp3实现Cookies管理及持久化》</a>这篇博文直接用 url 当 key 值，这样的话该 Cookie 就只能在当前页面可用了，而我们是整个网站可用。</p>
<h2 id="Retrofit__u4F7F_u7528_Cookie"><a href="#Retrofit__u4F7F_u7528_Cookie" class="headerlink" title="Retrofit 使用 Cookie"></a><strong>Retrofit 使用 Cookie</strong></h2><p>在 Retrofit 中使用 Cookie 就更加简单了，因为它内部使用 OkHttp3，只要把之前设置了 CookieJar 的 OkHttpClient 设置给它就可以了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HttpService service = <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line">               .client(mHttpClient) <span class="comment">//OkHttpClient 指定了 CookieJar，这样 Retrofit 也能使用 Cookie 了</span></span><br><span class="line">               .baseUrl(mBaseUrl)</span><br><span class="line">               .addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">               .build()</span><br><span class="line">               .create(HttpService.class);</span><br></pre></td></tr></table></figure>
<h2 id="u9A8C_u8BC1_u7801_u5C0F_Demo"><a href="#u9A8C_u8BC1_u7801_u5C0F_Demo" class="headerlink" title="验证码小 Demo"></a><strong>验证码小 Demo</strong></h2><p>现状我们用一个实现了验证码功能的小 Demo 来更加深刻的理解之前所讲的知识。</p>
<p>首先我写了两个页面：</p>
<ul>
<li>生成验证码的页面 ： <a href="http://www.islinjw.cn/okhttp_cookie_demo/verifycode.php" target="_blank" rel="external">http://www.islinjw.cn/okhttp_cookie_demo/verifycode.php</a></li>
<li>检查验证码的页面 ： <a href="http://www.islinjw.cn/okhttp_cookie_demo/checkverifycode.php" target="_blank" rel="external">http://www.islinjw.cn/okhttp_cookie_demo/checkverifycode.php</a></li>
</ul>
<p>访问第一个页面能获得一张随机的验证码图片，而第二个页面使用 GET 方法来检测验证码（键值为 verifycode）。</p>
<h3 id="u83B7_u53D6_u9A8C_u8BC1_u7801_u56FE_u7247"><a href="#u83B7_u53D6_u9A8C_u8BC1_u7801_u56FE_u7247" class="headerlink" title="获取验证码图片"></a><em>获取验证码图片</em></h3><p>首先我们使用 OkHttp3 访问第一个页面，下载一张验证码图片，将它显示在 ImageView 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadVerifyCode</span><span class="params">(<span class="keyword">final</span> ImageView imageView, <span class="keyword">final</span> HttpUrl url)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">               .url(url)</span><br><span class="line">               .build();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">           <span class="annotation">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   okhttp3.Response response = mHttpClient.newCall(request).execute();</span><br><span class="line"></span><br><span class="line">                   <span class="comment">//创建bitmap</span></span><br><span class="line">                   InputStream is = response.body().byteStream();</span><br><span class="line">                   <span class="keyword">final</span> Bitmap bm = BitmapFactory.decodeStream(is);</span><br><span class="line"></span><br><span class="line">                   <span class="comment">//加载到ImageView中</span></span><br><span class="line">                   runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                       <span class="annotation">@Override</span></span><br><span class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                           imageView.setImageBitmap(bm);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;);</span><br><span class="line"></span><br><span class="line">                   <span class="comment">//打印cookie信息</span></span><br><span class="line">                   List&lt;Cookie&gt; cookies = Cookie.parseAll(request.url(), response.headers());</span><br><span class="line">                   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cookies.size(); i++) &#123;</span><br><span class="line">                       Log.d(<span class="string">"cookie"</span>, <span class="string">"request headers: "</span> + cookies.get(i).toString());</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                   e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;).start();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>运行程序可以看到验证码被显示出来：</p>
<img src="/学习HTTP协议-在安卓上的使用Cookie与Session/5.jpg">
<p>我们还能能看到服务器返回的 Cookie 信息，因为我的网页使用 php 写的，所以它返回了一个 PHPSESSID ，用来标记服务器保存的 Session 对象。服务器的 Session 对象里面就保存了验证码的值。之后我们把用户输入的验证码传会服务器的时候只要把这个 PHPSESSID 一同传过去，服务器就能找到之前生成的验证码的值，并和用户所输入的进行对比了:</p>
<img src="/学习HTTP协议-在安卓上的使用Cookie与Session/6.jpg">
<h3 id="u53D1_u9001_u7528_u6237_u8F93_u5165_u7684_u9A8C_u8BC1_u7801"><a href="#u53D1_u9001_u7528_u6237_u8F93_u5165_u7684_u9A8C_u8BC1_u7801" class="headerlink" title="发送用户输入的验证码"></a><em>发送用户输入的验证码</em></h3><p>这里我们直接使用 Retrofit 将用户输入的验证码传给服务器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">       HttpService service = <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line">               .client(mHttpClient)  <span class="comment">//OkHttpClient 指定了 CookieJar，这样 Retrofit 也能使用 Cookie 了</span></span><br><span class="line">               .baseUrl(mBaseUrl)</span><br><span class="line">               .addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">               .build()</span><br><span class="line">               .create(HttpService.class);</span><br><span class="line"></span><br><span class="line">       String verifyCode = mEditText.getText().toString();</span><br><span class="line">       <span class="keyword">if</span> (verifyCode == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       Call&lt;VerifyCodeResult&gt; call = service.getResult(verifyCode);</span><br><span class="line">       call.enqueue(<span class="keyword">new</span> Callback&lt;VerifyCodeResult&gt;() &#123;</span><br><span class="line">           <span class="annotation">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;VerifyCodeResult&gt; call, Response&lt;VerifyCodeResult&gt; response)</span> </span>&#123;</span><br><span class="line">               Log.d(<span class="string">"cookie"</span>, <span class="string">"request headers: "</span> + call.request().headers().toString());</span><br><span class="line">               Toast.makeText(MainActivity.<span class="keyword">this</span>, response.body().getResult(), Toast.LENGTH_SHORT).show();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="annotation">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call&lt;VerifyCodeResult&gt; call, Throwable t)</span> </span>&#123;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HttpService</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@GET</span>(<span class="string">"okhttp_cookie_demo/checkverifycode.php"</span>)</span><br><span class="line">    <span class="function">Call&lt;VerifyCodeResult&gt; <span class="title">getResult</span><span class="params">(@Query(<span class="string">"verifycode"</span>)</span> String yam)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VerifyCodeResult</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String result;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResult</span><span class="params">(String result)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.result = result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行程序，输入验证码可以看到结果：</p>
<img src="/学习HTTP协议-在安卓上的使用Cookie与Session/7.jpg">
<img src="/学习HTTP协议-在安卓上的使用Cookie与Session/8.jpg">
<p>程序正常运行，但看 log 输出，Request 并没有把 PHPSESSID 传过去。这是怎么回事？没有传 PHPSESSID，服务器又怎么能知道之前生成的验证码是什么？</p>
<img src="/学习HTTP协议-在安卓上的使用Cookie与Session/9.jpg">
<p>在 CookieJar 的 loadForRequest 方法设置断点，可以发现在发送验证码的时候确实有调用，随之运行到 HttpEngine 的源码，发现原来框架创建了个新的 Resquest 副本，将 Cookie 传入这个新的副本中去连接服务器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendRequest</span><span class="params">()</span> <span class="keyword">throws</span> RequestException, RouteException, IOException </span>&#123;</span><br><span class="line">       ...</span><br><span class="line">       Request request = networkRequest(userRequest);</span><br><span class="line">	...</span><br><span class="line">   &#125;</span><br><span class="line">...</span><br><span class="line">   <span class="function"><span class="keyword">private</span> Request <span class="title">networkRequest</span><span class="params">(Request request)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">       Request.Builder result = request.newBuilder();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (request.header(<span class="string">"Host"</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">         result.header(<span class="string">"Host"</span>, hostHeader(request.url()));</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (request.header(<span class="string">"Connection"</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">         result.header(<span class="string">"Connection"</span>, <span class="string">"Keep-Alive"</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (request.header(<span class="string">"Accept-Encoding"</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">         transparentGzip = <span class="keyword">true</span>;</span><br><span class="line">         result.header(<span class="string">"Accept-Encoding"</span>, <span class="string">"gzip"</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//看这里，其实是有设置 CookieJar 中的 Cookie 的</span></span><br><span class="line">       <span class="comment">//也就是说 PHPSESSID 有传回去给服务器</span></span><br><span class="line">       List&lt;Cookie&gt; cookies = client.cookieJar().loadForRequest(request.url());</span><br><span class="line">       <span class="keyword">if</span> (!cookies.isEmpty()) &#123;</span><br><span class="line">         result.header(<span class="string">"Cookie"</span>, cookieHeader(cookies));</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (request.header(<span class="string">"User-Agent"</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">         result.header(<span class="string">"User-Agent"</span>, Version.userAgent());</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> result.build();</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<p>原来如此，操作都使用了副本 Request 去执行，怪不得我们直接用下面的代码输出，请求头部不能看到 PHPSESSID 的 Cookie 值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;VerifyCodeResult&gt; call, Response&lt;VerifyCodeResult&gt; response)</span> </span>&#123;</span><br><span class="line">       Log.d(<span class="string">"cookie"</span>, <span class="string">"request headers: "</span> + call.request().headers().toString());</span><br><span class="line">       Toast.makeText(MainActivity.<span class="keyword">this</span>, response.body().getResult(), Toast.LENGTH_SHORT).show();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Glide__u4F7F_u7528_Cookie"><a href="#Glide__u4F7F_u7528_Cookie" class="headerlink" title="Glide 使用 Cookie"></a><strong>Glide 使用 Cookie</strong></h2><p>Glide 是Google推荐的图片加载库，用来加载图片十分之方便，最少只需要三行代码就能将网络图片加载到 ImageView 上。</p>
<p>我有在 Glide 的文档上看到它也能使用 OkHttp3，理论上应该也能使用设置 OkHttpClient 的方法使用 Cookie。</p>
<p>但弄了很久还是没有搞定，等以后有时间找到实现方法再把这一节补全。</p>
<h2 id="Demo__u5B8C_u6574_u4EE3_u7801"><a href="#Demo__u5B8C_u6574_u4EE3_u7801" class="headerlink" title="Demo 完整代码"></a><strong>Demo 完整代码</strong></h2><p>MainActivity:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String mBaseUrl = <span class="string">"http://www.islinjw.cn"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String mVerifyCideUrl = <span class="string">"http://www.islinjw.cn/okhttp_cookie_demo/verifycode.php"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> OkHttpClient mHttpClient;</span><br><span class="line">    <span class="keyword">private</span> EditText mEditText;</span><br><span class="line">    <span class="keyword">private</span> ImageView mImageView;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, List&lt;Cookie&gt;&gt; mCookieStore;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        mEditText = (EditText) findViewById(R.id.input);</span><br><span class="line">        mImageView = (ImageView) findViewById(R.id.yzm);</span><br><span class="line">        mCookieStore = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        mHttpClient = createHttpClient();</span><br><span class="line"></span><br><span class="line">        loadVerifyCode(mImageView, HttpUrl.parse(mVerifyCideUrl));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> OkHttpClient <span class="title">createHttpClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CookieJar cookieJar = <span class="keyword">new</span> CookieJar() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveFromResponse</span><span class="params">(HttpUrl url, List&lt;Cookie&gt; cookies)</span> </span>&#123;</span><br><span class="line">                mCookieStore.put(url.host(), cookies);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> List&lt;Cookie&gt; <span class="title">loadForRequest</span><span class="params">(HttpUrl url)</span> </span>&#123;</span><br><span class="line">                List list = mCookieStore.get(url.host());</span><br><span class="line">                <span class="keyword">return</span> list != <span class="keyword">null</span> ? list : <span class="keyword">new</span> ArrayList&lt;Cookie&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OkHttpClient.Builder()</span><br><span class="line">                .cookieJar(cookieJar)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadVerifyCode</span><span class="params">(<span class="keyword">final</span> ImageView imageView, <span class="keyword">final</span> HttpUrl url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">                .url(url)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    okhttp3.Response response = mHttpClient.newCall(request).execute();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//创建bitmap</span></span><br><span class="line">                    InputStream is = response.body().byteStream();</span><br><span class="line">                    <span class="keyword">final</span> Bitmap bm = BitmapFactory.decodeStream(is);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//加载到ImageView中</span></span><br><span class="line">                    runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                        <span class="annotation">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            imageView.setImageBitmap(bm);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//打印cookie信息</span></span><br><span class="line">                    List&lt;Cookie&gt; cookies = Cookie.parseAll(request.url(), response.headers());</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cookies.size(); i++) &#123;</span><br><span class="line">                        Log.d(<span class="string">"cookie"</span>, <span class="string">"response headers: "</span> + cookies.get(i).toString());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        HttpService service = <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line">                .client(mHttpClient)  <span class="comment">//OkHttpClient 指定了 CookieJar，这样 Retrofit 也能使用 Cookie 了</span></span><br><span class="line">                .baseUrl(mBaseUrl)</span><br><span class="line">                .addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">                .build()</span><br><span class="line">                .create(HttpService.class);</span><br><span class="line"></span><br><span class="line">        String verifyCode = mEditText.getText().toString();</span><br><span class="line">        <span class="keyword">if</span> (verifyCode == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Call&lt;VerifyCodeResult&gt; call = service.getResult(verifyCode);</span><br><span class="line">        call.enqueue(<span class="keyword">new</span> Callback&lt;VerifyCodeResult&gt;() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;VerifyCodeResult&gt; call, Response&lt;VerifyCodeResult&gt; response)</span> </span>&#123;</span><br><span class="line">                Log.d(<span class="string">"cookie"</span>, <span class="string">"request headers: "</span> + call.request().headers().toString());</span><br><span class="line">                Toast.makeText(MainActivity.<span class="keyword">this</span>, response.body().getResult(), Toast.LENGTH_SHORT).show();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call&lt;VerifyCodeResult&gt; call, Throwable t)</span> </span>&#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>HttpService:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HttpService</span> </span>&#123;</span><br><span class="line">       <span class="annotation">@GET</span>(<span class="string">"okhttp_cookie_demo/checkverifycode.php"</span>)</span><br><span class="line">       <span class="function">Call&lt;VerifyCodeResult&gt; <span class="title">getResult</span><span class="params">(@Query(<span class="string">"verifycode"</span>)</span> String yam)</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VerifyCodeResult</span> </span>&#123;</span><br><span class="line">       <span class="keyword">private</span> String result;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> String <span class="title">getResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> result;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResult</span><span class="params">(String result)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">this</span>.result = result;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Http协议/">Http协议</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/技术相关/">技术相关</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Retrofit-学习笔记" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/02/22/Retrofit-学习笔记/" class="article-date">
  	<time datetime="2016-02-22T08:19:56.000Z" itemprop="datePublished">2016-02-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/22/Retrofit-学习笔记/">Retrofit 学习笔记</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>工欲善其事必先利其器，使用一些强大方便的器，可以大大的提高开发的效率，我认为 Retrofit 和 RxJava 就是这样的利器。</p>
<p>Retrofit 是一个开源的 java http 请求库，目前已经更新到 2.0.0-beta4，官方的介绍是：</p>
<blockquote>
<p>Type-safe HTTP client for Android and Java by Square, Inc.</p>
</blockquote>
<p>我在学习它的过程中遇到了不少问题，于是写了这篇东西把遇到的问题和解决方法都记录一下。</p>
<h2 id="android_studio__u5BFC_u5165_Retrofit"><a href="#android_studio__u5BFC_u5165_Retrofit" class="headerlink" title="android studio 导入 Retrofit"></a><strong>android studio 导入 Retrofit</strong></h2><p>首先我使用的是 android studio，一开始搜索怎样使用第三方库的时候看到了不少的文章，有介绍导入 jar 包的，有介绍源码库的，但使用方法和我接下来介绍的都显得复杂很多。</p>
<p>比如现在我们要使用 Retrofit ，先登录 <a href="http://search.maven.org/" target="_blank" rel="external">http://search.maven.org/</a>，搜索 Retrofit 我们可以看到搜出了不少东西，我们直接用最新的版本 2.0.0-beta4，可以看到它有两个版本，点进去看看：</p>
<img src="/Retrofit-学习笔记/1.jpg">
<p>原来一个是beta3，一个是beta4：</p>
<img src="/Retrofit-学习笔记/2.jpg">
<p>然后我们打开 android studio 项目的 build.gradle(Module: app)， 在它的 dependencies 里面加上  retrofit 的引用:</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="keyword">compile</span> <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">include</span>: [<span class="string">'*.jar'</span>])</span><br><span class="line">    testCompile <span class="string">'junit:junit:4.12'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.android.support:appcompat-v7:23.1.1'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.squareup.retrofit2:retrofit:2.0.0-beta4'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要使用 <a href="http://search.maven.org/" target="_blank" rel="external">http://search.maven.org/</a>，搜索到的第三方库只需要在 dependencies 里面加上</p>
<blockquote>
<p>compile ‘GroupId:ArtifactId:Version’</p>
</blockquote>
<p>对应 retrofit 就是这句：</p>
<blockquote>
<p>compile ‘com.squareup.retrofit2:retrofit:2.0.0-beta4’</p>
</blockquote>
<p>再点击 android studio 弹出的 Sync Now，android studio 就会帮你自动下载和配置第三方库，而你就能直接使用了。</p>
<img src="/Retrofit-学习笔记/3.jpg">
<h2 id="u4F7F_u7528_Retrofit__u7684_Call__u7C7B_u83B7_u53D6_github__u7528_u6237_u7684_u4FE1_u606F"><a href="#u4F7F_u7528_Retrofit__u7684_Call__u7C7B_u83B7_u53D6_github__u7528_u6237_u7684_u4FE1_u606F" class="headerlink" title="使用 Retrofit 的 Call 类获取 github 用户的信息"></a><strong>使用 Retrofit 的 Call 类获取 github 用户的信息</strong></h2><p>官方文档一开始就展示了一个简单的demo <a href="http://square.github.io/retrofit/" target="_blank" rel="external">http://square.github.io/retrofit/</a></p>
<p>可惜都是代码碎片，你按照它写好代码之后就会发现……报异常了。</p>
<img src="/Retrofit-学习笔记/4.jpg">
<img src="/Retrofit-学习笔记/5.jpg">
<p>我先把讲讲我写的demo，最后再告诉你们官方文档到底哪里出问题了。</p>
<p>首先定义一个 User 类用于保存获取到的用户信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String login;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"login:"</span> + login + <span class="string">", "</span></span><br><span class="line">                + <span class="string">"id:"</span> + id + <span class="string">", "</span></span><br><span class="line">                + <span class="string">"name:"</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLogin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> login;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLogin</span><span class="params">(String login)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.login = login;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着定义一个接口用于告诉 Retrofit 怎样去获取数据，如下代码就表明使用 get 方法获取 users 路径下的 user 资源，使用的最终使用的时候，传入的 user 参数会替换 users/{user} 的 {user} 字段。</p>
<p>不过我还真不知道它这里到底是怎么实现的，看来 java 基础还真要去补一补才行了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GitHubService</span> </span>&#123;</span><br><span class="line">       <span class="annotation">@GET</span>(<span class="string">"users/&#123;user&#125;"</span>)</span><br><span class="line">       <span class="function">Call&lt;User&gt; <span class="title">getUserInfoByCall</span><span class="params">(@Path(<span class="string">"user"</span>)</span> String user)</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>之后就可以创建一个 GitHubService 实例了（我总觉得有点 java 黑魔法的感觉）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GitHubService service = <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line">               .baseUrl(<span class="string">"https://api.github.com"</span>)</span><br><span class="line">               .addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">               .build()</span><br><span class="line">               .create(GitHubService.class);</span><br></pre></td></tr></table></figure>
<p>然后调用 service 的 getUserInfoByCall 方法就能获取到一个 Call 对象了。像如下的代码，就能获取到一个用于访问 <a href="https://api.github.com/users/bluesky466" target="_blank" rel="external">https://api.github.com/users/bluesky466</a> 的 Call 对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Call&lt;User&gt; call = service.getUserInfoByCall(<span class="string">"bluesky466"</span>);</span><br></pre></td></tr></table></figure>
<p>最后就能用 call 的 execute 方法访问服务器获取用户数据了。因为 execute 是同步的，而安卓不允许在 ui 线程访问网络，所以我们需要用一个子线程去访问。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Response&lt;User&gt; response = call.execute();</span><br><span class="line">                    User user = response.body();</span><br><span class="line">                    Log.d(<span class="string">"result"</span>, user.toString());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<img src="/Retrofit-学习笔记/6.jpg">
<p>当然，Retrofit 也提供了异步访问的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">call.enqueue(<span class="keyword">new</span> Callback&lt;User&gt;() &#123;</span><br><span class="line">           <span class="annotation">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;User&gt; call, Response&lt;User&gt; response)</span> </span>&#123;</span><br><span class="line">               User user = response.body();</span><br><span class="line">           	Log.d(<span class="string">"result"</span>, user.toString());</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="annotation">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call&lt;User&gt; call, Throwable t)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br></pre></td></tr></table></figure>
<p>Retrofit 用获取到的数据生成了一个User对象。这是什么黑魔法？</p>
<p>还记得我一开始说的按照官方文档的代码会报异常吗？</p>
<p>官方文档的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line">    .baseUrl(<span class="string">"https://api.github.com"</span>)</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line">GitHubService service = retrofit.create(GitHubService.class);</span><br></pre></td></tr></table></figure>
<p>我的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GitHubService service = <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line">                    .baseUrl(<span class="string">"https://api.github.com"</span>)</span><br><span class="line">                    .addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">                    .build()</span><br><span class="line">                    .create(GitHubService.class);</span><br></pre></td></tr></table></figure>
<p>差别就在在这里：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.<span class="function"><span class="title">addConverterFactory</span><span class="params">(GsonConverterFactory.create()</span></span>)</span><br></pre></td></tr></table></figure>
<p>我这里指定了一个 Gson 转换工厂，因为 <a href="https://api.github.com" target="_blank" rel="external">https://api.github.com</a> 使用josn 格式返回数据，所以我们可以使用 Gson 去解析它，然后生成一个 User 对象。</p>
<p>不过就算你按我这样写代码又会发现找不到 GsonConverterFactory 的包……</p>
<img src="/Retrofit-学习笔记/7.jpg">
<p>原因在于 GsonConverterFactory 使用来转换json的，你也可以指定其他的 Factory 去转换 xml 之类的格式。而这些 Factory 并不包含在 Retrofit 库里面，需要用户自己去导入。</p>
<img src="/Retrofit-学习笔记/8.jpg">
<p>在 dependencies 中加入：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">compile</span> <span class="string">'com.squareup.retrofit2:converter-gson:2.0.0-beta4'</span></span><br></pre></td></tr></table></figure>
<p>类似的库有下面这些：</p>
<ul>
<li><strong>Gson</strong>: com.squareup.retrofit2:converter-gson</li>
<li><strong>Jackson</strong>: com.squareup.retrofit2:converter-jackson</li>
<li><strong>Moshi</strong>: com.squareup.retrofit2:converter-moshi</li>
<li><strong>Protobuf</strong>: com.squareup.retrofit2:converter-protobuf</li>
<li><strong>Wire</strong>: com.squareup.retrofit2:converter-wire</li>
<li><strong>Simple</strong> XML: com.squareup.retrofit2:converter-simplexml</li>
<li><strong>Scalars</strong> (primitives, boxed, and String): com.squareup.retrofit2:converter-scalars</li>
</ul>
<h2 id="u4F7F_u7528_Retrofit__u914D_u5408_RxJava__u83B7_u53D6_github__u7528_u6237_u7684_u4FE1_u606F"><a href="#u4F7F_u7528_Retrofit__u914D_u5408_RxJava__u83B7_u53D6_github__u7528_u6237_u7684_u4FE1_u606F" class="headerlink" title="使用 Retrofit 配合 RxJava 获取 github 用户的信息"></a><strong>使用 Retrofit 配合 RxJava 获取 github 用户的信息</strong></h2><p>RxJava 在 GitHub 主页上的自我介绍是 “a library for composing asynchronous and event-based programs using observable sequences for the Java VM”（一个在 Java VM 上使用可观测的序列来组成异步的、基于事件的程序的库）。这就是 RxJava ，概括得非常精准。</p>
<p>它可以用来替换 AsyncTask 之类的东西。</p>
<p>关于 RxJava 有一篇很好的博客 – <a href="http://gank.io/post/560e15be2dca930e00da1083" target="_blank" rel="external">给 Android 开发者的 RxJava 详解</a>。这里基本上把 RxJava 讲的很透彻了。我这里就不多说，只是讲一讲怎样在 Retrofit 中使用 RxJava。</p>
<p>在 Retrofit 中使用 RxJava 首先需要导入 adapter-rxjava 库，而且因为是在安卓上使用，所以需要导入 RxJava 的 Android 平台的扩展 rxandroid 库：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">compile</span> <span class="string">'com.squareup.retrofit2:adapter-rxjava:2.0.0-beta4</span><br><span class="line">   compile '</span>io.reactivex:rxandroid:<span class="number">1</span>.<span class="number">1</span>.<span class="number">0</span><span class="string">'</span></span><br></pre></td></tr></table></figure>
<p>添加 GitHubService 接口的 RxJava 获取方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GitHubService</span> </span>&#123;</span><br><span class="line">        <span class="annotation">@GET</span>(<span class="string">"users/&#123;user&#125;"</span>)</span><br><span class="line">        <span class="function">Call&lt;User&gt; <span class="title">getUserInfoByCall</span><span class="params">(@Path(<span class="string">"user"</span>)</span> String user)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@GET</span>(<span class="string">"users/&#123;user&#125;"</span>)</span><br><span class="line">        <span class="function">Observable&lt;User&gt; <span class="title">getUserInfoByObservable</span><span class="params">(@Path(<span class="string">"user"</span>)</span> String user)</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>然后创建 GitHubService 的时候需要指定 RxJava的适配工厂：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GitHubService service = <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line">               .baseUrl(<span class="string">"https://api.github.com"</span>)</span><br><span class="line">               .addConverterFactory(GsonConverterFactory.create())<span class="comment">//指定RxJava适配工厂</span></span><br><span class="line">               .addCallAdapterFactory(RxJavaCallAdapterFactory.create())</span><br><span class="line">               .build()</span><br><span class="line">               .create(GitHubService.class);</span><br></pre></td></tr></table></figure>
<p>然后就是指定 subscribe 去输出结果了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">service.getUserInfoByObservable(<span class="string">"bluesky466"</span>)</span><br><span class="line">                .subscribeOn(Schedulers.newThread())</span><br><span class="line">                .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">                .subscribe(<span class="keyword">new</span> Subscriber&lt;User&gt;() &#123;</span><br><span class="line">                    <span class="annotation">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span> (user != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            Log.d(<span class="string">"result"</span>, user.toString());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="annotation">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="annotation">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br></pre></td></tr></table></figure>
<h2 id="u4E00_u4E2A_u5C0F_Demo"><a href="#u4E00_u4E2A_u5C0F_Demo" class="headerlink" title="一个小 Demo"></a><strong>一个小 Demo</strong></h2><p>我写了一个 demo 用来展示 Retrofit 的用法，完整源码如下：</p>
<p>MainActivity：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> GitHubService mService;</span><br><span class="line">    <span class="keyword">private</span> EditText mUserName;</span><br><span class="line">    <span class="keyword">private</span> TextView mResult;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GitHubService</span> </span>&#123;</span><br><span class="line">        <span class="annotation">@GET</span>(<span class="string">"users/&#123;user&#125;"</span>)</span><br><span class="line">        <span class="function">Call&lt;User&gt; <span class="title">getUserInfoByCall</span><span class="params">(@Path(<span class="string">"user"</span>)</span> String user)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@GET</span>(<span class="string">"users/&#123;user&#125;"</span>)</span><br><span class="line">        <span class="function">Observable&lt;User&gt; <span class="title">getUserInfoByObservable</span><span class="params">(@Path(<span class="string">"user"</span>)</span> String user)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        mUserName = (EditText) findViewById(R.id.username);</span><br><span class="line">        mResult = (TextView) findViewById(R.id.result);</span><br><span class="line"></span><br><span class="line">        Button btnCall = (Button) findViewById(R.id.btnCall);</span><br><span class="line">        btnCall.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                queryByCall(mUserName.getText().toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Button btnObservable = (Button) findViewById(R.id.btnObservable);</span><br><span class="line">        btnObservable.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                queryByObservable(mUserName.getText().toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        mService = <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line">                .baseUrl(<span class="string">"https://api.github.com"</span>)</span><br><span class="line">                .addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">                .addCallAdapterFactory(RxJavaCallAdapterFactory.create())</span><br><span class="line">                .build()</span><br><span class="line">                .create(GitHubService.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">queryByCall</span><span class="params">(<span class="keyword">final</span> String username)</span> </span>&#123;</span><br><span class="line">        mService.getUserInfoByCall(username).enqueue(<span class="keyword">new</span> Callback&lt;User&gt;() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;User&gt; call, Response&lt;User&gt; response)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (response.body() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mResult.setText(<span class="string">"[ByCall] "</span> + response.body().toString());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mResult.setText(<span class="string">"[ByCall] Not Found"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call&lt;User&gt; call, Throwable t)</span> </span>&#123;</span><br><span class="line">                mResult.setText(<span class="string">"[ByCall] Not Found"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">queryByObservable</span><span class="params">(<span class="keyword">final</span> String username)</span> </span>&#123;</span><br><span class="line">        mService.getUserInfoByObservable(username)</span><br><span class="line">                .subscribeOn(Schedulers.newThread())</span><br><span class="line">                .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">                .subscribe(<span class="keyword">new</span> Subscriber&lt;User&gt;() &#123;</span><br><span class="line">                    <span class="annotation">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="annotation">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">                        mResult.setText(<span class="string">"[ByObservable] Not Found"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="annotation">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span> (user != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            mResult.setText(<span class="string">"[ByObservable] "</span> + user.toString());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>activity_main.xml:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">LinearLayout</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attribute">xmlns:tools</span>=<span class="value">"http://schemas.android.com/tools"</span></span><br><span class="line">    <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">    <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">    <span class="attribute">android:orientation</span>=<span class="value">"vertical"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">LinearLayout</span></span><br><span class="line">        <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">        <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">        <span class="attribute">android:orientation</span>=<span class="value">"horizontal"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="title">EditText</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/username"</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_weight</span>=<span class="value">"1"</span></span><br><span class="line">            <span class="attribute">android:hint</span>=<span class="value">"user name"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="title">Button</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/btnCall"</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">            <span class="attribute">android:text</span>=<span class="value">"Call"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="title">Button</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/btnObservable"</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">            <span class="attribute">android:text</span>=<span class="value">"Observable"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">        <span class="attribute">android:id</span>=<span class="value">"@+id/result"</span></span><br><span class="line">        <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">        <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">        <span class="attribute">android:text</span>=<span class="value">""</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>User:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String login;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"login:"</span> + login + <span class="string">", "</span></span><br><span class="line">                + <span class="string">"id:"</span> + id + <span class="string">", "</span></span><br><span class="line">                + <span class="string">"name:"</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLogin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> login;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLogin</span><span class="params">(String login)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.login = login;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>dependencies:</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">       <span class="keyword">compile</span> <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">include</span>: [<span class="string">'*.jar'</span>])</span><br><span class="line">       testCompile <span class="string">'junit:junit:4.12'</span></span><br><span class="line">       <span class="keyword">compile</span> <span class="string">'com.android.support:appcompat-v7:23.1.1'</span></span><br><span class="line">       <span class="keyword">compile</span> <span class="string">'com.squareup.retrofit2:retrofit:2.0.0-beta4'</span></span><br><span class="line">       <span class="keyword">compile</span> <span class="string">'com.squareup.retrofit2:converter-gson:2.0.0-beta4'</span></span><br><span class="line">       <span class="keyword">compile</span> <span class="string">'com.squareup.retrofit2:adapter-rxjava:2.0.0-beta4'</span></span><br><span class="line">       <span class="keyword">compile</span> <span class="string">'io.reactivex:rxandroid:1.1.0'</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/技术相关/">技术相关</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-GTest源码剖析-测试代码的注册" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/02/15/GTest源码剖析-测试代码的注册/" class="article-date">
  	<time datetime="2016-02-15T14:07:08.000Z" itemprop="datePublished">2016-02-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/15/GTest源码剖析-测试代码的注册/">GTest源码剖析 - 测试代码的注册</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>单元测试框架，最基本的功能当然就是运行用户所编写的测试用例了。</p>
<h2 id="u6BEB_u65E0_u6280_u5DE7_u7684_u65B9_u6CD5"><a href="#u6BEB_u65E0_u6280_u5DE7_u7684_u65B9_u6CD5" class="headerlink" title="毫无技巧的方法"></a><strong>毫无技巧的方法</strong></h2><p>一种毫无技巧的方法就是用户手动在 main 函数里面将自己编写的测试代码注册到框架中，就像下面的代码：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    RegisterTestFunc(test1);</span><br><span class="line">    RegisterTestFunc(test2);</span><br><span class="line">    RegisterTestFunc(test3);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样的代码虽然可以运行，但是将初始化的责任放到的用户那里，这样的代码是不够优秀的。有两种容易出现的情况：一是项目中可能拥有大量的测试代码，用户很有可能会漏掉其中的部分测试代码，忘记把它们注册到测试框架中。二是可能用户去掉了一些测试代码，却又忘了去掉注册的代码。</p>
<p>后者编译器会报错，但前者却没有办法检测（除非对着测试结果一条条的检测，看是否所有测试代码都运行了）。</p>
<h2 id="u4E00_u79CD_u6709_u95EE_u9898_u7684_u65B9_u6CD5"><a href="#u4E00_u79CD_u6709_u95EE_u9898_u7684_u65B9_u6CD5" class="headerlink" title="一种有问题的方法"></a><strong>一种有问题的方法</strong></h2><p>最好在编写测试代码的时候就能通过一种机制帮用户注册，而不用用户手动去注册。面对这个需求，我脑海里面想到的第一个方法就是利用全局变量和宏定义。</p>
<p>首先定义一个用来管理注册的测试方法的类：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">list</span>&lt;function&lt;<span class="keyword">void</span>()&gt;&gt; FuncList;</span><br><span class="line">   <span class="keyword">class</span> Test&#123;</span><br><span class="line">   <span class="keyword">public</span>:</span><br><span class="line">       Test(<span class="keyword">const</span> function&lt;<span class="keyword">void</span>()&gt;&amp; test_func)&#123;</span><br><span class="line">           test_funcs_.push_back(test_func);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runAllTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">auto</span> func : test_funcs_)&#123;</span><br><span class="line">               func();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span>:</span><br><span class="line">       <span class="keyword">static</span> FuncList test_funcs_;</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure></p>
<p>它有一个静态的成员变量 test_funcs_ ，用来保存测试方法，同时它有一个构造函数用来将传入的测试方法插入 test_funcs_ 中</p>
<p>接着定义一个宏：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> TEST_FUNC(NAME) \</span><br><span class="line">    void NAME(); \</span><br><span class="line">    static Test register_##NAME(NAME); \</span><br><span class="line">    void NAME()</span></span><br></pre></td></tr></table></figure></p>
<p>它在帮助我们在定义一个测试方法的时候自动注册到 test_funcs_ 中。原理其实很简单，就是在声明一个函数的同时声明一个 Test 全局变量，将定义的测试方法传入，这个测试函数就会在 Test 的构造函数中被插入 test_funcs_ 。</p>
<p>所以我们只要这样编写测试代码，就能实现自动注册了：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TEST_FUNC(testSomething)&#123;</span><br><span class="line">       ...</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>看起来这个方法不错是吧？可惜这种方法是有问题的！至少在我的 vs2013 上会崩溃！</p>
<p>问题就出在 Test 全局变量和 Test::test_funcs_ 的初始化顺序上。你无法保证 Test::test_funcs_ 比全局变量 Test 先初始化。很奇怪是吧？ Test 的静态成员变量居然比 Test 全局变量的初始化时间晚，也就是说在 Test 这个类还没有完全准备好的时候，就已经拿来创建一个全局变量了。书上一直强调的全局变量的初始化顺序不能确定难道也有这种含义？</p>
<h2 id="u4E00_u79CD_u53EF_u80FD_u53EF_u884C_u7684_u65B9_u6CD5"><a href="#u4E00_u79CD_u53EF_u80FD_u53EF_u884C_u7684_u65B9_u6CD5" class="headerlink" title="一种可能可行的方法"></a><strong>一种可能可行的方法</strong></h2><p>既然是因为初始化顺序导致了内存错误，那我们只要使用某种机制让保存测试函数的容器首先初始化就行了。</p>
<p>让我们将 Test 类的定义修改成下面的样子：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Test&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runAllTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> i : test_list)&#123;</span><br><span class="line">            i-&gt;run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addTest</span><span class="params">(Test* test)</span></span>&#123;</span><br><span class="line">        test_list.push_back(test);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">list</span>&lt;Test*&gt; test_list;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>容器里面不再直接放测试函数，改为放 Test 的指针。而 Test 又是一个抽象类，所以事实上放的是 Test 的子类。</p>
<p>再把 TEST_FUNC 宏的定义改成下面的样子：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> TEST_FUNC(NAME) \</span><br><span class="line">    class NAME : public Test&#123; \</span><br><span class="line">    public: \</span><br><span class="line">        virtual void run(); \</span><br><span class="line">    private: \</span><br><span class="line">        NAME()&#123; \</span><br><span class="line">            addTest(this); \</span><br><span class="line">        &#125; \</span><br><span class="line">        static NAME* instance_; \</span><br><span class="line">    &#125;; \</span><br><span class="line">    NAME* NAME::instance_ = new NAME(); \</span><br><span class="line">    void NAME::run()</span></span><br></pre></td></tr></table></figure>
<p>现在实际上用户写的测试方法实现的是 Test 的子类的 run 方法。</p>
<p>依然是需要在定义测试方法的时候顺便定义一个全局变量，但我们换了一种方式，定义了一个类静态变量。子类在构造函数中把自己注册到 Test 的测试容器中，而且子类还包含了一个本类指针静态成员变量（有点拗口，但看代码很容易看出来）。在子类的静态成员变量初始化的之前，父类的静态成员变量应该就已经初始化了。就是根据这种机制，达到了我们的目的。</p>
<p>使用方法还是一样：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TEST_FUNC(testSomething)&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为什么说这是“一种可能可行的方法”呢？因为父类的静态成员变量初始化先于子类的静态成员变量初始化这个前提是我自己推论的。可能是我读的书少或者读书不仔细，至今没有在哪里见到有提及父类和子类的静态成员变量的初始化顺序的。所以虽然在我的编译器上它的确能正常的工作，但为了严谨起见，姑且称为“可能”的吧。如果有人有在哪里看到这方面的描述，请务必私信我，让我把“可能”二字去掉或者将标题改成“另一种有问题的方法”</p>
<h2 id="GTest__u7684_u505A_u6CD5"><a href="#GTest__u7684_u505A_u6CD5" class="headerlink" title="GTest 的做法"></a><strong>GTest 的做法</strong></h2><p>讲了这么久我的想法，现状让我们来看看谷歌的大神们是怎么做的吧。</p>
<p>我们从 TEST 宏看起：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">if</span> !GTEST_DONT_DEFINE_TEST</span></span><br><span class="line"><span class="preprocessor"># <span class="keyword">define</span> TEST(test_case_name, test_name) GTEST_TEST(test_case_name, test_name)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>这里这么搞，主要是为了防止 TEST 被系统或者其他框架定义了。如果出现这种情况，只要把GTEST_DONT_DEFINE_TEST 定义为 1，之后编写测试用例的时候直接使用 GTEST_TEST 就好了。不得不说，他们考虑的真仔细。让我们继续跟踪，看 GTEST_TEST：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> GTEST_TEST(test_case_name, test_name)\</span><br><span class="line">  GTEST_TEST_(test_case_name, test_name, \</span><br><span class="line">              ::testing::Test, ::testing::internal::GetTestTypeId())</span></span><br></pre></td></tr></table></figure>
<p>GTEST_TEST 宏又用到了另一个宏 GTEST_TEST_，但我想先说一下 GetTestTypeId，这个东西的用法真的令我眼前一亮，不得不佩服：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function">TypeId <span class="title">GetTestTypeId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> GetTypeId&lt;Test&gt;();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">   <span class="function">TypeId <span class="title">GetTypeId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="comment">// The compiler is required to allocate a different</span></span><br><span class="line">     <span class="comment">// TypeIdHelper&lt;T&gt;::dummy_ variable for each T used to instantiate</span></span><br><span class="line">     <span class="comment">// the template.  Therefore, the address of dummy_ is guaranteed to</span></span><br><span class="line">     <span class="comment">// be unique.</span></span><br><span class="line">     <span class="keyword">return</span> &amp;(TypeIdHelper&lt;T&gt;::dummy_);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">   <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">   <span class="keyword">class</span> TypeIdHelper &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">     <span class="comment">// dummy_ must not have a const type.  Otherwise an overly eager</span></span><br><span class="line">     <span class="comment">// compiler (e.g. MSVC 7.1 &amp; 8.0) may try to merge</span></span><br><span class="line">     <span class="comment">// TypeIdHelper&lt;T&gt;::dummy_ for different Ts as an "optimization".</span></span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">bool</span> dummy_;</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>
<p>这里直接用一个类的静态成员变量的地址当作 id 号。当时我就懵逼了，明明很简单，怎么就感觉那么玄幻呢？</p>
<p>膜拜完我们再继续看 GTEST_TEST_：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> GTEST_TEST_(test_case_name, test_name, parent_class, parent_id)\</span><br><span class="line">class GTEST_TEST_CLASS_NAME_(test_case_name, test_name) : public parent_class &#123;\</span><br><span class="line"> public:\</span><br><span class="line">  GTEST_TEST_CLASS_NAME_(test_case_name, test_name)() &#123;&#125;\</span><br><span class="line"> private:\</span><br><span class="line">  virtual void TestBody();\</span><br><span class="line">  static ::testing::TestInfo* const test_info_ GTEST_ATTRIBUTE_UNUSED_;\</span><br><span class="line">  GTEST_DISALLOW_COPY_AND_ASSIGN_(\</span><br><span class="line">      GTEST_TEST_CLASS_NAME_(test_case_name, test_name));\</span><br><span class="line">&#125;;\</span><br><span class="line">\</span><br><span class="line">::testing::TestInfo* const GTEST_TEST_CLASS_NAME_(test_case_name, test_name)\</span><br><span class="line">  ::test_info_ =\</span><br><span class="line">    ::testing::internal::MakeAndRegisterTestInfo(\</span><br><span class="line">        #test_case_name, #test_name, NULL, NULL, \</span><br><span class="line">        (parent_id), \</span><br><span class="line">        parent_class::SetUpTestCase, \</span><br><span class="line">        parent_class::TearDownTestCase, \</span><br><span class="line">        new ::testing::internal::TestFactoryImpl&lt;\</span><br><span class="line">            GTEST_TEST_CLASS_NAME_(test_case_name, test_name)&gt;);\</span><br><span class="line">void GTEST_TEST_CLASS_NAME_(test_case_name, test_name)::TestBody()</span></span><br></pre></td></tr></table></figure></p>
<p>这个宏的做法和我的最后一个方法的 TEST_FUNC 宏差不多，用户写的测试函数实际上是实现了 ::testing::Test 的子类的 TestBody 方法。也是初始化了子类的一个静态成员变量，但GTest这里没有我那么暴力，它初始化的是一个 TestInfo 类型的的静态成员变量，这里面包含了测试的很多信息。其中最重要的是 ::testing::internal::TestFactoryImpl 这个东西：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">template</span> &lt;<span class="keyword">class</span> TestClass&gt;</span><br><span class="line">   <span class="keyword">class</span> TestFactoryImpl : <span class="keyword">public</span> TestFactoryBase &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">     <span class="function"><span class="keyword">virtual</span> Test* <span class="title">CreateTest</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">new</span> TestClass; &#125;</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> TestFactoryBase &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">     <span class="keyword">virtual</span> ~TestFactoryBase() &#123;&#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Creates a test instance to run. The instance is both created and destroyed</span></span><br><span class="line">     <span class="comment">// within TestInfoImpl::Run()</span></span><br><span class="line">     <span class="function"><span class="keyword">virtual</span> Test* <span class="title">CreateTest</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">     TestFactoryBase() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">     GTEST_DISALLOW_COPY_AND_ASSIGN_(TestFactoryBase);</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>
<p>它是一个工厂类，用来创建传入的测试类的实例，也就是 GTEST_TEST_CLASS_NAME_(test_case_name, test_name)&gt; 这个类，它的 TestBody 就是用户所写的测试代码。可以看看 GTEST_TEST_CLASS_NAME_ 的定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> GTEST_TEST_CLASS_NAME_(test_case_name, test_name) \</span><br><span class="line">  test_case_name##_##test_name##_Test</span></span><br></pre></td></tr></table></figure>
<p>ok,很简单是吧？就是字符串拼接而已。</p>
<p>好了，让我们继续深入，看看 MakeAndRegisterTestInfo ：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//gtest.cc</span></span><br><span class="line">   <span class="function">TestInfo* <span class="title">MakeAndRegisterTestInfo</span><span class="params">(</span><br><span class="line">       <span class="keyword">const</span> <span class="keyword">char</span>* test_case_name,</span><br><span class="line">       <span class="keyword">const</span> <span class="keyword">char</span>* name,</span><br><span class="line">       <span class="keyword">const</span> <span class="keyword">char</span>* type_param,</span><br><span class="line">       <span class="keyword">const</span> <span class="keyword">char</span>* value_param,</span><br><span class="line">       TypeId fixture_class_id,</span><br><span class="line">       SetUpTestCaseFunc set_up_tc,</span><br><span class="line">       TearDownTestCaseFunc tear_down_tc,</span><br><span class="line">       TestFactoryBase* factory)</span> </span>&#123;</span><br><span class="line">     TestInfo* <span class="keyword">const</span> test_info =</span><br><span class="line">         <span class="keyword">new</span> TestInfo(test_case_name, name, type_param, value_param,</span><br><span class="line">                      fixture_class_id, factory);</span><br><span class="line">     GetUnitTestImpl()-&gt;AddTestInfo(set_up_tc, tear_down_tc, test_info);</span><br><span class="line">     <span class="keyword">return</span> test_info;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//gtest-internal-inl.h</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> UnitTestImpl* <span class="title">GetUnitTestImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> UnitTest::GetInstance()-&gt;impl();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//gtest.h</span></span><br><span class="line">   <span class="keyword">class</span> GTEST_API_ UnitTest &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">     <span class="function"><span class="keyword">static</span> UnitTest* <span class="title">GetInstance</span><span class="params">()</span></span>;</span><br><span class="line">     ...</span><br><span class="line">     internal::<span class="function">UnitTestImpl* <span class="title">impl</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> impl_; &#125;</span><br><span class="line">     ...</span><br><span class="line">     internal::UnitTestImpl* impl_;</span><br><span class="line">     ...</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//gtest.cc</span></span><br><span class="line">   UnitTest* UnitTest::GetInstance() &#123;</span><br><span class="line">     <span class="comment">// When compiled with MSVC 7.1 in optimized mode, destroying the</span></span><br><span class="line">     <span class="comment">// UnitTest object upon exiting the program messes up the exit code,</span></span><br><span class="line">     <span class="comment">// causing successful tests to appear failed.  We have to use a</span></span><br><span class="line">     <span class="comment">// different implementation in this case to bypass the compiler bug.</span></span><br><span class="line">     <span class="comment">// This implementation makes the compiler happy, at the cost of</span></span><br><span class="line">     <span class="comment">// leaking the UnitTest object.</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">// CodeGear C++Builder insists on a public destructor for the</span></span><br><span class="line">     <span class="comment">// default implementation.  Use this implementation to keep good OO</span></span><br><span class="line">     <span class="comment">// design with private destructor.</span></span><br><span class="line"></span><br><span class="line">   <span class="preprocessor">#<span class="keyword">if</span> (_MSC_VER == <span class="number">1310</span> &amp;&amp; !defined(_DEBUG)) || defined(__BORLANDC__)</span></span><br><span class="line">     <span class="keyword">static</span> UnitTest* <span class="keyword">const</span> instance = <span class="keyword">new</span> UnitTest;</span><br><span class="line">     <span class="keyword">return</span> instance;</span><br><span class="line">   <span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">     <span class="keyword">static</span> UnitTest instance;</span><br><span class="line">     <span class="keyword">return</span> &amp;instance;</span><br><span class="line">   <span class="preprocessor">#<span class="keyword">endif</span>  <span class="comment">// (_MSC_VER == 1310 &amp;&amp; !defined(_DEBUG)) || defined(__BORLANDC__)</span></span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//gtest-internal-inl.h</span></span><br><span class="line">   <span class="keyword">class</span> GTEST_API_ UnitTestImpl &#123;</span><br><span class="line">   	...</span><br><span class="line">       <span class="function"><span class="keyword">void</span> <span class="title">AddTestInfo</span><span class="params">(Test::SetUpTestCaseFunc set_up_tc,</span><br><span class="line">                  Test::TearDownTestCaseFunc tear_down_tc,</span><br><span class="line">                  TestInfo* test_info)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// In order to support thread-safe death tests, we need to</span></span><br><span class="line">       <span class="comment">// remember the original working directory when the test program</span></span><br><span class="line">       <span class="comment">// was first invoked.  We cannot do this in RUN_ALL_TESTS(), as</span></span><br><span class="line">       <span class="comment">// the user may have changed the current directory before calling</span></span><br><span class="line">       <span class="comment">// RUN_ALL_TESTS().  Therefore we capture the current directory in</span></span><br><span class="line">       <span class="comment">// AddTestInfo(), which is called to register a TEST or TEST_F</span></span><br><span class="line">       <span class="comment">// before main() is reached.</span></span><br><span class="line">       <span class="keyword">if</span> (original_working_dir_.IsEmpty()) &#123;</span><br><span class="line">         original_working_dir_.Set(FilePath::GetCurrentDir());</span><br><span class="line">         GTEST_CHECK_(!original_working_dir_.IsEmpty())</span><br><span class="line">             &lt;&lt; <span class="string">"Failed to get the current working directory."</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       GetTestCase(test_info-&gt;test_case_name(),</span><br><span class="line">                   test_info-&gt;type_param(),</span><br><span class="line">                   set_up_tc,</span><br><span class="line">                   tear_down_tc)-&gt;AddTestInfo(test_info);</span><br><span class="line">     &#125;</span><br><span class="line">     ...</span><br><span class="line">     <span class="comment">//这个方法从test_cases_里面获取TestCase</span></span><br><span class="line">     <span class="function">TestCase* <span class="title">GetTestCase</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* test_case_name,</span><br><span class="line">                       <span class="keyword">const</span> <span class="keyword">char</span>* type_param,</span><br><span class="line">                       Test::SetUpTestCaseFunc set_up_tc,</span><br><span class="line">                       Test::TearDownTestCaseFunc tear_down_tc)</span></span>;</span><br><span class="line">     ...</span><br><span class="line">     <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;TestCase*&gt; test_cases_;</span><br><span class="line">     ...</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//gtest.cc</span></span><br><span class="line">   <span class="keyword">void</span> TestCase::AddTestInfo(TestInfo * test_info) &#123;</span><br><span class="line">     test_info_list_.push_back(test_info);</span><br><span class="line">     test_indices_.push_back(<span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(test_indices_.size()));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//gtest.h</span></span><br><span class="line">   <span class="keyword">class</span> GTEST_API_ TestCase &#123;</span><br><span class="line">   	...</span><br><span class="line">   	<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;TestInfo*&gt; test_info_list_;</span><br><span class="line">       <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; test_indices_;</span><br><span class="line">       ...</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure></p>
<p>代码很多，我简单的描述一下。UnitTest 是一个单例类，它有一个成员变量 internal::UnitTestImpl* impl_， impl_ 里面又有成员变量 test_info_list_。最终我们写的测试类就放在 test_info_list_ 里。</p>
<p>九曲十八弯，实际 GTest 用一个单例类 UnitTest 保存了注册的测试代码（放在 ::testing::Test 子类的 TestBody 方法里面）。</p>
<p>那他是怎么解决初始化顺序的问题的？注意看 UnitTest::GetInstance() 方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//gtest.cc</span></span><br><span class="line">   UnitTest* UnitTest::GetInstance() &#123;</span><br><span class="line">     <span class="comment">// When compiled with MSVC 7.1 in optimized mode, destroying the</span></span><br><span class="line">     <span class="comment">// UnitTest object upon exiting the program messes up the exit code,</span></span><br><span class="line">     <span class="comment">// causing successful tests to appear failed.  We have to use a</span></span><br><span class="line">     <span class="comment">// different implementation in this case to bypass the compiler bug.</span></span><br><span class="line">     <span class="comment">// This implementation makes the compiler happy, at the cost of</span></span><br><span class="line">     <span class="comment">// leaking the UnitTest object.</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">// CodeGear C++Builder insists on a public destructor for the</span></span><br><span class="line">     <span class="comment">// default implementation.  Use this implementation to keep good OO</span></span><br><span class="line">     <span class="comment">// design with private destructor.</span></span><br><span class="line"></span><br><span class="line">   <span class="preprocessor">#<span class="keyword">if</span> (_MSC_VER == <span class="number">1310</span> &amp;&amp; !defined(_DEBUG)) || defined(__BORLANDC__)</span></span><br><span class="line">     <span class="keyword">static</span> UnitTest* <span class="keyword">const</span> instance = <span class="keyword">new</span> UnitTest;</span><br><span class="line">     <span class="keyword">return</span> instance;</span><br><span class="line">   <span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">     <span class="keyword">static</span> UnitTest instance;</span><br><span class="line">     <span class="keyword">return</span> &amp;instance;</span><br><span class="line">   <span class="preprocessor">#<span class="keyword">endif</span>  <span class="comment">// (_MSC_VER == 1310 &amp;&amp; !defined(_DEBUG)) || defined(__BORLANDC__)</span></span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里使用了局部静态变量，在第一次进入这个方法的时候就会生成一个 UnitTest 实例！不需要靠人品祈祷编译器按照我们设想的顺序创建全局变量！</p>
<p>谷歌大神们不愧是大神，在看 GTest 源码的时候我都不知道被惊艳了多少次，真心学到了不少东西。怪不得别人都说看源码才是最好的提升方式。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/">c++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/单元测试/">单元测试</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/技术相关/">技术相关</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 林嘉伟
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>