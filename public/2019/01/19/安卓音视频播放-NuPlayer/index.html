<!DOCTYPE html>


  <html class="light page-home">


<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>安卓音视频播放 - NuPlayer | 编程代码笔记</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="技术相关,Android,音视频,">
  

  <meta name="description" content="系列文章:  安卓音视频播放 - 总体架构 安卓音视频播放 - AwesomePlayer 安卓音视频播放 - NuPlayer  这里有一点需要提一下,不像StagefrightPlayerFactory直接就创建出了StagefrightPlayer, NuPlayerFactory创建出来的是NuPlayerDriver,不过NuPlayerDriver内部也是封装了NuPlayer,对Nu">
<meta name="keywords" content="技术相关,Android,音视频">
<meta property="og:type" content="article">
<meta property="og:title" content="安卓音视频播放 - NuPlayer">
<meta property="og:url" content="https://blog.islinjw.cn/2019/01/19/安卓音视频播放-NuPlayer/index.html">
<meta property="og:site_name" content="编程代码笔记">
<meta property="og:description" content="系列文章:  安卓音视频播放 - 总体架构 安卓音视频播放 - AwesomePlayer 安卓音视频播放 - NuPlayer  这里有一点需要提一下,不像StagefrightPlayerFactory直接就创建出了StagefrightPlayer, NuPlayerFactory创建出来的是NuPlayerDriver,不过NuPlayerDriver内部也是封装了NuPlayer,对Nu">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://blog.islinjw.cn/安卓音视频播放-NuPlayer/1.png">
<meta property="og:image" content="https://blog.islinjw.cn/安卓音视频播放-NuPlayer/2.png">
<meta property="og:image" content="https://blog.islinjw.cn/安卓音视频播放-NuPlayer/3.png">
<meta property="og:updated_time" content="2022-05-30T12:47:34.243Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="安卓音视频播放 - NuPlayer">
<meta name="twitter:description" content="系列文章:  安卓音视频播放 - 总体架构 安卓音视频播放 - AwesomePlayer 安卓音视频播放 - NuPlayer  这里有一点需要提一下,不像StagefrightPlayerFactory直接就创建出了StagefrightPlayer, NuPlayerFactory创建出来的是NuPlayerDriver,不过NuPlayerDriver内部也是封装了NuPlayer,对Nu">
<meta name="twitter:image" content="https://blog.islinjw.cn/安卓音视频播放-NuPlayer/1.png">

  
    <link rel="alternate" href="/atom.xml" title="编程代码笔记" type="application/atom+xml">
  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=32204ee7" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?57e94d016e201fba3603a8a2b0263af0";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</head>
</html>
<body>

  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            target="_self"
            >
            关于
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/search/"
            target="_self"
            >
            搜索
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/atom.xml"
            target="_self"
            >
            RSS
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#NuPlayer-Source"><span class="toc-text">NuPlayer::Source</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#NuPlayer-Source准备数据"><span class="toc-text">NuPlayer::Source准备数据</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NuPlayer-Decoder"><span class="toc-text">NuPlayer::Decoder</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NuPlayer-Render"><span class="toc-text">NuPlayer::Render</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#音频处理"><span class="toc-text">音频处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#视频处理"><span class="toc-text">视频处理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#整体架构图"><span class="toc-text">整体架构图</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-安卓音视频播放-NuPlayer" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">安卓音视频播放 - NuPlayer</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2019.01.19</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>林嘉伟</span>
        </span>
      

      


      

    </div>
  </header>

  <div class="article-content">
    
      <p>系列文章:</p>
<ul>
<li><a href="http://blog.islinjw.cn/2019/01/17/%E5%AE%89%E5%8D%93%E9%9F%B3%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE-%E6%80%BB%E4%BD%93%E6%9E%B6%E6%9E%84/">安卓音视频播放 - 总体架构</a></li>
<li><a href="http://blog.islinjw.cn/2019/01/17/%E5%AE%89%E5%8D%93%E9%9F%B3%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE-AwesomePlayer/">安卓音视频播放 - AwesomePlayer</a></li>
<li><a href="http://blog.islinjw.cn/2019/01/19/%E5%AE%89%E5%8D%93%E9%9F%B3%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE-NuPlayer/">安卓音视频播放 - NuPlayer</a></li>
</ul>
<p>这里有一点需要提一下,不像StagefrightPlayerFactory直接就创建出了StagefrightPlayer, NuPlayerFactory创建出来的是NuPlayerDriver,不过NuPlayerDriver内部也是封装了NuPlayer,对NuPlayer进行调用就是了:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class NuPlayerFactory : public MediaPlayerFactory::IFactory &#123;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">    virtual sp&lt;MediaPlayerBase&gt; createPlayer(pid_t pid) &#123;</span><br><span class="line">        ALOGV(&quot; create NuPlayer&quot;);</span><br><span class="line">        return new NuPlayerDriver(pid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>接下来就要介绍NuPlayer了,NuPlayer的特点在于它用了Handler机制去实现子线程解码。对的,就是我们熟悉的Handler机制.只不过它是在C/C++的实现,但是原理和java层的是一样的。</p>
<p>看下接口声明就会感觉似曾相识了:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">struct ALooper : public RefBase &#123;</span><br><span class="line">	...</span><br><span class="line">	status_t start(bool runOnCallingThread = false,bool canCallJava = false,int32_t priority = PRIORITY_DEFAULT);</span><br><span class="line">	...</span><br><span class="line">    status_t stop();</span><br><span class="line">    ...</span><br><span class="line">    void post(const sp&lt;AMessage&gt; &amp;msg, int64_t delayUs);</span><br><span class="line">    ...</span><br><span class="line">    bool loop();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">struct AHandler : public RefBase &#123;</span><br><span class="line">...</span><br><span class="line">protected:</span><br><span class="line">    virtual void onMessageReceived(const sp&lt;AMessage&gt; &amp;msg) = 0;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct AMessage : public RefBase &#123;</span><br><span class="line">    AMessage();</span><br><span class="line">    AMessage(uint32_t what, const sp&lt;const AHandler&gt; &amp;handler);</span><br><span class="line">	...</span><br><span class="line">    void setTarget(const sp&lt;const AHandler&gt; &amp;handler);</span><br><span class="line"></span><br><span class="line">    void clear();</span><br><span class="line"></span><br><span class="line">    void setInt32(const char *name, int32_t value);</span><br><span class="line">    void setInt64(const char *name, int64_t value);</span><br><span class="line">    void setSize(const char *name, size_t value);</span><br><span class="line">    void setFloat(const char *name, float value);</span><br><span class="line">    void setDouble(const char *name, double value);</span><br><span class="line">    void setPointer(const char *name, void *value);</span><br><span class="line">    void setString(const char *name, const char *s, ssize_t len = -1);</span><br><span class="line">    void setString(const char *name, const AString &amp;s);</span><br><span class="line">    void setObject(const char *name, const sp&lt;RefBase&gt; &amp;obj);</span><br><span class="line">    void setBuffer(const char *name, const sp&lt;ABuffer&gt; &amp;buffer);</span><br><span class="line">    void setMessage(const char *name, const sp&lt;AMessage&gt; &amp;obj);</span><br><span class="line">    ...</span><br><span class="line">    status_t post(int64_t delayUs = 0);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而Looper就是在NuPlayerDriver中创建并启动的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">NuPlayerDriver::NuPlayerDriver(pid_t pid)</span><br><span class="line">    : mState(STATE_IDLE),</span><br><span class="line">      mIsAsyncPrepare(false),</span><br><span class="line">      mAsyncResult(UNKNOWN_ERROR),</span><br><span class="line">      mSetSurfaceInProgress(false),</span><br><span class="line">      mDurationUs(-1),</span><br><span class="line">      mPositionUs(-1),</span><br><span class="line">      mSeekInProgress(false),</span><br><span class="line">      mLooper(new ALooper),</span><br><span class="line">      mPlayerFlags(0),</span><br><span class="line">      mAtEOS(false),</span><br><span class="line">      mLooping(false),</span><br><span class="line">      mAutoLoop(false) &#123;</span><br><span class="line">    ALOGV(&quot;NuPlayerDriver(%p)&quot;, this);</span><br><span class="line">    mLooper-&gt;setName(&quot;NuPlayerDriver Looper&quot;);</span><br><span class="line"></span><br><span class="line">    mLooper-&gt;start(</span><br><span class="line">            false, /* runOnCallingThread */</span><br><span class="line">            true,  /* canCallJava */</span><br><span class="line">            PRIORITY_AUDIO);</span><br><span class="line"></span><br><span class="line">    mPlayer = new NuPlayer(pid);</span><br><span class="line">    mLooper-&gt;registerHandler(mPlayer);</span><br><span class="line"></span><br><span class="line">    mPlayer-&gt;setDriver(this);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NuPlayerDriver::~NuPlayerDriver() &#123;</span><br><span class="line">    ALOGV(&quot;~NuPlayerDriver(%p)&quot;, this);</span><br><span class="line">    mLooper-&gt;stop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们的NuPlayer其实是一个AHandler:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct NuPlayer : public AHandler &#123;</span><br><span class="line">	...</span><br><span class="line">    virtual void onMessageReceived(const sp&lt;AMessage&gt; &amp;msg);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它通过AMessage::post方法将操作放到子线程中,这操作简直不能再熟悉,甚至就没有细讲的必要:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">void NuPlayer::setDataSourceAsync(const sp&lt;IStreamSource&gt; &amp;source) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = new AMessage(kWhatSetDataSource, this);</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; notify = new AMessage(kWhatSourceNotify, this);</span><br><span class="line"></span><br><span class="line">    msg-&gt;setObject(&quot;source&quot;, new StreamingSource(notify, source));</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">void NuPlayer::prepareAsync() &#123;</span><br><span class="line">    (new AMessage(kWhatPrepare, this))-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">void NuPlayer::onMessageReceived(const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">	...</span><br><span class="line">	switch (msg-&gt;what()) &#123;</span><br><span class="line">		case kWhatSetDataSource:</span><br><span class="line">        &#123;</span><br><span class="line">            ALOGV(&quot;kWhatSetDataSource&quot;);</span><br><span class="line"></span><br><span class="line">            CHECK(mSource == NULL);</span><br><span class="line"></span><br><span class="line">            status_t err = OK;</span><br><span class="line">            sp&lt;RefBase&gt; obj;</span><br><span class="line">            CHECK(msg-&gt;findObject(&quot;source&quot;, &amp;obj));</span><br><span class="line">            if (obj != NULL) &#123;</span><br><span class="line">                Mutex::Autolock autoLock(mSourceLock);</span><br><span class="line">                mSource = static_cast&lt;Source *&gt;(obj.get());</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                err = UNKNOWN_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            CHECK(mDriver != NULL);</span><br><span class="line">            sp&lt;NuPlayerDriver&gt; driver = mDriver.promote();</span><br><span class="line">            if (driver != NULL) &#123;</span><br><span class="line">                driver-&gt;notifySetDataSourceCompleted(err);</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        case kWhatPrepare:</span><br><span class="line">        &#123;</span><br><span class="line">            mSource-&gt;prepareAsync();</span><br><span class="line">            break;</span><br><span class="line">        &#125;		</span><br><span class="line">        ...</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="NuPlayer-Source"><a href="#NuPlayer-Source" class="headerlink" title="NuPlayer::Source"></a>NuPlayer::Source</h1><p>NuPlayer::Source顾名思义,是数据源的意思,它复制从音视频源读取数据。</p>
<p>数据源在java层调用setDataSource方法之后,传递到NuPlayer都会打包成不同的NuPlayer::Source</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">void NuPlayer::setDataSourceAsync(const sp&lt;IMediaHTTPService&gt; &amp;httpService, const char *url, const KeyedVector&lt;String8, String8&gt; *headers) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = new AMessage(kWhatSetDataSource, this);</span><br><span class="line">    size_t len = strlen(url);</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; notify = new AMessage(kWhatSourceNotify, this);</span><br><span class="line"></span><br><span class="line">    sp&lt;Source&gt; source;</span><br><span class="line">    if (IsHTTPLiveURL(url)) &#123;</span><br><span class="line">        source = new HTTPLiveSource(notify, httpService, url, headers);</span><br><span class="line">    &#125; else if (!strncasecmp(url, &quot;rtsp://&quot;, 7)) &#123;</span><br><span class="line">        source = new RTSPSource(notify, httpService, url, headers, mUIDValid, mUID);</span><br><span class="line">    &#125; else if ((!strncasecmp(url, &quot;http://&quot;, 7) || !strncasecmp(url, &quot;https://&quot;, 8)) &amp;&amp; ((len &gt;= 4 &amp;&amp; !strcasecmp(&quot;.sdp&quot;, &amp;url[len - 4])) || strstr(url, &quot;.sdp?&quot;))) &#123;</span><br><span class="line">        source = new RTSPSource(notify, httpService, url, headers, mUIDValid, mUID, true);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        sp&lt;GenericSource&gt; genericSource = new GenericSource(notify, mUIDValid, mUID);</span><br><span class="line">        status_t err = genericSource-&gt;setDataSource(httpService, url, headers);</span><br><span class="line"></span><br><span class="line">        if (err == OK) &#123;</span><br><span class="line">            source = genericSource;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            ALOGE(&quot;Failed to set data source!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    msg-&gt;setObject(&quot;source&quot;, source);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void NuPlayer::setDataSourceAsync(int fd, int64_t offset, int64_t length) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = new AMessage(kWhatSetDataSource, this);</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; notify = new AMessage(kWhatSourceNotify, this);</span><br><span class="line"></span><br><span class="line">    sp&lt;GenericSource&gt; source = new GenericSource(notify, mUIDValid, mUID);</span><br><span class="line"></span><br><span class="line">    status_t err = source-&gt;setDataSource(fd, offset, length);</span><br><span class="line"></span><br><span class="line">    if (err != OK) &#123;</span><br><span class="line">        ALOGE(&quot;Failed to set data source!&quot;);</span><br><span class="line">        source = NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    msg-&gt;setObject(&quot;source&quot;, source);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void NuPlayer::setDataSourceAsync(const sp&lt;DataSource&gt; &amp;dataSource) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = new AMessage(kWhatSetDataSource, this);</span><br><span class="line">    sp&lt;AMessage&gt; notify = new AMessage(kWhatSourceNotify, this);</span><br><span class="line"></span><br><span class="line">    sp&lt;GenericSource&gt; source = new GenericSource(notify, mUIDValid, mUID);</span><br><span class="line">    status_t err = source-&gt;setDataSource(dataSource);</span><br><span class="line"></span><br><span class="line">    if (err != OK) &#123;</span><br><span class="line">        ALOGE(&quot;Failed to set data source!&quot;);</span><br><span class="line">        source = NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    msg-&gt;setObject(&quot;source&quot;, source);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void NuPlayer::setDataSourceAsync(const sp&lt;IStreamSource&gt; &amp;source) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = new AMessage(kWhatSetDataSource, this);</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; notify = new AMessage(kWhatSourceNotify, this);</span><br><span class="line"></span><br><span class="line">    msg-&gt;setObject(&quot;source&quot;, new StreamingSource(notify, source));</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的HTTPLiveSource、RTSPSource、GenericSource、StreamingSource都继承NuPlayer::Source</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">struct NuPlayer::HTTPLiveSource : public NuPlayer::Source &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct NuPlayer::RTSPSource : public NuPlayer::Source &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct NuPlayer::GenericSource : public NuPlayer::Source &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct NuPlayer::StreamingSource : public NuPlayer::Source &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/安卓音视频播放-NuPlayer/1.png">

<p>可以看到NuPlayer根据音视频源的类型,创建了不同的NuPlayer::Source,然后放到了一个what=kWhatSetDataSource的AMessage中post了出去。</p>
<p>让我们跟踪下NuPlayer这个Handler是怎么处理kWhatSetDataSource消息的:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">void NuPlayer::onMessageReceived(const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    switch (msg-&gt;what()) &#123;</span><br><span class="line">        case kWhatSetDataSource:</span><br><span class="line">        &#123;</span><br><span class="line">        	...</span><br><span class="line">        	sp&lt;RefBase&gt; obj;</span><br><span class="line">        	CHECK(msg-&gt;findObject(&quot;source&quot;, &amp;obj));</span><br><span class="line">        	...</span><br><span class="line">        	mSource = static_cast&lt;Source *&gt;(obj.get());</span><br><span class="line">        	...</span><br><span class="line">        &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实就是赋值了一下mSource</p>
<h2 id="NuPlayer-Source准备数据"><a href="#NuPlayer-Source准备数据" class="headerlink" title="NuPlayer::Source准备数据"></a>NuPlayer::Source准备数据</h2><p>首先在调用prepare方法之后NuPlayer会发送kWhatPrepare消息,在NuPlayer::onMessageReceived里面会调用NuPlayer::Source::prepareAsync方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">void NuPlayer::prepareAsync() &#123;</span><br><span class="line">    (new AMessage(kWhatPrepare, this))-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void NuPlayer::onMessageReceived(const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    switch (msg-&gt;what()) &#123;</span><br><span class="line">        ...</span><br><span class="line">        case kWhatPrepare:</span><br><span class="line">        &#123;</span><br><span class="line">            mSource-&gt;prepareAsync();</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NuPlayer::Source::prepareAsync是让NuPlayer::Source去准备好数据源,例如通过网络请求获取或者打开文件获取。</p>
<p>NuPlayer::Source内部基本也是通过Handler机制异步去加载数据的,这里只举一个NuPlayer::GenericSource的例子:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">void NuPlayer::GenericSource::prepareAsync() &#123;</span><br><span class="line">    if (mLooper == NULL) &#123;</span><br><span class="line">        mLooper = new ALooper;</span><br><span class="line">        mLooper-&gt;setName(&quot;generic&quot;);</span><br><span class="line">        mLooper-&gt;start();</span><br><span class="line"></span><br><span class="line">        mLooper-&gt;registerHandler(this);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; msg = new AMessage(kWhatPrepareAsync, this);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void NuPlayer::GenericSource::onMessageReceived(const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    switch (msg-&gt;what()) &#123;</span><br><span class="line">      case kWhatPrepareAsync:</span><br><span class="line">      &#123;</span><br><span class="line">          onPrepareAsync();</span><br><span class="line">          break;</span><br><span class="line">      &#125;</span><br><span class="line">      ....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void NuPlayer::GenericSource::onPrepareAsync() &#123;</span><br><span class="line">	...</span><br><span class="line">	if (!mUri.empty()) &#123;</span><br><span class="line">		const char* uri = mUri.c_str();</span><br><span class="line">		...</span><br><span class="line">		mDataSource = DataSource::CreateFromURI(</span><br><span class="line">                   mHTTPService, uri, &amp;mUriHeaders, &amp;contentType,</span><br><span class="line">                   static_cast&lt;HTTPBase *&gt;(mHttpSource.get()));</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		mIsWidevine = false;</span><br><span class="line">		mDataSource = new FileSource(mFd, mOffset, mLength);</span><br><span class="line">		mFd = -1;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">	finishPrepareAsync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>准备好数据之后会调用finishPrepareAsync用构造的时候传给NuPlayer::Source的kWhatSourceNotify消息复制出一个新的kWhatPrepared消息反向通知NuPlayer,这是一种标准的原型模式:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">void NuPlayer::GenericSource::finishPrepareAsync() &#123;</span><br><span class="line">	...</span><br><span class="line">	notifyPrepared();</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void NuPlayer::Source::notifyPrepared(status_t err) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; notify = dupNotify();</span><br><span class="line">    notify-&gt;setInt32(&quot;what&quot;, kWhatPrepared);</span><br><span class="line">    notify-&gt;setInt32(&quot;err&quot;, err);</span><br><span class="line">    notify-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct NuPlayer::Source : public AHandler &#123;</span><br><span class="line">	...</span><br><span class="line">	Source(const sp&lt;AMessage&gt; &amp;notify)</span><br><span class="line">       : mNotify(notify) &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">	sp&lt;AMessage&gt; dupNotify() const &#123; return mNotify-&gt;dup(); &#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后NuPlayer::Source其实也充当了Demux的功能,它生命了一个dequeueAccessUnit纯虚方法,这个方法就是从数据源分离获取音频或者视频数据:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virtual status_t dequeueAccessUnit( bool audio, sp&lt;ABuffer&gt; *accessUnit) = 0;</span><br></pre></td></tr></table></figure>

<img src="/安卓音视频播放-NuPlayer/2.png">

<h1 id="NuPlayer-Decoder"><a href="#NuPlayer-Decoder" class="headerlink" title="NuPlayer::Decoder"></a>NuPlayer::Decoder</h1><p>NuPlayer::Decoder是NuPlayer的解码模块,然我们来看看它是怎么创建的吧。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">void NuPlayer::start() &#123;</span><br><span class="line">    (new AMessage(kWhatStart, this))-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void NuPlayer::onMessageReceived(const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    switch (msg-&gt;what()) &#123;</span><br><span class="line">        ...</span><br><span class="line">        case kWhatStart:</span><br><span class="line">        &#123;</span><br><span class="line">            ...</span><br><span class="line">            onStart();</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//startPositionUs 有个默认值-1</span><br><span class="line">void NuPlayer::onStart(int64_t startPositionUs) &#123;</span><br><span class="line">	...</span><br><span class="line">	sp&lt;AMessage&gt; notify = new AMessage(kWhatRendererNotify, this);</span><br><span class="line">	...</span><br><span class="line">    mRenderer = new Renderer(mAudioSink, notify, flags);</span><br><span class="line">    ...</span><br><span class="line">    postScanSources();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在onStart里面创建了Renderer,然后调用postScanSources</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">void NuPlayer::postScanSources() &#123;</span><br><span class="line">    if (mScanSourcesPending) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; msg = new AMessage(kWhatScanSources, this);</span><br><span class="line">    msg-&gt;setInt32(&quot;generation&quot;, mScanSourcesGeneration);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line"></span><br><span class="line">    mScanSourcesPending = true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void NuPlayer::onMessageReceived(const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    switch (msg-&gt;what()) &#123;</span><br><span class="line">        ...</span><br><span class="line">        case kWhatScanSources:</span><br><span class="line">        &#123;</span><br><span class="line">            ...</span><br><span class="line">            if (mSurface != NULL) &#123;</span><br><span class="line">                if (instantiateDecoder(false, &amp;mVideoDecoder) == -EWOULDBLOCK) &#123;</span><br><span class="line">                    rescan = true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (mAudioSink != NULL &amp;&amp; mAudioDecoder == NULL) &#123;</span><br><span class="line">                if (instantiateDecoder(true, &amp;mAudioDecoder) == -EWOULDBLOCK) &#123;</span><br><span class="line">                    rescan = true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">status_t NuPlayer::instantiateDecoder(bool audio, sp&lt;DecoderBase&gt; *decoder, bool checkAudioModeChange) &#123;</span><br><span class="line">	...</span><br><span class="line">	sp&lt;AMessage&gt; format = mSource-&gt;getFormat(audio);</span><br><span class="line">	...</span><br><span class="line">	if (audio) &#123;</span><br><span class="line">		...</span><br><span class="line">		*decoder = new Decoder(notify, mSource, mPID, mRenderer);</span><br><span class="line">		...</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		...</span><br><span class="line">		*decoder = new Decoder(notify, mSource, mPID, mRenderer, mSurface, mCCDecoder);</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">	(*decoder)-&gt;init();</span><br><span class="line">    (*decoder)-&gt;configure(format);</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void NuPlayer::Decoder::onConfigure(const sp&lt;AMessage&gt; &amp;format) &#123;</span><br><span class="line">	...</span><br><span class="line">	AString mime;</span><br><span class="line">    CHECK(format-&gt;findString(&quot;mime&quot;, &amp;mime));</span><br><span class="line">    ...</span><br><span class="line">	mCodec = MediaCodec::CreateByType(</span><br><span class="line">            mCodecLooper, mime.c_str(), false /* encoder */, NULL /* err */, mPid);</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从这里可以看到NuPlayer::Decoder实际上是通过MediaCodec去进行音视频的解码的。</p>
<p>MediaCodec是安卓提供的,访问底层编解码器的接口。其实最后也是依赖OpenMax的。</p>
<h1 id="NuPlayer-Render"><a href="#NuPlayer-Render" class="headerlink" title="NuPlayer::Render"></a>NuPlayer::Render</h1><p>NuPlayer::Render顾名思义是做渲染的,但是经过代码分析,其实它的逻辑只是做音视频同步,然后音频渲染会交给MediaPlayerBase::AudioSink,而视频渲染会交回给NuPlayer::Decoder再交给MediaCodec。</p>
<p>当NuPlayer::Decoder从NuPlayer::Source拿到数据并解码之后,会调用NuPlayer::Renderer::queueBuffer方法将解码之后的数据丢给NuPlayer::Renderer</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">bool NuPlayer::Decoder::handleAnOutputBuffer(</span><br><span class="line">        size_t index,</span><br><span class="line">        size_t offset,</span><br><span class="line">        size_t size,</span><br><span class="line">        int64_t timeUs,</span><br><span class="line">        int32_t flags) &#123;</span><br><span class="line">	sp&lt;ABuffer&gt; buffer;</span><br><span class="line">	mCodec-&gt;getOutputBuffer(index, &amp;buffer); // 从MediaCodec获取解码之后的数据</span><br><span class="line">	...</span><br><span class="line">	// 注意这里,这个reply用于让mRenderer回调NuPlayer::Decoder视频绘制.</span><br><span class="line">	// 不过很多人都会忽略这行注释吧,没关系,读到后面你们还会返回来看的...</span><br><span class="line">	sp&lt;AMessage&gt; reply = new AMessage(kWhatRenderBuffer, this); </span><br><span class="line">	...</span><br><span class="line">	mRenderer-&gt;queueBuffer(mIsAudio, buffer, reply);</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NuPlayer::Renderer会往消息队列丢入kWhatQueueBuffer消息:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">void NuPlayer::Renderer::queueBuffer(</span><br><span class="line">        bool audio,</span><br><span class="line">        const sp&lt;ABuffer&gt; &amp;buffer,</span><br><span class="line">        const sp&lt;AMessage&gt; &amp;notifyConsumed) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = new AMessage(kWhatQueueBuffer, this);</span><br><span class="line">    msg-&gt;setInt32(&quot;queueGeneration&quot;, getQueueGeneration(audio));</span><br><span class="line">    msg-&gt;setInt32(&quot;audio&quot;, static_cast&lt;int32_t&gt;(audio));</span><br><span class="line">    msg-&gt;setBuffer(&quot;buffer&quot;, buffer);</span><br><span class="line">    msg-&gt;setMessage(&quot;notifyConsumed&quot;, notifyConsumed);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void NuPlayer::Renderer::onMessageReceived(const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    switch (msg-&gt;what()) &#123;</span><br><span class="line">        case kWhatQueueBuffer:</span><br><span class="line">        &#123;</span><br><span class="line">            onQueueBuffer(msg);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void NuPlayer::Renderer::onQueueBuffer(const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    int32_t audio;</span><br><span class="line">    CHECK(msg-&gt;findInt32(&quot;audio&quot;, &amp;audio));</span><br><span class="line">    ...</span><br><span class="line">    sp&lt;ABuffer&gt; buffer;</span><br><span class="line">    CHECK(msg-&gt;findBuffer(&quot;buffer&quot;, &amp;buffer));</span><br><span class="line">    </span><br><span class="line">    sp&lt;AMessage&gt; notifyConsumed;</span><br><span class="line">    CHECK(msg-&gt;findMessage(&quot;notifyConsumed&quot;, &amp;notifyConsumed));</span><br><span class="line"></span><br><span class="line">    QueueEntry entry;</span><br><span class="line">    entry.mBuffer = buffer;</span><br><span class="line">    entry.mNotifyConsumed = notifyConsumed;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    if (audio) &#123;</span><br><span class="line">        Mutex::Autolock autoLock(mLock);</span><br><span class="line">        mAudioQueue.push_back(entry);</span><br><span class="line">        postDrainAudioQueue_l();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        mVideoQueue.push_back(entry);</span><br><span class="line">        postDrainVideoQueue();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里会判断是从AudioDecoder传来的音频数据,还是从VideoDecoder传来的视频数据。音频数据会丢到mAudioQueue而视频数据会丢到mVideoQueue,然后调用postDrainAudioQueue_l或者postDrainVideoQueue通过Handler机制发送音频处理消息或者视频处理消息</p>
<h2 id="音频处理"><a href="#音频处理" class="headerlink" title="音频处理"></a>音频处理</h2><p>让我们先看看音频部分的处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">void NuPlayer::Renderer::postDrainAudioQueue_l(int64_t delayUs) &#123;</span><br><span class="line">	...</span><br><span class="line">	sp&lt;AMessage&gt; msg = new AMessage(kWhatDrainAudioQueue, this);</span><br><span class="line">    msg-&gt;setInt32(&quot;drainGeneration&quot;, mAudioDrainGeneration);</span><br><span class="line">    msg-&gt;post(delayUs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void NuPlayer::Renderer::onMessageReceived(const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    switch (msg-&gt;what()) &#123;</span><br><span class="line">        case kWhatDrainAudioQueue:</span><br><span class="line">        &#123;</span><br><span class="line">            if (onDrainAudioQueue()) &#123;</span><br><span class="line">            	...</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bool NuPlayer::Renderer::onDrainAudioQueue() &#123;</span><br><span class="line">	...</span><br><span class="line">	while (!mAudioQueue.empty()) &#123;</span><br><span class="line">        QueueEntry *entry = &amp;*mAudioQueue.begin();</span><br><span class="line">        ...</span><br><span class="line">        ssize_t written = mAudioSink-&gt;write(entry-&gt;mBuffer-&gt;data() + entry-&gt;mOffset,</span><br><span class="line">                                            copy, false /* blocking */);</span><br><span class="line">        ...</span><br><span class="line">   &#125;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里NuPlayer::Renderer会从mAudioQueue拿音频数据然后写入mAudioSink。mAudioSink内部就会调用声音输出设备如喇叭等去播放了。</p>
<h2 id="视频处理"><a href="#视频处理" class="headerlink" title="视频处理"></a>视频处理</h2><p>接着看看视频处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">void NuPlayer::Renderer::postDrainVideoQueue() &#123;</span><br><span class="line">	sp&lt;AMessage&gt; msg = new AMessage(kWhatDrainVideoQueue, this);</span><br><span class="line">	...</span><br><span class="line">	msg-&gt;post(postDelayUs);</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void NuPlayer::Renderer::onMessageReceived(const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    switch (msg-&gt;what()) &#123;</span><br><span class="line">        case kWhatDrainVideoQueue:</span><br><span class="line">        &#123;</span><br><span class="line">            ...</span><br><span class="line">            onDrainVideoQueue();</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void NuPlayer::Renderer::onDrainVideoQueue() &#123;</span><br><span class="line">	...</span><br><span class="line">	QueueEntry *entry = &amp;*mVideoQueue.begin();</span><br><span class="line">	...</span><br><span class="line">	</span><br><span class="line">    entry-&gt;mNotifyConsumed-&gt;setInt64(&quot;timestampNs&quot;, realTimeUs * 1000ll);</span><br><span class="line">    entry-&gt;mNotifyConsumed-&gt;setInt32(&quot;render&quot;, !tooLate);</span><br><span class="line">    entry-&gt;mNotifyConsumed-&gt;post();</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>视频处理这里其实还会做一些数值计算,主要用于视频的平滑播放,这里就忽略了。然后就调用了mNotifyConsumed的post方法。这个mNotifyConsumed是啥呢?大家可以往上拉回到NuPlayer::Decoder::handleAnOutputBuffer给NuPlayer::Renderer丢入解码后的音视频数据那里,估计很多人都没有注意到。</p>
<p>总之,它会给NuPlayer::Decoder发一个kWhatRenderBuffer消息,然后就会让NuPlayer::Decoder去渲染视频画面了,不过它也是交给MediaCodec去渲染而已:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">void NuPlayer::Decoder::onMessageReceived(const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    ALOGV(&quot;[%s] onMessage: %s&quot;, mComponentName.c_str(), msg-&gt;debugString().c_str());</span><br><span class="line"></span><br><span class="line">    switch (msg-&gt;what()) &#123;</span><br><span class="line">        case kWhatRenderBuffer:</span><br><span class="line">        &#123;</span><br><span class="line">            if (!isStaleReply(msg)) &#123;</span><br><span class="line">                onRenderBuffer(msg);</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void NuPlayer::Decoder::onRenderBuffer(const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">	...</span><br><span class="line">   err = mCodec-&gt;renderOutputBufferAndRelease(bufferIx, timestampNs);</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个mCodec大家可能都忘了是啥,其实在NuPlayer::Decoder那节有说过的,就是MediaCodec:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">void NuPlayer::Decoder::onConfigure(const sp&lt;AMessage&gt; &amp;format) &#123;</span><br><span class="line">	...</span><br><span class="line">	AString mime;</span><br><span class="line">    CHECK(format-&gt;findString(&quot;mime&quot;, &amp;mime));</span><br><span class="line">	...</span><br><span class="line">	mCodec = MediaCodec::CreateByType(</span><br><span class="line">            mCodecLooper, mime.c_str(), false /* encoder */, NULL /* err */, mPid);</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="整体架构图"><a href="#整体架构图" class="headerlink" title="整体架构图"></a>整体架构图</h1><p>所以NuPlayer的整个架构图如下:</p>
<img src="/安卓音视频播放-NuPlayer/3.png">

<p>可以看出来, NuPlayer的核心功能是依赖MediaCodec去实现的</p>

    
  </div>
</article>

</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              target="_self"
              >
              关于
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/search/"
              target="_self"
              >
              搜索
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/atom.xml"
              target="_self"
              >
              RSS
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    




  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235687', function() {
      // load success
    });
  }
</script>

  <footer style="flex: 0 0 auto;text-align: center;">
<a style="font-size:12px; color:#6C6C6C" target="_blank">© 2021  林嘉伟 ❤ <a style="font-size:12px; color:#6C6C6C" target="_blank" href="http://beian.miit.gov.cn/" rel="nofollow">粤ICP备2021021473号</a></footer>
</body>
</html>
