<!DOCTYPE html>


  <html class="light page-home">


<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>Android进程冻结机制 | 编程代码笔记</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="技术相关,Android,">
  

  <meta name="description" content="奇怪的ANR今天遇到了个很有意思的anr问题, 应用出现了anr: 127696:08-29 14:12:59.564898  7904  8341 I WindowManager: ANR in Window&amp;#123;3b0709 u0 me.linjw.demo.anr&amp;#125;. Reason:3b0709 me.linjw.demo.anr (server) is not respon">
<meta name="keywords" content="技术相关,Android">
<meta property="og:type" content="article">
<meta property="og:title" content="Android进程冻结机制">
<meta property="og:url" content="https://blog.islinjw.cn/2023/11/01/Android进程冻结机制/index.html">
<meta property="og:site_name" content="编程代码笔记">
<meta property="og:description" content="奇怪的ANR今天遇到了个很有意思的anr问题, 应用出现了anr: 127696:08-29 14:12:59.564898  7904  8341 I WindowManager: ANR in Window&amp;#123;3b0709 u0 me.linjw.demo.anr&amp;#125;. Reason:3b0709 me.linjw.demo.anr (server) is not respon">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://www.plantuml.com/plantuml/svg/Aov9B4bLK79CBiaiooofL4X9BIufogzKKaWiLe09ka34k8eXQb-is_TyxxgdwsOzcxxjwSmLEazx6vzsjBsSDF_fXBwdRRkVxvxyOl_ivokwmMOu5wK2DOLavgOMmVG_xLZmSkOIk7wmCfVKd5HqPUX6kHMbfbQbmbsnV35G1P9qQ5uQH05Nj5QiWcvAVdcUhXs67z3u2hf0DKXkLB1IoC_FLKXCoLAmirLmTdJsS7M9Tmm8YFVrz8jtTF7YGbOBqWjn550R8XGwDd11HK4AOCu2Ae47Cj0BHILFzkv_kcywt3eRRBR1DODC0deBmtgaS4DnGrihwPOXcmMr3m00">
<meta property="og:updated_time" content="2023-11-01T11:02:00.181Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android进程冻结机制">
<meta name="twitter:description" content="奇怪的ANR今天遇到了个很有意思的anr问题, 应用出现了anr: 127696:08-29 14:12:59.564898  7904  8341 I WindowManager: ANR in Window&amp;#123;3b0709 u0 me.linjw.demo.anr&amp;#125;. Reason:3b0709 me.linjw.demo.anr (server) is not respon">
<meta name="twitter:image" content="http://www.plantuml.com/plantuml/svg/Aov9B4bLK79CBiaiooofL4X9BIufogzKKaWiLe09ka34k8eXQb-is_TyxxgdwsOzcxxjwSmLEazx6vzsjBsSDF_fXBwdRRkVxvxyOl_ivokwmMOu5wK2DOLavgOMmVG_xLZmSkOIk7wmCfVKd5HqPUX6kHMbfbQbmbsnV35G1P9qQ5uQH05Nj5QiWcvAVdcUhXs67z3u2hf0DKXkLB1IoC_FLKXCoLAmirLmTdJsS7M9Tmm8YFVrz8jtTF7YGbOBqWjn550R8XGwDd11HK4AOCu2Ae47Cj0BHILFzkv_kcywt3eRRBR1DODC0deBmtgaS4DnGrihwPOXcmMr3m00">

  
    <link rel="alternate" href="/atom.xml" title="编程代码笔记" type="application/atom+xml">
  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=32204ee7" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?57e94d016e201fba3603a8a2b0263af0";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</head>
</html>
<body>

  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            target="_self"
            >
            关于
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/search/"
            target="_self"
            >
            搜索
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/atom.xml"
            target="_self"
            >
            RSS
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#奇怪的ANR"><span class="toc-text">奇怪的ANR</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Freeze"><span class="toc-text">Freeze</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#冻结流程"><span class="toc-text">冻结流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解冻流程"><span class="toc-text">解冻流程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#问题定位与规避"><span class="toc-text">问题定位与规避</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-Android进程冻结机制" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">Android进程冻结机制</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2023.11.01</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>林嘉伟</span>
        </span>
      

      


      

    </div>
  </header>

  <div class="article-content">
    
      <h1 id="奇怪的ANR"><a href="#奇怪的ANR" class="headerlink" title="奇怪的ANR"></a>奇怪的ANR</h1><p>今天遇到了个很有意思的anr问题, 应用出现了anr:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">7696:08-29 14:12:59.564898  7904  8341 I WindowManager: ANR in Window&#123;3b0709 u0 me.linjw.demo.anr&#125;. Reason:3b0709 me.linjw.demo.anr (server) is not responding. Waited 5001ms for FocusEvent(hasFocus=false)</span><br><span class="line">8367:08-29 14:13:11.713363  7904 27946 E ActivityManager: ANR in me.linjw.demo.anr</span><br></pre></td></tr></table></figure>

<p>但是trace文件里面没有任何堆栈:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">Subject: Input dispatching timed out (3b0709 me.linjw.demo.anr (server) is not responding. Waited 5001ms for FocusEvent(hasFocus=false))</span><br><span class="line"></span><br><span class="line">--- CriticalEventLog ---</span><br><span class="line">capacity: 20</span><br><span class="line">timestamp_ms: 1693311179660</span><br><span class="line">window_ms: 300000</span><br><span class="line"></span><br><span class="line">libdebuggerd_client: failed to read status response from tombstoned: timeout reached?</span><br><span class="line"></span><br><span class="line">----- Waiting Channels: pid 26859 at 2023-08-29 14:12:59.664895544+0200 -----</span><br><span class="line">Cmd line: me.linjw.demo.anr</span><br><span class="line"></span><br><span class="line">sysTid=26859     do_freezer_trap</span><br><span class="line">sysTid=26864     do_freezer_trap</span><br><span class="line">sysTid=26865     do_freezer_trap</span><br><span class="line">sysTid=26866     do_freezer_trap</span><br><span class="line">sysTid=26867     do_freezer_trap</span><br><span class="line">sysTid=26868     do_freezer_trap</span><br><span class="line">sysTid=26869     do_freezer_trap</span><br><span class="line">sysTid=26870     do_freezer_trap</span><br><span class="line">sysTid=26871     do_freezer_trap</span><br><span class="line">sysTid=26872     do_freezer_trap</span><br><span class="line">sysTid=26873     do_freezer_trap</span><br><span class="line">sysTid=26874     do_freezer_trap</span><br><span class="line">sysTid=26875     do_freezer_trap</span><br><span class="line">sysTid=26877     do_freezer_trap</span><br><span class="line">sysTid=26879     do_freezer_trap</span><br><span class="line">sysTid=26880     do_freezer_trap</span><br><span class="line">sysTid=26882     do_freezer_trap</span><br><span class="line">sysTid=26883     do_freezer_trap</span><br><span class="line">sysTid=26887     do_freezer_trap</span><br><span class="line">sysTid=26912     do_freezer_trap</span><br><span class="line">sysTid=26918     do_freezer_trap</span><br><span class="line">sysTid=26919     do_freezer_trap</span><br><span class="line">sysTid=26922     do_freezer_trap</span><br><span class="line">sysTid=26923     do_freezer_trap</span><br><span class="line">sysTid=26938     do_freezer_trap</span><br><span class="line">sysTid=27772     do_freezer_trap</span><br><span class="line">sysTid=27815     do_freezer_trap</span><br><span class="line">sysTid=27826     do_freezer_trap</span><br><span class="line">sysTid=27827     do_freezer_trap</span><br><span class="line"></span><br><span class="line">----- end 26859 -----</span><br><span class="line"></span><br><span class="line">libdebuggerd_client: failed to read status response from tombstoned: Try again</span><br><span class="line"></span><br><span class="line">----- Waiting Channels: pid 26859 at 2023-08-29 14:13:09.677383215+0200 -----</span><br><span class="line">Cmd line: me.linjw.demo.anr</span><br><span class="line"></span><br><span class="line">sysTid=26859     do_freezer_trap</span><br><span class="line">sysTid=26864     do_freezer_trap</span><br><span class="line">sysTid=26865     do_freezer_trap</span><br><span class="line">sysTid=26866     do_freezer_trap</span><br><span class="line">sysTid=26867     do_freezer_trap</span><br><span class="line">sysTid=26868     do_freezer_trap</span><br><span class="line">sysTid=26869     do_freezer_trap</span><br><span class="line">sysTid=26870     do_freezer_trap</span><br><span class="line">sysTid=26871     do_freezer_trap</span><br><span class="line">sysTid=26872     do_freezer_trap</span><br><span class="line">sysTid=26873     do_freezer_trap</span><br><span class="line">sysTid=26874     do_freezer_trap</span><br><span class="line">sysTid=26875     do_freezer_trap</span><br><span class="line">sysTid=26877     do_freezer_trap</span><br><span class="line">sysTid=26879     do_freezer_trap</span><br><span class="line">sysTid=26880     do_freezer_trap</span><br><span class="line">sysTid=26882     do_freezer_trap</span><br><span class="line">sysTid=26883     do_freezer_trap</span><br><span class="line">sysTid=26887     do_freezer_trap</span><br><span class="line">sysTid=26912     do_freezer_trap</span><br><span class="line">sysTid=26918     do_freezer_trap</span><br><span class="line">sysTid=26919     do_freezer_trap</span><br><span class="line">sysTid=26922     do_freezer_trap</span><br><span class="line">sysTid=26923     do_freezer_trap</span><br><span class="line">sysTid=26938     do_freezer_trap</span><br><span class="line">sysTid=27772     do_freezer_trap</span><br><span class="line">sysTid=27815     do_freezer_trap</span><br><span class="line">sysTid=27826     do_freezer_trap</span><br><span class="line">sysTid=27827     do_freezer_trap</span><br><span class="line"></span><br><span class="line">----- end 26859 -----</span><br></pre></td></tr></table></figure>

<p>从日志上过滤进程pid可以看到正在正常的执行任务,还没有执行完就被am_freeze冻结了进程:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">08-29 14:11:45.807967 26859 27815 V MessageEncoder: ... // 正常执行任务的打印</span><br><span class="line">08-29 14:11:45.809835 26859 26859 D FloatView: ... // 正常执行任务的打印,任务没有执行完,后面应该还有打印但实际没有</span><br><span class="line">08-29 14:11:45.884625  7904  8331 D ActivityManager: freezing 26859 me.linjw.demo.anr</span><br><span class="line">08-29 14:11:45.885503  7904  8331 I am_freeze: [26859,me.linjw.demo.anr]</span><br><span class="line">08-29 14:12:59.660658  7904 27946 I am_anr  : [0,26859,me.linjw.demo.anr,545832517,Input dispatching timed out (3b0709 me.linjw.demo.anr (server) is not responding. Waited 5001ms for FocusEvent(hasFocus=false))]</span><br></pre></td></tr></table></figure>

<p>由于进程被冻结了,所以处理不了Input消息所以anr,由于进程被冻结了,所以anr的时候让进程去dump堆栈的请求也不会被处理。</p>
<h1 id="Freeze"><a href="#Freeze" class="headerlink" title="Freeze"></a>Freeze</h1><p>很多的进程在退出前台之后会长期在后台占用内存、cpu,影响用户体验。在内存不足的时候会触发lmk清除内存,但是如果内存充足的情况下为了加速应用的切换速度,是不会杀死后台进程的。为了解决应用在后台默默消化cpu资源的问题,高版本的安卓实现了一套冻结进程的机制。</p>
<p>我们可以在开发者选项里面找到”Suspend execution for cached apps”条目去控制后台进程冻结功能的开关,也可以用命令去控制:</p>
<blockquote>
<p>adb shell settings put global cached_apps_freezer &lt;enabled|disabled|default&gt;</p>
</blockquote>
<ul>
<li>enable 打开</li>
<li>disabled 关闭</li>
<li>default 由系统决定是否打开</li>
</ul>
<p>进程的OOM_ADJ (Out of Memory Adjustment)值除了决定系统内存不足的时候是否回收该进程,进程冻结策略也是依赖它去计算的。有下面的这些场景会触发进程oom adj值的重新计算,大概有切换Activity、启动广播、绑定服务、是否可见状态改变等:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:frameworks/base/services/core/java/com/android/server/am/OomAdjuster.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OomAdjuster</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"OomAdjuster"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String OOM_ADJ_REASON_METHOD = <span class="string">"updateOomAdj"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String OOM_ADJ_REASON_NONE = OOM_ADJ_REASON_METHOD + <span class="string">"_meh"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String OOM_ADJ_REASON_ACTIVITY = OOM_ADJ_REASON_METHOD + <span class="string">"_activityChange"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String OOM_ADJ_REASON_FINISH_RECEIVER = OOM_ADJ_REASON_METHOD + <span class="string">"_finishReceiver"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String OOM_ADJ_REASON_START_RECEIVER = OOM_ADJ_REASON_METHOD + <span class="string">"_startReceiver"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String OOM_ADJ_REASON_BIND_SERVICE = OOM_ADJ_REASON_METHOD + <span class="string">"_bindService"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String OOM_ADJ_REASON_UNBIND_SERVICE = OOM_ADJ_REASON_METHOD + <span class="string">"_unbindService"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String OOM_ADJ_REASON_START_SERVICE = OOM_ADJ_REASON_METHOD + <span class="string">"_startService"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String OOM_ADJ_REASON_GET_PROVIDER = OOM_ADJ_REASON_METHOD + <span class="string">"_getProvider"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String OOM_ADJ_REASON_REMOVE_PROVIDER = OOM_ADJ_REASON_METHOD + <span class="string">"_removeProvider"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String OOM_ADJ_REASON_UI_VISIBILITY = OOM_ADJ_REASON_METHOD + <span class="string">"_uiVisibility"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String OOM_ADJ_REASON_ALLOWLIST = OOM_ADJ_REASON_METHOD + <span class="string">"_allowlistChange"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String OOM_ADJ_REASON_PROCESS_BEGIN = OOM_ADJ_REASON_METHOD + <span class="string">"_processBegin"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String OOM_ADJ_REASON_PROCESS_END = OOM_ADJ_REASON_METHOD + <span class="string">"_processEnd"</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="冻结流程"><a href="#冻结流程" class="headerlink" title="冻结流程"></a>冻结流程</h2><p>例如Activity destroy的时候在ActivityRecord.setState里面就会去更新进程状态,更新进程状态的时候就会更新oom adj:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:frameworks/base/services/core/java/com/android/server/wm/ActivityRecord.java</span></span><br><span class="line">WindowProcessController app;      <span class="comment">// if non-null, hosting application</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setState</span><span class="params">(State state, String reason)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">case</span> DESTROYING:</span><br><span class="line">            <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; !app.hasActivities()) &#123;</span><br><span class="line">                <span class="comment">// Update any services we are bound to that might care about whether</span></span><br><span class="line">                <span class="comment">// their client may have activities.</span></span><br><span class="line">                <span class="comment">// No longer have activities, so update LRU list and oom adj.</span></span><br><span class="line">                app.updateProcessInfo(<span class="keyword">true</span> <span class="comment">/* updateServiceConnectionActivities */</span>,</span><br><span class="line">                        <span class="keyword">false</span> <span class="comment">/* activityChange */</span>, <span class="keyword">true</span> <span class="comment">/* updateOomAdj */</span>,</span><br><span class="line">                        <span class="keyword">false</span> <span class="comment">/* addPendingTopUid */</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:frameworks/base/services/core/java/com/android/server/wm/WindowProcessController.java</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateProcessInfo</span><span class="params">(<span class="keyword">boolean</span> updateServiceConnectionActivities, <span class="keyword">boolean</span> activityChange,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> updateOomAdj, <span class="keyword">boolean</span> addPendingTopUid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (addPendingTopUid) &#123;</span><br><span class="line">        addToPendingTop();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (updateOomAdj) &#123;</span><br><span class="line">        prepareOomAdjustment();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Posting on handler so WM lock isn't held when we call into AM.</span></span><br><span class="line">    <span class="comment">// 这里是延迟去调用mListener的WindowProcessListener::updateProcessInfo方法,而mListener实际是实现了WindowProcessListener接口的ProcessRecord</span></span><br><span class="line">    <span class="keyword">final</span> Message m = PooledLambda.obtainMessage(WindowProcessListener::updateProcessInfo,</span><br><span class="line">            mListener, updateServiceConnectionActivities, activityChange, updateOomAdj);</span><br><span class="line">    mAtm.mH.sendMessage(m);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:frameworks/base/services/core/java/com/android/server/am/ProcessRecord.java</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProcessRecord</span> <span class="keyword">implements</span> <span class="title">WindowProcessListener</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateProcessInfo</span><span class="params">(<span class="keyword">boolean</span> updateServiceConnectionActivities, <span class="keyword">boolean</span> activityChange,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> updateOomAdj)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (updateOomAdj) &#123;</span><br><span class="line">            mService.updateOomAdjLocked(<span class="keyword">this</span>, OomAdjuster.OOM_ADJ_REASON_ACTIVITY);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进程oom adj值的重新计算最终会去到OomAdjuster.applyOomAdjLSP,在里面就会调用updateAppFreezeStateLSP去更新进程的进程冻结状态:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">updateOomAdjLocked</span><span class="params">(String oomAdjReason)</span> </span>&#123;</span><br><span class="line">    mOomAdjuster.updateOomAdjLocked(oomAdjReason);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:frameworks/base/services/core/java/com/android/server/am/OomAdjuster.java</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">updateOomAdjLocked</span><span class="params">(ProcessRecord app, String oomAdjReason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mProcLock) &#123;</span><br><span class="line">        <span class="keyword">return</span> updateOomAdjLSP(app, oomAdjReason);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">performUpdateOomAdjLSP</span><span class="params">(ProcessRecord app, String oomAdjReason)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    applyOomAdjLSP(app, <span class="keyword">false</span>, SystemClock.uptimeMillis(),</span><br><span class="line">                        SystemClock.elapsedRealtime(), oomAdjReason);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">applyOomAdjLSP</span><span class="params">(ProcessRecord app, <span class="keyword">boolean</span> doingAll, <span class="keyword">long</span> now,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">long</span> nowElapsed, String oomAdjReson)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  updateAppFreezeStateLSP(app);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>updateAppFreezeStateLSP里面判断adj &gt; CACHED_APP_MIN_ADJ(900)的时候就会去调用freezeAppAsyncLSP, 进程的adj在900 ~ 999代表它只有不可见的activity,可以随时被干掉,所以我们去冻结它也不会有影响:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:frameworks/base/services/core/java/com/android/server/am/OomAdjuster.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateAppFreezeStateLSP</span><span class="params">(ProcessRecord app)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> ProcessStateRecord state = app.mState;</span><br><span class="line">    <span class="comment">// Use current adjustment when freezing, set adjustment when unfreezing.</span></span><br><span class="line">    <span class="keyword">if</span> (state.getCurAdj() &gt;= ProcessList.CACHED_APP_MIN_ADJ &amp;&amp; !opt.isFrozen()</span><br><span class="line">            &amp;&amp; !opt.shouldNotFreeze()) &#123;</span><br><span class="line">        mCachedAppOptimizer.freezeAppAsyncLSP(app);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state.getSetAdj() &lt; ProcessList.CACHED_APP_MIN_ADJ) &#123;</span><br><span class="line">        mCachedAppOptimizer.unfreezeAppLSP(app, oomAdjReason);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:frameworks/base/services/core/java/com/android/server/am/ProcessList.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This is a process only hosting activities that are not visible,</span></span><br><span class="line"><span class="comment">// so it can be killed without any disruption.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CACHED_APP_MAX_ADJ = <span class="number">999</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CACHED_APP_MIN_ADJ = <span class="number">900</span>;</span><br></pre></td></tr></table></figure>

<p>freezeAppAsyncLSP里面会post一个10分钟的message在时间到了的时候去冻结进程(就是10分钟之后调用Process.setProcessFrozen):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:frameworks/base/services/core/java/com/android/server/am/CachedAppOptimizer.java</span></span><br><span class="line"><span class="meta">@VisibleForTesting</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DEFAULT_FREEZER_DEBOUNCE_TIMEOUT = <span class="number">600_000L</span>;</span><br><span class="line"><span class="meta">@VisibleForTesting</span> <span class="keyword">volatile</span> <span class="keyword">long</span> mFreezerDebounceTimeout = DEFAULT_FREEZER_DEBOUNCE_TIMEOUT;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">freezeAppAsyncLSP</span><span class="params">(ProcessRecord app)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ProcessCachedOptimizerRecord opt = app.mOptRecord;</span><br><span class="line">    <span class="keyword">if</span> (opt.isPendingFreeze()) &#123;</span><br><span class="line">        <span class="comment">// Skip redundant DO_FREEZE message</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mFreezeHandler.sendMessageDelayed(</span><br><span class="line">            mFreezeHandler.obtainMessage(</span><br><span class="line">                SET_FROZEN_PROCESS_MSG, DO_FREEZE, <span class="number">0</span>, app),</span><br><span class="line">            mFreezerDebounceTimeout);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> SET_FROZEN_PROCESS_MSG:</span><br><span class="line">            <span class="keyword">synchronized</span> (mAm) &#123;</span><br><span class="line">                freezeProcess((ProcessRecord) msg.obj);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">freezeProcess</span><span class="params">(<span class="keyword">final</span> ProcessRecord proc)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    Process.setProcessFrozen(pid, proc.uid, <span class="keyword">true</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:frameworks/base/core/java/android/os/Process.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Freeze or unfreeze the specified process.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pid Identifier of the process to freeze or unfreeze.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uid Identifier of the user the process is running under.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> frozen Specify whether to free (true) or unfreeze (false).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">setProcessFrozen</span><span class="params">(<span class="keyword">int</span> pid, <span class="keyword">int</span> uid, <span class="keyword">boolean</span> frozen)</span></span>;</span><br></pre></td></tr></table></figure>

<p>总结一下就是,如果进程的oom adj大于CACHED_APP_MIN_ADJ,就会启动一个10分钟的定时器,在10分钟之内如果进程的oom adj一直没有变化就会冻结进程。</p>
<h2 id="解冻流程"><a href="#解冻流程" class="headerlink" title="解冻流程"></a>解冻流程</h2><p>同样Activity start的时候在ActivityRecord.setState里面就会去调用WindowProcessController.updateProcessInfo更新进程状态,更新进程状态的时候就会更新oom adj:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:frameworks/base/services/core/java/com/android/server/wm/ActivityRecord.java</span></span><br><span class="line">WindowProcessController app;      <span class="comment">// if non-null, hosting application</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setState</span><span class="params">(State state, String reason)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">case</span> STARTED:</span><br><span class="line">            <span class="comment">// Update process info while making an activity from invisible to visible, to make</span></span><br><span class="line">            <span class="comment">// sure the process state is updated to foreground.</span></span><br><span class="line">            <span class="keyword">if</span> (app != <span class="keyword">null</span>) &#123;</span><br><span class="line">                app.updateProcessInfo(<span class="keyword">false</span> <span class="comment">/* updateServiceConnectionActivities */</span>,</span><br><span class="line">                        <span class="keyword">true</span> <span class="comment">/* activityChange */</span>, <span class="keyword">true</span> <span class="comment">/* updateOomAdj */</span>,</span><br><span class="line">                        <span class="keyword">true</span> <span class="comment">/* addPendingTopUid */</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> ContentCaptureManagerInternal contentCaptureService =</span><br><span class="line">                    LocalServices.getService(ContentCaptureManagerInternal<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            <span class="keyword">if</span> (contentCaptureService != <span class="keyword">null</span>) &#123;</span><br><span class="line">                contentCaptureService.notifyActivityEvent(mUserId, mActivityComponent,</span><br><span class="line">                        ActivityEvent.TYPE_ACTIVITY_STARTED);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终也是会去到OomAdjuster.updateAppFreezeStateLSP,调用链路在上面的冻结流程里面已经追过,这里就省略了。可以看到如果adj小于CACHED_APP_MIN_ADJ怎会嗲用CachedAppOptimizer.unfreezeAppLSP进行解冻:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:frameworks/base/services/core/java/com/android/server/am/OomAdjuster.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateAppFreezeStateLSP</span><span class="params">(ProcessRecord app)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> ProcessStateRecord state = app.mState;</span><br><span class="line">    <span class="comment">// Use current adjustment when freezing, set adjustment when unfreezing.</span></span><br><span class="line">    <span class="keyword">if</span> (state.getCurAdj() &gt;= ProcessList.CACHED_APP_MIN_ADJ &amp;&amp; !opt.isFrozen()</span><br><span class="line">            &amp;&amp; !opt.shouldNotFreeze()) &#123;</span><br><span class="line">        mCachedAppOptimizer.freezeAppAsyncLSP(app);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state.getSetAdj() &lt; ProcessList.CACHED_APP_MIN_ADJ) &#123;</span><br><span class="line">        mCachedAppOptimizer.unfreezeAppLSP(app, oomAdjReason);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终去到CachedAppOptimizer.unfreezeAppInternalLSP里面,如果还在10分钟的后悔时间里面就直接removeMessages删除定时器,如果进程已经冻结了就调用Process.setProcessFrozen解冻进程(frozen参数传入false)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:frameworks/base/services/core/java/com/android/server/am/CachedAppOptimizer.java</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unfreezeAppLSP</span><span class="params">(ProcessRecord app, String reason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mFreezerLock) &#123;</span><br><span class="line">        unfreezeAppInternalLSP(app, reason);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unfreezeAppInternalLSP</span><span class="params">(ProcessRecord app, String reason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> pid = app.getPid();</span><br><span class="line">    <span class="keyword">final</span> ProcessCachedOptimizerRecord opt = app.mOptRecord;</span><br><span class="line">    <span class="keyword">if</span> (opt.isPendingFreeze()) &#123;</span><br><span class="line">        <span class="comment">// Remove pending DO_FREEZE message</span></span><br><span class="line">        mFreezeHandler.removeMessages(SET_FROZEN_PROCESS_MSG, app);</span><br><span class="line">        opt.setPendingFreeze(<span class="keyword">false</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    opt.setFreezerOverride(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span> || !opt.isFrozen()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    Process.setProcessFrozen(pid, app.uid, <span class="keyword">false</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面例子中,整个从退出Activity冻结进程到进入Activity解冻进程的流程如下:</p>
<img src="http://www.plantuml.com/plantuml/svg/Aov9B4bLK79CBiaiooofL4X9BIufogzKKaWiLe09ka34k8eXQb-is_TyxxgdwsOzcxxjwSmLEazx6vzsjBsSDF_fXBwdRRkVxvxyOl_ivokwmMOu5wK2DOLavgOMmVG_xLZmSkOIk7wmCfVKd5HqPUX6kHMbfbQbmbsnV35G1P9qQ5uQH05Nj5QiWcvAVdcUhXs67z3u2hf0DKXkLB1IoC_FLKXCoLAmirLmTdJsS7M9Tmm8YFVrz8jtTF7YGbOBqWjn550R8XGwDd11HK4AOCu2Ae47Cj0BHILFzkv_kcywt3eRRBR1DODC0deBmtgaS4DnGrihwPOXcmMr3m00">

<h1 id="问题定位与规避"><a href="#问题定位与规避" class="headerlink" title="问题定位与规避"></a>问题定位与规避</h1><p>从日志上看这个进程在被kill的时候adj就是905:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">08-29 14:13:11.716499  7904 27946 I ActivityManager: Killing 26859:me.linjw.demo.anr/1000 (adj 905): bg anr</span><br></pre></td></tr></table></figure>

<p>而且它的启动时间和冻结时间刚好差10分钟:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">08-29 14:01:45.124651  7904  8283 I ActivityManager: Start proc 26859:me.linjw.demo.anr/1000 for service &#123;me.linjw.demo.anr/me.linjw.demo.anr.RemoteService&#125;</span><br><span class="line">08-29 14:11:45.885503  7904  8331 I am_freeze: [26859,me.linjw.demo.anr]</span><br></pre></td></tr></table></figure>

<p>也就是说应用进程启动的时候adj就是905,然后就设置了10分钟的进程冻结定时器。</p>
<p>问题在于我们的应用的确只有一个Service,没有启动Activity而是通过WindowManager.addView添加的全局浮窗。</p>
<p>addView源码太多我没有找到更新oom adj的逻辑,但是复现问题使用<code>cat /proc/{pid}/oom_adj</code>命令获取oom adj发现并不是大于900的,也复现不出10分钟被冻结的现象。</p>
<p>那有可能是的确没有,也有可能是在某种情况下没有更新成功。在日志里没有看到任何报错,问题转给系统哥估计也解决不了,只能应用规避了。</p>
<p>规避的方式也很简单,将服务<a href="https://developer.android.com/guide/components/services?hl=zh-cn#Foreground" target="_blank" rel="noopener">设置成前台服务</a>主动触发OOM_ADJ_REASON_UI_VISIBILITY类型的oom adj重新计算:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:frameworks/base/services/core/java/com/android/server/am/ActiveServices.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateServiceForegroundLocked</span><span class="params">(ProcessServiceRecord psr, <span class="keyword">boolean</span> oomAdj)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    mAm.updateProcessForegroundLocked(psr.mApp, anyForeground, fgServiceTypes, oomAdj);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://cs.android.com/android/platform/superproject/+/android-13.0.0_r74:frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">updateProcessForegroundLocked</span><span class="params">(ProcessRecord proc, <span class="keyword">boolean</span> isForeground,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> fgServiceTypes, <span class="keyword">boolean</span> oomAdj)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (oomAdj) &#123;</span><br><span class="line">        updateOomAdjLocked(proc, OomAdjuster.OOM_ADJ_REASON_UI_VISIBILITY);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


    
  </div>
</article>

</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              target="_self"
              >
              关于
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/search/"
              target="_self"
              >
              搜索
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/atom.xml"
              target="_self"
              >
              RSS
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    




  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235687', function() {
      // load success
    });
  }
</script>

  <footer style="flex: 0 0 auto;text-align: center;">
<a style="font-size:12px; color:#6C6C6C" target="_blank">© 2021  林嘉伟 ❤ <a style="font-size:12px; color:#6C6C6C" target="_blank" href="http://beian.miit.gov.cn/" rel="nofollow">粤ICP备2021021473号</a></footer>
</body>
</html>
