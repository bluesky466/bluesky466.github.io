<!DOCTYPE html>


  <html class="light page-home">


<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>如何实现安卓消息推送 | 编程代码笔记</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="技术相关,Android,">
  

  <meta name="description" content="最近突然对安卓消息推送的原理感兴趣,找了不少资料,实现了一个包括服务端和客户端的简单Demo。 在具体实现的时候踩了不少坑,这里做一下笔记,防止以后忘记。 安卓消息推送的实现方案有下面几种:  MQTT协议实现 XMPP协议实现 C2DM云端推送功能(google官方提供,系统内置,但是国内用不了……) 中国统一推送(工信部牵头成立,但是目前只是开了几次会议,并没有什么实际的接口出来,不过以后应该">
<meta name="keywords" content="技术相关,Android">
<meta property="og:type" content="article">
<meta property="og:title" content="如何实现安卓消息推送">
<meta property="og:url" content="https://blog.islinjw.cn/2017/12/14/如何实现安卓消息推送/index.html">
<meta property="og:site_name" content="编程代码笔记">
<meta property="og:description" content="最近突然对安卓消息推送的原理感兴趣,找了不少资料,实现了一个包括服务端和客户端的简单Demo。 在具体实现的时候踩了不少坑,这里做一下笔记,防止以后忘记。 安卓消息推送的实现方案有下面几种:  MQTT协议实现 XMPP协议实现 C2DM云端推送功能(google官方提供,系统内置,但是国内用不了……) 中国统一推送(工信部牵头成立,但是目前只是开了几次会议,并没有什么实际的接口出来,不过以后应该">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://blog.islinjw.cn/如何实现安卓消息推送/1.png">
<meta property="og:image" content="https://blog.islinjw.cn/如何实现安卓消息推送/2.png">
<meta property="og:image" content="https://blog.islinjw.cn/如何实现安卓消息推送/3.png">
<meta property="og:image" content="https://blog.islinjw.cn/如何实现安卓消息推送/4.png">
<meta property="og:updated_time" content="2022-02-07T05:47:21.438Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="如何实现安卓消息推送">
<meta name="twitter:description" content="最近突然对安卓消息推送的原理感兴趣,找了不少资料,实现了一个包括服务端和客户端的简单Demo。 在具体实现的时候踩了不少坑,这里做一下笔记,防止以后忘记。 安卓消息推送的实现方案有下面几种:  MQTT协议实现 XMPP协议实现 C2DM云端推送功能(google官方提供,系统内置,但是国内用不了……) 中国统一推送(工信部牵头成立,但是目前只是开了几次会议,并没有什么实际的接口出来,不过以后应该">
<meta name="twitter:image" content="https://blog.islinjw.cn/如何实现安卓消息推送/1.png">

  
    <link rel="alternate" href="/atom.xml" title="编程代码笔记" type="application/atom+xml">
  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=32204ee7" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?57e94d016e201fba3603a8a2b0263af0";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</head>
</html>
<body>

  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            target="_self"
            >
            关于
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/search/"
            target="_self"
            >
            搜索
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/atom.xml"
            target="_self"
            >
            RSS
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#MQTT协议"><span class="toc-text">MQTT协议</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MQTT原理"><span class="toc-text">MQTT原理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实现库的选择"><span class="toc-text">实现库的选择</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MQTT-服务器搭建"><span class="toc-text">MQTT 服务器搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、安装jdk"><span class="toc-text">1、安装jdk</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、下载apache-apollo"><span class="toc-text">2、下载apache-apollo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、创建项目"><span class="toc-text">3、创建项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4、编辑admin-ip配置"><span class="toc-text">4、编辑admin ip配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5、启动MQTT服务"><span class="toc-text">5、启动MQTT服务</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Python-paho-mqtt"><span class="toc-text">Python paho-mqtt</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Python-paho-mqtt-简单收发端Demo"><span class="toc-text">Python paho-mqtt 简单收发端Demo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常见错误"><span class="toc-text">常见错误</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#权限配置"><span class="toc-text">权限配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#创建用户"><span class="toc-text">创建用户</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建用户组"><span class="toc-text">创建用户组</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#设置用户组权限"><span class="toc-text">设置用户组权限</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#安卓端实现"><span class="toc-text">安卓端实现</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#主题名和主题通配符"><span class="toc-text">主题名和主题通配符</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#多层通配符"><span class="toc-text">多层通配符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#单层通配符"><span class="toc-text">单层通配符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#开始通配符"><span class="toc-text">开始通配符</span></a></li></ol></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-如何实现安卓消息推送" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">如何实现安卓消息推送</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2017.12.14</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>林嘉伟</span>
        </span>
      

      


      

    </div>
  </header>

  <div class="article-content">
    
      <p>最近突然对安卓消息推送的原理感兴趣,找了不少资料,实现了一个包括服务端和客户端的简单Demo。</p>
<p>在具体实现的时候踩了不少坑,这里做一下笔记,防止以后忘记。</p>
<p>安卓消息推送的实现方案有下面几种:</p>
<ul>
<li>MQTT协议实现</li>
<li>XMPP协议实现</li>
<li>C2DM云端推送功能(google官方提供,系统内置,但是国内用不了……)</li>
<li><a href="http://www.chinaupa.com/" target="_blank" rel="noopener">中国统一推送</a>(工信部牵头成立,但是目前只是开了几次会议,并没有什么实际的接口出来,不过以后应该会是中国境内的首选方案)</li>
</ul>
<p>我这里选择了MQTT协议去实现。</p>
<h1 id="MQTT协议"><a href="#MQTT协议" class="headerlink" title="MQTT协议"></a>MQTT协议</h1><p>MQTT是一个客户端服务端架构的发布/订阅模式的消息传输协议。它的设计思想是轻巧、开放、简单、规范，因此易于实现。这些特点使得它对很多场景来说都是很好的选择，包括受限的环境如机器与机器的通信（M2M）以及物联网环境（IoT），这些场景要求很小的代码封装或者网络带宽非常昂贵。</p>
<p>本协议运行在TCP/IP，或其它提供了有序、可靠、双向连接的网络连接上。它有以下特点：</p>
<p>使用发布/订阅消息模式，提供了一对多的消息分发和应用之间的解耦。</p>
<p>消息传输不需要知道负载内容。</p>
<p>提供三种等级的服务质量：.</p>
<p>“最多一次”，尽操作环境所能提供的最大努力分发消息。消息可能会丢失。例如，这个等级可用于环境传感器数据，单次的数据丢失没关系，因为不久之后会再次发送。<br>“至少一次”，保证消息可以到达，但是可能会重复。<br>“仅一次”，保证消息只到达一次。例如，这个等级可用在一个计费系统中，这里如果消息重复或丢失会导致不正确的收费。<br>很小的传输消耗和协议数据交换，最大限度减少网络流量</p>
<p>异常连接断开发生时，能通知到相关各方。</p>
<p>上面这一段话是从网友翻译的MQTT中文文档直接复制的。有兴趣的同学可以直接访问<a href="https://github.com/mcxiaoke/mqtt" target="_blank" rel="noopener">MQTT协议中文版</a>查看具体的协议细节。</p>
<h2 id="MQTT原理"><a href="#MQTT原理" class="headerlink" title="MQTT原理"></a>MQTT原理</h2><p>MQTT协议原理的原理简单说来就是客户端与服务端通过心跳包来保持连接。客户接收端向服务端订阅消息,客户发布端向服务端发布消息。服务端再将消息分发给订阅了该消息的客户接收端。</p>
<p>原理图如下:</p>
<img src="/如何实现安卓消息推送/1.png">

<h1 id="实现库的选择"><a href="#实现库的选择" class="headerlink" title="实现库的选择"></a>实现库的选择</h1><p>因为<a href="https://github.com/mcxiaoke/mqtt" target="_blank" rel="noopener">MQTT协议中文版</a>上面已经有了整个QMTT的协议细节,所以理论上如果你够厉害的话,完全可以自己从零开始实现服务端和客户端。</p>
<p>但是从实际项目中,我还是倾向选择官方提供或者第三方开源的项目直接使用。</p>
<p>其实官方已经给我们提供了一些推荐实现:</p>
<p><a href="https://github.com/mqtt/mqtt.github.io/wiki/software?id=software" target="_blank" rel="noopener">https://github.com/mqtt/mqtt.github.io/wiki/software?id=software</a></p>
<h1 id="MQTT-服务器搭建"><a href="#MQTT-服务器搭建" class="headerlink" title="MQTT 服务器搭建"></a>MQTT 服务器搭建</h1><p>我这边选择使用<a href="http://activemq.apache.org/apollo/" target="_blank" rel="noopener">apache-apollo</a>这个开源的MQTT服务器。</p>
<p>网上有不少的博客都有讲它的配置方法的,但是我按着做之后都出现了一些问题。</p>
<h2 id="1、安装jdk"><a href="#1、安装jdk" class="headerlink" title="1、安装jdk"></a>1、安装jdk</h2><p>首先需要去安装jdk:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install default-jdk</span><br></pre></td></tr></table></figure>

<h2 id="2、下载apache-apollo"><a href="#2、下载apache-apollo" class="headerlink" title="2、下载apache-apollo"></a>2、下载apache-apollo</h2><p>然后到<a href="http://www.apache.org/dyn/closer.cgi?path=activemq/activemq-apollo/1.7.1/apache-apollo-1.7.1-windows-distro.zip" target="_blank" rel="noopener">官网</a>下载最新的软件。我这边使用的是腾讯云的ubuntu服务器,所以就下载了linux的版本。</p>
<p>下载完之后解压到/opt目录下(其实任意目录均可,只不过我用linux习惯放这里):</p>
<blockquote>
<p>/opt/apache-apollo-1.7.1</p>
</blockquote>
<h2 id="3、创建项目"><a href="#3、创建项目" class="headerlink" title="3、创建项目"></a>3、创建项目</h2><p>然后进入任意目录使用下面命令创建一个项目(官方管它叫broker):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/apache-apollo-1.7.1/bin/apollo create mybroker</span><br></pre></td></tr></table></figure>

<p>它会在当前目录创建一个mybroker目录,里面就是你的项目。</p>
<h2 id="4、编辑admin-ip配置"><a href="#4、编辑admin-ip配置" class="headerlink" title="4、编辑admin ip配置"></a>4、编辑admin ip配置</h2><p>可以编辑mybroker/etc/apollo.xml进行一些配置。</p>
<p>admin后台会默认被绑定到127.0.0.1,这样你是不能通过你电脑的浏览器去访问服务器的admin后台的:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;web_admin bind=&quot;http://127.0.0.1:61680&quot;/&gt;</span><br><span class="line">&lt;web_admin bind=&quot;https://127.0.0.1:61681&quot;/&gt;</span><br></pre></td></tr></table></figure>

<p>我们将它改成0.0.0.0:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;web_admin bind=&quot;http://0.0.0.0:61680&quot;/&gt;</span><br><span class="line">&lt;web_admin bind=&quot;https://0.0.0.0:61681&quot;/&gt;</span><br></pre></td></tr></table></figure>

<p>注意这里的61680和61681端口,之后需要访问该端口去登陆admin后台</p>
<h2 id="5、启动MQTT服务"><a href="#5、启动MQTT服务" class="headerlink" title="5、启动MQTT服务"></a>5、启动MQTT服务</h2><p>你可以进到mybroker/bin/目录中使用下面两种方式中的一种去启动服务:</p>
<ul>
<li>当前进程阻塞启动:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./apollo-broker run</span><br></pre></td></tr></table></figure>

<ul>
<li>启动后台服务:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./apollo-broker-service start</span><br></pre></td></tr></table></figure>

<p>然后你就可以在你的电脑打开浏览器输入网址访问MQTT后台了:</p>
<ul>
<li>如果你的服务是跑在阿里云、腾讯云这样的服务器上:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://服务器ip:61680</span><br></pre></td></tr></table></figure>

<ul>
<li>如果你的服务就是跑在你自己的电脑上:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://0.0.0.0:61680</span><br></pre></td></tr></table></figure>

<p>它的需要输入账号密码才能登陆。默认账号是admin、密码是password</p>
<img src="/如何实现安卓消息推送/2.png">


<img src="/如何实现安卓消息推送/3.png">

<h1 id="Python-paho-mqtt"><a href="#Python-paho-mqtt" class="headerlink" title="Python paho-mqtt"></a>Python paho-mqtt</h1><p>我们可以用python写一个客户端去验证搭建的mqtt服务器是否可用。</p>
<p>首先需要下载paho-mqtt:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install paho-mqtt</span><br></pre></td></tr></table></figure>

<h2 id="Python-paho-mqtt-简单收发端Demo"><a href="#Python-paho-mqtt-简单收发端Demo" class="headerlink" title="Python paho-mqtt 简单收发端Demo"></a>Python paho-mqtt 简单收发端Demo</h2><p>接收端代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">import paho.mqtt.client as mqtt                                                  </span><br><span class="line"></span><br><span class="line">def on_connect(client, userdata, flags, rc):                                     </span><br><span class="line">    print(&quot;Connected with result code &quot;+str(rc))                                 </span><br><span class="line">    client.subscribe(&quot;topic/test&quot;)                                               </span><br><span class="line"></span><br><span class="line">def on_message(client, userdata, msg):                                           </span><br><span class="line">    print(&quot;on_message &quot;+msg.topic+&quot; &quot;+str(msg.payload))                          </span><br><span class="line"></span><br><span class="line">client = mqtt.Client(client_id=&quot;&quot;, clean_session=True, userdata=None, protocol=mqtt.MQTTv31, transport=&quot;tcp&quot;)</span><br><span class="line">client.username_pw_set(&quot;admin&quot;, &quot;password&quot;)                                      </span><br><span class="line">client.on_connect = on_connect                                                   </span><br><span class="line">client.on_message = on_message                                                   </span><br><span class="line"></span><br><span class="line">client.connect(&quot;www.islinjw.cn&quot;, 61613, 60)                                      </span><br><span class="line">client.loop_forever()</span><br></pre></td></tr></table></figure>

<p>发送端代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import paho.mqtt.client as mqtt                                                  </span><br><span class="line"></span><br><span class="line">def on_connect(client, userdata, flags, rc):                                     </span><br><span class="line">    print(&quot;Connected with result code &quot;+str(rc))                                 </span><br><span class="line"></span><br><span class="line">client = mqtt.Client(client_id=&quot;&quot;, clean_session=True, userdata=None, protocol=mqtt.MQTTv31, transport=&quot;tcp&quot;)</span><br><span class="line">client.username_pw_set(&quot;admin&quot;, &quot;password&quot;)                                      </span><br><span class="line">client.on_connect = on_connect                                                         </span><br><span class="line"></span><br><span class="line">client.connect(&quot;www.islinjw.cn&quot;, 61613, 60)                                                                     </span><br><span class="line">client.publish(&quot;topic/test&quot;, &quot;hello world&quot;)</span><br></pre></td></tr></table></figure>

<p>我们先运行接收端,再运行发送端,就可以在接收端看到”hello world”的打印</p>
<h2 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h2><p>这里需要注意的是一定要配置协议版本为MQTTv31,网上的demo代码都没有配置,没有的话python这就会报错:</p>
<blockquote>
<p>[Errno 104] Connection reset by peer</p>
</blockquote>
<p>服务器则会报空指针,我们可以在mybroker/log/stacktrace.log中看到:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">java.lang.NullPointerException</span><br><span class="line">        at org.apache.activemq.apollo.mqtt.MqttProtocolHandler.on_mqtt_connect(MqttProtocolHandler.java:443)</span><br><span class="line">        at org.apache.activemq.apollo.mqtt.MqttProtocolHandler$9.call(MqttProtocolHandler.java:410)</span><br><span class="line">        at org.apache.activemq.apollo.util.UnitFn1.apply(Scala2JavaHelper.scala:41)</span><br><span class="line">        at org.apache.activemq.apollo.mqtt.MqttProtocolHandler.on_transport_command(MqttProtocolHandler.java:377)</span><br><span class="line">        at org.apache.activemq.apollo.broker.BrokerConnection.on_transport_command(Connection.scala:144)</span><br><span class="line">        at org.apache.activemq.apollo.broker.Connection$$anon$1.onTransportCommand(Connection.scala:71)</span><br><span class="line">        at org.fusesource.hawtdispatch.transport.TcpTransport.drainInbound(TcpTransport.java:709)</span><br><span class="line">        at org.fusesource.hawtdispatch.transport.TcpTransport$9.run(TcpTransport.java:770)</span><br><span class="line">        at org.fusesource.hawtdispatch.internal.SerialDispatchQueue.run(SerialDispatchQueue.java:100)</span><br><span class="line">        at org.fusesource.hawtdispatch.internal.pool.SimpleThread.run(SimpleThread.java:77)</span><br></pre></td></tr></table></figure>

<p>而如果没有设置账号密码的话就收到result code 4:</p>
<blockquote>
<p>Connected with result code 4</p>
</blockquote>
<p>我们可以从<a href="https://pypi.python.org/pypi/paho-mqtt/#single" target="_blank" rel="noopener">官方文档</a>看到result code 4代表用户名或者密码错误:</p>
<blockquote>
<p>0: Connection successful<br>1: Connection refused - incorrect protocol version<br>2: Connection refused - invalid client identifier<br>3: Connection refused - server unavailable<br>4: Connection refused - bad username or password<br>5: Connection refused - not authorised 6-255: Currently unused.</p>
</blockquote>
<h1 id="权限配置"><a href="#权限配置" class="headerlink" title="权限配置"></a>权限配置</h1><p>我们设想一下,如果没有账户系统,那么只要知道服务器的ip和端口,就能随便发送消息了,这样谁都能给你的应用推送消息,十分危险。</p>
<p>所以mqtt是需要用账户密码去建权的,有些账户只能发送,有些账户只能接收,而有些账户全部都能做。</p>
<h2 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h2><p>我们可以编辑mybroker/etc/users.properties添加user1和user2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">admin=password</span><br><span class="line">user1=123456</span><br><span class="line">user2=654321</span><br></pre></td></tr></table></figure>

<p>等号的左边是账户,右边是密码。所以我们也能在这里改admin的密码</p>
<h2 id="创建用户组"><a href="#创建用户组" class="headerlink" title="创建用户组"></a>创建用户组</h2><p>创建完用用户,我们还需要编辑mybroker/etc/groups.properties给用户指定用户组:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">admins=admin</span><br><span class="line">groupsend=user1</span><br><span class="line">grouprecv=user2</span><br><span class="line"></span><br><span class="line"># 还可以用下面的方式将多个用户指定到一个用户组</span><br><span class="line"># groupdemo = user1|user2</span><br></pre></td></tr></table></figure>

<h2 id="设置用户组权限"><a href="#设置用户组权限" class="headerlink" title="设置用户组权限"></a>设置用户组权限</h2><p>最后我们就能在mybroker/etc/apollo.xml设置用户组权限了:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;access_rule allow=&quot;admins&quot; action=&quot;*&quot;/&gt;</span><br><span class="line">&lt;access_rule allow=&quot;*&quot; action=&quot;connect&quot; kind=&quot;connector&quot;/&gt;</span><br><span class="line">&lt;access_rule allow=&quot;groupsend&quot; action=&quot;connect create send&quot;/&gt;</span><br><span class="line">&lt;access_rule allow=&quot;grouprecv&quot; action=&quot;connect receive&quot;/&gt;</span><br></pre></td></tr></table></figure>

<p>可以给一个用户组设置多个权限,多个权限之间用空格分割。从<a href="http://activemq.apache.org/apollo/versions/1.7.1/website/documentation/user-manual.html#Resource_Actions" target="_blank" rel="noopener">官方文档</a>可以看到权限有下面的类别:</p>
<ul>
<li>admin : use of the administrative web interface</li>
<li>monitor : read only use of the administrative web interface</li>
<li>config : use of the administrative web interface to  access and change the broker configuration.</li>
<li>connect : allows connections to the connector or virtual host</li>
<li>create : allows creation</li>
<li>destroy : allows destruction</li>
<li>send : allows the user to send to the destination</li>
<li>receive : allows the user to send to do non-destructive reads from the destination</li>
<li>consume : allows the user to do destructive reads against a destination</li>
<li>* : All actions</li>
</ul>
<p>配置好之后我们的user1就只能发送消息,user2就只能接收消息了。</p>
<h1 id="安卓端实现"><a href="#安卓端实现" class="headerlink" title="安卓端实现"></a>安卓端实现</h1><p>官方推荐的qatja-android我看了一下，它的实现太挫了,所以在github上搜索了下,发现了个不错的库<a href="https://github.com/fusesource/mqtt-client" target="_blank" rel="noopener">mqtt-client</a>。</p>
<p>添加依赖：</p>
<blockquote>
<p>compile ‘org.fusesource.mqtt-client:mqtt-client:1.14’</p>
</blockquote>
<p>因为代码比较简单,所以我就直接贴上来了:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">public class MainActivity extends AppCompatActivity &#123;</span><br><span class="line">    public static final String TAG = &quot;MainActivity&quot;;</span><br><span class="line">    public static final String TOPIC = &quot;topic/test&quot;;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            testMqtt();</span><br><span class="line">        &#125; catch (URISyntaxException e) &#123;</span><br><span class="line">            Log.e(TAG, &quot;testMqtt failed&quot;, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void testMqtt() throws URISyntaxException &#123;</span><br><span class="line">        MQTT mqtt = new MQTT();</span><br><span class="line">        mqtt.setHost(&quot;www.islinjw.cn&quot;, 61613);</span><br><span class="line">        mqtt.setVersion(&quot;3.1&quot;);</span><br><span class="line">        mqtt.setUserName(&quot;admin&quot;);</span><br><span class="line">        mqtt.setPassword(&quot;password&quot;);</span><br><span class="line"></span><br><span class="line">        final CallbackConnection connection = mqtt.callbackConnection();</span><br><span class="line"></span><br><span class="line">        //设置监听</span><br><span class="line">        connection.listener(new ExtendedListener() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void onPublish(UTF8Buffer topic, Buffer body, Callback&lt;Callback&lt;Void&gt;&gt; ack) &#123;</span><br><span class="line">                Log.d(TAG, &quot;onPublish &quot; + topic.toString() + &quot; &quot; + body.toString());</span><br><span class="line"></span><br><span class="line">                NotificationManager notifyManager</span><br><span class="line">                        = (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);</span><br><span class="line">                NotificationCompat.Builder builder = new NotificationCompat</span><br><span class="line">                        .Builder(MainActivity.this)</span><br><span class="line">                        .setSmallIcon(R.mipmap.ic_launcher)</span><br><span class="line">                        .setContentTitle(topic.toString())</span><br><span class="line">                        .setContentText(body.ascii().toString());</span><br><span class="line">                notifyManager.notify(1, builder.build());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onConnected() &#123;</span><br><span class="line">                Log.d(TAG, &quot;onConnected&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onDisconnected() &#123;</span><br><span class="line">                Log.d(TAG, &quot;onDisconnected&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onPublish(UTF8Buffer topic, Buffer body, Runnable ack) &#123;</span><br><span class="line">                Log.d(TAG, &quot;onPublish &quot; + topic.toString() + &quot; &quot; + body);</span><br><span class="line">                ack.run();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onFailure(Throwable value) &#123;</span><br><span class="line">                Log.d(TAG, &quot;onFailure&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        //连接服务器</span><br><span class="line">        connection.connect(new Callback&lt;Void&gt;() &#123;</span><br><span class="line">            public void onFailure(Throwable value) &#123;</span><br><span class="line">                Log.d(TAG, &quot;connect failure&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            public void onSuccess(Void v) &#123;</span><br><span class="line">                //订阅消息</span><br><span class="line">                Topic[] topics = &#123;new Topic(TOPIC, QoS.AT_LEAST_ONCE)&#125;;</span><br><span class="line">                connection.subscribe(topics, new Callback&lt;byte[]&gt;() &#123;</span><br><span class="line">                    public void onSuccess(byte[] qoses) &#123;</span><br><span class="line">                        Log.d(TAG, &quot;subscribe success&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    public void onFailure(Throwable value) &#123;</span><br><span class="line">                        Log.e(TAG, &quot;subscribe failure&quot;, value);</span><br><span class="line">                        connection.disconnect(null); //断开连接</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                //发布一个消息</span><br><span class="line">                byte[] payload = &quot;hello world&quot;.getBytes();</span><br><span class="line">                connection.publish(TOPIC, payload, QoS.AT_LEAST_ONCE, false, new Callback&lt;Void&gt;() &#123;</span><br><span class="line">                    public void onSuccess(Void v) &#123;</span><br><span class="line">                        Log.d(TAG, &quot;publish success&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    public void onFailure(Throwable value) &#123;</span><br><span class="line">                        Log.e(TAG, &quot;publish failure&quot;, value);</span><br><span class="line">                        connection.disconnect(null); //断开连接</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">//                //断开连接</span><br><span class="line">//                connection.disconnect(new Callback&lt;Void&gt;() &#123;</span><br><span class="line">//                    public void onSuccess(Void v) &#123;</span><br><span class="line">//                        Log.d(TAG, &quot;disconnect success&quot;);</span><br><span class="line">//                    &#125;</span><br><span class="line">//</span><br><span class="line">//                    public void onFailure(Throwable value) &#123;</span><br><span class="line">//                        Log.d(TAG, &quot;disconnect failure&quot;);</span><br><span class="line">//                        // disconnects是不会失败的,也就是这里永远不会被调到</span><br><span class="line">//                    &#125;</span><br><span class="line">//                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们就可以用发送端的py脚本将消息推送给安卓客户端了。</p>
<img src="/如何实现安卓消息推送/4.png">

<h1 id="主题名和主题通配符"><a href="#主题名和主题通配符" class="headerlink" title="主题名和主题通配符"></a>主题名和主题通配符</h1><p>发布的消息都有一个主题名,例如我们之前作为例子的”topic/test”。客户端向服务端订阅感兴趣的主题。当有某主题的消息被发布的时候,服务端就会将消息分发给订阅了该主题的客户端。</p>
<p>主题名可以用分割符”/“如果存在的话就会将主题分割为多个主题层级。</p>
<p>有了主题层级的概念之后我们就可以用主题通配符去过滤不同的主题。</p>
<p>我这里只做简单介绍,详细的信息可以参考<a href="https://github.com/mcxiaoke/mqtt/blob/master/mqtt/04-OperationalBehavior.md" target="_blank" rel="noopener">文档</a></p>
<h2 id="多层通配符"><a href="#多层通配符" class="headerlink" title="多层通配符"></a>多层通配符</h2><p>数字标志（”#”）是用于匹配主题中任意层级的通配符。多层通配符表示它的父级和任意数量的子层级。多层通配符必须位于它自己的层级或者跟在主题层级分隔符后面。不管哪种情况，它都必须是主题过滤器的最后一个字符。</p>
<p>例如，如果客户端订阅主题 “sport/tennis/player1/#”，它会收到使用下列主题名发布的消息：</p>
<ul>
<li>“sport/tennis/player1”</li>
<li>“sport/tennis/player1/ranking”</li>
<li>“sport/tennis/player1/score/wimbledon”</li>
<li>“sport/#”也匹配单独的 “sport” ，因为 # 包括它的父级。</li>
<li>“#”也是有效的，会收到所有的应用消息。</li>
</ul>
<p>多层通配符用法举例:</p>
<ul>
<li>“sport/tennis/#”也是有效的。</li>
<li>“sport/tennis#”是无效的。</li>
<li>“sport/tennis/#/ranking”是无效的。</li>
</ul>
<h2 id="单层通配符"><a href="#单层通配符" class="headerlink" title="单层通配符"></a>单层通配符</h2><p>加号 (“+”) 是只能用于单个主题层级匹配的通配符。在主题过滤器的任意层级都可以使用单层通配符，包括第一个和最后一个层级。然而它必须占据过滤器的整个层级。可以在主题过滤器中的多个层级中使用它，也可以和多层通配符一起使用。</p>
<p>例如， “sport/tennis/+” 匹配 “sport/tennis/player1” 和 “sport/tennis/player2”,但是不匹配 “sport/tennis/player1/ranking” 。同时，由于单层通配符只能匹配一个层级， “sport/+” 不匹配 “sport” 但是却匹配 “sport/“。</p>
<p>单层通配符的一些使用情况:</p>
<ul>
<li>“+” 是有效的。</li>
<li>“+/tennis/#” 是有效的。</li>
<li>“sport+” 是无效的。</li>
<li>“sport/+/player1” 也是有效的。</li>
<li>“/finance” 匹配 “+/+” 和 “/+” ，但是不匹配 “+”。</li>
</ul>
<h2 id="开始通配符"><a href="#开始通配符" class="headerlink" title="开始通配符"></a>开始通配符</h2><p>美元符号(“$”) 用于匹配起始主题,如”$SYS/“ 被广泛用作包含服务器特定信息或控制接口的主题的前缀。</p>
<p>开始通配符的一些用法:</p>
<ul>
<li>订阅 “#” 的客户端不会收到任何发布到以 “$” 开头主题的消息。</li>
<li>订阅 “+/monitor/Clients” 的客户端不会收到任何发布到 “$SYS/monitor/Clients” 的消息。</li>
<li>订阅 “$SYS/#” 的客户端会收到发布到以 “$SYS/” 开头主题的消息。</li>
<li>订阅 “$SYS/monitor/+” 的客户端会收到发布到 “$SYS/monitor/Clients” 主题的消息。</li>
<li>如果客户端想同时接受以 “$SYS/“ 开头主题的消息和不以 “$” 开头主题的消息，它需要同时订阅 “#” 和 “$SYS/#”。</li>
</ul>

    
  </div>
</article>

</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              target="_self"
              >
              关于
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/search/"
              target="_self"
              >
              搜索
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/atom.xml"
              target="_self"
              >
              RSS
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    




  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235687', function() {
      // load success
    });
  }
</script>

  <footer style="flex: 0 0 auto;text-align: center;">
<a style="font-size:12px; color:#6C6C6C" target="_blank">© 2021  林嘉伟 ❤ <a style="font-size:12px; color:#6C6C6C" target="_blank" href="http://beian.miit.gov.cn/" rel="nofollow">粤ICP备2021021473号</a></footer>
</body>
</html>
