<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>修我矛戟</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="林嘉伟的个人博客">
<meta property="og:type" content="website">
<meta property="og:title" content="修我矛戟">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="修我矛戟">
<meta property="og:description" content="林嘉伟的个人博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="修我矛戟">
<meta name="twitter:description" content="林嘉伟的个人博客">
  
    <link rel="alternative" href="/atom.xml" title="修我矛戟" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://blog.islinjw.cn/head.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">林嘉伟</a></h1>
		</hgroup>

		
		<p class="header-subtitle">什么都想学</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>標籤</li>
						
						<li>友情链接</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/tags/读书笔记">读书笔记</a></li>
				        
							<li><a href="/tags/技术相关">技术相关</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="http://github.com/bluesky466" title="github">github</a>
					        
								<a class="mail" target="_blank" href="mailto:466474482@qq.com" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Android/" style="font-size: 18px;">Android</a> <a href="/tags/Http协议/" style="font-size: 12px;">Http协议</a> <a href="/tags/automake/" style="font-size: 10px;">automake</a> <a href="/tags/c/" style="font-size: 12px;">c++</a> <a href="/tags/grpc/" style="font-size: 10px;">grpc</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/lua/" style="font-size: 14px;">lua</a> <a href="/tags/单元测试/" style="font-size: 12px;">单元测试</a> <a href="/tags/技术相关/" style="font-size: 20px;">技术相关</a> <a href="/tags/编译相关/" style="font-size: 10px;">编译相关</a> <a href="/tags/设计模式/" style="font-size: 12px;">设计模式</a> <a href="/tags/读书笔记/" style="font-size: 16px;">读书笔记</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.guorongfei.com/">荣飞大大的博客</a>
			        
			        </div>
				</section>
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">林嘉伟</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="http://blog.islinjw.cn/head.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">林嘉伟</h1>
			</hgroup>
			
			<p class="header-subtitle">什么都想学</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags/读书笔记">读书笔记</a></li>
		        
					<li><a href="/tags/技术相关">技术相关</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="http://github.com/bluesky466" title="github">github</a>
			        
						<a class="mail" target="_blank" href="mailto:466474482@qq.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-GTest源码剖析-测试代码的注册" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/02/15/GTest源码剖析-测试代码的注册/" class="article-date">
  	<time datetime="2016-02-15T14:07:08.000Z" itemprop="datePublished">2016-02-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/15/GTest源码剖析-测试代码的注册/">GTest源码剖析 - 测试代码的注册</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>单元测试框架，最基本的功能当然就是运行用户所编写的测试用例了。</p>
<h2 id="u6BEB_u65E0_u6280_u5DE7_u7684_u65B9_u6CD5"><a href="#u6BEB_u65E0_u6280_u5DE7_u7684_u65B9_u6CD5" class="headerlink" title="毫无技巧的方法"></a><strong>毫无技巧的方法</strong></h2><p>一种毫无技巧的方法就是用户手动在 main 函数里面将自己编写的测试代码注册到框架中，就像下面的代码：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123;...&#125;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    RegisterTestFunc(test1);</span><br><span class="line">    RegisterTestFunc(test2);</span><br><span class="line">    RegisterTestFunc(test3);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样的代码虽然可以运行，但是将初始化的责任放到的用户那里，这样的代码是不够优秀的。有两种容易出现的情况：一是项目中可能拥有大量的测试代码，用户很有可能会漏掉其中的部分测试代码，忘记把它们注册到测试框架中。二是可能用户去掉了一些测试代码，却又忘了去掉注册的代码。</p>
<p>后者编译器会报错，但前者却没有办法检测（除非对着测试结果一条条的检测，看是否所有测试代码都运行了）。</p>
<h2 id="u4E00_u79CD_u6709_u95EE_u9898_u7684_u65B9_u6CD5"><a href="#u4E00_u79CD_u6709_u95EE_u9898_u7684_u65B9_u6CD5" class="headerlink" title="一种有问题的方法"></a><strong>一种有问题的方法</strong></h2><p>最好在编写测试代码的时候就能通过一种机制帮用户注册，而不用用户手动去注册。面对这个需求，我脑海里面想到的第一个方法就是利用全局变量和宏定义。</p>
<p>首先定义一个用来管理注册的测试方法的类：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">list</span>&lt;function&lt;<span class="keyword">void</span>()&gt;&gt; FuncList;</span><br><span class="line">   <span class="keyword">class</span> Test&#123;</span><br><span class="line">   <span class="keyword">public</span>:</span><br><span class="line">       Test(<span class="keyword">const</span> function&lt;<span class="keyword">void</span>()&gt;&amp; test_func)&#123;</span><br><span class="line">           test_funcs_.push_back(test_func);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runAllTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">auto</span> func : test_funcs_)&#123;</span><br><span class="line">               func();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span>:</span><br><span class="line">       <span class="keyword">static</span> FuncList test_funcs_;</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure></p>
<p>它有一个静态的成员变量 test_funcs_ ，用来保存测试方法，同时它有一个构造函数用来将传入的测试方法插入 test_funcs_ 中</p>
<p>接着定义一个宏：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> TEST_FUNC(NAME) \</span><br><span class="line">    void NAME(); \</span><br><span class="line">    static Test register_##NAME(NAME); \</span><br><span class="line">    void NAME()</span></span><br></pre></td></tr></table></figure></p>
<p>它在帮助我们在定义一个测试方法的时候自动注册到 test_funcs_ 中。原理其实很简单，就是在声明一个函数的同时声明一个 Test 全局变量，将定义的测试方法传入，这个测试函数就会在 Test 的构造函数中被插入 test_funcs_ 。</p>
<p>所以我们只要这样编写测试代码，就能实现自动注册了：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TEST_FUNC(testSomething)&#123;</span><br><span class="line">       ...</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>看起来这个方法不错是吧？可惜这种方法是有问题的！至少在我的 vs2013 上会崩溃！</p>
<p>问题就出在 Test 全局变量和 Test::test_funcs_ 的初始化顺序上。你无法保证 Test::test_funcs_ 比全局变量 Test 先初始化。很奇怪是吧？ Test 的静态成员变量居然比 Test 全局变量的初始化时间晚，也就是说在 Test 这个类还没有完全准备好的时候，就已经拿来创建一个全局变量了。书上一直强调的全局变量的初始化顺序不能确定难道也有这种含义？</p>
<h2 id="u4E00_u79CD_u53EF_u80FD_u53EF_u884C_u7684_u65B9_u6CD5"><a href="#u4E00_u79CD_u53EF_u80FD_u53EF_u884C_u7684_u65B9_u6CD5" class="headerlink" title="一种可能可行的方法"></a><strong>一种可能可行的方法</strong></h2><p>既然是因为初始化顺序导致了内存错误，那我们只要使用某种机制让保存测试函数的容器首先初始化就行了。</p>
<p>让我们将 Test 类的定义修改成下面的样子：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Test&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runAllTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> i : test_list)&#123;</span><br><span class="line">            i-&gt;run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addTest</span><span class="params">(Test* test)</span></span>&#123;</span><br><span class="line">        test_list.push_back(test);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">list</span>&lt;Test*&gt; test_list;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>容器里面不再直接放测试函数，改为放 Test 的指针。而 Test 又是一个抽象类，所以事实上放的是 Test 的子类。</p>
<p>再把 TEST_FUNC 宏的定义改成下面的样子：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> TEST_FUNC(NAME) \</span><br><span class="line">    class NAME : public Test&#123; \</span><br><span class="line">    public: \</span><br><span class="line">        virtual void run(); \</span><br><span class="line">    private: \</span><br><span class="line">        NAME()&#123; \</span><br><span class="line">            addTest(this); \</span><br><span class="line">        &#125; \</span><br><span class="line">        static NAME* instance_; \</span><br><span class="line">    &#125;; \</span><br><span class="line">    NAME* NAME::instance_ = new NAME(); \</span><br><span class="line">    void NAME::run()</span></span><br></pre></td></tr></table></figure>
<p>现在实际上用户写的测试方法实现的是 Test 的子类的 run 方法。</p>
<p>依然是需要在定义测试方法的时候顺便定义一个全局变量，但我们换了一种方式，定义了一个类静态变量。子类在构造函数中把自己注册到 Test 的测试容器中，而且子类还包含了一个本类指针静态成员变量（有点拗口，但看代码很容易看出来）。在子类的静态成员变量初始化的之前，父类的静态成员变量应该就已经初始化了。就是根据这种机制，达到了我们的目的。</p>
<p>使用方法还是一样：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TEST_FUNC(testSomething)&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为什么说这是“一种可能可行的方法”呢？因为父类的静态成员变量初始化先于子类的静态成员变量初始化这个前提是我自己推论的。可能是我读的书少或者读书不仔细，至今没有在哪里见到有提及父类和子类的静态成员变量的初始化顺序的。所以虽然在我的编译器上它的确能正常的工作，但为了严谨起见，姑且称为“可能”的吧。如果有人有在哪里看到这方面的描述，请务必私信我，让我把“可能”二字去掉或者将标题改成“另一种有问题的方法”</p>
<h2 id="GTest__u7684_u505A_u6CD5"><a href="#GTest__u7684_u505A_u6CD5" class="headerlink" title="GTest 的做法"></a><strong>GTest 的做法</strong></h2><p>讲了这么久我的想法，现状让我们来看看谷歌的大神们是怎么做的吧。</p>
<p>我们从 TEST 宏看起：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">if</span> !GTEST_DONT_DEFINE_TEST</span></span><br><span class="line"><span class="preprocessor"># <span class="keyword">define</span> TEST(test_case_name, test_name) GTEST_TEST(test_case_name, test_name)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>这里这么搞，主要是为了防止 TEST 被系统或者其他框架定义了。如果出现这种情况，只要把GTEST_DONT_DEFINE_TEST 定义为 1，之后编写测试用例的时候直接使用 GTEST_TEST 就好了。不得不说，他们考虑的真仔细。让我们继续跟踪，看 GTEST_TEST：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> GTEST_TEST(test_case_name, test_name)\</span><br><span class="line">  GTEST_TEST_(test_case_name, test_name, \</span><br><span class="line">              ::testing::Test, ::testing::internal::GetTestTypeId())</span></span><br></pre></td></tr></table></figure>
<p>GTEST_TEST 宏又用到了另一个宏 GTEST_TEST_，但我想先说一下 GetTestTypeId，这个东西的用法真的令我眼前一亮，不得不佩服：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function">TypeId <span class="title">GetTestTypeId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> GetTypeId&lt;Test&gt;();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">   <span class="function">TypeId <span class="title">GetTypeId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="comment">// The compiler is required to allocate a different</span></span><br><span class="line">     <span class="comment">// TypeIdHelper&lt;T&gt;::dummy_ variable for each T used to instantiate</span></span><br><span class="line">     <span class="comment">// the template.  Therefore, the address of dummy_ is guaranteed to</span></span><br><span class="line">     <span class="comment">// be unique.</span></span><br><span class="line">     <span class="keyword">return</span> &amp;(TypeIdHelper&lt;T&gt;::dummy_);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">   <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">   <span class="keyword">class</span> TypeIdHelper &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">     <span class="comment">// dummy_ must not have a const type.  Otherwise an overly eager</span></span><br><span class="line">     <span class="comment">// compiler (e.g. MSVC 7.1 &amp; 8.0) may try to merge</span></span><br><span class="line">     <span class="comment">// TypeIdHelper&lt;T&gt;::dummy_ for different Ts as an "optimization".</span></span><br><span class="line">     <span class="keyword">static</span> <span class="keyword">bool</span> dummy_;</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>
<p>这里直接用一个类的静态成员变量的地址当作 id 号。当时我就懵逼了，明明很简单，怎么就感觉那么玄幻呢？</p>
<p>膜拜完我们再继续看 GTEST_TEST_：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> GTEST_TEST_(test_case_name, test_name, parent_class, parent_id)\</span><br><span class="line">class GTEST_TEST_CLASS_NAME_(test_case_name, test_name) : public parent_class &#123;\</span><br><span class="line"> public:\</span><br><span class="line">  GTEST_TEST_CLASS_NAME_(test_case_name, test_name)() &#123;&#125;\</span><br><span class="line"> private:\</span><br><span class="line">  virtual void TestBody();\</span><br><span class="line">  static ::testing::TestInfo* const test_info_ GTEST_ATTRIBUTE_UNUSED_;\</span><br><span class="line">  GTEST_DISALLOW_COPY_AND_ASSIGN_(\</span><br><span class="line">      GTEST_TEST_CLASS_NAME_(test_case_name, test_name));\</span><br><span class="line">&#125;;\</span><br><span class="line">\</span><br><span class="line">::testing::TestInfo* const GTEST_TEST_CLASS_NAME_(test_case_name, test_name)\</span><br><span class="line">  ::test_info_ =\</span><br><span class="line">    ::testing::internal::MakeAndRegisterTestInfo(\</span><br><span class="line">        #test_case_name, #test_name, NULL, NULL, \</span><br><span class="line">        (parent_id), \</span><br><span class="line">        parent_class::SetUpTestCase, \</span><br><span class="line">        parent_class::TearDownTestCase, \</span><br><span class="line">        new ::testing::internal::TestFactoryImpl&lt;\</span><br><span class="line">            GTEST_TEST_CLASS_NAME_(test_case_name, test_name)&gt;);\</span><br><span class="line">void GTEST_TEST_CLASS_NAME_(test_case_name, test_name)::TestBody()</span></span><br></pre></td></tr></table></figure></p>
<p>这个宏的做法和我的最后一个方法的 TEST_FUNC 宏差不多，用户写的测试函数实际上是实现了 ::testing::Test 的子类的 TestBody 方法。也是初始化了子类的一个静态成员变量，但GTest这里没有我那么暴力，它初始化的是一个 TestInfo 类型的的静态成员变量，这里面包含了测试的很多信息。其中最重要的是 ::testing::internal::TestFactoryImpl 这个东西：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">template</span> &lt;<span class="keyword">class</span> TestClass&gt;</span><br><span class="line">   <span class="keyword">class</span> TestFactoryImpl : <span class="keyword">public</span> TestFactoryBase &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">     <span class="function"><span class="keyword">virtual</span> Test* <span class="title">CreateTest</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">new</span> TestClass; &#125;</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> TestFactoryBase &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">     <span class="keyword">virtual</span> ~TestFactoryBase() &#123;&#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Creates a test instance to run. The instance is both created and destroyed</span></span><br><span class="line">     <span class="comment">// within TestInfoImpl::Run()</span></span><br><span class="line">     <span class="function"><span class="keyword">virtual</span> Test* <span class="title">CreateTest</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span>:</span><br><span class="line">     TestFactoryBase() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">     GTEST_DISALLOW_COPY_AND_ASSIGN_(TestFactoryBase);</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>
<p>它是一个工厂类，用来创建传入的测试类的实例，也就是 GTEST_TEST_CLASS_NAME_(test_case_name, test_name)&gt; 这个类，它的 TestBody 就是用户所写的测试代码。可以看看 GTEST_TEST_CLASS_NAME_ 的定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> GTEST_TEST_CLASS_NAME_(test_case_name, test_name) \</span><br><span class="line">  test_case_name##_##test_name##_Test</span></span><br></pre></td></tr></table></figure>
<p>ok,很简单是吧？就是字符串拼接而已。</p>
<p>好了，让我们继续深入，看看 MakeAndRegisterTestInfo ：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//gtest.cc</span></span><br><span class="line">   <span class="function">TestInfo* <span class="title">MakeAndRegisterTestInfo</span><span class="params">(</span><br><span class="line">       <span class="keyword">const</span> <span class="keyword">char</span>* test_case_name,</span><br><span class="line">       <span class="keyword">const</span> <span class="keyword">char</span>* name,</span><br><span class="line">       <span class="keyword">const</span> <span class="keyword">char</span>* type_param,</span><br><span class="line">       <span class="keyword">const</span> <span class="keyword">char</span>* value_param,</span><br><span class="line">       TypeId fixture_class_id,</span><br><span class="line">       SetUpTestCaseFunc set_up_tc,</span><br><span class="line">       TearDownTestCaseFunc tear_down_tc,</span><br><span class="line">       TestFactoryBase* factory)</span> </span>&#123;</span><br><span class="line">     TestInfo* <span class="keyword">const</span> test_info =</span><br><span class="line">         <span class="keyword">new</span> TestInfo(test_case_name, name, type_param, value_param,</span><br><span class="line">                      fixture_class_id, factory);</span><br><span class="line">     GetUnitTestImpl()-&gt;AddTestInfo(set_up_tc, tear_down_tc, test_info);</span><br><span class="line">     <span class="keyword">return</span> test_info;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//gtest-internal-inl.h</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> UnitTestImpl* <span class="title">GetUnitTestImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> UnitTest::GetInstance()-&gt;impl();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//gtest.h</span></span><br><span class="line">   <span class="keyword">class</span> GTEST_API_ UnitTest &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">     <span class="function"><span class="keyword">static</span> UnitTest* <span class="title">GetInstance</span><span class="params">()</span></span>;</span><br><span class="line">     ...</span><br><span class="line">     internal::<span class="function">UnitTestImpl* <span class="title">impl</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> impl_; &#125;</span><br><span class="line">     ...</span><br><span class="line">     internal::UnitTestImpl* impl_;</span><br><span class="line">     ...</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//gtest.cc</span></span><br><span class="line">   UnitTest* UnitTest::GetInstance() &#123;</span><br><span class="line">     <span class="comment">// When compiled with MSVC 7.1 in optimized mode, destroying the</span></span><br><span class="line">     <span class="comment">// UnitTest object upon exiting the program messes up the exit code,</span></span><br><span class="line">     <span class="comment">// causing successful tests to appear failed.  We have to use a</span></span><br><span class="line">     <span class="comment">// different implementation in this case to bypass the compiler bug.</span></span><br><span class="line">     <span class="comment">// This implementation makes the compiler happy, at the cost of</span></span><br><span class="line">     <span class="comment">// leaking the UnitTest object.</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">// CodeGear C++Builder insists on a public destructor for the</span></span><br><span class="line">     <span class="comment">// default implementation.  Use this implementation to keep good OO</span></span><br><span class="line">     <span class="comment">// design with private destructor.</span></span><br><span class="line"></span><br><span class="line">   <span class="preprocessor">#<span class="keyword">if</span> (_MSC_VER == <span class="number">1310</span> &amp;&amp; !defined(_DEBUG)) || defined(__BORLANDC__)</span></span><br><span class="line">     <span class="keyword">static</span> UnitTest* <span class="keyword">const</span> instance = <span class="keyword">new</span> UnitTest;</span><br><span class="line">     <span class="keyword">return</span> instance;</span><br><span class="line">   <span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">     <span class="keyword">static</span> UnitTest instance;</span><br><span class="line">     <span class="keyword">return</span> &amp;instance;</span><br><span class="line">   <span class="preprocessor">#<span class="keyword">endif</span>  <span class="comment">// (_MSC_VER == 1310 &amp;&amp; !defined(_DEBUG)) || defined(__BORLANDC__)</span></span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//gtest-internal-inl.h</span></span><br><span class="line">   <span class="keyword">class</span> GTEST_API_ UnitTestImpl &#123;</span><br><span class="line">   	...</span><br><span class="line">       <span class="function"><span class="keyword">void</span> <span class="title">AddTestInfo</span><span class="params">(Test::SetUpTestCaseFunc set_up_tc,</span><br><span class="line">                  Test::TearDownTestCaseFunc tear_down_tc,</span><br><span class="line">                  TestInfo* test_info)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// In order to support thread-safe death tests, we need to</span></span><br><span class="line">       <span class="comment">// remember the original working directory when the test program</span></span><br><span class="line">       <span class="comment">// was first invoked.  We cannot do this in RUN_ALL_TESTS(), as</span></span><br><span class="line">       <span class="comment">// the user may have changed the current directory before calling</span></span><br><span class="line">       <span class="comment">// RUN_ALL_TESTS().  Therefore we capture the current directory in</span></span><br><span class="line">       <span class="comment">// AddTestInfo(), which is called to register a TEST or TEST_F</span></span><br><span class="line">       <span class="comment">// before main() is reached.</span></span><br><span class="line">       <span class="keyword">if</span> (original_working_dir_.IsEmpty()) &#123;</span><br><span class="line">         original_working_dir_.Set(FilePath::GetCurrentDir());</span><br><span class="line">         GTEST_CHECK_(!original_working_dir_.IsEmpty())</span><br><span class="line">             &lt;&lt; <span class="string">"Failed to get the current working directory."</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       GetTestCase(test_info-&gt;test_case_name(),</span><br><span class="line">                   test_info-&gt;type_param(),</span><br><span class="line">                   set_up_tc,</span><br><span class="line">                   tear_down_tc)-&gt;AddTestInfo(test_info);</span><br><span class="line">     &#125;</span><br><span class="line">     ...</span><br><span class="line">     <span class="comment">//这个方法从test_cases_里面获取TestCase</span></span><br><span class="line">     <span class="function">TestCase* <span class="title">GetTestCase</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* test_case_name,</span><br><span class="line">                       <span class="keyword">const</span> <span class="keyword">char</span>* type_param,</span><br><span class="line">                       Test::SetUpTestCaseFunc set_up_tc,</span><br><span class="line">                       Test::TearDownTestCaseFunc tear_down_tc)</span></span>;</span><br><span class="line">     ...</span><br><span class="line">     <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;TestCase*&gt; test_cases_;</span><br><span class="line">     ...</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//gtest.cc</span></span><br><span class="line">   <span class="keyword">void</span> TestCase::AddTestInfo(TestInfo * test_info) &#123;</span><br><span class="line">     test_info_list_.push_back(test_info);</span><br><span class="line">     test_indices_.push_back(<span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(test_indices_.size()));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//gtest.h</span></span><br><span class="line">   <span class="keyword">class</span> GTEST_API_ TestCase &#123;</span><br><span class="line">   	...</span><br><span class="line">   	<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;TestInfo*&gt; test_info_list_;</span><br><span class="line">       <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; test_indices_;</span><br><span class="line">       ...</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure></p>
<p>代码很多，我简单的描述一下。UnitTest 是一个单例类，它有一个成员变量 internal::UnitTestImpl* impl_， impl_ 里面又有成员变量 test_info_list_。最终我们写的测试类就放在 test_info_list_ 里。</p>
<p>九曲十八弯，实际 GTest 用一个单例类 UnitTest 保存了注册的测试代码（放在 ::testing::Test 子类的 TestBody 方法里面）。</p>
<p>那他是怎么解决初始化顺序的问题的？注意看 UnitTest::GetInstance() 方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//gtest.cc</span></span><br><span class="line">   UnitTest* UnitTest::GetInstance() &#123;</span><br><span class="line">     <span class="comment">// When compiled with MSVC 7.1 in optimized mode, destroying the</span></span><br><span class="line">     <span class="comment">// UnitTest object upon exiting the program messes up the exit code,</span></span><br><span class="line">     <span class="comment">// causing successful tests to appear failed.  We have to use a</span></span><br><span class="line">     <span class="comment">// different implementation in this case to bypass the compiler bug.</span></span><br><span class="line">     <span class="comment">// This implementation makes the compiler happy, at the cost of</span></span><br><span class="line">     <span class="comment">// leaking the UnitTest object.</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">// CodeGear C++Builder insists on a public destructor for the</span></span><br><span class="line">     <span class="comment">// default implementation.  Use this implementation to keep good OO</span></span><br><span class="line">     <span class="comment">// design with private destructor.</span></span><br><span class="line"></span><br><span class="line">   <span class="preprocessor">#<span class="keyword">if</span> (_MSC_VER == <span class="number">1310</span> &amp;&amp; !defined(_DEBUG)) || defined(__BORLANDC__)</span></span><br><span class="line">     <span class="keyword">static</span> UnitTest* <span class="keyword">const</span> instance = <span class="keyword">new</span> UnitTest;</span><br><span class="line">     <span class="keyword">return</span> instance;</span><br><span class="line">   <span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">     <span class="keyword">static</span> UnitTest instance;</span><br><span class="line">     <span class="keyword">return</span> &amp;instance;</span><br><span class="line">   <span class="preprocessor">#<span class="keyword">endif</span>  <span class="comment">// (_MSC_VER == 1310 &amp;&amp; !defined(_DEBUG)) || defined(__BORLANDC__)</span></span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里使用了局部静态变量，在第一次进入这个方法的时候就会生成一个 UnitTest 实例！不需要靠人品祈祷编译器按照我们设想的顺序创建全局变量！</p>
<p>谷歌大神们不愧是大神，在看 GTest 源码的时候我都不知道被惊艳了多少次，真心学到了不少东西。怪不得别人都说看源码才是最好的提升方式。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/">c++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/单元测试/">单元测试</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/技术相关/">技术相关</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-读书笔记-《黑客与画家》" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/02/11/读书笔记-《黑客与画家》/" class="article-date">
  	<time datetime="2016-02-11T12:22:40.000Z" itemprop="datePublished">2016-02-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/11/读书笔记-《黑客与画家》/">读书笔记 -《黑客与画家》</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这本书是一本文集，也有点像paul graham的自传。以成长的各个阶段为引子，讲到了paul graham对书呆子、优秀程序员、创业和编程语言等的观点看法。</p>
<p>其实不太适合这个阶段的我读，创业、程序语言的设计这些离我还太遥远。不像书中的”黑客“从初中高中就开始学习编程，在大学时期甚至更早之前就能做出一些很厉害的东西。我经历的实际项目一个巴掌都数的过来，甚至还不知道书中“黑客”推崇备至的lisp代码到底长什么样子，很多东西看来了不能产生太深的感悟。</p>
<p>但换个角度，把它当成一本闲时读物，用来拓展眼界还是极好的。</p>
<p>以前我不明白为什么公司里面的项目组普遍在十人左右，现在才知道小团体和可测量性之间的关系，组织机构越精简往往能提供越大的生产力。</p>
<p>书中对现存编程语言的解析还有对未来编程语言的预测也让我大开眼界，了解到了一些以前从来没有去注意的细节之处。</p>
<p>而要说最大的收获的话，应该就是对于编写代码的方式有了和以前不太一样的理解了。刚学编程那会儿，总是直接上手敲代码，完全没有事前的思考，所以总会写出一堆不堪入目的东西。之后看受一些书本和前辈的影响，又总是喜欢做一些“完美”的设计。通常是考虑了一堆多余的东西，到了真正要编码的时候又发现能力不足以把这些东西都实现，其实就是陷入了“过早优化”。</p>
<p>这本书和《道法自然》的建议有点类似，设计的时候只需要考虑必须实现的功能就可以了。“把整个程序想清楚的时间点，应该是在编写代码的同时，而不是在编写代码之前，这与作家、画家和建筑师的做法完全一样”。人们往往很难在没有实际编码之前就将遇到的问题和未知的需求都考虑在内，所以一开始的设计不应该是一种解决所有问题的方案，不应该太早的决定一个程序应该怎么做。而应该设计一种灵活可变的方案，类似打草稿、画轮廓，然后在编写代码的时候再慢慢修改和填充。</p>
<p>最近看书有点急。大概是以前看的书太少了，好不容易有时间，有心情去看书，所以才看得那么匆忙，一本还没看完就开另一本，同时实际动手敲代码的时间也少的可怜。时间还剩下一个月左右，是该调整一下了，书还是得看仔细点，代码也应该敲多点。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/读书笔记/">读书笔记</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-读书笔记-《第一行代码——Android》" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/02/10/读书笔记-《第一行代码——Android》/" class="article-date">
  	<time datetime="2016-02-10T14:29:03.000Z" itemprop="datePublished">2016-02-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/10/读书笔记-《第一行代码——Android》/">读书笔记 -《第一行代码——Android》</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>很久之前就打算学安卓了，但总被各种事情干扰，一直断断续续。这本书是我第一本真正读完的安卓入门教程。</p>
<p>这本书不愧被称为“Android初学者的最佳入门书”。它涵盖了安卓软件开发的方方面面，不仅讲到了四大组件、UI、碎片、广播机制、数据存储、服务、多媒体、网络、定位服务、传感器这些安卓开发知识，也讲简单提到了git和安卓测试工程的使用。在书本的最后还通过一个比较完整的天气app把书中大部分的内容以实际项目的形式回顾了一遍。</p>
<p>我觉得这本书最大的优点就是点到为止，不像之前读过的那些书，用大篇幅去把各个部件属性和控件都不厌其烦的描述一遍。因为很多东西只要知道有这个东西，知道它的部分关键属性，其他的到需要用到的时候在去查看文档就可以了。</p>
<p>但这本书又不仅是简单的介绍安卓那些组件和类的使用方法，它还介绍了listview加载数据的优化方法、全局获取Context的技巧和制定自己的Log类等实用的安卓编程技巧。虽然由于安卓版本更新太快，有部分代码已经过时，但对于善于使用搜索引擎的程序员来说也不是什么大问题。</p>
<p>总的来说，这本书除了每节末尾的不太相关的RPG剧情描述之外，其它都很合我口味，很幸运可以在入门的阶段遇到这本书。</p>
<p>经过这一段时间的学习，也对安卓编程有了一点心得，接下来就可以正式开始我的毕业设计手机端部分了。边编码，边深入学习java、安卓编程和单元测试等知识。希望在大学的最后一段时间，能够学多点东西，提高自己的编程能力。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/读书笔记/">读书笔记</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-GTest实例解析" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/02/08/GTest实例解析/" class="article-date">
  	<time datetime="2016-02-08T09:01:49.000Z" itemprop="datePublished">2016-02-08</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/08/GTest实例解析/">GTest实例解析</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>gtest是google的一套开源的c++单元测试框架，可以方便程序员对自己的代码进行单元测试。学习这套框架，除了墙外的官方文档之外，我强力推荐<a href="http://www.cnblogs.com/coderzh/archive/2009/04/06/1426755.html" target="_blank" rel="external">玩转Google开源C++单元测试框架Google Test系列</a>。</p>
<p>这系列的博客已经将gtest讲的十分详细了，所以我这篇博客就不再详细介绍gtest的基本使用方法了，而是通过一个简单的例子，介绍一下如何在实际的项目中使用它。同时也会通过分析gtest的源代码，使得大家能够更好的理解gtest的工作原理</p>
<h2 id="u9700_u8981_u6D4B_u8BD5_u7684_u7C7B"><a href="#u9700_u8981_u6D4B_u8BD5_u7684_u7C7B" class="headerlink" title="需要测试的类"></a><strong>需要测试的类</strong></h2><p>首先我实现了一个简单的类TwoDimensionalMark，它的功能相当于bool二维数组，可以将二维下标标记为true或者false。只不过它内部使用位运算，一个字节可以记录八个标记数据，可以大量节省内存。它的声明如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> TwoDimensionalMark&#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        TwoDimensionalMark(<span class="keyword">int</span> row, <span class="keyword">int</span> col, <span class="keyword">bool</span> flag = <span class="literal">false</span>);</span><br><span class="line">        TwoDimensionalMark(<span class="keyword">const</span> TwoDimensionalMark&amp; cpy)；</span><br><span class="line">        ~TwoDimensionalMark();</span><br><span class="line">        <span class="keyword">const</span> TwoDimensionalMark&amp; <span class="keyword">operator</span> =(<span class="keyword">const</span> TwoDimensionalMark&amp; cpy)；</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将所有的位置标记为true或者false</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">clean</span><span class="params">(<span class="keyword">bool</span> mark)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置(x,y)下标为true或者false</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">bool</span> mark)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取(x,y)下标的数据</span></span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">check</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span><span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">int</span> <span class="title">getRow</span><span class="params">()</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">int</span> <span class="title">getCol</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="u5B8C_u6574_u7684_u6D4B_u8BD5_u4EE3_u7801"><a href="#u5B8C_u6574_u7684_u6D4B_u8BD5_u4EE3_u7801" class="headerlink" title="完整的测试代码"></a><strong>完整的测试代码</strong></h2><p>我先把完整的测试代码放在这里，可以先简单浏览一遍。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">"TwoDimensionalMark.h"</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">"gtest/gtest.h"</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> MarkSize&#123;</span><br><span class="line">    MarkSize(<span class="keyword">int</span> r, <span class="keyword">int</span> c): row(r),col(c)&#123;&#125;</span><br><span class="line">    <span class="keyword">int</span> row, col;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> TestWithMarkSize : <span class="keyword">public</span> testing::TestWithParam&lt;MarkSize&gt;&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">struct</span> Coord&#123;</span><br><span class="line">        <span class="keyword">int</span> x, y;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">bool</span>&gt; &gt; CreateContrast(<span class="keyword">int</span> row, <span class="keyword">int</span> col, <span class="keyword">bool</span> flag)&#123;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">bool</span>&gt; &gt; contrast(row);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row; i++)&#123;</span><br><span class="line">            contrast[i] = <span class="built_in">vector</span>&lt;<span class="keyword">bool</span>&gt;(col, flag);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> contrast;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">vector</span>&lt;Coord&gt; CreateRandCoords(<span class="keyword">int</span> row, <span class="keyword">int</span> col)&#123;</span><br><span class="line">        <span class="keyword">int</span> yRange = row * <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">int</span> xRange = col * <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">int</span> numRandCoord = row * col / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">vector</span>&lt;Coord&gt; coords;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numRandCoord; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> x = (rand() % xRange) - col;</span><br><span class="line">            <span class="keyword">int</span> y = (rand() % yRange) - row;</span><br><span class="line">            coords.push_back(&#123; x, y &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> coords;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">SetFlag</span><span class="params">(TwoDimensionalMark* mark,  <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">bool</span>&gt; &gt;* contrast,  </span><br><span class="line">                <span class="keyword">const</span> MarkSize&amp; size, <span class="keyword">const</span> <span class="built_in">vector</span>&lt;Coord&gt;&amp; coords, <span class="keyword">bool</span> flag)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> c : coords)&#123;</span><br><span class="line">            mark-&gt;<span class="built_in">set</span>(c.x, c.y, flag);</span><br><span class="line">            <span class="comment">//随机位置有可能在row，col之外，要防止溢出</span></span><br><span class="line">            <span class="keyword">if</span> (c.x &gt;= <span class="number">0</span> &amp;&amp; c.x &lt; size.col &amp;&amp; c.y &gt;= <span class="number">0</span> &amp;&amp; c.y &lt; size.row)&#123;</span><br><span class="line">                (*contrast)[c.y][c.x] = flag;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//行数多于列数的情况</span></span><br><span class="line">INSTANTIATE_TEST_CASE_P(RowLTCol, TestWithMarkSize,	testing::Values(MarkSize(<span class="number">200</span>, <span class="number">100</span>), MarkSize(<span class="number">50</span>, <span class="number">30</span>)));</span><br><span class="line"><span class="comment">//行数少于列数的情况</span></span><br><span class="line">INSTANTIATE_TEST_CASE_P(ColLTRow, TestWithMarkSize,	testing::Values(MarkSize(<span class="number">10</span>, <span class="number">100</span>), MarkSize(<span class="number">3</span>, <span class="number">10</span>)));</span><br><span class="line"><span class="comment">//行数等于列数的情况</span></span><br><span class="line">INSTANTIATE_TEST_CASE_P(RowEQCol, TestWithMarkSize,	testing::Values(MarkSize(<span class="number">100</span>, <span class="number">100</span>), MarkSize(<span class="number">3</span>, <span class="number">3</span>)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TEST_P(TestWithMarkSize,testWithTrueClean)&#123;</span><br><span class="line">    MarkSize size = GetParam();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化TwoDimensionalMark和用来做对比的contrast,将他们全部用true填充</span></span><br><span class="line">    <span class="function">TwoDimensionalMark <span class="title">mark</span><span class="params">(size.row, size.col)</span></span>;</span><br><span class="line">    mark.clean(<span class="literal">true</span>);</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">bool</span>&gt; &gt; contrast = CreateContrast(size.row, size.col, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//验证mark和contrast里面都是true</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size.row; i++)&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; size.col; j++)&#123;</span><br><span class="line">            ASSERT_TRUE(mark.check(j, i));</span><br><span class="line">            ASSERT_TRUE(contrast[i][j]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//随机将一些坐标位置,这个函数生成的随机位置有可能在row，col之外</span></span><br><span class="line">    <span class="built_in">vector</span>&lt;Coord&gt; coords = CreateRandCoords(size.row, size.col);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将mark和contrast的之前随机生成的位置设为false</span></span><br><span class="line">    SetFlag(&amp;mark, &amp;contrast, size, coords, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检测随机生成的位置上的值有没有设置正确</span></span><br><span class="line">    <span class="comment">//mark若位置超出范围则返回false,而contrast则需要防止溢出</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> c : coords)&#123;</span><br><span class="line">        ASSERT_FALSE(mark.check(c.x,c.y));</span><br><span class="line">        <span class="keyword">if</span> (c.x &gt;= <span class="number">0</span> &amp;&amp; c.x &lt; size.col &amp;&amp; c.y &gt;= <span class="number">0</span> &amp;&amp; c.y &lt; size.row)&#123;</span><br><span class="line">            ASSERT_FALSE(contrast[c.y][c.x]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对比contrast和mark，两者应该相等</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; size.row; y++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; size.col; x++)&#123;</span><br><span class="line">            ASSERT_EQ(contrast[y][x], mark.check(x, y));</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TEST_P(TestWithMarkSize, testWithFalseClean)&#123;</span><br><span class="line">    MarkSize size = GetParam();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化TwoDimensionalMark和用来做对比的contrast,将他们全部用false填充</span></span><br><span class="line">    <span class="function">TwoDimensionalMark <span class="title">mark</span><span class="params">(size.row, size.col)</span></span>;</span><br><span class="line">    mark.clean(<span class="literal">false</span>);</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">bool</span>&gt; &gt; contrast = CreateContrast(size.row, size.col, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//验证mark和contrast里面都是false</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size.row; i++)&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; size.col; j++)&#123;</span><br><span class="line">            ASSERT_FALSE(mark.check(j, i));</span><br><span class="line">            ASSERT_FALSE(contrast[i][j]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//随机将一些坐标位置,这个函数生成的随机位置有可能在row，col之外</span></span><br><span class="line">    <span class="built_in">vector</span>&lt;Coord&gt; coords = CreateRandCoords(size.row, size.col);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将mark和contrast的之前随机生成的位置设为true</span></span><br><span class="line">    SetFlag(&amp;mark, &amp;contrast, size, coords, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检测随机生成的位置上的值有没有设置正确</span></span><br><span class="line">    <span class="comment">//mark若位置超出范围则返回false,而contrast则需要防止溢出</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> c : coords)&#123;</span><br><span class="line">        <span class="keyword">if</span> (c.x &gt;= <span class="number">0</span> &amp;&amp; c.x &lt; size.col &amp;&amp; c.y &gt;= <span class="number">0</span> &amp;&amp; c.y &lt; size.row)&#123;</span><br><span class="line">            ASSERT_TRUE(contrast[c.y][c.x]);</span><br><span class="line">            ASSERT_TRUE(mark.check(c.x, c.y));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            ASSERT_FALSE(mark.check(c.x, c.y));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    testing::InitGoogleTest(&amp;argc, argv);</span><br><span class="line">    <span class="keyword">int</span> result =  RUN_ALL_TESTS();</span><br><span class="line">    getchar();</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="u4F20_u5165_u591A_u4E2A_u53C2_u6570"><a href="#u4F20_u5165_u591A_u4E2A_u53C2_u6570" class="headerlink" title="传入多个参数"></a><strong>传入多个参数</strong></h2><p>为了覆盖各种大小的情况（行和列数量相等，行多于列，行少于列），需要定义多个不同行列数的TwoDimensionalMark。但如果每个测试用例都手动硬编码的话将会有许多的重复代码，这个时候就可以使用参数化的方法去将行列数作为参数传入各个测试用例中，详细的介绍看<a href="http://www.cnblogs.com/coderzh/archive/2009/04/08/1431297.html" target="_blank" rel="external">这里</a>。</p>
<p>这篇博客只写到了一个参数的处理。但我们这里需要传入行数和列数两个参数应该怎么办？<br>其实很方法也很简单，首先定义一个结构体MarkSize用于保存行数和列数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> MarkSize&#123;</span><br><span class="line">    MarkSize(<span class="keyword">int</span> r, <span class="keyword">int</span> c): row(r),col(c)&#123;&#125;</span><br><span class="line">    <span class="keyword">int</span> row, col;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用它作为TestWithParam的模板参数，再声明一个类继承于它。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> TestWithMarkSize : <span class="keyword">public</span> testing::TestWithParam&lt;MarkSize&gt;&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后传入参数，这里我定义了三组参数，每组两个。分别对应行数比较多，列数比较多，行数列数一样多三种情况：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//行数多于列数的情况</span></span><br><span class="line">INSTANTIATE_TEST_CASE_P(RowLTCol, TestWithMarkSize,	testing::Values(MarkSize(<span class="number">200</span>, <span class="number">100</span>), MarkSize(<span class="number">50</span>, <span class="number">30</span>)));</span><br><span class="line"><span class="comment">//行数少于列数的情况</span></span><br><span class="line">INSTANTIATE_TEST_CASE_P(ColLTRow, TestWithMarkSize,	testing::Values(MarkSize(<span class="number">10</span>, <span class="number">100</span>), MarkSize(<span class="number">3</span>, <span class="number">10</span>)));</span><br><span class="line"><span class="comment">//行数等于列数的情况</span></span><br><span class="line">INSTANTIATE_TEST_CASE_P(RowEQCol, TestWithMarkSize,	testing::Values(MarkSize(<span class="number">100</span>, <span class="number">100</span>), MarkSize(<span class="number">3</span>, <span class="number">3</span>)));</span><br></pre></td></tr></table></figure>
<p>这样一来，只要是 test_case_name 为 TestWithMarkSize 的测试用例都可以使用GetParam方法获取传入的参数了：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   TEST_P(TestWithMarkSize,testWithTrueClean)&#123;</span><br><span class="line">       MarkSize size = GetParam();</span><br><span class="line">       ...</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   TEST_P(TestWithMarkSize, testWithFalseClean)&#123;</span><br><span class="line">	MarkSize size = GetParam();</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="TEST_P_u6E90_u7801_u89E3_u6790"><a href="#TEST_P_u6E90_u7801_u89E3_u6790" class="headerlink" title="TEST_P源码解析"></a><strong>TEST_P源码解析</strong></h2><p>TEST_P 宏的定义如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># define TEST_P(test_case_name, test_name) \</span><br><span class="line">  class GTEST_TEST_CLASS_NAME_(test_case_name, test_name) \</span><br><span class="line">      : public test_case_name &#123; \</span><br><span class="line">  ...</span><br><span class="line">  &#125;; \</span><br><span class="line">  ...</span><br><span class="line">  void GTEST_TEST_CLASS_NAME_(test_case_name, test_name)::TestBody()</span><br></pre></td></tr></table></figure>
<p>GTEST_TEST_CLASS<em>NAME</em>又是个什么东西？其实它的功能十分简单，就是将类名拼接出来而已，它的定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> GTEST_TEST_CLASS_NAME_(test_case_name, test_name) \</span><br><span class="line">  test_case_name##_##test_name##_Test</span></span><br></pre></td></tr></table></figure>
<p>所以我们使用 TEST_P(TestWithMarkSize,testWithTrueClean){…} 实际上就是定义了一个 TestWithMarkSize 的子类 TestWithMarkSize_testWithTrueClean_Test。</p>
<p>而花括号里面实际上就是void TestWithMarkSize_testWithTrueClean_Test::TestBody()的实现。</p>
<p>也就是说，实际上我们的测试用例都是TestWithMarkSize的子类。所以我们可以将一些公共的方法和数据结构定义在TestWithMarkSize内，只要将他们声明为protected或者public，就能在TEST_P(TestWithMarkSize,testWithTrueClean){…} 和 TEST_P(TestWithMarkSize,testWithFalseClean){…} 内使用。</p>
<p>这样既可以提炼重复代码，又能将它们的作用范围限定在测试用例中，防止提炼出来的函数或者定义的数据结构放在全局影响实际的功能代码。</p>
<p>如我这里定义的 Coord 结构体和CreateContrast、CreateRandCoords 和 SetFlag 方法。</p>
<p>而GetParam()的定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> ParamType* parameter_;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">const</span> ParamType&amp; <span class="title">GetParam</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    GTEST_CHECK_(parameter_ != <span class="literal">NULL</span>)</span><br><span class="line">        &lt;&lt; <span class="string">"GetParam() can only be called inside a value-parameterized test "</span></span><br><span class="line">        &lt;&lt; <span class="string">"-- did you intend to write TEST_P instead of TEST_F?"</span>;</span><br><span class="line">    <span class="keyword">return</span> *parameter_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然 const T* WithParamInterface<t>::parameter_ 是有一个类静态成员变量，那就不难理解为什么所有继承于 TestWithMarkSize 的测试用例都能拿到同样的参数了。</t></p>
<h2 id="u6D4B_u8BD5_u7528_u4F8B_u5206_u6790"><a href="#u6D4B_u8BD5_u7528_u4F8B_u5206_u6790" class="headerlink" title="测试用例分析"></a><strong>测试用例分析</strong></h2><p>要知道 TwoDimensionalMark 实际上的功能是和bool二维数组基本一样的，所以我们就很自然的想到使用一个对比用的bool二维数组作为参照，去测试 TwoDimensionalMark 的功能究竟有没有bug。</p>
<p>TEST_P(TestWithMarkSize,testWithTrueClean) 的测试分下面三个步骤：</p>
<p>1.根据传入的数组大小，创建了一个 TwoDimensionalMark 和用两重 vector 实现的 bool 二维数组。</p>
<p>2.将它们全部用true填充，然后验证每一个下标的数据是否均为 true，如此去测试TwoDimensionalMark::clean(true) 的功能</p>
<p>3.随机生成一些坐标，将 TwoDimensionalMark 和 bool 二维数组对应这些坐标的数据都设为 false 。然后检测设置的位置的数据是否都为false，还有对比两者每个下标的数据是否相等。以测试 set 和 check 方法是否正确。同时因为这些下标有些是超出范围之外的，也能测试 TwoDimensionalMark 对超出范围的操作是否正确</p>
<p>代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">TEST_P(TestWithMarkSize,testWithTrueClean)&#123;</span><br><span class="line">    MarkSize size = GetParam();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化TwoDimensionalMark和用来做对比的contrast,将他们全部用true填充</span></span><br><span class="line">    <span class="function">TwoDimensionalMark <span class="title">mark</span><span class="params">(size.row, size.col)</span></span>;</span><br><span class="line">    mark.clean(<span class="literal">true</span>);</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">bool</span>&gt; &gt; contrast = CreateContrast(size.row, size.col, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//验证mark和contrast里面都是true</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size.row; i++)&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; size.col; j++)&#123;</span><br><span class="line">            ASSERT_TRUE(mark.check(j, i));</span><br><span class="line">            ASSERT_TRUE(contrast[i][j]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//随机将一些坐标位置,这个函数生成的随机位置有可能在row，col之外</span></span><br><span class="line">    <span class="built_in">vector</span>&lt;Coord&gt; coords = CreateRandCoords(size.row, size.col);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将mark和contrast的之前随机生成的位置设为false</span></span><br><span class="line">    SetFlag(&amp;mark, &amp;contrast, size, coords, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检测随机生成的位置上的值有没有设置正确</span></span><br><span class="line">    <span class="comment">//mark若位置超出范围则返回false,而contrast则需要防止溢出</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> c : coords)&#123;</span><br><span class="line">        ASSERT_FALSE(mark.check(c.x,c.y));</span><br><span class="line">        <span class="keyword">if</span> (c.x &gt;= <span class="number">0</span> &amp;&amp; c.x &lt; size.col &amp;&amp; c.y &gt;= <span class="number">0</span> &amp;&amp; c.y &lt; size.row)&#123;</span><br><span class="line">            ASSERT_FALSE(contrast[c.y][c.x]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对比contrast和mark，两者应该相等</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; size.row; y++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; size.col; x++)&#123;</span><br><span class="line">            ASSERT_EQ(contrast[y][x], mark.check(x, y));</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>TEST_P(TestWithMarkSize, testWithFalseClean) 和上面的差不多，只不过换成一开始用 false 填充，之后设置随机下标的数据为 true，读者可以自己查看代码，这里就不详细分析了。</p>
<h2 id="u6D4B_u8BD5_u7ED3_u679C"><a href="#u6D4B_u8BD5_u7ED3_u679C" class="headerlink" title="测试结果"></a><strong>测试结果</strong></h2><p>运行测试代码得到下面的结果：<br><img src="/GTest实例解析/1.jpg"></p>
<p>全部测试均通过！</p>
<p>完整代码:<a href="https://github.com/bluesky466/GTestDemo" target="_blank" rel="external">https://github.com/bluesky466/GTestDemo</a><br>（为了方便，我直接将实现写在了头文件里，好孩子不要学~）</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/">c++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/单元测试/">单元测试</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/技术相关/">技术相关</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-读书笔记-《代码整洁之道》" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/30/读书笔记-《代码整洁之道》/" class="article-date">
  	<time datetime="2016-01-30T07:22:14.000Z" itemprop="datePublished">2016-01-30</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/30/读书笔记-《代码整洁之道》/">读书笔记 -《代码整洁之道》</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>长呼一口气，终于看完了。明明就只有300多页，但这本《代码整洁之道》还真是难啃啊。</p>
<p>书是好书，讲的也十分细致。就连命名、方法定义的顺序、注释这些小细节都用了不少的文字去强调。虽然有些观点我不太认同（比如我觉得类成员变量就应该多一个字符m或者下划线去和临时变量做区别）但绝大部分的建议和条款我觉得都讲的十分有道理。总结了几个自认为最重要的点：</p>
<ol>
<li>不管是变量还是函数，命名都应该有意义且名副其实</li>
<li>应该按照垂直格式摆放函数定义</li>
<li>注释应该正确且有用</li>
<li>函数应该只做一件事，且应该尽量短小</li>
<li>模块不应该了解它所操作的对象的内部情形</li>
</ol>
<p>作者对于代码的要求堪称苛刻，看他写代码的过程真的可以算是精雕细琢，最终呈现的代码可谓优雅。虽然我也不能指望自己通过读完一本书，写代码的能力就有质的飞跃。但这本书起码提醒了我一些以前没有注意到的地方，以后写代码的时候试试提醒自己，能有所提高也就不负我这几天的努力了。</p>
<p>要说这本书难啃也是真的。中间有大量的代码实例，而且很多都是著名的开源框架的源码（如Tomcat、Spring和JUnit），在阅读这本书的过程中大部分时间我是花在理解这些代码上的。因为对java不太熟悉，这些框架更是一个都没有用过，所以读起来十分的痛苦，中间好几次都想放弃了。</p>
<p>多亏最终坚持了下来，我还得到了一些以后的学习道路的启示：</p>
<p>一是java还需要重新好好学一遍。毕竟现在正在学安卓，我的java基础实在弱的可以，尤其是并发编程相关的知识可以说就是一张白纸。</p>
<p>二是需要学习一下测试驱动开发（TDD）相关的知识。我发现最近看的书，都把测试放在了很重要的位置上。以前写代码就没有做过单元测试，所以拿到测试部门的时候总会出现这样那样不应该出现的问题。java方面jUnit是一定要去学习的，而c++其实也有类似googletest这样的测试框架。为了写出高质量的代码，这部分的知识也应该去好好补一补了。</p>
<p>所以我下一步打算找找java还有测试相关的书籍来看看。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/读书笔记/">读书笔记</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-DrawerLayout-学习笔记" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/27/DrawerLayout-学习笔记/" class="article-date">
  	<time datetime="2016-01-27T09:44:24.000Z" itemprop="datePublished">2016-01-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/27/DrawerLayout-学习笔记/">DrawerLayout 学习笔记</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>DrawerLayout的使用十分简单，使用android.support.v4.widget.DrawerLayout标签即可，DrawerLayout的第一个子标签就是正文，其他布局都是抽屉布局（默认隐藏在屏幕外）。可以使用android:layout_gravity属性指定是隐藏在屏幕的左边或者右边。</p>
<h2 id="u4E00_u3001_u4F7F_u7528DrawerLayout_u5E03_u5C40"><a href="#u4E00_u3001_u4F7F_u7528DrawerLayout_u5E03_u5C40" class="headerlink" title="一、使用DrawerLayout布局"></a><strong>一、使用DrawerLayout布局</strong></h2><p>把activity_main.xml修改成下面的样子，这里声明了一个LinearLayout作为正文布局（DrawerLayout的第一个子标签），和其他两个LinearLayout布局作为抽屉布局（将android:layout_gravity设置为left或者right）：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">LinearLayout</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">    <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">    <span class="attribute">android:orientation</span>=<span class="value">"vertical"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">android.support.v4.widget.DrawerLayout</span></span><br><span class="line">        <span class="attribute">android:id</span>=<span class="value">"@+id/drawer_layout"</span></span><br><span class="line">        <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">        <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 正文布局 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">LinearLayout</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/content"</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:gravity</span>=<span class="value">"center_horizontal"</span></span><br><span class="line">            <span class="attribute">android:orientation</span>=<span class="value">"horizontal"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">                <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:text</span>=<span class="value">"content"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 从左边抽出来的布局 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">LinearLayout</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/drawer_left"</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_gravity</span>=<span class="value">"left"</span></span><br><span class="line">            <span class="attribute">android:background</span>=<span class="value">"#FFFFFF"</span></span><br><span class="line">            <span class="attribute">android:gravity</span>=<span class="value">"center_horizontal"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">                <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:text</span>=<span class="value">"left"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 从右边抽出来的布局 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">LinearLayout</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/drawer_right"</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_gravity</span>=<span class="value">"right"</span></span><br><span class="line">            <span class="attribute">android:background</span>=<span class="value">"#FFFFFF"</span></span><br><span class="line">            <span class="attribute">android:gravity</span>=<span class="value">"center_horizontal"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">                <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:text</span>=<span class="value">"right"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">android.support.v4.widget.DrawerLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>运行之后就长这个样子，可以用手指从左边或者右边把抽屉布局拖出来：<br><img src="/DrawerLayout-学习笔记/1.jpg"></p>
<img src="/DrawerLayout-学习笔记/3.jpg">
<img src="/DrawerLayout-学习笔记/2.jpg">
<p>当然也能在代码里面调用openDrawer来显示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//打开左边的抽屉布局</span></span><br><span class="line">drawerLayout.openDrawer(Gravity.LEFT);</span><br><span class="line"><span class="comment">//打开右边的抽屉布局</span></span><br><span class="line">drawerLayout.openDrawer(Gravity.RIGHT);</span><br></pre></td></tr></table></figure></p>
<h2 id="u4E8C_u3001_u4F7F_u7528ActionBarDrawerToggle"><a href="#u4E8C_u3001_u4F7F_u7528ActionBarDrawerToggle" class="headerlink" title="二、使用ActionBarDrawerToggle"></a><strong>二、使用ActionBarDrawerToggle</strong></h2><p>android提供了一个ActionBarDrawerToggle来简化DrawerLayout的操作，用法十分简单。<br>1.自定义一个ToolBar（可以查看我之前的一篇博文）<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">LinearLayout</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">    <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">    <span class="attribute">android:orientation</span>=<span class="value">"vertical"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">android.support.v7.widget.Toolbar</span></span><br><span class="line">        <span class="attribute">android:id</span>=<span class="value">"@+id/toolbar"</span></span><br><span class="line">        <span class="attribute">android:background</span>=<span class="value">"#3F51B5"</span></span><br><span class="line">        <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">        <span class="attribute">android:layout_height</span>=<span class="value">"?attr/actionBarSize"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">android.support.v4.widget.DrawerLayout</span></span><br><span class="line">        <span class="attribute">android:id</span>=<span class="value">"@+id/drawer_layout"</span></span><br><span class="line">        <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">        <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 正文布局 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">LinearLayout</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/content"</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:gravity</span>=<span class="value">"center_horizontal"</span></span><br><span class="line">            <span class="attribute">android:orientation</span>=<span class="value">"horizontal"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">                <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:text</span>=<span class="value">"content"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 从左边抽出来的布局 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">LinearLayout</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/drawer_left"</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_gravity</span>=<span class="value">"left"</span></span><br><span class="line">            <span class="attribute">android:background</span>=<span class="value">"#FFFFFF"</span></span><br><span class="line">            <span class="attribute">android:gravity</span>=<span class="value">"center_horizontal"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">                <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:text</span>=<span class="value">"left"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 从右边抽出来的布局 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">LinearLayout</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/drawer_right"</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_gravity</span>=<span class="value">"right"</span></span><br><span class="line">            <span class="attribute">android:background</span>=<span class="value">"#FFFFFF"</span></span><br><span class="line">            <span class="attribute">android:gravity</span>=<span class="value">"center_horizontal"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">                <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:text</span>=<span class="value">"right"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">android.support.v4.widget.DrawerLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>2.在acvitity代码中创建ActionBarDrawerToggle并重写下面的方法就可以了</p>
<ul>
<li>在onPostCreate方法中调用ActionBarDrawerToggle.syncState()，如果不调用该方法，则ActionBarDrawerToggle不会显示 （onPostCreate在Activity完全加载成功之后调用，这个时候所有界面资源都已经创建和初始化完成）</li>
<li>在onOptionsItemSelected方法中调用ActionBarDrawerToggle.onOptionsItemSelected()。（原本我以为这里是用来实现按下按钮打开和关闭抽屉布局的，但经测试，就算不调用也能正常运行。）<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    ActionBarDrawerToggle mToggle;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        Toolbar toolbar = (Toolbar) findViewById(R.id.toolbar);</span><br><span class="line">        setSupportActionBar(toolbar);</span><br><span class="line"></span><br><span class="line">        DrawerLayout drawerLayout = (DrawerLayout) findViewById(R.id.drawer_layout);</span><br><span class="line">        mToggle = <span class="keyword">new</span> ActionBarDrawerToggle(<span class="keyword">this</span>, drawerLayout,toolbar,R.string.drawer_open, R.string.drawer_close);</span><br><span class="line"></span><br><span class="line">        drawerLayout.setDrawerListener(mToggle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">//onPostCreate在Activity完全加载成功之后调用</span></span><br><span class="line">        <span class="comment">//这个时候所有界面资源都已经创建和初始化完成</span></span><br><span class="line">        <span class="keyword">super</span>.onPostCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果不调用该方法，则ActionBarDrawerToggle不会显示</span></span><br><span class="line">        mToggle.syncState();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">//原本我以为这里是用来实现按下按钮打开和关闭抽屉布局的</span></span><br><span class="line">        <span class="comment">//但经测试，就算不调用也能正常运行。</span></span><br><span class="line">        <span class="keyword">return</span> mToggle.onOptionsItemSelected(item) || <span class="keyword">super</span>.onOptionsItemSelected(item);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>运行可以得到下面这效果，可以使用控制按钮来打开和关闭左边的抽屉布局，那个控制按钮还实现了一种特别酷炫的动画：<br><img src="/DrawerLayout-学习笔记/4.jpg"></p>
<img src="/DrawerLayout-学习笔记/5.jpg">
<img src="/DrawerLayout-学习笔记/6.jpg">
<h2 id="u4E09_u3001_u5C06_u62BD_u5C49_u5E03_u5C40_u7684_u5C42_u7EA7_u586B_u5230toolbar_u4E4B_u4E0A"><a href="#u4E09_u3001_u5C06_u62BD_u5C49_u5E03_u5C40_u7684_u5C42_u7EA7_u586B_u5230toolbar_u4E4B_u4E0A" class="headerlink" title="三、将抽屉布局的层级填到toolbar之上"></a><strong>三、将抽屉布局的层级填到toolbar之上</strong></h2><p>知乎的安卓app也使用了DrawerLayout，但它的抽屉布局显示的时候是位于toolbar之上的。我们只要把toolbar标签放到内容布局（DrawerLayout的第一个子标签）里面就能实现这样的效果了。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">LinearLayout</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">    <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">    <span class="attribute">android:orientation</span>=<span class="value">"vertical"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">android.support.v4.widget.DrawerLayout</span></span><br><span class="line">        <span class="attribute">android:id</span>=<span class="value">"@+id/drawer_layout"</span></span><br><span class="line">        <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">        <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 正文布局 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">LinearLayout</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/content"</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:gravity</span>=<span class="value">"center_horizontal"</span></span><br><span class="line">            <span class="attribute">android:orientation</span>=<span class="value">"horizontal"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 把toolbar放到这里，使抽屉布局层级比toolbar高 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">android.support.v7.widget.Toolbar</span></span><br><span class="line">                <span class="attribute">android:id</span>=<span class="value">"@+id/toolbar"</span></span><br><span class="line">                <span class="attribute">android:background</span>=<span class="value">"#3F51B5"</span></span><br><span class="line">                <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">                <span class="attribute">android:layout_height</span>=<span class="value">"?attr/actionBarSize"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">                <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:text</span>=<span class="value">"content"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 从左边抽出来的布局 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">LinearLayout</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/drawer_left"</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_gravity</span>=<span class="value">"left"</span></span><br><span class="line">            <span class="attribute">android:background</span>=<span class="value">"#FFFFFF"</span></span><br><span class="line">            <span class="attribute">android:gravity</span>=<span class="value">"center_horizontal"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">                <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:text</span>=<span class="value">"left"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 从右边抽出来的布局 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">LinearLayout</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/drawer_right"</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_gravity</span>=<span class="value">"right"</span></span><br><span class="line">            <span class="attribute">android:background</span>=<span class="value">"#FFFFFF"</span></span><br><span class="line">            <span class="attribute">android:gravity</span>=<span class="value">"center_horizontal"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">                <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:text</span>=<span class="value">"right"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">android.support.v4.widget.DrawerLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>运行效果如下：</p>
<img src="/DrawerLayout-学习笔记/7.jpg">
      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/技术相关/">技术相关</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-ToolBar-学习笔记" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/25/ToolBar-学习笔记/" class="article-date">
  	<time datetime="2016-01-25T06:56:42.000Z" itemprop="datePublished">2016-01-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/25/ToolBar-学习笔记/">ToolBar 学习笔记</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>虽然android studio在新建项目的时候就可以创建一个默认带有ToolBar的MainActivity，但是抱着学习学全套的精神，我们就从一个没有Activity的空项目入手，一步一步把ToolBar学透。</p>
<h2 id="u4E00_u3001_u521B_u5EFA_u57FA_u7840ToolBar"><a href="#u4E00_u3001_u521B_u5EFA_u57FA_u7840ToolBar" class="headerlink" title="一、创建基础ToolBar"></a><strong>一、创建基础ToolBar</strong></h2><p>创建完一个不带Activity的空项目之后的第一步就是创建自己的Activity了，注意这个Activity必须继承AppCompatActivity（ActionBarActivity已经被废弃了）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span></span>&#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.main_activity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果不能import android.support.v7.app.AppCompatActivity;的话就在build.gradle（Module：App）的dependencies里面添加</p>
<pre><code>compile &apos;com.android.support:appcompat-v7:23.1.1&apos;
</code></pre><p>这个R.layout.main_activity也是要自己创建的，我这里创建了一个只有一个TextView的LinearLayout</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">LinearLayout</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">    <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">    <span class="attribute">android:orientation</span>=<span class="value">"vertical"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">        <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">        <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">        <span class="attribute">android:text</span>=<span class="value">"Hello World"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当然，不要忘了在manifests里面注册MainActivity<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">activity</span> <span class="attribute">android:name</span>=<span class="value">".MainActivity"</span></span><br><span class="line">           <span class="attribute">android:label</span>=<span class="value">"@string/app_name"</span></span><br><span class="line">           <span class="attribute">android:theme</span>=<span class="value">"@style/AppTheme"</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="title">intent-filter</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="title">action</span> <span class="attribute">android:name</span>=<span class="value">"android.intent.action.MAIN"</span>/&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="title">category</span> <span class="attribute">android:name</span>=<span class="value">"android.intent.category.LAUNCHER"</span>/&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="title">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">activity</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>然后运行程序就能就是下面这个样子：<br><img src="/ToolBar-学习笔记/1.jpg"></p>
<h2 id="u4E8C_u3001_u81EA_u5B9A_u4E49ToolBar_u6837_u5F0F"><a href="#u4E8C_u3001_u81EA_u5B9A_u4E49ToolBar_u6837_u5F0F" class="headerlink" title="二、自定义ToolBar样式"></a><strong>二、自定义ToolBar样式</strong></h2><p>因为用上面的方法创建的ToolBar是Activity自带的，在需要自定义样式的时候不够灵活，所以我们把它去掉，换成我们自己创建的ToolBar。</p>
<p>可以在@style/AppTheme添加如下item：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 去掉Activity自带的ToolBar --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">item</span> <span class="attribute">name</span>=<span class="value">"windowNoTitle"</span>&gt;</span>true<span class="tag">&lt;/<span class="title">item</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这个时候再运行项目，就会发现ToolBar已经不见了。然后我们自己在R.layout.main_activity里面自己声明一个ToolBar:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">LinearLayout</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">    <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">    <span class="attribute">android:orientation</span>=<span class="value">"vertical"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">android.support.v7.widget.Toolbar</span></span><br><span class="line">        <span class="attribute">android:id</span>=<span class="value">"@+id/toolbar"</span></span><br><span class="line">        <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">        <span class="attribute">android:layout_height</span>=<span class="value">"?attr/actionBarSize"</span></span><br><span class="line">        <span class="attribute">android:theme</span>=<span class="value">"@style/ToolBarTheme"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">        <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">        <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">        <span class="attribute">android:text</span>=<span class="value">"Hello World"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>ToolBar的Theme分离出来放在@style/Theme,可以在这里自定义ToolBar的样式:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">style</span> <span class="attribute">name</span>=<span class="value">"ToolBarTheme"</span> <span class="attribute">parent</span>=<span class="value">"Theme.AppCompat"</span>&gt;</span><span class="css"></span><br><span class="line">      &lt;!<span class="tag">--</span> 设置<span class="tag">ToolBar</span>底色 <span class="tag">--</span>&gt;</span><br><span class="line">      &lt;<span class="tag">item</span> <span class="tag">name</span>="<span class="tag">android</span><span class="pseudo">:background"</span>&gt;<span class="id">#3F51B5</span>&lt;/<span class="tag">item</span>&gt;</span><br><span class="line">      &lt;!<span class="tag">--</span> 设置字体颜色 <span class="tag">--</span>&gt;</span><br><span class="line">      &lt;<span class="tag">item</span> <span class="tag">name</span>="<span class="tag">android</span><span class="pseudo">:textColorPrimary"</span>&gt;<span class="id">#FFFFFF</span>&lt;/<span class="tag">item</span>&gt;</span><br><span class="line">  </span><span class="tag">&lt;/<span class="title">style</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>最后在MainActivity里调用setSupportActionBar，顺便设置调用ToolBar的方法设置一些属性。注意这里的ToolBar是导的android.support.v7.widget.Toolbar的包：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span></span>&#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.main_activity);</span><br><span class="line"></span><br><span class="line">        Toolbar toolbar = (Toolbar) findViewById(R.id.toolbar);</span><br><span class="line"></span><br><span class="line">        toolbar.setTitle(<span class="string">"title"</span>); <span class="comment">//setTile方法必须在setSupportActionBar之前调用</span></span><br><span class="line">        toolbar.setSubtitle(<span class="string">"subtitle"</span>);</span><br><span class="line">        toolbar.setLogo(R.mipmap.ic_launcher);</span><br><span class="line"></span><br><span class="line">        setSupportActionBar(toolbar);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//给Navigate按钮加一个默认的返回箭头</span></span><br><span class="line">        <span class="comment">//也可以用toolbar.setNavigationIcon()直接给Navigate设置icon</span></span><br><span class="line">    	getSupportActionBar().setDisplayHomeAsUpEnabled(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行起来之后长这个样子:<br><img src="/ToolBar-学习笔记/2.jpg"></p>
<h2 id="u4E09_u3001_u6DFB_u52A0_u83DC_u5355_u6309_u94AE"><a href="#u4E09_u3001_u6DFB_u52A0_u83DC_u5355_u6309_u94AE" class="headerlink" title="三、添加菜单按钮"></a><strong>三、添加菜单按钮</strong></h2><p>首先创建一个menu/main.xml:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">menu</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line"><span class="attribute">xmlns:app</span>=<span class="value">"http://schemas.android.com/apk/res-auto"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">item</span></span><br><span class="line">        <span class="attribute">android:id</span>=<span class="value">"@+id/btn_ico"</span></span><br><span class="line">        <span class="attribute">android:title</span>=<span class="value">"btn_ico"</span></span><br><span class="line">        <span class="attribute">android:icon</span>=<span class="value">"@mipmap/ic_launcher"</span></span><br><span class="line">        <span class="attribute">app:showAsAction</span>=<span class="value">"ifRoom"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">item</span></span><br><span class="line">        <span class="attribute">android:id</span>=<span class="value">"@+id/btn_search"</span></span><br><span class="line">        <span class="attribute">android:title</span>=<span class="value">"btn_search"</span></span><br><span class="line">        <span class="attribute">app:actionViewClass</span>=<span class="value">"android.support.v7.widget.SearchView"</span></span><br><span class="line">        <span class="attribute">app:showAsAction</span>=<span class="value">"ifRoom"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">item</span></span><br><span class="line">        <span class="attribute">android:id</span>=<span class="value">"@+id/btn_1"</span></span><br><span class="line">        <span class="attribute">android:title</span>=<span class="value">"btn_1"</span></span><br><span class="line">        <span class="attribute">app:showAsAction</span>=<span class="value">"never"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">item</span></span><br><span class="line">        <span class="attribute">android:id</span>=<span class="value">"@+id/btn_2"</span></span><br><span class="line">        <span class="attribute">android:title</span>=<span class="value">"btn_2"</span></span><br><span class="line">        <span class="attribute">app:showAsAction</span>=<span class="value">"never"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">menu</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里的app:showAsAction就是按钮出现的位置，它可以填入以下的值:</p>
<ol>
<li>always：这个值会使菜单项一直显示在ToolBar上。</li>
<li>ifRoom：如果有足够的空间，这个值会使菜单项显示在ToolBar上。</li>
<li>never：这个值使菜单项永远都不出现在ToolBar上。</li>
<li>withText：这个值使菜单项和它的图标，菜单文本一起显示。 </li>
</ol>
<p>然后在MainActivity覆盖onCreateOptionsMenu方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> </span>&#123;</span><br><span class="line">    getMenuInflater().inflate(R.menu.main, menu);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>运行程序之后长这个样子：<br><img src="/ToolBar-学习笔记/3.jpg"></p>
<h2 id="u56DB_u3001_u76D1_u542C_u83DC_u5355_u6309_u94AE_u6D88_u606F"><a href="#u56DB_u3001_u76D1_u542C_u83DC_u5355_u6309_u94AE_u6D88_u606F" class="headerlink" title="四、监听菜单按钮消息"></a><strong>四、监听菜单按钮消息</strong></h2><p>监听这些菜单按钮的消息有两种方法<br>1.覆盖Activity的onOptionsItemSelected方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onOptionsItemSelected</span><span class="params">(MenuItem item)</span> </span>&#123;</span><br><span class="line">    Toast.makeText(<span class="keyword">this</span>, item.getTitle(), Toast.LENGTH_SHORT).show();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.调用ToolBar的setOnMenuItemClickListener方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//setOnMenuItemClickListener方法必须在setSupportActionBar之后调用才有效</span></span><br><span class="line">toolbar.setOnMenuItemClickListener(<span class="keyword">new</span> Toolbar.OnMenuItemClickListener() &#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onMenuItemClick</span><span class="params">(MenuItem item)</span> </span>&#123;</span><br><span class="line">        Toast.makeText(MainActivity.<span class="keyword">this</span>, item.getTitle(), Toast.LENGTH_SHORT).show();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这个时候Navigation按钮的消息也是在上面两个回调方法中处理的，当然也能直接调用ToolBar的setNavigationOnClickListener方法设置，这样只有在该listener方法里面才会收到Navigation按钮的消息：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//setNavigationOnClickListener方法必须在setSupportActionBar之后调用才有效</span></span><br><span class="line">toolbar.setNavigationOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        finish();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>而ToolBar上的搜索按钮可以这样设置它的回调:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreateOptionsMenu</span><span class="params">(Menu menu)</span> </span>&#123;</span><br><span class="line">    getMenuInflater().inflate(R.menu.main, menu);</span><br><span class="line">    MenuItem item = menu.findItem(R.id.btn_search);</span><br><span class="line">    SearchView searcher = (SearchView) item.getActionView();</span><br><span class="line">    searcher.setOnQueryTextListener(<span class="keyword">new</span> SearchView.OnQueryTextListener() &#123;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onQueryTextSubmit</span><span class="params">(String query)</span> </span>&#123;</span><br><span class="line">            Toast.makeText(MainActivity.<span class="keyword">this</span>, query, Toast.LENGTH_SHORT).show();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onQueryTextChange</span><span class="params">(String newText)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="u4E94_u3001_u8BBE_u7F6E_u5F39_u51FA_u83DC_u5355_u7684_u6837_u5F0F"><a href="#u4E94_u3001_u8BBE_u7F6E_u5F39_u51FA_u83DC_u5355_u7684_u6837_u5F0F" class="headerlink" title="五、设置弹出菜单的样式"></a><strong>五、设置弹出菜单的样式</strong></h2><p>弹出菜单的样式默认是和ToolBar的样式一样的:<br><img src="/ToolBar-学习笔记/4.jpg"></p>
<p>但也可以通过下面的方法自定义</p>
<p>1.新建样式PopupTheme</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">style</span> <span class="attribute">name</span>=<span class="value">"PopupTheme"</span> <span class="attribute">parent</span>=<span class="value">"Theme.AppCompat"</span>&gt;</span><span class="css"></span><br><span class="line">       &lt;<span class="tag">item</span> <span class="tag">name</span>="<span class="tag">android</span><span class="pseudo">:background"</span>&gt;<span class="id">#FFFFFF</span>&lt;/<span class="tag">item</span>&gt;</span><br><span class="line">       &lt;<span class="tag">item</span> <span class="tag">name</span>="<span class="tag">android</span><span class="pseudo">:textColorPrimary"</span>&gt;<span class="id">#000000</span>&lt;/<span class="tag">item</span>&gt;</span><br><span class="line">   </span><span class="tag">&lt;/<span class="title">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2.设置ToolBar的PopupTheme,注意这里的前缀是app:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">android.support.v7.widget.Toolbar</span></span><br><span class="line">       <span class="attribute">android:id</span>=<span class="value">"@+id/toolbar"</span></span><br><span class="line">       <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">       <span class="attribute">android:layout_height</span>=<span class="value">"?attr/actionBarSize"</span></span><br><span class="line">       <span class="attribute">android:theme</span>=<span class="value">"@style/ToolBarTheme"</span></span><br><span class="line">       <span class="attribute">app:popupTheme</span>=<span class="value">"@style/PopupTheme"</span>/&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>效果如下：<br><img src="/ToolBar-学习笔记/5.jpg"></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/技术相关/">技术相关</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-读书笔记-《道法自然—面向对象实践指南》" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/21/读书笔记-《道法自然—面向对象实践指南》/" class="article-date">
  	<time datetime="2016-01-21T08:59:47.000Z" itemprop="datePublished">2016-01-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/21/读书笔记-《道法自然—面向对象实践指南》/">读书笔记 -《道法自然—面向对象实践指南》</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>不可否认，我一开始是被这本书的名字吸引才去读的。《道法自然》，这名字逼格真心不要太高。但真的开始阅读，你就会发现它绝对不是标题党。依稀记得那天凌晨4点多睡不着，刷知乎看到有人推荐这本书，于是冲着标题去下载来看。结果一发不可收拾，那一天我就没干别的事，都被它吸引住了。</p>
<p>之前也看过不少讲设计模式的书，像什么《大话设计模式》、《head first设计模式》、《设计模式之禅》等等。当然它们也是好书。尤其是《设计模式之禅》，在读《道法自然》之前我最推崇的讲设计模式的书就是它了。但相比起来，我还是觉得《道法自然》讲的更加的透彻和易于理解。</p>
<p>《道法自然—面向对象实践指南》这本书真要算起来其实并不是严格意义上的讲设计模式的书籍。它以实际的开发案例–FishGUI项目为主线，从立项到需求分析，再到架构设计，最后到编码和优化。通过文字，将整个项目的流程一点不漏的展现在读者面前。在实际编码那几章，通过分析项目的需求，确定使用的设计模式，分析为什么要使用这种模式，有什么优缺点，又谈到怎么去应用到FishGUI这个框架中。有时候甚至会对比其他的框架的源代码讲到多种设计之间的差异和优缺点，例如书中在消息机制那里就分析了MFC、.net和java AWT的设计。相比起其他讲设计模式的书，它更加贴合实际开发，也讲到更加的透彻。毕竟是通过一个实际的项目去讲，能让人更透彻的取理解所讲到的模式。</p>
<p>这本书还有一个吸引我的地方，之前读到的关于设计模式的书籍，要不是用的c#要不用的是java，但这本书使用的编程语言是c++，也不是说其他语言不好，但作为一个大部分时间都在学习c++的人来说，看c++语言更有一种亲切感。同时这本书在最后的一章里面还讲到了在FishGUI这个项目中使用c++时遇到的坑。对于c++程序员来说，这本书真心不能错过。</p>
<p>读完这本书，除了对于一些设计模式理解的更为透彻之外，我认为更重要的收获是对编程思想或者编程习惯的培养：</p>
<ol>
<li>实际编码之前一定要有分析和设计的阶段</li>
<li>只实现你真正需要的东西 </li>
<li>面向接口编程而不是面向实现编程</li>
<li>边编码边做一些优化性的重构</li>
</ol>
<p>我想这本书我以后肯定会再读的，因为现在的项目经验还不足，相信做多几个实际的项目之后再看一遍，肯定会有不一样的见解和更多的收获。</p>
<p>看这本书总共花了10天左右的时间吧，其实这个过程中也发现了自己在读书方面的缺点。就是后劲不足，在刚刚开始的时候每天都很有热情的去阅读，速度很快，看到也很仔细，但读了一半热情下来之后就没有之前那么入神了。这也是我接下来必须改进的地方，以前读的书太少，2016年有太多的书想要读。这是今年读完的第一本书，希望有始有终，之后的日子可以培养起看书的好习惯。  </p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/设计模式/">设计模式</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/读书笔记/">读书笔记</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-使用hexo搭建个人博客" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/19/使用hexo搭建个人博客/" class="article-date">
  	<time datetime="2016-01-19T13:10:24.000Z" itemprop="datePublished">2016-01-19</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/19/使用hexo搭建个人博客/">使用hexo搭建个人博客</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="u4E00_u3001_u5B89_u88C5hexo"><a href="#u4E00_u3001_u5B89_u88C5hexo" class="headerlink" title="一、安装hexo"></a>一、安装hexo</h2><p><strong>1.安装Node.js</strong><br>hexo是一款基于Node.js的静态博客框架，所以要使用它必须先安装Node.js。网上很多教程讲的都是如何编译源码安装Node.js。但我认为应该用最简单的方式取获取和使用软件或者框架，不是每个初学者都需要从一个软件的源代码编译开始学习。当然，在日后想要更深入理解它的时候，挖出它的源代码进行分析也是一种十分有效的途径。<br>下面是ubuntu下使用apt-get安装Node.js的方法（源自博客<a href="http://blog.csdn.net/chszs/article/details/37521463" target="_blank" rel="external">如何在Ubuntu上安装最新版本的Node.js </a>）</p>
<ol>
<li>apt-get update</li>
<li>apt-get install -y python-software-properties software-properties-common</li>
<li>add-apt-repository ppa:chris-lea/node.js</li>
<li>apt-get update</li>
<li>apt-get install nodejs</li>
</ol>
<p><strong>2.安装hexo</strong><br>之后安装hexo就更简单了，只需要这一行代码</p>
<pre><code>npm install hexo -g
</code></pre><p><strong>3.更新hexo</strong></p>
<pre><code>npm update hexo -g 
</code></pre><p><br></p>
<h2 id="u4E8C_u3001_u521B_u5EFA_u548C_u914D_u7F6Ehexo_u9879_u76EE"><a href="#u4E8C_u3001_u521B_u5EFA_u548C_u914D_u7F6Ehexo_u9879_u76EE" class="headerlink" title="二、创建和配置hexo项目"></a>二、创建和配置hexo项目</h2><p><strong>1.初始化hexo项目</strong></p>
<pre><code>hexo init [folder]
</code></pre><p>如果指定 <em>folder</em>，便会在目前的资料夹建立一个名为 <em>folder</em> 的新资料夹，否则会在当前文件夹初始化。<br>执行完这条命令，会出现如下提示:</p>
<blockquote>
<p>INFO  You are almost done! Don’t forget to run ‘npm install’ before you start blogging with Hexo!</p>
</blockquote>
<p>所以记得执行npm install</p>
<p><strong>2.创建新的文章</strong></p>
<pre><code>hexo new &quot;文章标题&quot;
</code></pre><p>执行完创建命令后会生成以下文件:</p>
<blockquote>
<p>source/_posts/文章标题.md</p>
</blockquote>
<p>之后只需要在这个markdown文件里面编写自己的博客文章就可以了</p>
<p><strong>3.添加主题</strong></p>
<p>有很多人为hexo编写了很多漂亮的主题，可以自己去<a href="https://github.com/hexojs/hexo/wiki/Themes" target="_blank" rel="external">主题列表</a>选择<br>安装的方法也很简单，这些主题都是托管在github上的，只要把它们克隆到项目文件夹的themes目录下面就可以了。当然还需要去__config.yml修改配置，选择使用哪个主题：</p>
<pre><code>theme: 主题名
</code></pre><p><strong>4.启动服务器</strong></p>
<p>编写完文章之后只需要运行下面命令就可以在浏览器地址栏输入 <a href="http://0.0.0.0:4000" target="_blank" rel="external">http://0.0.0.0:4000</a> 查看自己的博客了</p>
<pre><code>hexo server
</code></pre><p><br></p>
<h2 id="u4E09_u3001_u914D_u7F6E_u535A_u5BA2_u4FE1_u606F"><a href="#u4E09_u3001_u914D_u7F6E_u535A_u5BA2_u4FE1_u606F" class="headerlink" title="三、配置博客信息"></a>三、配置博客信息</h2><p>可以在项目根目录下的_config.yml文件配置博客的标题，作者，语言等相关信息</p>
<p><br></p>
<h2 id="u56DB_u3001_u90E8_u7F72_u5230Github"><a href="#u56DB_u3001_u90E8_u7F72_u5230Github" class="headerlink" title="四、部署到Github"></a>四、部署到Github</h2><p>github提供了一个名叫Github Pages的服务，我们可以免费的用它来搭建自己的博客。<br>做法很简单，首先在github建立与你用户名对应的仓库，仓库名必须为 “你的github用户名.github.io” </p>
<p>接着执行以下命令在本机安装hexo-deployer-git</p>
<pre><code>npm install hexo-deployer-git --save
</code></pre><p>然后在_config.yml文件，找到下面的内容</p>
<pre><code># Deployment
## Docs: http://hexo.io/docs/deployment.html
deploy:
  type:
</code></pre><p>将它们修改为</p>
<pre><code># Deployment
## Docs: http://hexo.io/docs/deployment.html
deploy:
  type: git
  repository: git@github.com:你的github用户名/你的github用户名.github.io
  branch: master
</code></pre><p>最后执行以下三条命令即可：</p>
<pre><code>hexo clean
hexo generate
hexo deploy
</code></pre><p>（当然你必须为你的电脑添加github ssh key才能正常执行hexo deploy命令上传代码）</p>
<p><br></p>
<h2 id="u4E94_u3001_u7ED1_u5B9A_u57DF_u540D"><a href="#u4E94_u3001_u7ED1_u5B9A_u57DF_u540D" class="headerlink" title="五、绑定域名"></a>五、绑定域名</h2><p>按照github pages的文档，是在github项目根目录下创建CNAME文件。但因为每次使用hexo更新博客再次上传，都会清除掉之前创建的CNAME文件。所以我们把CNAME放在source目录下（想上传的文件都放在该目录下）</p>
<p>完整步骤如下:</p>
<ol>
<li><p>在source目录下添加一个CNAM文件，没有后缀名，里面内容为你的域名(如我的是:blog.islinjw.cn)。</p>
</li>
<li><p>ping username.github.io记录下IP地址</p>
</li>
<li><p>购买域名，配置域名解析username.github.io的ip地址</p>
</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hexo/">hexo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/技术相关/">技术相关</a></li></ul>
	</div>

      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 林嘉伟
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>