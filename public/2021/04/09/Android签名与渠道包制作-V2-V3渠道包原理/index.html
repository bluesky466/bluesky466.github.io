<!DOCTYPE html>


  <html class="light page-home">


<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>Android签名与渠道包制作-V2/V3渠道包原理 | LinJW</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="技术相关,Android,">
  

  <meta name="description" content="系列文章:  Android签名与渠道包制作-V1版本 Android签名与渠道包制作-V2/V3签名原理 Android签名与渠道包制作-V2/V3渠道包原理  上一篇文章我们详细描述了V2/V3签名的原理，大概的原理的就是在APK中插入签名块保存签名信息:   APK签名块的格式如下:   V2的签名数据id为0x7109871a,V3的签名数据id为0xf05368c0。由于校验流程里面对A">
<meta name="keywords" content="技术相关,Android">
<meta property="og:type" content="article">
<meta property="og:title" content="Android签名与渠道包制作-V2&#x2F;V3渠道包原理">
<meta property="og:url" content="http://139.199.4.241/2021/04/09/Android签名与渠道包制作-V2-V3渠道包原理/index.html">
<meta property="og:site_name" content="LinJW">
<meta property="og:description" content="系列文章:  Android签名与渠道包制作-V1版本 Android签名与渠道包制作-V2/V3签名原理 Android签名与渠道包制作-V2/V3渠道包原理  上一篇文章我们详细描述了V2/V3签名的原理，大概的原理的就是在APK中插入签名块保存签名信息:   APK签名块的格式如下:   V2的签名数据id为0x7109871a,V3的签名数据id为0xf05368c0。由于校验流程里面对A">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://139.199.4.241/Android签名与渠道包制作V2V3渠道包原理/1.png">
<meta property="og:image" content="http://139.199.4.241/Android签名与渠道包制作V2V3渠道包原理/2.png">
<meta property="og:image" content="http://139.199.4.241/Android签名与渠道包制作V2V3渠道包原理/3.png">
<meta property="og:image" content="http://139.199.4.241/Android签名与渠道包制作V2V3渠道包原理/4.gif">
<meta property="og:updated_time" content="2022-02-07T05:47:21.420Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android签名与渠道包制作-V2&#x2F;V3渠道包原理">
<meta name="twitter:description" content="系列文章:  Android签名与渠道包制作-V1版本 Android签名与渠道包制作-V2/V3签名原理 Android签名与渠道包制作-V2/V3渠道包原理  上一篇文章我们详细描述了V2/V3签名的原理，大概的原理的就是在APK中插入签名块保存签名信息:   APK签名块的格式如下:   V2的签名数据id为0x7109871a,V3的签名数据id为0xf05368c0。由于校验流程里面对A">
<meta name="twitter:image" content="http://139.199.4.241/Android签名与渠道包制作V2V3渠道包原理/1.png">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=32204ee7" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?57e94d016e201fba3603a8a2b0263af0";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</head>
</html>
<body>

  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            target="_self"
            >
            关于
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#渠道信息写入"><span class="toc-text">渠道信息写入</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#渠道信息读取"><span class="toc-text">渠道信息读取</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#完整代码"><span class="toc-text">完整代码</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-Android签名与渠道包制作-V2-V3渠道包原理" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">Android签名与渠道包制作-V2/V3渠道包原理</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2021.04.09</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>林嘉伟</span>
        </span>
      

      


      

    </div>
  </header>

  <div class="article-content">
    
      <p>系列文章:</p>
<ul>
<li><a href="https://blog.islinjw.cn/2021/04/07/Android%E7%AD%BE%E5%90%8D%E4%B8%8E%E6%B8%A0%E9%81%93%E5%8C%85%E5%88%B6%E4%BD%9C-V1%E7%89%88%E6%9C%AC/" target="_blank" rel="noopener">Android签名与渠道包制作-V1版本</a></li>
<li><a href="https://blog.islinjw.cn/2021/04/07/Android%E7%AD%BE%E5%90%8D%E4%B8%8E%E6%B8%A0%E9%81%93%E5%8C%85%E5%88%B6%E4%BD%9C-V2-V3%E7%AD%BE%E5%90%8D%E5%8E%9F%E7%90%86/" target="_blank" rel="noopener">Android签名与渠道包制作-V2/V3签名原理</a></li>
<li><a href="https://blog.islinjw.cn/2021/04/09/Android%E7%AD%BE%E5%90%8D%E4%B8%8E%E6%B8%A0%E9%81%93%E5%8C%85%E5%88%B6%E4%BD%9C-V2-V3%E6%B8%A0%E9%81%93%E5%8C%85%E5%8E%9F%E7%90%86/" target="_blank" rel="noopener">Android签名与渠道包制作-V2/V3渠道包原理</a></li>
</ul>
<p><a href="https://blog.islinjw.cn/2021/04/07/Android%E7%AD%BE%E5%90%8D%E4%B8%8E%E6%B8%A0%E9%81%93%E5%8C%85%E5%88%B6%E4%BD%9C-V2-V3%E7%AD%BE%E5%90%8D%E5%8E%9F%E7%90%86/" target="_blank" rel="noopener">上一篇</a>文章我们详细描述了V2/V3签名的原理，大概的原理的就是在APK中插入签名块保存签名信息:</p>
<img src="/Android签名与渠道包制作V2V3渠道包原理/1.png">

<p>APK签名块的格式如下:</p>
<img src="/Android签名与渠道包制作V2V3渠道包原理/2.png">

<p>V2的签名数据id为0x7109871a,V3的签名数据id为0xf05368c0。由于校验流程里面对APK本身做了校验，所以V1版本的添加zip file comment的方法就失效了。</p>
<p>但是由于V2/V3签名对这个APK签名块是没有做校验的，所以我们可以添加一个自定义的渠道包信息键值对保存渠道信息。这篇文章就通过分析<a href="https://github.com/bluesky466/ChannelInfoHelper" target="_blank" rel="noopener">Demo</a>代码来讲解V2/V3渠道包的原理。</p>
<h1 id="渠道信息写入"><a href="#渠道信息写入" class="headerlink" title="渠道信息写入"></a>渠道信息写入</h1><p>基本原理就是渠道信息打包成一个id-value键值对放到键值对序列的最后:</p>
<img src="/Android签名与渠道包制作V2V3渠道包原理/3.png">

<p>插入的代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addChannelInfo</span><span class="params">(String srcApk, String outputApk, String channelInfo)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// [APK签名块]插入在[central directory]之前,而[central directory]的起始位置可以在[EOCD]的socdOffset部分读取</span></span><br><span class="line">    <span class="comment">// 我们在[APK签名块]里面插入渠道信息,会影响到[central directory]的位置,</span></span><br><span class="line">    <span class="comment">// 所以需要同步修改[EOCD]里面的socdOffset</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// [zip包其余内容](不变)          ...</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//                              1. APK签名块大小(不包含自己的8个字节)        8字节</span></span><br><span class="line">    <span class="comment">// [APK签名块](需要插入渠道信息)   2. ID-Value键值对                        大小可变</span></span><br><span class="line">    <span class="comment">//                              3. APK签名块大小(和第1部分相等)             8字节</span></span><br><span class="line">    <span class="comment">//                              4. 魔法数(固定为字符串"APK Sig Block 42")  16字节</span></span><br><span class="line">    <span class="comment">//                                      &lt;--------------------------</span></span><br><span class="line">    <span class="comment">// [central directory](不变)    ...                                |</span></span><br><span class="line">    <span class="comment">//                                                                 |</span></span><br><span class="line">    <span class="comment">//                              end of central dir signature       |</span></span><br><span class="line">    <span class="comment">//                              ...                                |</span></span><br><span class="line">    <span class="comment">// [EOCD](需要修改socdOffset)    socdOffset  ------------------------</span></span><br><span class="line">    <span class="comment">//                              ...</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (channelInfo == <span class="keyword">null</span> || channelInfo.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    RandomAccessFile zipFile = <span class="keyword">null</span>;</span><br><span class="line">    FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">    FileChannel srcChannel = <span class="keyword">null</span>;</span><br><span class="line">    FileChannel dstChannel = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        zipFile = <span class="keyword">new</span> RandomAccessFile(<span class="keyword">new</span> File(srcApk), <span class="string">"r"</span>);</span><br><span class="line">        srcChannel = zipFile.getChannel();</span><br><span class="line"></span><br><span class="line">        fos = <span class="keyword">new</span> FileOutputStream(outputApk);</span><br><span class="line">        dstChannel = fos.getChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查找eocd</span></span><br><span class="line">        ByteBuffer eocd = Utils.findEocd(srcChannel);</span><br><span class="line">        <span class="keyword">if</span> (eocd == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取旧的APK签名块</span></span><br><span class="line">        <span class="keyword">long</span> socdOffset = Utils.getSocdOffset(eocd);</span><br><span class="line">        Utils.Pair&lt;Long, ByteBuffer&gt; oldSignV2Block = Utils.getSignV2Block(zipFile, socdOffset);</span><br><span class="line">        <span class="keyword">if</span> (oldSignV2Block == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 往APK签名块插入渠道信息,得到新的APK签名块</span></span><br><span class="line">        ByteBuffer newSignV2Block = addChannelInfo(oldSignV2Block.second, channelInfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 修改eocd中的socd</span></span><br><span class="line">        changeSocdOffset(eocd, channelInfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// APK签名块前的数据是没有改过的,可以直接拷贝</span></span><br><span class="line">        srcChannel.position(<span class="number">0</span>);</span><br><span class="line">        Utils.copyByLength(srcChannel, dstChannel, oldSignV2Block.first);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 往后插入新的APK签名块的数据</span></span><br><span class="line">        dstChannel.write(newSignV2Block);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 往后插入[central directory]的数据,这部分也是没有修改的</span></span><br><span class="line">        srcChannel.position(socdOffset);</span><br><span class="line">        Utils.copyByLength(srcChannel, dstChannel, srcChannel.size() - socdOffset - eocd.capacity());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 往后插入修改后的eocd</span></span><br><span class="line">        eocd.position(<span class="number">0</span>);</span><br><span class="line">        dstChannel.write(eocd);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Utils.safeClose(srcChannel, zipFile, dstChannel, fos);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基本流程并不复杂，就是:</p>
<ol>
<li>通过魔数查找eocd</li>
<li>在eocd中查找central directory的偏移地址socd</li>
<li>socd往前读就是APK签名块</li>
<li>在APK签名块中插入渠道信息</li>
<li>由于APK签名块在socd的签名，插入渠道信息后需要将socd往后移</li>
<li>将修改后的各部分重新写入apk</li>
</ol>
<p>socd的修改很简单，读取原来的值加上渠道信息键值对的长度重新写入即可:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">changeSocdOffset</span><span class="params">(ByteBuffer eocd, String channelInfo)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 由于APK签名块在socd offset的前面</span></span><br><span class="line">    <span class="comment">// 而我们又在APK签名块里面插入了渠道信息</span></span><br><span class="line">    <span class="comment">// 所以socd offset应该再往后移动插入的渠道信息键值对的大小</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取原本的socd offset</span></span><br><span class="line">    eocd.position(Utils.EOCD_POSITION_SOCD_OFFSET);</span><br><span class="line">    <span class="keyword">int</span> originOffset = eocd.getInt();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 键值对格式如下:</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 键值对长度(不包含自己的8个字节)   8字节</span></span><br><span class="line">    <span class="comment">// ID                            4字节</span></span><br><span class="line">    <span class="comment">// Value                         键值对长度-ID的4字节</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 所以应该加上键值对长度(8字节)、ID长度(4字节)、渠道信息长度</span></span><br><span class="line">    eocd.position(Utils.EOCD_POSITION_SOCD_OFFSET);</span><br><span class="line">    eocd.putInt(originOffset + Long.BYTES + Integer.BYTES + channelInfo.getBytes().length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>往APK签名块中插入渠道信息稍微复杂一点。我们想将渠道信息插入到id-value键值对的最后，但是这里并没有去遍历这个键值对序列，而是用了一种取巧的方式。</p>
<p>由于键值对直接并没有什么指针关系去指定下一个键值对，仅仅只是将将它们排列在一起，所以我们只需要从APK签名块的末尾往前跳过16字节的魔数和8字节的长度信息就能找到插入位置的地址偏移:</p>
<img src="/Android签名与渠道包制作V2V3渠道包原理/4.gif">

<p>由于插入之后APK签名块的长度会增加，所以长度信息需要同步修改，完整的插入代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ByteBuffer <span class="title">addChannelInfo</span><span class="params">(ByteBuffer oldSignV2BlockSize, String channelInfo)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ID-Value键值对的格式如下:</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 键值对长度(不包含自己的8个字节)   8字节</span></span><br><span class="line">    <span class="comment">// ID                            4字节</span></span><br><span class="line">    <span class="comment">// Value                         键值对长度-ID的4字节</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 所以整个ID-Value键的长度应该是 Value长度 + ID长度(4字节) + 键值对长度(8字节)</span></span><br><span class="line">    <span class="keyword">long</span> infoLength = channelInfo.getBytes().length;</span><br><span class="line">    <span class="keyword">long</span> channelBlockRealSize = Long.BYTES + Integer.BYTES + infoLength;</span><br><span class="line"></span><br><span class="line">    ByteBuffer buffer = ByteBuffer.allocate((<span class="keyword">int</span>) (oldSignV2BlockSize.capacity() + channelBlockRealSize));</span><br><span class="line">    buffer.order(ByteOrder.LITTLE_ENDIAN);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 先将原本的APK完整拷贝出来</span></span><br><span class="line">    oldSignV2BlockSize.position(<span class="number">0</span>);</span><br><span class="line">    buffer.put(oldSignV2BlockSize);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取原本的APK签名块长度</span></span><br><span class="line">    oldSignV2BlockSize.position(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">long</span> originSize = oldSignV2BlockSize.getLong();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 该长度要加上插入的渠道信息键值对长度</span></span><br><span class="line">    buffer.position(<span class="number">0</span>);</span><br><span class="line">    buffer.putLong(originSize + channelBlockRealSize);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// APK签名块结构如下:</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 1. APK签名块大小(不包含自己的8个字节)        8字节</span></span><br><span class="line">    <span class="comment">// 2. ID-Value键值对                        大小可变</span></span><br><span class="line">    <span class="comment">// 3. APK签名块大小(和第1部分相等)             8字节</span></span><br><span class="line">    <span class="comment">// 4. 魔法数(固定为字符串"APK Sig Block 42")  16字节</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 我们把渠道包键值对放到整个APK签名块的最后</span></span><br><span class="line">    <span class="comment">// 所以从后往前减去魔法数的16字节,减去APK签名块大小的8字节</span></span><br><span class="line">    <span class="comment">// 定位到渠道包键值的起始位置</span></span><br><span class="line">    <span class="keyword">long</span> magicNumberSize = Utils.SIG_V2_MAGIC_NUMBER.getBytes().length;</span><br><span class="line">    buffer.position((<span class="keyword">int</span>) (oldSignV2BlockSize.capacity() - magicNumberSize - Long.BYTES));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入渠道包键值对数据</span></span><br><span class="line">    buffer.putLong(infoLength + Integer.BYTES);</span><br><span class="line">    buffer.putInt(Utils.CHANNEL_INFO_SIG);</span><br><span class="line">    buffer.put(channelInfo.getBytes());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入APK签名块长度</span></span><br><span class="line">    buffer.putLong(originSize + channelBlockRealSize);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入魔法数</span></span><br><span class="line">    buffer.put(Utils.SIG_V2_MAGIC_NUMBER.getBytes());</span><br><span class="line"></span><br><span class="line">    buffer.flip();</span><br><span class="line">    <span class="keyword">return</span> buffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="渠道信息读取"><a href="#渠道信息读取" class="headerlink" title="渠道信息读取"></a>渠道信息读取</h1><p>读取部分的逻辑也比较清晰:</p>
<ol>
<li>通过魔数查找eocd</li>
<li>在eocd中查找central directory的偏移地址socd</li>
<li>socd往前读就是APK签名块</li>
<li>跳过APK签名块头8个字节(长度信息)就是第一个id-value键值对</li>
<li>遍历键值对查找渠道信息键值对的id</li>
<li>找到渠道信息键值对之后读取value部分返回即可</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getChannelInfo</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    String apkPath = Utils.getApkPath(context);</span><br><span class="line">    <span class="keyword">if</span> (apkPath == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    RandomAccessFile apk = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        apk = <span class="keyword">new</span> RandomAccessFile(apkPath, <span class="string">"r"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查找eocd</span></span><br><span class="line">        ByteBuffer eocd = Utils.findEocd(apk.getChannel());</span><br><span class="line">        <span class="keyword">if</span> (eocd == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取APK签名块</span></span><br><span class="line">        Utils.Pair&lt;Long, ByteBuffer&gt; signV2Block = Utils.getSignV2Block(apk, Utils.getSocdOffset(eocd));</span><br><span class="line">        <span class="keyword">if</span> (signV2Block == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// APK签名块结构如下:</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// 1. APK签名块大小(不包含自己的8个字节)        8字节</span></span><br><span class="line">        <span class="comment">// 2. ID-Value键值对(有多个键值对)            大小可变</span></span><br><span class="line">        <span class="comment">//      2.1 键值对长度(不包含自己的8个字节)     8字节</span></span><br><span class="line">        <span class="comment">//      2.2 ID                              4字节</span></span><br><span class="line">        <span class="comment">//      2.3 Value                           键值对长度-ID的4字节</span></span><br><span class="line">        <span class="comment">// 3. APK签名块大小(和第1部分相等)             8字节</span></span><br><span class="line">        <span class="comment">// 4. 魔法数(固定为字符串"APK Sig Block 42")  16字节</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> id;</span><br><span class="line">        <span class="keyword">long</span> length,realLength;</span><br><span class="line">        <span class="keyword">long</span> positionLimit = signV2Block.second.capacity()</span><br><span class="line">                - Long.BYTES                                    <span class="comment">// APK签名块大小的长度(8字节)</span></span><br><span class="line">                - Utils.SIG_V2_MAGIC_NUMBER.getBytes().length;  <span class="comment">// 结尾魔数的长度(16字节)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> position = Long.BYTES; <span class="comment">// 跳过开头APK签名块大小的8字节才是第一个ID-Value键值对</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            signV2Block.second.position(position);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 读取键值对长度(不包含自己的8个字节)</span></span><br><span class="line">            length = signV2Block.second.getLong();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 键值对长度是不包含长度信息的8个字节的,所以要加上这8个字节</span></span><br><span class="line">            realLength = Long.BYTES + length;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 读取ID</span></span><br><span class="line">            id = signV2Block.second.getInt();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 移动到下一个键值对</span></span><br><span class="line">            position += realLength;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 判断是否找到渠道信息键值对的ID,或者已经遍历完整个APK签名块</span></span><br><span class="line">        &#125; <span class="keyword">while</span> (id != Utils.CHANNEL_INFO_SIG &amp;&amp; position &lt;= positionLimit);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (id == Utils.CHANNEL_INFO_SIG) &#123;</span><br><span class="line">            <span class="comment">// 如果可以找到渠道信息键值对,往后读取就可以读到渠道信息</span></span><br><span class="line">            <span class="comment">// 键值对长度是包含ID的四个字节的,要减去</span></span><br><span class="line">            <span class="keyword">return</span> Utils.readString(signV2Block.second, (<span class="keyword">int</span>) (length - Integer.BYTES));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Utils.safeClose(apk);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><p>由于V2/V3的原理其实是大致相同的，都是在APK签名块里面插入id-value键值对，所以我们这个做法是能够兼容V2/V3版本的签名的。完整的demo已经上传到<a href="https://github.com/bluesky466/ChannelInfoHelper" target="_blank" rel="noopener">Github</a>,我将添加渠道信息的操作放到了<a href="https://github.com/bluesky466/ChannelInfoHelper/blob/master/app/src/test/java/me/linjw/channelinfohelper/AddChannelInfo.java" target="_blank" rel="noopener">单元测试</a>里，编译完之后执行插入渠道信息。</p>

    
  </div>
</article>

</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              target="_self"
              >
              关于
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    




  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235687', function() {
      // load success
    });
  }
</script>

  <footer style="flex: 0 0 auto;text-align: center;">
<a style="font-size:12px; color:#6C6C6C" target="_blank">© 2021  林嘉伟 ❤ <a style="font-size:12px; color:#6C6C6C" target="_blank" href="http://beian.miit.gov.cn/" rel="nofollow">粤ICP备2021021473号</a></footer>
</body>
</html>
