<!DOCTYPE html>


  <html class="light page-home">


<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>stm32 can总线学习笔记 | LinJW</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="技术相关,嵌入式,">
  

  <meta name="description" content="这段时间折腾stm32与树莓派之间的can总线通讯遇到了不少问题,树莓派那端的已经写在树莓派外挂MCP2515模块爬坑记录里面了。这次来总结下CAN总线协议和讲讲stm32如何使用CAN总线。 can总线协议基础首先我们来大概看看CAN总线协议是怎样的。 完整的CAN电路是由CAN控制器和CAN收发器组成的。协议相关的内容由CAN控制器完成。CAN 控制器和CAN收发器用CAN TX和CAN RX">
<meta name="keywords" content="技术相关,嵌入式">
<meta property="og:type" content="article">
<meta property="og:title" content="stm32 can总线学习笔记">
<meta property="og:url" content="http://139.199.4.241/2021/02/26/stm32-can总线学习笔记/index.html">
<meta property="og:site_name" content="LinJW">
<meta property="og:description" content="这段时间折腾stm32与树莓派之间的can总线通讯遇到了不少问题,树莓派那端的已经写在树莓派外挂MCP2515模块爬坑记录里面了。这次来总结下CAN总线协议和讲讲stm32如何使用CAN总线。 can总线协议基础首先我们来大概看看CAN总线协议是怎样的。 完整的CAN电路是由CAN控制器和CAN收发器组成的。协议相关的内容由CAN控制器完成。CAN 控制器和CAN收发器用CAN TX和CAN RX">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://139.199.4.241/stm32can学习笔记/1.png">
<meta property="og:image" content="http://139.199.4.241/stm32can学习笔记/2.png">
<meta property="og:image" content="http://139.199.4.241/stm32can学习笔记/3.png">
<meta property="og:image" content="http://139.199.4.241/stm32can学习笔记/4.png">
<meta property="og:image" content="http://139.199.4.241/stm32can学习笔记/5.jpg">
<meta property="og:image" content="http://139.199.4.241/stm32can学习笔记/6.jpg">
<meta property="og:image" content="http://139.199.4.241/stm32can学习笔记/7.jpg">
<meta property="og:image" content="http://139.199.4.241/stm32can学习笔记/8.png">
<meta property="og:image" content="http://139.199.4.241/stm32can学习笔记/9.png">
<meta property="og:image" content="http://139.199.4.241/stm32can学习笔记/10.png">
<meta property="og:updated_time" content="2021-02-26T13:57:55.747Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="stm32 can总线学习笔记">
<meta name="twitter:description" content="这段时间折腾stm32与树莓派之间的can总线通讯遇到了不少问题,树莓派那端的已经写在树莓派外挂MCP2515模块爬坑记录里面了。这次来总结下CAN总线协议和讲讲stm32如何使用CAN总线。 can总线协议基础首先我们来大概看看CAN总线协议是怎样的。 完整的CAN电路是由CAN控制器和CAN收发器组成的。协议相关的内容由CAN控制器完成。CAN 控制器和CAN收发器用CAN TX和CAN RX">
<meta name="twitter:image" content="http://139.199.4.241/stm32can学习笔记/1.png">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=32204ee7" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?57e94d016e201fba3603a8a2b0263af0";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</head>
</html>
<body>

  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            target="_self"
            >
            关于
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#can总线协议基础"><span class="toc-text">can总线协议基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#位时序"><span class="toc-text">位时序</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#stm32-位时序配置"><span class="toc-text">stm32 位时序配置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#标准帧与拓展帧"><span class="toc-text">标准帧与拓展帧</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#stm32-CAN-id过滤器"><span class="toc-text">stm32 CAN id过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#掩码模式"><span class="toc-text">掩码模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#32位宽的掩码模式"><span class="toc-text">32位宽的掩码模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16位宽的掩码模式"><span class="toc-text">16位宽的掩码模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#列表模式"><span class="toc-text">列表模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#32位宽的列表模式"><span class="toc-text">32位宽的列表模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16位宽的列表模式"><span class="toc-text">16位宽的列表模式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#接收数据"><span class="toc-text">接收数据</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NORMAL和LOOPBACK模式"><span class="toc-text">NORMAL和LOOPBACK模式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NORMAL模式下收不到数据"><span class="toc-text">NORMAL模式下收不到数据</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-stm32-can总线学习笔记" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">stm32 can总线学习笔记</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2021.02.26</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>林嘉伟</span>
        </span>
      

      


      

    </div>
  </header>

  <div class="article-content">
    
      <p>这段时间折腾stm32与树莓派之间的can总线通讯遇到了不少问题,树莓派那端的已经写在<a href="https://blog.islinjw.cn/2021/02/09/%E6%A0%91%E8%8E%93%E6%B4%BE%E5%A4%96%E6%8C%82MCP2515%E6%A8%A1%E5%9D%97%E7%88%AC%E5%9D%91%E8%AE%B0%E5%BD%95/" target="_blank" rel="noopener">树莓派外挂MCP2515模块爬坑记录</a>里面了。这次来总结下CAN总线协议和讲讲stm32如何使用CAN总线。</p>
<h1 id="can总线协议基础"><a href="#can总线协议基础" class="headerlink" title="can总线协议基础"></a>can总线协议基础</h1><p>首先我们来大概看看CAN总线协议是怎样的。</p>
<p>完整的CAN电路是由CAN控制器和CAN收发器组成的。协议相关的内容由CAN控制器完成。CAN 控制器和CAN收发器用CAN TX和CAN RX两根线传输TTL电平信号。低电平代表二进制的0,高电平代表二进制的1。</p>
<p>CAN H 和CAN L就是CAN总线,所有设备的CAN 收发器都会挂在这两根线上。数据通过差分信号在这两个线间传输:</p>
<ul>
<li>CAN H - CAN L &lt; 0.5V 表示二进制的1</li>
<li>CAN H - CAN L &gt; 0.9V 表示二进制的0</li>
</ul>
<p>为了避免信号的反射和干扰，还需要在CAN H和CAN L之间接上120欧姆的终端电阻。</p>
<img src="/stm32can学习笔记/1.png">

<p>CAN收发器将CAN控制器通过CAN TX线传来的二进制码流转换为差分信号用CAN H、CAN L两根线发送出去。同时接收端设备的CAN接收器会监听CAN H、CAN L两根线的差分信号，转换成二进制码流通过CAN RX线传给CAN控制器</p>
<h2 id="位时序"><a href="#位时序" class="headerlink" title="位时序"></a>位时序</h2><p>can总线并没有主从之分,当can总线上的一个设备发送数据时,它以广播的形式在can总线上发送报文给所有的设备。其他设备通过过滤报文的id,处理自己感兴趣的报文。</p>
<p>由于CAN通讯协议并没有时钟信号线,所以要求发送端与接收端的波特率是一致的,而can总线的数据发送效率需要我们去自定义。</p>
<p>要设置设置速率，我先要了解CAN的位时序概念。CAN协议把每个bit分成了四个时间段。我们可以用示波器在CAN TX或者CAN RX上量到下面的10101的波形,把每个bit的波形放大其实会有四段时间:</p>
<img src="/stm32can学习笔记/2.png">

<ul>
<li>ss : 同步段（Synchronization Segment）固定为1Tq</li>
<li>pts : 传播段（Propagation Time Segment）1~8Tq</li>
<li>pbs1 : 相位缓冲段1（Phase Buffer Segment 1）1~8Tq</li>
<li>pbs2 : 相位缓冲段2（Phase Buffer Segment 2）2~8Tq</li>
</ul>
<p>每个段的时长单位是Tq(Time Quantum),这个Tq可以由我们去设置,例如设置为1000ns。</p>
<h1 id="stm32-位时序配置"><a href="#stm32-位时序配置" class="headerlink" title="stm32 位时序配置"></a>stm32 位时序配置</h1><p>上面的是标准的CAN总线位时序,具体每一段的意义我没有深入去了解,但是对于使用来讲并不重要。而stm32里面将pts和pbs1合并了,所以它剩下了三段:</p>
<ul>
<li>ss : Synchronization Segment固定为1Tq</li>
<li>ts1 : Time segment 1, 即 pts + pbs1</li>
<li>ts2 : Time segment 2, 即pbs2</li>
</ul>
<p>由于ss固定为1Tq，所以我们在STM32CubeMX里面可以设置的是Tq、ts1和ts2:</p>
<img src="/stm32can学习笔记/3.png">

<p>Tq并不能直接设置,要通过Prescaler设置分频去设置。</p>
<p>例如我们将can的时钟频率设置为36MHz:</p>
<img src="/stm32can学习笔记/4.png">

<p>所以Prescaler设置成36的时候Tq可以这样计算:<br>1Tq = 36 MHz / 36 = 1 MHz = 1000 ns</p>
<p>这个时候我们就能去计算一个bit的时间了,如上图我们把ts1设置为4,ts2设置为5,再加上ss固定的1Tq:</p>
<p>1Tq + 4Tq + 5Tq = 10 Tq = 10000 ns = 10 us</p>
<p>波特率为 1 s / 10 us = 100k</p>
<p>于是我们可以在树莓派中设置CAN的波特率为100k:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo<span class="built_in"> ip </span>link <span class="builtin-name">set</span> can0 up<span class="built_in"> type </span>can bitrate 100000</span><br></pre></td></tr></table></figure>

<p>当然也可以设置每一段的时间:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo<span class="built_in"> ip </span>link <span class="builtin-name">set</span> can0 up<span class="built_in"> type </span>can tq 1000 prop-seg 3 phase-seg1 1 phase-seg2 5 sjw 4</span><br></pre></td></tr></table></figure>

<p>prop-seg和phase-seg1加起来等于ts1即可。当然有同学会看到还有另外一个sjw(ReSynchronization Jump Width)的参数,这个时间是用于同步的不影响波特率,范围是1~4Tq,我这里设置成4Tq。</p>
<h1 id="标准帧与拓展帧"><a href="#标准帧与拓展帧" class="headerlink" title="标准帧与拓展帧"></a>标准帧与拓展帧</h1><p>如此配置之后树莓派就能接收到stm32通过CAN总线发送的数据了,发送的代码如下:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">HAL_StatusTypeDef Can_TxMessage(uint8_t ide,uint32_t <span class="keyword">id</span>,uint8_t len,uint8_t *data)</span><br><span class="line">&#123;</span><br><span class="line">    uint32_t   TxMailbox;</span><br><span class="line">    <span class="built_in">CAN_TxHeaderTypeDef</span> <span class="built_in">CAN_TxHeader</span>;</span><br><span class="line">    HAL_StatusTypeDef   HAL_RetVal;</span><br><span class="line">    uint16_t i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(ide == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">CAN_TxHeader</span>.IDE = <span class="built_in">CAN_ID_STD</span>;</span><br><span class="line">        <span class="built_in">CAN_TxHeader</span>.StdId = <span class="keyword">id</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">CAN_TxHeader</span>.IDE = <span class="built_in">CAN_ID_EXT</span>;</span><br><span class="line">        <span class="built_in">CAN_TxHeader</span>.ExtId = <span class="keyword">id</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CAN_TxHeader</span>.DLC = len;</span><br><span class="line">    <span class="built_in">CAN_TxHeader</span>.RTR = <span class="built_in">CAN_RTR_DATA</span>;</span><br><span class="line">    <span class="built_in">CAN_TxHeader</span>.TransmitGlobalTime = DISABLE;</span><br><span class="line">    <span class="keyword">while</span>(HAL_CAN_GetTxMailboxesFreeLevel(&amp;hcan) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        i++;</span><br><span class="line">        <span class="keyword">if</span>(i&gt;<span class="number">0xfffe</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> HAL_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    HAL_Delay(<span class="number">500</span>);</span><br><span class="line">    HAL_RetVal = HAL_CAN_AddTxMessage(&amp;hcan,&amp;<span class="built_in">CAN_TxHeader</span>,data,&amp;TxMailbox);</span><br><span class="line">    <span class="keyword">if</span>(HAL_RetVal != HAL_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> HAL_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> HAL_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送数据</span></span><br><span class="line">uint8_t data[<span class="number">8</span>]=&#123;<span class="number">170</span>,<span class="number">170</span>,<span class="number">170</span>,<span class="number">170</span>,<span class="number">170</span>,<span class="number">170</span>,<span class="number">170</span>,<span class="number">170</span>&#125;;</span><br><span class="line">Can_TxMessage(<span class="number">0</span>,<span class="number">0x222</span>,<span class="number">8</span>,data);</span><br></pre></td></tr></table></figure>

<p>Can_TxMessage的第一个参数可以配置CAN报文是标准帧还是拓展帧。它们其实基本只有id的长度不一样而已。这个id就是上面我们提到的用于过滤CAN广播的标识符。<br>标准帧的id有11位,这11位被命名为STDID。拓展帧在标准帧的基础上增加了18位所以有29位,这个拓展的18位被命名为EXID。</p>
<h1 id="stm32-CAN-id过滤器"><a href="#stm32-CAN-id过滤器" class="headerlink" title="stm32 CAN id过滤器"></a>stm32 CAN id过滤器</h1><p>stm32 提供了一组过滤器,可以用于过滤CAN报文,只要符合某一个过滤器的规则,该报文即被接收。</p>
<p>过滤器过滤报文有两种模式: 列表模式与掩码模式</p>
<h2 id="掩码模式"><a href="#掩码模式" class="headerlink" title="掩码模式"></a>掩码模式</h2><p>掩码模式下我们需要配置屏蔽寄存器和标识符寄存器，屏蔽寄存器用于配置需要匹配的CAN id的比特位。屏蔽码寄存器某位为1表示接收到的CAN ID对应的位必须和标识符寄存器对应的位相同。</p>
<p>例如我们将屏蔽码寄存器配置为0xF,意味着我们只关心CAN ID二进制的后4位,此时再将标识符寄存器配置为0xa,意味着所有二进制后四位为1010的CAN ID都能能被接收(例如0xa/0xaa/0xffa等)。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span> <span class="number">0000</span> <span class="string">ffff</span>  <span class="comment"># 掩码寄存器</span></span><br><span class="line"><span class="number">0000</span> <span class="number">0000</span> <span class="number">1010</span>  <span class="comment"># 标识符寄存器</span></span><br><span class="line"><span class="string">--------------</span></span><br><span class="line"><span class="number">0000</span> <span class="number">0000</span> <span class="number">1010</span>  <span class="comment"># 0xa</span></span><br><span class="line"><span class="number">0000</span> <span class="number">1010</span> <span class="number">1010</span>  <span class="comment"># 0xaa</span></span><br><span class="line"><span class="number">1111</span> <span class="number">1111</span> <span class="number">1010</span>  <span class="comment"># 0xffa</span></span><br></pre></td></tr></table></figure>

<p>原理是这个原理,但是是stm32的配置还是需要了解一下的。虽然CAN报文的id长度只有标准帧的11位或者拓展帧的29位，但是stm32中却是用了16位宽或者32位宽的寄存器去保存掩码和标识符。所以会有除了id和mask之外还会有其他的位需要配置。</p>
<h3 id="32位宽的掩码模式"><a href="#32位宽的掩码模式" class="headerlink" title="32位宽的掩码模式"></a>32位宽的掩码模式</h3><p>我们先来看下面这附图，它说明了32位宽的掩码模式的寄存器每一位的作用:</p>
<img src="/stm32can学习笔记/5.jpg">

<p>id和mask皆由4个字节组成,第一个字节存放了STDID的10~3bit，第二个字节放了STDID的2~0bit还有EXID的17~13bit，第三个字节放了EXID的12~5bit，第四个字节放了EXID的4~0bit、IDE（扩展帧标识）、RTR（远程帧标志）和一个预留的0。</p>
<p>我们在代码中通过FilterMaskIdHigh、FilterIdLow、FilterMaskIdHigh、FilterMaskIdLow去设置掩码和标识符:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">uint32_t ext_id =<span class="number">0xa</span>;</span><br><span class="line">uint32_t mask =<span class="number">0xf</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">CAN_FilterTypeDef</span> <span class="built_in">CAN_FilterType</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 过滤器的id,STM32F072RBTx提供了14个过滤器所以id可以配置成0~13</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterBank=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置位宽为32位</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterScale=<span class="built_in">CAN_FILTERSCALE_32BIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置为掩码模式</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterMode=<span class="built_in">CAN_FILTERMODE_IDMASK</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置前两个字节的STDID[10:3]、STDID[2:0]、EXID[17:13]</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterIdHigh=((ext_id&lt;&lt;<span class="number">3</span>) &gt;&gt;<span class="number">16</span>) &amp;<span class="number">0xffff</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置后两个字节的EXID[12:5]、EXID[4:0]、IDE、RTR、预留的一个0</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterIdLow=(ext_id&lt;&lt;<span class="number">3</span>) | <span class="built_in">CAN_ID_EXT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置掩码前两个字节,左移3位再或CAN_ID_EXT是因为最后的三位并不是ID，而是IDE、RTR和预留的0</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterMaskIdHigh=((mask&lt;&lt;<span class="number">3</span>|<span class="built_in">CAN_ID_EXT</span>)&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置掩码后两个字节,左移3位再或CAN_ID_EXT是因为最后的三位并不是ID，而是IDE、RTR和预留的0</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterMaskIdLow=(mask&lt;&lt;<span class="number">3</span>|<span class="built_in">CAN_ID_EXT</span>)&amp;<span class="number">0xffff</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将消息放到FIFO0这个队列里</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterFIFOAssignment=<span class="built_in">CAN_RX_FIFO0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 激活过滤器</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterActivation=ENABLE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置过滤器</span></span><br><span class="line"><span class="keyword">if</span>(HAL_CAN_ConfigFilter(&amp;hcan,&amp;<span class="built_in">CAN_FilterType</span>)!=HAL_OK)</span><br><span class="line">&#123;</span><br><span class="line">  Error_Handler();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="16位宽的掩码模式"><a href="#16位宽的掩码模式" class="headerlink" title="16位宽的掩码模式"></a>16位宽的掩码模式</h3><p>16位宽的寄存器示意图如下:</p>
<img src="/stm32can学习笔记/6.jpg">

<p>id和mask都是两个字节，但是真正使得标准id起作用的只有第一个字节和第二个自己的前3位。这里各只用了两个字节，也就是说一个过滤器可以设置两组id和mask,FilterMaskIdHigh和FilterMaskIdHigh一组FilterIdLow和FilterMaskIdLow一组:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">uint32_t std_id1 =<span class="number">0xa</span>;</span><br><span class="line">uint32_t mask1 = <span class="number">0xf</span>;</span><br><span class="line">uint32_t std_id2 =<span class="number">0xbb</span>;</span><br><span class="line">uint32_t mask2 = <span class="number">0xff</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">CAN_FilterTypeDef</span> <span class="built_in">CAN_FilterType</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 过滤器的id,STM32F072RBTx提供了14个过滤器所以id可以配置成0~13</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterBank=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置位宽为16位</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterScale=<span class="built_in">CAN_FILTERSCALE_16BIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置为掩码模式</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterMode=<span class="built_in">CAN_FILTERMODE_IDMASK</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置第一组的id,左移5位是因为最后的5bit是RTR、IDE和EXID[17:15]</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterIdHigh=(std_id1&lt;&lt;<span class="number">5</span>) | <span class="built_in">CAN_ID_STD</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置第一组的mask,左移5位是因为最后的5bit是RTR、IDE和EXID[17:15]</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterMaskIdHigh= ((mask1&lt;&lt;<span class="number">5</span>)|<span class="built_in">CAN_ID_STD</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置第二组的id,左移5位是因为最后的5bit是RTR、IDE和EXID[17:15]</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterIdLow=(std_id2&lt;&lt;<span class="number">5</span>)|<span class="built_in">CAN_ID_STD</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置第二组的mask,左移5位是因为最后的5bit是RTR、IDE和EXID[17:15]</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterMaskIdLow=(mask2&lt;&lt;<span class="number">5</span>|<span class="built_in">CAN_ID_STD</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将消息放到FIFO0这个队列里</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterFIFOAssignment=<span class="built_in">CAN_RX_FIFO0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 激活过滤器</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterActivation=ENABLE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置过滤器</span></span><br><span class="line"><span class="keyword">if</span>(HAL_CAN_ConfigFilter(&amp;hcan,&amp;<span class="built_in">CAN_FilterType</span>)!=HAL_OK)</span><br><span class="line">&#123;</span><br><span class="line">  Error_Handler();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="列表模式"><a href="#列表模式" class="headerlink" title="列表模式"></a>列表模式</h2><p>列表模式意味着我们将想要接收的CAN id直接配置到过滤器。</p>
<h3 id="32位宽的列表模式"><a href="#32位宽的列表模式" class="headerlink" title="32位宽的列表模式"></a>32位宽的列表模式</h3><img src="/stm32can学习笔记/7.jpg">

<p>32位宽的列表模式下,可以设置两个id,FilterMaskIdHigh和FilterMaskIdHigh一个，FilterIdLow和FilterMaskIdLow一个:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">uint32_t ext_id1 =<span class="number">0xa</span>;</span><br><span class="line">uint32_t ext_id2 =<span class="number">0xbb</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">CAN_FilterTypeDef</span> <span class="built_in">CAN_FilterType</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 过滤器的id,STM32F072RBTx提供了14个过滤器所以id可以配置成0~13</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterBank=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置位宽为32位</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterScale=<span class="built_in">CAN_FILTERSCALE_32BIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置为列表模式</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterMode=<span class="built_in">CAN_FILTERMODE_IDLIST</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置第一个id的高字节,左移三位是因为最后的三位是IDE、RTR和预留的0</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterIdHigh=((ext_id1&lt;&lt;<span class="number">3</span>)&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置第一个id的低字节,左移三位是因为最后的三位是IDE、RTR和预留的0</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterIdLow=((ext_id1&lt;&lt;<span class="number">3</span>)&amp;<span class="number">0xffff</span>)|<span class="built_in">CAN_ID_EXT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置第二个id的高字节,左移三位是因为最后的三位是IDE、RTR和预留的0</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterMaskIdHigh=((ext_id2&lt;&lt;<span class="number">3</span>)&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置第二个id的低字节,左移三位是因为最后的三位是IDE、RTR和预留的0</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterMaskIdLow=((ext_id2&lt;&lt;<span class="number">3</span>)&amp;<span class="number">0xffff</span>)|<span class="built_in">CAN_ID_EXT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将消息放到FIFO0这个队列里</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterFIFOAssignment=<span class="built_in">CAN_RX_FIFO0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 激活过滤器</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterActivation=ENABLE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置过滤器</span></span><br><span class="line"><span class="keyword">if</span>(HAL_CAN_ConfigFilter(&amp;hcan,&amp;<span class="built_in">CAN_FilterType</span>)!=HAL_OK)</span><br><span class="line">&#123;</span><br><span class="line">  Error_Handler();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="16位宽的列表模式"><a href="#16位宽的列表模式" class="headerlink" title="16位宽的列表模式"></a>16位宽的列表模式</h3><img src="/stm32can学习笔记/8.png">

<p>16位宽的列表模式下,可以设置四个id,FilterMaskIdHigh、FilterMaskIdHigh、FilterIdLow和FilterMaskIdLow各一个:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">uint16_t ext_id1 =<span class="number">0xa</span>;</span><br><span class="line">uint16_t ext_id2 =<span class="number">0xb</span>;</span><br><span class="line">uint16_t ext_id3 =<span class="number">0xc</span>;</span><br><span class="line">uint16_t ext_id4 =<span class="number">0xd</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">CAN_FilterTypeDef</span> <span class="built_in">CAN_FilterType</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 过滤器的id,STM32F072RBTx提供了14个过滤器所以id可以配置成0~13</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterBank=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置位宽为16位</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterScale=<span class="built_in">CAN_FILTERSCALE_16BIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置为列表模式</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterMode=<span class="built_in">CAN_FILTERMODE_IDLIST</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置第一个id,左移五位是因为最后的五位是RTR、IDE和EXID[17:15]</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterIdHigh=(ext_id1&lt;&lt;<span class="number">5</span>)|<span class="built_in">CAN_ID_STD</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置第二个id,左移五位是因为最后的五位是RTR、IDE和EXID[17:15]</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterIdLow=(ext_id2&lt;&lt;<span class="number">5</span>)|<span class="built_in">CAN_ID_STD</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置第三个id,左移五位是因为最后的五位是RTR、IDE和EXID[17:15]</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterMaskIdHigh=(ext_id3&lt;&lt;<span class="number">5</span>)|<span class="built_in">CAN_ID_STD</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置第四个id,左移五位是因为最后的五位是RTR、IDE和EXID[17:15]</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterMaskIdLow=(ext_id4&lt;&lt;<span class="number">5</span>)|<span class="built_in">CAN_ID_STD</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将消息放到FIFO0这个队列里</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterFIFOAssignment=<span class="built_in">CAN_RX_FIFO0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 激活过滤器</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterActivation=ENABLE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置过滤器</span></span><br><span class="line"><span class="keyword">if</span>(HAL_CAN_ConfigFilter(&amp;hcan,&amp;<span class="built_in">CAN_FilterType</span>)!=HAL_OK)</span><br><span class="line">&#123;</span><br><span class="line">  Error_Handler();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="接收数据"><a href="#接收数据" class="headerlink" title="接收数据"></a>接收数据</h1><p>我们可以看到设置过滤器的时候,会配置将过滤出来的数据放到FIFO0这个队里里面:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将消息放到FIFO0这个队列里</span></span><br><span class="line"><span class="built_in">CAN_FilterType</span>.FilterFIFOAssignment=<span class="built_in">CAN_RX_FIFO0</span>;</span><br></pre></td></tr></table></figure>

<p>然后我们还有两步需要操作:</p>
<ol>
<li>激活这个队列的通知</li>
</ol>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">if</span>(HAL_CAN_ActivateNotification(&amp;hcan,CAN_IT_RX_FIFO0_MSG_PENDING)!=HAL_OK)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="selector-tag">Error_Handler</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在STM32CubeMX中使能CAN的接收中断:</li>
</ol>
<img src="/stm32can学习笔记/9.png">

<p>然后就能重写HAL_CAN_RxFifo0MsgPendingCallback函数去处理接收的数据了:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_CAN_RxFifo0MsgPendingCallback</span><span class="params">(CAN_HandleTypeDef *hcan)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"HAL_CAN_RxFifo0MsgPendingCallback\r\n"</span>);</span><br><span class="line">    CAN_RxHeaderTypeDef CAN_RxHeader;</span><br><span class="line">    HAL_StatusTypeDef HAL_Retval;</span><br><span class="line">    <span class="keyword">uint8_t</span> Rx_Data[<span class="number">8</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> Data_Len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> ID = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span> i;</span><br><span class="line">    HAL_Retval = HAL_CAN_GetRxMessage(hcan,CAN_RX_FIFO0,&amp;CAN_RxHeader,Rx_Data);</span><br><span class="line">    <span class="keyword">if</span>(HAL_Retval == HAL_OK)</span><br><span class="line">    &#123;</span><br><span class="line">        Data_Len = CAN_RxHeader.DLC;</span><br><span class="line">        <span class="keyword">if</span>(CAN_RxHeader.IDE)</span><br><span class="line">        &#123;</span><br><span class="line">            ID = CAN_RxHeader.ExtId;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ID = CAN_RxHeader.StdId;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"id:%x\r\n"</span>,ID);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Data_Len:%d\r\n"</span>,Data_Len);</span><br><span class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Rx_Data[%d]=%x\r\n"</span>,i,Rx_Data[i]);  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="NORMAL和LOOPBACK模式"><a href="#NORMAL和LOOPBACK模式" class="headerlink" title="NORMAL和LOOPBACK模式"></a>NORMAL和LOOPBACK模式</h1><p>正常模式下设备是收不到自己发送的报文的，我们可以设置LOOPBACK模式实现自发自收,但是注意该模式只用于调试,此时报文其实不会在总线上传播,所以其他设备是收不到发送的报文的:</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//hcan.Init.Mode = CAN_MODE_NORMAL<span class="comment">;</span></span><br><span class="line">hcan.Init.Mode = CAN_MODE_LOOPBACK<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<h1 id="NORMAL模式下收不到数据"><a href="#NORMAL模式下收不到数据" class="headerlink" title="NORMAL模式下收不到数据"></a>NORMAL模式下收不到数据</h1><p>我在调CAN总线的最后遇到了这样一个问题:LOOPBACK模式下能收到自己发的数据,但NORMAL模式下收不到树莓派发送的数据。</p>
<p>通过示波器测量: stm32的CAN RX可以量到树莓派发送的数据波形了，波特率是100k，甚至CAN TX都量到有stm32响应的波形。</p>
<p>而且有个奇怪的现象，stm32在loopback下发数据，CAN TX可以量到完整的数据波形，但是如果改成NORMAL模式，就只能量到一个bit的数据。</p>
<p>于是我怀疑是收发器哪里出问题了,导致发送失败,在接收到数据的时候由于发送响应失败,导致接收的流程也断掉了,没有去到回调函数那里。</p>
<p>最终定位到收发器TJA1042T的STB脚没有拉低,导致收发器处于Standby模式:</p>
<img src="/stm32can学习笔记/10.png">

<p>除了这个原因之外在<a href="http://www.cnblogs.com/whitetiger/p/3811872.html" target="_blank" rel="noopener">网上</a>也有看到这种情况的其他可能原因:</p>
<ol>
<li><p>回环下应该与GPIO无关</p>
</li>
<li><p>GPIO是否初始化正确，时钟启用</p>
</li>
<li><p>是否复用，AFIO时钟是否启用</p>
</li>
<li><p>回环下是否有CAN_Tx应该有输出</p>
</li>
<li><p>终端电阻是否有</p>
</li>
<li><p>CAN收发器电路电压是否正常</p>
</li>
<li><p>波特率是否标准</p>
</li>
<li><p>换块板试一下</p>
</li>
</ol>

    
  </div>
</article>

</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              target="_self"
              >
              关于
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    




  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235687', function() {
      // load success
    });
  }
</script>

  <footer style="flex: 0 0 auto;text-align: center;">
<a style="font-size:12px; color:#6C6C6C" target="_blank">© 2021  林嘉伟 ❤ <a style="font-size:12px; color:#6C6C6C" target="_blank" href="http://beian.miit.gov.cn/" rel="nofollow">粤ICP备2021021473号</a></footer>
</body>
</html>
