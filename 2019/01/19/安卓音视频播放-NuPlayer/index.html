<!DOCTYPE html>


  <html class="light page-post">


<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>安卓音视频播放 - NuPlayer | LinJW</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="技术相关,Android,">
  

  <meta name="description" content="系列文章:  安卓音视频播放 - 总体架构 安卓音视频播放 - AwesomePlayer 安卓音视频播放 - NuPlayer  这里有一点需要提一下,不像StagefrightPlayerFactory直接就创建出了StagefrightPlayer, NuPlayerFactory创建出来的是NuPlayerDriver,不过NuPlayerDriver内部也是封装了NuPlayer,对Nu">
<meta name="keywords" content="技术相关,Android">
<meta property="og:type" content="article">
<meta property="og:title" content="安卓音视频播放 - NuPlayer">
<meta property="og:url" content="http://139.199.4.241/2019/01/19/安卓音视频播放-NuPlayer/index.html">
<meta property="og:site_name" content="LinJW">
<meta property="og:description" content="系列文章:  安卓音视频播放 - 总体架构 安卓音视频播放 - AwesomePlayer 安卓音视频播放 - NuPlayer  这里有一点需要提一下,不像StagefrightPlayerFactory直接就创建出了StagefrightPlayer, NuPlayerFactory创建出来的是NuPlayerDriver,不过NuPlayerDriver内部也是封装了NuPlayer,对Nu">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://139.199.4.241/安卓音视频播放-NuPlayer/1.png">
<meta property="og:image" content="http://139.199.4.241/安卓音视频播放-NuPlayer/2.png">
<meta property="og:image" content="http://139.199.4.241/安卓音视频播放-NuPlayer/3.png">
<meta property="og:updated_time" content="2019-10-14T14:06:52.282Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="安卓音视频播放 - NuPlayer">
<meta name="twitter:description" content="系列文章:  安卓音视频播放 - 总体架构 安卓音视频播放 - AwesomePlayer 安卓音视频播放 - NuPlayer  这里有一点需要提一下,不像StagefrightPlayerFactory直接就创建出了StagefrightPlayer, NuPlayerFactory创建出来的是NuPlayerDriver,不过NuPlayerDriver内部也是封装了NuPlayer,对Nu">
<meta name="twitter:image" content="http://139.199.4.241/安卓音视频播放-NuPlayer/1.png">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=c114cbe6" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?57e94d016e201fba3603a8a2b0263af0";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  
  <script type="text/javascript">
	(function(){
	    var bp = document.createElement('script');
	    var curProtocol = window.location.protocol.split(':')[0];
	    if (curProtocol === 'https') {
	        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
	    }
	    else {
	        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
	    }
	    var s = document.getElementsByTagName("script")[0];
	    s.parentNode.insertBefore(bp, s);
	})();
  </script>



  
    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  
</head>
</html>
<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            rel="noopener noreferrer"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            rel="noopener noreferrer"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            rel="noopener noreferrer"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            rel="noopener noreferrer"
            target="_self"
            >
            关于
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#NuPlayer-Source"><span class="toc-text">NuPlayer::Source</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#NuPlayer-Source准备数据"><span class="toc-text">NuPlayer::Source准备数据</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NuPlayer-Decoder"><span class="toc-text">NuPlayer::Decoder</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NuPlayer-Render"><span class="toc-text">NuPlayer::Render</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#音频处理"><span class="toc-text">音频处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#视频处理"><span class="toc-text">视频处理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#整体架构图"><span class="toc-text">整体架构图</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-安卓音视频播放-NuPlayer" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">安卓音视频播放 - NuPlayer</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2019.01.19</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>林嘉伟</span>
        </span>
      

      


      

      
      <i class="fa fa-eye"></i> 
        <span id="busuanzi_container_page_pv">
           &nbsp热度 <span id="busuanzi_value_page_pv">
           <i class="fa fa-spinner fa-spin"></i></span>℃
        </span>
      

      
      
    </div>
  </header>

  <div class="article-content">
    
      <p>系列文章:</p>
<ul>
<li><a href="http://blog.islinjw.cn/2019/01/17/%E5%AE%89%E5%8D%93%E9%9F%B3%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE-%E6%80%BB%E4%BD%93%E6%9E%B6%E6%9E%84/" target="_blank" rel="noopener">安卓音视频播放 - 总体架构</a></li>
<li><a href="http://blog.islinjw.cn/2019/01/17/%E5%AE%89%E5%8D%93%E9%9F%B3%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE-AwesomePlayer/" target="_blank" rel="noopener">安卓音视频播放 - AwesomePlayer</a></li>
<li><a href="http://blog.islinjw.cn/2019/01/19/%E5%AE%89%E5%8D%93%E9%9F%B3%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE-NuPlayer/" target="_blank" rel="noopener">安卓音视频播放 - NuPlayer</a></li>
</ul>
<p>这里有一点需要提一下,不像StagefrightPlayerFactory直接就创建出了StagefrightPlayer, NuPlayerFactory创建出来的是NuPlayerDriver,不过NuPlayerDriver内部也是封装了NuPlayer,对NuPlayer进行调用就是了:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NuPlayerFactory</span> :</span> <span class="keyword">public</span> MediaPlayerFactory::IFactory &#123;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> sp&lt;MediaPlayerBase&gt; createPlayer(<span class="keyword">pid_t</span> pid) &#123;</span><br><span class="line">        ALOGV(<span class="string">" create NuPlayer"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NuPlayerDriver(pid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>接下来就要介绍NuPlayer了,NuPlayer的特点在于它用了Handler机制去实现子线程解码。对的,就是我们熟悉的Handler机制.只不过它是在C/C++的实现,但是原理和java层的是一样的。</p>
<p>看下接口声明就会感觉似曾相识了:</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ALooper</span> :</span> <span class="keyword">public</span> RefBase &#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">status_t</span> start(<span class="keyword">bool</span> runOnCallingThread = <span class="literal">false</span>,<span class="keyword">bool</span> canCallJava = <span class="literal">false</span>,<span class="keyword">int32_t</span> priority = PRIORITY_DEFAULT);</span><br><span class="line">	...</span><br><span class="line">    <span class="keyword">status_t</span> <span class="built_in">stop</span>();</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">post</span><span class="params">(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg, <span class="keyword">int64_t</span> delayUs)</span></span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">loop</span><span class="params">()</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AHandler</span> :</span> <span class="keyword">public</span> RefBase &#123;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onMessageReceived</span><span class="params">(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg)</span> </span>= <span class="number">0</span>;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AMessage</span> :</span> <span class="keyword">public</span> RefBase &#123;</span><br><span class="line">    AMessage();</span><br><span class="line">    AMessage(<span class="keyword">uint32_t</span> what, <span class="keyword">const</span> sp&lt;<span class="keyword">const</span> AHandler&gt; &amp;handler);</span><br><span class="line">	...</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setTarget</span><span class="params">(<span class="keyword">const</span> sp&lt;<span class="keyword">const</span> AHandler&gt; &amp;handler)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setInt32</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">int32_t</span> value)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setInt64</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">int64_t</span> value)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSize</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">size_t</span> value)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setFloat</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">float</span> value)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDouble</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">double</span> value)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setPointer</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">void</span> *value)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setString</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">char</span> *s, <span class="keyword">ssize_t</span> len = <span class="number">-1</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setString</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> AString &amp;s)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setObject</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> sp&lt;RefBase&gt; &amp;obj)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setBuffer</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> sp&lt;ABuffer&gt; &amp;<span class="built_in">buffer</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setMessage</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> sp&lt;AMessage&gt; &amp;obj)</span></span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">status_t</span> post(<span class="keyword">int64_t</span> delayUs = <span class="number">0</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而Looper就是在NuPlayerDriver中创建并启动的</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">NuPlayerDriver::NuPlayerDriver(pid_t pid)</span><br><span class="line">    : mState(STATE_IDLE),</span><br><span class="line">      mIsAsyncPrepare(<span class="literal">false</span>),</span><br><span class="line">      mAsyncResult(UNKNOWN_ERROR),</span><br><span class="line">      mSetSurfaceInProgress(<span class="literal">false</span>),</span><br><span class="line">      mDurationUs(-<span class="number">1</span>),</span><br><span class="line">      mPositionUs(-<span class="number">1</span>),</span><br><span class="line">      mSeekInProgress(<span class="literal">false</span>),</span><br><span class="line">      mLooper(<span class="keyword">new</span> ALooper),</span><br><span class="line">      mPlayerFlags(<span class="number">0</span>),</span><br><span class="line">      mAtEOS(<span class="literal">false</span>),</span><br><span class="line">      mLooping(<span class="literal">false</span>),</span><br><span class="line">      mAutoLoop(<span class="literal">false</span>) &#123;</span><br><span class="line">    ALOGV(<span class="string">"NuPlayerDriver(%p)"</span>, <span class="keyword">this</span>);</span><br><span class="line">    mLooper-&gt;setName(<span class="string">"NuPlayerDriver Looper"</span>);</span><br><span class="line"></span><br><span class="line">    mLooper-&gt;start(</span><br><span class="line">            <span class="literal">false</span>, <span class="comment">/* runOnCallingThread */</span></span><br><span class="line">            <span class="literal">true</span>,  <span class="comment">/* canCallJava */</span></span><br><span class="line">            PRIORITY_AUDIO);</span><br><span class="line"></span><br><span class="line">    mPlayer = <span class="keyword">new</span> NuPlayer(pid);</span><br><span class="line">    mLooper-&gt;registerHandler(mPlayer);</span><br><span class="line"></span><br><span class="line">    mPlayer-&gt;setDriver(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NuPlayerDriver::~NuPlayerDriver() &#123;</span><br><span class="line">    ALOGV(<span class="string">"~NuPlayerDriver(%p)"</span>, <span class="keyword">this</span>);</span><br><span class="line">    mLooper-&gt;stop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们的NuPlayer其实是一个AHandler:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NuPlayer</span> :</span> <span class="keyword">public</span> AHandler &#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onMessageReceived</span><span class="params">(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg)</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它通过AMessage::post方法将操作放到子线程中,这操作简直不能再熟悉,甚至就没有细讲的必要:</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> NuPlayer::setDataSourceAsync(<span class="keyword">const</span> sp&lt;IStreamSource&gt; &amp;source) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatSetDataSource, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; notify = <span class="keyword">new</span> AMessage(kWhatSourceNotify, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    msg-&gt;setObject(<span class="string">"source"</span>, <span class="keyword">new</span> StreamingSource(notify, source));</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> NuPlayer::prepareAsync() &#123;</span><br><span class="line">    (<span class="keyword">new</span> AMessage(kWhatPrepare, <span class="keyword">this</span>))-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> NuPlayer::onMessageReceived(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">switch</span> (msg-&gt;what()) &#123;</span><br><span class="line">		<span class="keyword">case</span> kWhatSetDataSource:</span><br><span class="line">        &#123;</span><br><span class="line">            ALOGV(<span class="string">"kWhatSetDataSource"</span>);</span><br><span class="line"></span><br><span class="line">            CHECK(mSource == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">status_t</span> err = OK;</span><br><span class="line">            sp&lt;RefBase&gt; obj;</span><br><span class="line">            CHECK(msg-&gt;findObject(<span class="string">"source"</span>, &amp;obj));</span><br><span class="line">            <span class="keyword">if</span> (obj != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(mSourceLock)</span></span>;</span><br><span class="line">                mSource = <span class="keyword">static_cast</span>&lt;Source *&gt;(obj.<span class="built_in">get</span>());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                err = UNKNOWN_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            CHECK(mDriver != <span class="literal">NULL</span>);</span><br><span class="line">            sp&lt;NuPlayerDriver&gt; driver = mDriver.promote();</span><br><span class="line">            <span class="keyword">if</span> (driver != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                driver-&gt;notifySetDataSourceCompleted(err);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> kWhatPrepare:</span><br><span class="line">        &#123;</span><br><span class="line">            mSource-&gt;prepareAsync();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;		</span><br><span class="line">        ...</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="NuPlayer-Source"><a href="#NuPlayer-Source" class="headerlink" title="NuPlayer::Source"></a>NuPlayer::Source</h1><p>NuPlayer::Source顾名思义,是数据源的意思,它复制从音视频源读取数据。</p>
<p>数据源在java层调用setDataSource方法之后,传递到NuPlayer都会打包成不同的NuPlayer::Source</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> NuPlayer::setDataSourceAsync(<span class="keyword">const</span> sp&lt;IMediaHTTPService&gt; &amp;httpService, <span class="keyword">const</span> <span class="keyword">char</span> *url, <span class="keyword">const</span> KeyedVector&lt;String8, String8&gt; *headers) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatSetDataSource, <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">size_t</span> len = <span class="built_in">strlen</span>(url);</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; notify = <span class="keyword">new</span> AMessage(kWhatSourceNotify, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    sp&lt;Source&gt; source;</span><br><span class="line">    <span class="keyword">if</span> (IsHTTPLiveURL(url)) &#123;</span><br><span class="line">        source = <span class="keyword">new</span> HTTPLiveSource(notify, httpService, url, headers);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strncasecmp(url, <span class="string">"rtsp://"</span>, <span class="number">7</span>)) &#123;</span><br><span class="line">        source = <span class="keyword">new</span> RTSPSource(notify, httpService, url, headers, mUIDValid, mUID);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((!strncasecmp(url, <span class="string">"http://"</span>, <span class="number">7</span>) || !strncasecmp(url, <span class="string">"https://"</span>, <span class="number">8</span>)) &amp;&amp; ((len &gt;= <span class="number">4</span> &amp;&amp; !strcasecmp(<span class="string">".sdp"</span>, &amp;url[len - <span class="number">4</span>])) || <span class="built_in">strstr</span>(url, <span class="string">".sdp?"</span>))) &#123;</span><br><span class="line">        source = <span class="keyword">new</span> RTSPSource(notify, httpService, url, headers, mUIDValid, mUID, <span class="literal">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sp&lt;GenericSource&gt; genericSource = <span class="keyword">new</span> GenericSource(notify, mUIDValid, mUID);</span><br><span class="line">        <span class="keyword">status_t</span> err = genericSource-&gt;setDataSource(httpService, url, headers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (err == OK) &#123;</span><br><span class="line">            source = genericSource;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ALOGE(<span class="string">"Failed to set data source!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    msg-&gt;setObject(<span class="string">"source"</span>, source);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> NuPlayer::setDataSourceAsync(<span class="keyword">int</span> fd, <span class="keyword">int64_t</span> offset, <span class="keyword">int64_t</span> length) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatSetDataSource, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; notify = <span class="keyword">new</span> AMessage(kWhatSourceNotify, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    sp&lt;GenericSource&gt; source = <span class="keyword">new</span> GenericSource(notify, mUIDValid, mUID);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">status_t</span> err = source-&gt;setDataSource(fd, offset, length);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Failed to set data source!"</span>);</span><br><span class="line">        source = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    msg-&gt;setObject(<span class="string">"source"</span>, source);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> NuPlayer::setDataSourceAsync(<span class="keyword">const</span> sp&lt;DataSource&gt; &amp;dataSource) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatSetDataSource, <span class="keyword">this</span>);</span><br><span class="line">    sp&lt;AMessage&gt; notify = <span class="keyword">new</span> AMessage(kWhatSourceNotify, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    sp&lt;GenericSource&gt; source = <span class="keyword">new</span> GenericSource(notify, mUIDValid, mUID);</span><br><span class="line">    <span class="keyword">status_t</span> err = source-&gt;setDataSource(dataSource);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Failed to set data source!"</span>);</span><br><span class="line">        source = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    msg-&gt;setObject(<span class="string">"source"</span>, source);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> NuPlayer::setDataSourceAsync(<span class="keyword">const</span> sp&lt;IStreamSource&gt; &amp;source) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatSetDataSource, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; notify = <span class="keyword">new</span> AMessage(kWhatSourceNotify, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    msg-&gt;setObject(<span class="string">"source"</span>, <span class="keyword">new</span> StreamingSource(notify, source));</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的HTTPLiveSource、RTSPSource、GenericSource、StreamingSource都继承NuPlayer::Source</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NuPlayer</span>:</span>:HTTPLiveSource : <span class="keyword">public</span> NuPlayer::Source &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NuPlayer</span>:</span>:RTSPSource : <span class="keyword">public</span> NuPlayer::Source &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NuPlayer</span>:</span>:GenericSource : <span class="keyword">public</span> NuPlayer::Source &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NuPlayer</span>:</span>:StreamingSource : <span class="keyword">public</span> NuPlayer::Source &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/安卓音视频播放-NuPlayer/1.png">

<p>可以看到NuPlayer根据音视频源的类型,创建了不同的NuPlayer::Source,然后放到了一个what=kWhatSetDataSource的AMessage中post了出去。</p>
<p>让我们跟踪下NuPlayer这个Handler是怎么处理kWhatSetDataSource消息的:</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> NuPlayer::onMessageReceived(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (msg-&gt;what()) &#123;</span><br><span class="line">        <span class="keyword">case</span> kWhatSetDataSource:</span><br><span class="line">        &#123;</span><br><span class="line">        	...</span><br><span class="line">        	sp&lt;RefBase&gt; obj;</span><br><span class="line">        	CHECK(msg-&gt;findObject(<span class="string">"source"</span>, &amp;obj));</span><br><span class="line">        	...</span><br><span class="line">        	mSource = <span class="keyword">static_cast</span>&lt;Source *&gt;(obj.<span class="built_in">get</span>());</span><br><span class="line">        	...</span><br><span class="line">        &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实就是赋值了一下mSource</p>
<h2 id="NuPlayer-Source准备数据"><a href="#NuPlayer-Source准备数据" class="headerlink" title="NuPlayer::Source准备数据"></a>NuPlayer::Source准备数据</h2><p>首先在调用prepare方法之后NuPlayer会发送kWhatPrepare消息,在NuPlayer::onMessageReceived里面会调用NuPlayer::Source::prepareAsync方法:</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">void</span> NuPlayer::prepareAsync() &#123;</span><br><span class="line">    <span class="function"><span class="params">(<span class="keyword">new</span> AMessage(kWhatPrepare, <span class="keyword">this</span>))</span>-&gt;</span>post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="literal">void</span> NuPlayer::onMessageReceived(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (msg-&gt;what()) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">case</span> kWhatPrepare:</span><br><span class="line">        &#123;</span><br><span class="line">            mSource-&gt;prepareAsync();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NuPlayer::Source::prepareAsync是让NuPlayer::Source去准备好数据源,例如通过网络请求获取或者打开文件获取。</p>
<p>NuPlayer::Source内部基本也是通过Handler机制异步去加载数据的,这里只举一个NuPlayer::GenericSource的例子:</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> NuPlayer::GenericSource::prepareAsync() &#123;</span><br><span class="line">    <span class="keyword">if</span> (mLooper == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mLooper = <span class="keyword">new</span> ALooper;</span><br><span class="line">        mLooper-&gt;setName(<span class="string">"generic"</span>);</span><br><span class="line">        mLooper-&gt;start();</span><br><span class="line"></span><br><span class="line">        mLooper-&gt;registerHandler(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatPrepareAsync, <span class="keyword">this</span>);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> NuPlayer::GenericSource::onMessageReceived(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (msg-&gt;what()) &#123;</span><br><span class="line">      <span class="keyword">case</span> kWhatPrepareAsync:</span><br><span class="line">      &#123;</span><br><span class="line">          onPrepareAsync();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      ....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> NuPlayer::GenericSource::onPrepareAsync() &#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">if</span> (!mUri.empty()) &#123;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">char</span>* uri = mUri.c_str();</span><br><span class="line">		...</span><br><span class="line">		mDataSource = DataSource::CreateFromURI(</span><br><span class="line">                   mHTTPService, uri, &amp;mUriHeaders, &amp;contentType,</span><br><span class="line">                   <span class="keyword">static_cast</span>&lt;HTTPBase *&gt;(mHttpSource.<span class="built_in">get</span>()));</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		mIsWidevine = <span class="literal">false</span>;</span><br><span class="line">		mDataSource = <span class="keyword">new</span> FileSource(mFd, mOffset, mLength);</span><br><span class="line">		mFd = <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">	finishPrepareAsync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>准备好数据之后会调用finishPrepareAsync用构造的时候传给NuPlayer::Source的kWhatSourceNotify消息复制出一个新的kWhatPrepared消息反向通知NuPlayer,这是一种标准的原型模式:</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="literal">void</span> NuPlayer<span class="type">::GenericSource</span><span class="type">::finishPrepareAsync</span>() &#123;</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">	notifyPrepared();</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="literal">void</span> NuPlayer<span class="type">::Source</span><span class="type">::notifyPrepared</span>(status_t err) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; notify = dupNotify();</span><br><span class="line">    notify-&gt;setInt32(<span class="string">"what"</span>, kWhatPrepared);</span><br><span class="line">    notify-&gt;setInt32(<span class="string">"err"</span>, err);</span><br><span class="line">    notify-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct NuPlayer<span class="type">::Source</span> : <span class="keyword">public</span> AHandler &#123;</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">	Source(const sp&lt;AMessage&gt; &amp;notify)</span><br><span class="line">       : mNotify(notify) &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">	sp&lt;AMessage&gt; dupNotify() const &#123; <span class="keyword">return</span> mNotify-&gt;dup(); &#125;</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后NuPlayer::Source其实也充当了Demux的功能,它生命了一个dequeueAccessUnit纯虚方法,这个方法就是从数据源分离获取音频或者视频数据:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> status_t <span class="title">dequeueAccessUnit</span><span class="params">( <span class="keyword">bool</span> audio, sp&lt;ABuffer&gt; *accessUnit)</span> </span>= <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<img src="/安卓音视频播放-NuPlayer/2.png">

<h1 id="NuPlayer-Decoder"><a href="#NuPlayer-Decoder" class="headerlink" title="NuPlayer::Decoder"></a>NuPlayer::Decoder</h1><p>NuPlayer::Decoder是NuPlayer的解码模块,然我们来看看它是怎么创建的吧。</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">void</span> NuPlayer<span class="type">::start</span>() &#123;</span><br><span class="line">    (<span class="literal">new</span> AMessage(kWhatStart, this))-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="literal">void</span> NuPlayer<span class="type">::onMessageReceived</span>(const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    switch (msg-&gt;what()) &#123;</span><br><span class="line">        <span class="params">...</span></span><br><span class="line">        <span class="keyword">case</span> kWhatStart:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="params">...</span></span><br><span class="line">            onStart();</span><br><span class="line">            <span class="params">...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="params">...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//startPositionUs 有个默认值-1</span></span><br><span class="line"><span class="literal">void</span> NuPlayer<span class="type">::onStart</span>(int64_t startPositionUs) &#123;</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">	sp&lt;AMessage&gt; notify = <span class="literal">new</span> AMessage(kWhatRendererNotify, this);</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">    mRenderer = <span class="literal">new</span> Renderer(mAudioSink, notify, flags);</span><br><span class="line">    <span class="params">...</span></span><br><span class="line">    postScanSources();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在onStart里面创建了Renderer,然后调用postScanSources</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="literal">void</span> NuPlayer<span class="type">::postScanSources</span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> (mScanSourcesPending) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="literal">new</span> AMessage(kWhatScanSources, this);</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"generation"</span>, mScanSourcesGeneration);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line"></span><br><span class="line">    mScanSourcesPending = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="literal">void</span> NuPlayer<span class="type">::onMessageReceived</span>(const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    switch (msg-&gt;what()) &#123;</span><br><span class="line">        <span class="params">...</span></span><br><span class="line">        <span class="keyword">case</span> kWhatScanSources:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="params">...</span></span><br><span class="line">            <span class="keyword">if</span> (mSurface != <span class="built_in">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instantiateDecoder(<span class="literal">false</span>, &amp;mVideoDecoder) == <span class="params">-EWOULDBLOCK</span>) &#123;</span><br><span class="line">                    rescan = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mAudioSink != <span class="built_in">NULL</span> &amp;&amp; mAudioDecoder == <span class="built_in">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instantiateDecoder(<span class="literal">true</span>, &amp;mAudioDecoder) == <span class="params">-EWOULDBLOCK</span>) &#123;</span><br><span class="line">                    rescan = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="params">...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="params">...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">status_t NuPlayer<span class="type">::instantiateDecoder</span>(bool audio, sp&lt;DecoderBase&gt; *decoder, bool checkAudioModeChange) &#123;</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">	sp&lt;AMessage&gt; format = mSource-&gt;getFormat(audio);</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">	<span class="keyword">if</span> (audio) &#123;</span><br><span class="line">		<span class="params">...</span></span><br><span class="line">		*decoder = <span class="literal">new</span> Decoder(notify, mSource, mPID, mRenderer);</span><br><span class="line">		<span class="params">...</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="params">...</span></span><br><span class="line">		*decoder = <span class="literal">new</span> Decoder(notify, mSource, mPID, mRenderer, mSurface, mCCDecoder);</span><br><span class="line">		<span class="params">...</span></span><br><span class="line">	&#125;</span><br><span class="line">	(*decoder)-&gt;init();</span><br><span class="line">    (*decoder)-&gt;configure(format);</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="literal">void</span> NuPlayer<span class="type">::Decoder</span><span class="type">::onConfigure</span>(const sp&lt;AMessage&gt; &amp;format) &#123;</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">	AString mime;</span><br><span class="line">    CHECK(format-&gt;findString(<span class="string">"mime"</span>, &amp;mime));</span><br><span class="line">    <span class="params">...</span></span><br><span class="line">	mCodec = MediaCodec<span class="type">::CreateByType</span>(</span><br><span class="line">            mCodecLooper, mime.c_str(), <span class="literal">false</span> <span class="comment">/* encoder */</span>, <span class="built_in">NULL</span> <span class="comment">/* err */</span>, mPid);</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从这里可以看到NuPlayer::Decoder实际上是通过MediaCodec去进行音视频的解码的。</p>
<p>MediaCodec是安卓提供的,访问底层编解码器的接口。其实最后也是依赖OpenMax的。</p>
<h1 id="NuPlayer-Render"><a href="#NuPlayer-Render" class="headerlink" title="NuPlayer::Render"></a>NuPlayer::Render</h1><p>NuPlayer::Render顾名思义是做渲染的,但是经过代码分析,其实它的逻辑只是做音视频同步,然后音频渲染会交给MediaPlayerBase::AudioSink,而视频渲染会交回给NuPlayer::Decoder再交给MediaCodec。</p>
<p>当NuPlayer::Decoder从NuPlayer::Source拿到数据并解码之后,会调用NuPlayer::Renderer::queueBuffer方法将解码之后的数据丢给NuPlayer::Renderer</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> NuPlayer::Decoder::handleAnOutputBuffer(</span><br><span class="line">        <span class="keyword">size_t</span> index,</span><br><span class="line">        <span class="keyword">size_t</span> offset,</span><br><span class="line">        <span class="keyword">size_t</span> <span class="built_in">size</span>,</span><br><span class="line">        <span class="keyword">int64_t</span> timeUs,</span><br><span class="line">        <span class="keyword">int32_t</span> flags) &#123;</span><br><span class="line">	sp&lt;ABuffer&gt; <span class="built_in">buffer</span>;</span><br><span class="line">	mCodec-&gt;getOutputBuffer(index, &amp;<span class="built_in">buffer</span>); <span class="comment">// 从MediaCodec获取解码之后的数据</span></span><br><span class="line">	...</span><br><span class="line">	<span class="comment">// 注意这里,这个reply用于让mRenderer回调NuPlayer::Decoder视频绘制.</span></span><br><span class="line">	<span class="comment">// 不过很多人都会忽略这行注释吧,没关系,读到后面你们还会返回来看的...</span></span><br><span class="line">	sp&lt;AMessage&gt; reply = <span class="keyword">new</span> AMessage(kWhatRenderBuffer, <span class="keyword">this</span>); </span><br><span class="line">	...</span><br><span class="line">	mRenderer-&gt;queueBuffer(mIsAudio, <span class="built_in">buffer</span>, reply);</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NuPlayer::Renderer会往消息队列丢入kWhatQueueBuffer消息:</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> NuPlayer::Renderer::queueBuffer(</span><br><span class="line">        <span class="keyword">bool</span> audio,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;ABuffer&gt; &amp;<span class="built_in">buffer</span>,</span><br><span class="line">        <span class="keyword">const</span> sp&lt;AMessage&gt; &amp;notifyConsumed) &#123;</span><br><span class="line">    sp&lt;AMessage&gt; msg = <span class="keyword">new</span> AMessage(kWhatQueueBuffer, <span class="keyword">this</span>);</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"queueGeneration"</span>, getQueueGeneration(audio));</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"audio"</span>, <span class="keyword">static_cast</span>&lt;<span class="keyword">int32_t</span>&gt;(audio));</span><br><span class="line">    msg-&gt;setBuffer(<span class="string">"buffer"</span>, <span class="built_in">buffer</span>);</span><br><span class="line">    msg-&gt;setMessage(<span class="string">"notifyConsumed"</span>, notifyConsumed);</span><br><span class="line">    msg-&gt;post();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> NuPlayer::Renderer::onMessageReceived(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (msg-&gt;what()) &#123;</span><br><span class="line">        <span class="keyword">case</span> kWhatQueueBuffer:</span><br><span class="line">        &#123;</span><br><span class="line">            onQueueBuffer(msg);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> NuPlayer::Renderer::onQueueBuffer(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    <span class="keyword">int32_t</span> audio;</span><br><span class="line">    CHECK(msg-&gt;findInt32(<span class="string">"audio"</span>, &amp;audio));</span><br><span class="line">    ...</span><br><span class="line">    sp&lt;ABuffer&gt; <span class="built_in">buffer</span>;</span><br><span class="line">    CHECK(msg-&gt;findBuffer(<span class="string">"buffer"</span>, &amp;<span class="built_in">buffer</span>));</span><br><span class="line">    </span><br><span class="line">    sp&lt;AMessage&gt; notifyConsumed;</span><br><span class="line">    CHECK(msg-&gt;findMessage(<span class="string">"notifyConsumed"</span>, &amp;notifyConsumed));</span><br><span class="line"></span><br><span class="line">    QueueEntry entry;</span><br><span class="line">    entry.mBuffer = <span class="built_in">buffer</span>;</span><br><span class="line">    entry.mNotifyConsumed = notifyConsumed;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (audio) &#123;</span><br><span class="line">        Mutex::<span class="function">Autolock <span class="title">autoLock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">        mAudioQueue.push_back(entry);</span><br><span class="line">        postDrainAudioQueue_l();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mVideoQueue.push_back(entry);</span><br><span class="line">        postDrainVideoQueue();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里会判断是从AudioDecoder传来的音频数据,还是从VideoDecoder传来的视频数据。音频数据会丢到mAudioQueue而视频数据会丢到mVideoQueue,然后调用postDrainAudioQueue_l或者postDrainVideoQueue通过Handler机制发送音频处理消息或者视频处理消息</p>
<h2 id="音频处理"><a href="#音频处理" class="headerlink" title="音频处理"></a>音频处理</h2><p>让我们先看看音频部分的处理</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">void</span> NuPlayer<span class="type">::Renderer</span><span class="type">::postDrainAudioQueue_l</span>(int64_t delayUs) &#123;</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">	sp&lt;AMessage&gt; msg = <span class="literal">new</span> AMessage(kWhatDrainAudioQueue, this);</span><br><span class="line">    msg-&gt;setInt32(<span class="string">"drainGeneration"</span>, mAudioDrainGeneration);</span><br><span class="line">    msg-&gt;post(delayUs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="literal">void</span> NuPlayer<span class="type">::Renderer</span><span class="type">::onMessageReceived</span>(const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    switch (msg-&gt;what()) &#123;</span><br><span class="line">        <span class="keyword">case</span> kWhatDrainAudioQueue:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (onDrainAudioQueue()) &#123;</span><br><span class="line">            	<span class="params">...</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="params">...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="params">...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bool NuPlayer<span class="type">::Renderer</span><span class="type">::onDrainAudioQueue</span>() &#123;</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">	<span class="keyword">while</span> (!mAudioQueue.empty()) &#123;</span><br><span class="line">        QueueEntry *entry = &amp;*mAudioQueue.begin();</span><br><span class="line">        <span class="params">...</span></span><br><span class="line">        ssize_t written = mAudioSink-&gt;write(entry-&gt;mBuffer-&gt;<span class="built_in">data</span>() + entry-&gt;mOffset,</span><br><span class="line">                                            copy, <span class="literal">false</span> <span class="comment">/* blocking */</span>);</span><br><span class="line">        <span class="params">...</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="params">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里NuPlayer::Renderer会从mAudioQueue拿音频数据然后写入mAudioSink。mAudioSink内部就会调用声音输出设备如喇叭等去播放了。</p>
<h2 id="视频处理"><a href="#视频处理" class="headerlink" title="视频处理"></a>视频处理</h2><p>接着看看视频处理</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">void</span> NuPlayer<span class="type">::Renderer</span><span class="type">::postDrainVideoQueue</span>() &#123;</span><br><span class="line">	sp&lt;AMessage&gt; msg = <span class="literal">new</span> AMessage(kWhatDrainVideoQueue, this);</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">	msg-&gt;post(postDelayUs);</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="literal">void</span> NuPlayer<span class="type">::Renderer</span><span class="type">::onMessageReceived</span>(const sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    switch (msg-&gt;what()) &#123;</span><br><span class="line">        <span class="keyword">case</span> kWhatDrainVideoQueue:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="params">...</span></span><br><span class="line">            onDrainVideoQueue();</span><br><span class="line">            <span class="params">...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="params">...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="literal">void</span> NuPlayer<span class="type">::Renderer</span><span class="type">::onDrainVideoQueue</span>() &#123;</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">	QueueEntry *entry = &amp;*mVideoQueue.begin();</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">	</span><br><span class="line">    entry-&gt;mNotifyConsumed-&gt;setInt64(<span class="string">"timestampNs"</span>, realTimeUs * <span class="number">1000</span>ll);</span><br><span class="line">    entry-&gt;mNotifyConsumed-&gt;setInt32(<span class="string">"render"</span>, !tooLate);</span><br><span class="line">    entry-&gt;mNotifyConsumed-&gt;post();</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>视频处理这里其实还会做一些数值计算,主要用于视频的平滑播放,这里就忽略了。然后就调用了mNotifyConsumed的post方法。这个mNotifyConsumed是啥呢?大家可以往上拉回到NuPlayer::Decoder::handleAnOutputBuffer给NuPlayer::Renderer丢入解码后的音视频数据那里,估计很多人都没有注意到。</p>
<p>总之,它会给NuPlayer::Decoder发一个kWhatRenderBuffer消息,然后就会让NuPlayer::Decoder去渲染视频画面了,不过它也是交给MediaCodec去渲染而已:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">void NuPlayer::Decoder::onMessageReceived(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">    ALOGV(<span class="string">"[%s] onMessage: %s"</span>, mComponentName.c_str(), msg-&gt;debugString().c_str());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (msg-&gt;what()) &#123;</span><br><span class="line">        <span class="keyword">case</span> kWhatRenderBuffer:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isStaleReply(msg)) &#123;</span><br><span class="line">                onRenderBuffer(msg);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void NuPlayer::Decoder::onRenderBuffer(<span class="keyword">const</span> sp&lt;AMessage&gt; &amp;msg) &#123;</span><br><span class="line">	...</span><br><span class="line">   err = mCodec-&gt;renderOutputBufferAndRelease(bufferIx, timestampNs);</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个mCodec大家可能都忘了是啥,其实在NuPlayer::Decoder那节有说过的,就是MediaCodec:</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">void</span> NuPlayer<span class="type">::Decoder</span><span class="type">::onConfigure</span>(const sp&lt;AMessage&gt; &amp;format) &#123;</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">	AString mime;</span><br><span class="line">    CHECK(format-&gt;findString(<span class="string">"mime"</span>, &amp;mime));</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">	mCodec = MediaCodec<span class="type">::CreateByType</span>(</span><br><span class="line">            mCodecLooper, mime.c_str(), <span class="literal">false</span> <span class="comment">/* encoder */</span>, <span class="built_in">NULL</span> <span class="comment">/* err */</span>, mPid);</span><br><span class="line">	<span class="params">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="整体架构图"><a href="#整体架构图" class="headerlink" title="整体架构图"></a>整体架构图</h1><p>所以NuPlayer的整个架构图如下:</p>
<img src="/安卓音视频播放-NuPlayer/3.png">

<p>可以看出来, NuPlayer的核心功能是依赖MediaCodec去实现的</p>

    
  </div>
</article>


   

   
  <div class="box-prev-next clearfix">
    <a class="show pull-left" href="/2019/01/17/安卓音视频播放-AwesomePlayer/">
        <i class="icon icon-angle-left"></i>
    </a>
    <a class="show pull-right" href="/2019/03/02/Handler-postDelayed的原理/">
        <i class="icon icon-angle-right"></i>
    </a>
  </div>




</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              rel="noopener noreferrer"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              rel="noopener noreferrer"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              rel="noopener noreferrer"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              rel="noopener noreferrer"
              target="_self"
              >
              关于
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    




    

  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>


<footer style="position:absolute; bottom: 2%;left: 50%;transform: translateX(-50%);">
<a style="font-size:12px; color:#6C6C6C" target="_blank">© 2020  林嘉伟 | <a style="font-size:12px; color:#6C6C6C" target="_blank" href="http://beian.miit.gov.cn/" rel="nofollow">粤ICP备16021035号</a></footer>
</body>
</html>
